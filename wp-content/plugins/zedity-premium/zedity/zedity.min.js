/***
 Copyright (C) 2013-2015 Pridea Company - http://pridea.it

 This file is part of the Zedity library, available at http://zedity.com/

 The library is distributed under the terms of the Zedity Commercial License, which is
 available at http://zedity.com/license/commercial/, and WITHOUT ANY WARRANTY; without
 even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 ***/
Zedity = Zedity || {};
(function($) {
    Zedity = function(options) {
        this.$container = null;
        this.$this = null;
        this._options = $.extend({
            container: '#Editor,#editor',
            language: window.ZedityLang || 'en',
            width: 800,
            height: 550,
            minWidth: 150,
            minHeight: 150,
            maxWidth: 3000,
            maxHeight: 10000,
            maxTotalBoxes: undefined,
            content: '',
            undoSteps: 5,
            resizable: true,
            userResizable: true,
            snapBoxes: false,
            snapPage: false,
            snapGrid: false,
            onchange: null,
            onselect: null,
            onerror: null
        }, options);
        Zedity.i18n.set(this._options.language, true);
        for (var i = Zedity.requires.length - 1; i >= 0; --i) {
            if (Zedity.core.supports.hasOwnProperty(Zedity.requires[i]) && !Zedity.core.supports[Zedity.requires[i]]()) throw new Error(Zedity.t('Browser does not support required feature "%s".', Zedity.requires[i]))
        }
        this.$container = $(this._options.container);
        if (this.$container.length == 0) throw new Error(Zedity.t('Could not initialize %s. Container not found.', 'Zedity'));
        this.$container.data('zedity-editor', this);
        this.boxes.editor = this;
        Zedity.editors.push(this);
        this.editor = this;
        this._data = {
            internal: 0,
            locked: 0,
            lockmessage: []
        };
        this.menu = {
            _data: {},
            add: function() {},
            refresh: function() {}
        };
        if (!Zedity.Page) throw new Error(Zedity.t('%s needs %s.', 'Zedity', 'Zedity.Page'));
        this.page = new Zedity.Page({
            editor: this,
            width: this._options.width,
            height: this._options.height,
            minWidth: this._options.minWidth,
            minHeight: this._options.minHeight,
            maxWidth: this._options.maxWidth,
            maxHeight: this._options.maxHeight,
            content: this._options.content
        });
        this.menu = new Zedity.Ribbon($.extend({
            editor: this
        }, this._options.ribbon));
        this.contextMenu = new Zedity.ContextMenu({
            editor: this
        });
        this.$container.append($('<div/>', {
            'class': 'zedity-lock'
        }));
        this.init();
        this._changed();
        this.step = 0;
        Zedity.core.keys._bind();
        Zedity.core.shortcuts.add('ctrl+z meta+z', this, function(event) {
            this.undo()
        }, true);
        Zedity.core.shortcuts.add('ctrl+y meta+y', this, function(event) {
            this.redo()
        }, true);
        this.$this.on('click.zedity touchend.zedity', '.zedity-empty .zedity-button', function() {
            var box = $(this).closest('.zedity-box').box();
            if (!box) return;
            if (box.editor.responsive && box.editor.responsive.current && box.editor.responsive.current != box._data.ownerlayout) return false;
            box.insert()
        })
    };
    $.extend(Zedity.prototype, {
        _changed: function() {
            if (this._data.internal) return this;
            clearTimeout(this._data.changedEventTimer);
            if (!this._data.undoing && !this._data.savingundo) {
                var self = this;
                this._data.changedEventTimer = setTimeout(function() {
                    if (self.menu) self.menu.refresh();
                    self.page._saveUndo();
                    if (typeof(self._options.onchange) == 'function') self._options.onchange.call(self)
                }, 400)
            }
            return this
        },
        element: function() {
            this.$this = this.$container.find('.zedity-editor');
            return this.$this
        },
        options: function(options) {
            this._options = $.extend(this._options, options);
            return this._options
        },
        _error: function(error) {
            if (this._data.internal > 0) return;
            error = $.extend({
                code: 0,
                type: 'ERROR',
                message: 'Zedity error.'
            }, error);
            if (window.console) window.console.log(error);
            if (typeof(this._options.onerror) == 'function') {
                this._options.onerror.call(this, error)
            } else {
                if (error.type == 'ERROR') alert(error.message)
            }
        },
        _getSnap: function() {
            var snap = [];
            if (this._options.snapPage) snap.push('.zedity-editor');
            if (this._options.snapBoxes) snap.push('.zedity-box:not(.zedity-background)');
            return snap.join(',')
        },
        boxes: {
            $selected: null,
            _boxes: [],
            _getFromId: function(id) {
                for (var i = this._boxes.length - 1; i >= 0; --i) {
                    if (this._boxes[i].id == id || '#' + this._boxes[i].id == id) {
                        return this._boxes[i]
                    }
                }
            },
            _select: function(box) {
                if (box != null && box.$this.hasClass('zedity-selected')) {
                    if (box.asBackground()) this._select(null);
                    return box
                }
                var multiselect = Zedity.core.keys.state.ctrl || Zedity.core.keys.state.meta;
                this.editor.$this.children('.zedity-box').each(function(idx, elem) {
                    var $elem = $(this);
                    $elem.box().stop();
                    if (!multiselect) $elem.removeClass('zedity-selected');
                    if ($elem.data('ui-resizable')) $elem.resizable('destroy');
                    if ($elem.data('ui-rotatable')) $elem.rotatable('destroy')
                });
                this.editor.boxes.$selected = !box || multiselect ? null : box.$this;
                if (box) {
                    box.$this.addClass('zedity-selected');
                    if (!box.asBackground()) {
                        box._initDrag()
                    } else {
                        if (multiselect) box.$this.removeClass('zedity-selected')
                    }
                }
                if (this.editor.menu) this.editor.menu.refresh();
                if (multiselect) {
                    if (typeof(this.editor._options.onselect) == 'function') this.editor._options.onselect.call(this, null);
                    return box
                }
                if (box && !box.$this.hasClass('zedity-background')) {
                    box.$this.resizable($.extend({
                        handles: 'se',
                        reposition: true,
                        minWidth: box._sizeLimits().minWidth,
                        maxWidth: box._sizeLimits().maxWidth,
                        minHeight: box._sizeLimits().minHeight,
                        maxHeight: box._sizeLimits().maxHeight,
                        start: function(e, ui) {},
                        stop: function(e, ui) {
                            var editor = $(this).editor();
                            editor.boxes.selected().reposition()._resize();
                            editor._changed();
                            editor.boxes.refreshSelected()
                        },
                        resize: function() {}
                    }, box.rotation() == 0 ? {
                        snapTolerance: 12,
                        snap: this.editor._getSnap(),
                        snapToGrid: this.editor.grid && this.editor.grid.show()
                    } : {}));
                    if (box.can('rotation')) {
                        box.$this.rotatable({
                            snaps: [0, 45, 90, 135, 180, 225, 270, 315, 360],
                            snapTolerance: 3,
                            start: function() {},
                            stop: function(event, ui) {
                                var editor = $(this).editor();
                                editor.boxes.selected();
                                editor._changed();
                                editor.boxes.refreshSelected()
                            }
                        })
                    }
                }
                if (typeof(this.editor._options.onselect) == 'function') this.editor._options.onselect.call(this, box);
                return box
            },
            refreshSelected: function() {
                var sel = this.selected();
                if (!sel) return null;
                this._select(null);
                sel.select();
                return sel
            },
            get: function(idx) {
                var uidx = Zedity.core.store.get('zedUnIndex');
                var ids = Zedity.core.store.get('zedUnRef' + uidx);
                var list = [];
                if (ids) {
                    ids = ids.split(' ');
                    for (var i = ids.length - 1; i >= 0; --i) {
                        list.push(this._getFromId(ids[i]))
                    }
                }
                if (idx == null) {
                    return list
                } else if (typeof idx == 'string' || idx instanceof String) {
                    if (Zedity.Box.types.indexOf(idx) > -1) {
                        var sub = [];
                        for (var i = list.length - 1; i >= 0; --i) {
                            if (list[i].type == idx) {
                                sub.push(list[i])
                            }
                        }
                        return sub
                    } else {
                        for (var i = list.length - 1; i >= 0; --i) {
                            if (list[i].id == idx || '#' + list[i].id == idx) {
                                return list[i]
                            }
                        }
                        return null
                    }
                } else {
                    return list[(idx + list.length) % list.length]
                }
            },
            count: function() {
                var uidx = Zedity.core.store.get('zedUnIndex');
                var ids = Zedity.core.store.get('zedUnRef' + uidx);
                ids = ids.split(' ');
                return ids.length + 1
            },
            selected: function() {
                var $sel = this.editor.$this.children('.zedity-selected');
                if ($sel.length == 0) $sel = this.$selected;
                if (!$sel || $sel.length != 1) return null;
                return this._getFromId($sel.attr('id'))
            },
            add: function(type, options) {
                if (Zedity.Box.types.indexOf(type) == -1) {
                    this.editor._error({
                        message: Zedity.t('Box type "%s" doesn\'t exist.', type)
                    });
                    return null
                }
                try {
                    var box = new Zedity.Box[type]($.extend({
                        editor: this.editor
                    }, options))
                } catch (e) {
                    this.editor._error({
                        message: Zedity.t('Error during box creation: %s.', e.message)
                    });
                    return null
                }
                this._boxes.push(box);
                box.reposition(true).select();
                Zedity.core._call(box, 'arrange', 'front');
                if (!options || (options.id == null && options.element == null)) this.editor._changed();
                return box
            },
            background: function() {
                var boxes = this.get();
                for (var i = boxes.length - 1; i >= 0; --i) {
                    if (boxes[i].$this.hasClass('zedity-background')) {
                        return boxes[i]
                    }
                }
                return null
            }
        },
        undo: function() {
            this.page._undo();
            return this
        },
        redo: function() {
            this.page._redo();
            return this
        },
        save: function(callback, options) {
            options = $.extend({
                removeEmpty: true,
                formatHtml: false,
                finalize: true
            }, options);
            this.lock('<p>' + Zedity.t('Saving content.') + '<br/>' + Zedity.t('Please wait...') + '</p>');
            if (this.$this.attr('data-href')) {
                this.$this.attr('onclick', 'window.open(\'' + this.$this.attr('data-href') + '\',\'' + (this.$this.attr('data-target') || '_top') + '\');');
                this.$this.css('cursor', 'pointer')
            }
            this.boxes._select(null);
            var saveq = $({});
            this._data.saveq = saveq;
            var list = this.boxes.get();
            $.each(list, function(idx, box) {
                saveq.queue('save', function(next) {
                    box._save(function() {
                        next()
                    }, options)
                })
            });
            saveq.queue('save', $.proxy(function(next) {
                var content = this.page._getPage(options.removeEmpty);
                Zedity.core.patterns.add('data-zedcssbuffer', 'style');
                content = Zedity.core.patterns.substitute(content);
                this.page._setPage(content);
                this.page._saveUndo();
                this.unlock();
                if (options.formatHtml) content = Zedity.utils.formatHtml(content);
                if (typeof(callback) == 'function') callback.call(this, content);
                this._data.saveq = null;
                next()
            }, this));
            setTimeout(function() {
                saveq.dequeue('save')
            }, 10);
            return this
        },
        _setLockMessage: function(message) {
            if (message == null) message = this._data.lockmessage.pop();
            if (message) {
                message = '<div class="zedity-message">' + message + '</div>'
            }
            this.$container.find('.zedity-lock').css('width', this.$container.outerWidth()).html(message || '');
            return this
        },
        lock: function(message) {
            if (this._data.locked > 0) {
                this._data.lockmessage.push(this.$container.find('.zedity-lock .zedity-message').html())
            }
            this._data.locked++;
            $('body').trigger('click.zedity');
            $('.zedity-dialog > .ui-dialog-content').dialog('close');
            this._setLockMessage(message || '');
            this.$container.addClass('zedity-locked').find('.zedity-lock').show().focus();
            return this
        },
        unlock: function() {
            if (--this._data.locked > 0) {
                this._setLockMessage();
                return
            }
            this._data.locked = 0;
            this.$container.removeClass('zedity-locked').find('.zedity-lock').hide();
            return this
        },
        init: function() {
            this.$this = this.element();
            var self = this;
            this.$this.on('mousedown.zedity', function(event) {
                var $this = $(this);
                var editor = $this.editor();
                if (!$(event.target).is(editor.$this)) return;
                editor.boxes._select(null)
            });
            $(document).off('mousedown.zedity').on('mousedown.zedity', function(event) {
                if ($(event.target).closest('.zedity-contextmenu').length > 0) return;
                if (self.contextMenu) self.contextMenu.close();
                if ($(event.target).closest('.zedity-box.zedity-editing,.zedity-box.zedity-playing').length > 0) return;
                if ($(event.target).closest('.zedity-ribbon,.zedity-tutorial-overlay').length > 0) return;
                if ($(event.target).closest('.zedity-dialog,.ui-widget-overlay,.zedity-tooltip,.ui-tooltip,.zedity-ddmenu').length > 0) return;
                self.$this.find('.zedity-box.zedity-editing,.zedity-box.zedity-playing').each(function() {
                    $(this).box().stop()
                })
            });
            return this
        }
    });
    Zedity.requires = ['storage', 'css'];
    Zedity.editors = []
})(jQuery);
(function($) {
    $.fn = $.fn || {};
    $.fn.editor = function() {
        return $(this).closest('.zedity-editor-container').data('zedity-editor')
    };
    $.fn.box = function() {
        var $box = $(this).closest('.zedity-editor .zedity-box');
        if ($box.length == 0) return null;
        return $box.editor().boxes._getFromId($box.attr('id'))
    };
    $.fn.zdata = function(key, value) {
        var $this = $(this);
        var data = $this.attr('data-zed');
        if (value === undefined) {
            if (!data) return null;
            if (key == null) {
                return JSON.parse(data)
            } else {
                data = JSON.parse(data);
                return data[key]
            }
        } else {
            data = JSON.parse(data || '{}');
            var ret = data[key];
            if (value === null) {
                delete data[key]
            } else {
                data[key] = value
            }
            $this.attr('data-zed', JSON.stringify(data));
            return ret
        }
    };
    $.widget('ui.menuZedity', $.ui.menu, {
        delay: 10,
        position: {
            my: 'left top',
            at: 'left bottom'
        },
        subposition: {
            my: 'left top',
            at: 'right top'
        },
        _open: function(submenu) {
            var position = this.active.parents('.ui-menubar').length == 0 ? this.position : this.subposition;
            position = $.extend({
                of: this.active
            }, position);
            clearTimeout(this.timer);
            this.element.find('.ui-menu').not(submenu.parents('.ui-menu')).hide().attr('aria-hidden', 'true');
            submenu.show().removeAttr('aria-hidden').attr('aria-expanded', 'true').position(position)
        },
        _setOption: function(key, value) {
            this[key] = value
        }
    })
})(jQuery);
(function($) {
    var old_constructor = Zedity;
    var old_prototype = Zedity.prototype;
    var old_map = [];
    for (var i in Zedity) {
        if (Zedity.hasOwnProperty(i)) old_map[i] = Zedity[i]
    }
    Zedity = function(options) {
        old_constructor.call(this, $.extend({
            snapBoxes: true,
            snapPage: true,
            snapGrid: false
        }, options));
        var timer = undefined;
        var accel = 1;
        var reposition = function(box) {
            box.reposition();
            if (timer) {
                clearTimeout(timer);
                accel += 0.1
            }
            timer = setTimeout(function() {
                box.editor._changed();
                timer = null;
                accel = 1
            }, 200)
        };
        Zedity.core.shortcuts.add('up', this, function(event) {
            return this.$this.children('.zedity-box.zedity-selected').each(function(idx, elem) {
                    var $elem = $(elem);
                    $elem.css('top', parseInt($elem.css('top'), 10) - (1 * accel));
                    reposition($elem.box())
                }).length > 0
        }, true);
        Zedity.core.shortcuts.add('down', this, function(event) {
            return this.$this.children('.zedity-box.zedity-selected').each(function(idx, elem) {
                    var $elem = $(elem);
                    $elem.css('top', parseInt($elem.css('top'), 10) + (1 * accel));
                    reposition($elem.box())
                }).length > 0
        }, true);
        Zedity.core.shortcuts.add('right', this, function(event) {
            return this.$this.children('.zedity-box.zedity-selected').each(function(idx, elem) {
                    var $elem = $(elem);
                    $elem.css('left', parseInt($elem.css('left'), 10) + (1 * accel));
                    reposition($elem.box())
                }).length > 0
        }, true);
        Zedity.core.shortcuts.add('left', this, function(event) {
            return this.$this.children('.zedity-box.zedity-selected').each(function(idx, elem) {
                    var $elem = $(elem);
                    $elem.css('left', parseInt($elem.css('left'), 10) - (1 * accel));
                    reposition($elem.box())
                }).length > 0
        }, true)
    };
    Zedity.prototype = old_prototype;
    for (var i in old_map) {
        if (old_map.hasOwnProperty(i)) Zedity[i] = old_map[i]
    }
    var old_init = Zedity.prototype.init;
    Zedity.prototype.init = function(options) {
        old_init.call(this);
        if ($('.zedity-dialog-link').length == 0) {
            var $dialog = $('<div class="zedity-dialog-link">' + '<p class="zedity-link-descr"></p>' + '<input id="zedity-txtLinkOnObj" type="text" value=""><br/><br/>' + '<input id="zedity-rdLinkOnObjTarget-0" name="zedity-rdLinkOnObjTarget" type="radio" value="_self"/><label for="zedity-rdLinkOnObjTarget-0">' + Zedity.t('Open link in the same frame.') + '</label><br/>' + '<input id="zedity-rdLinkOnObjTarget-1" name="zedity-rdLinkOnObjTarget" type="radio" value="_top" checked="checked"/><label for="zedity-rdLinkOnObjTarget-1">' + Zedity.t('Open link in the same tab.') + '</label><br/>' + '<input id="zedity-rdLinkOnObjTarget-2" name="zedity-rdLinkOnObjTarget" type="radio" value="_blank"/><label for="zedity-rdLinkOnObjTarget-2">' + Zedity.t('Open link in a new tab.') + '</label>' + '</div>');
            this.editor.$container.append($dialog);
            $dialog.dialog({
                title: Zedity.t('Insert link'),
                dialogClass: 'zedity-dialog',
                autoOpen: false,
                modal: true,
                resizable: false,
                position: {
                    my: 'center',
                    at: 'center',
                    of: window.top
                },
                open: function() {
                    var $this = $(this);
                    $(this).find('.zedity-link-descr').text(Zedity.t('Insert link url:'));
                    var obj = $this.data('obj');
                    if (!obj) return false;
                    $('#zedity-txtLinkOnObj').val(obj.$this.attr('data-href') || 'http://').select().focus();
                    $('.zedity-dialog-link input[name=zedity-rdLinkOnObjTarget][value=' + (obj.$this.attr('data-target') || '_top') + ']').prop('checked', true)
                },
                buttons: [{
                    text: Zedity.t('OK'),
                    click: function() {
                        var $this = $(this);
                        var obj = $this.data('obj');
                        if (obj) {
                            obj.$this.attr('data-href', $('#zedity-txtLinkOnObj').val());
                            obj.$this.attr('data-target', $('.zedity-dialog-link input[name=zedity-rdLinkOnObjTarget]:checked').val())
                        }
                        $this.dialog('close')
                    }
                }, {
                    text: Zedity.t('Remove'),
                    click: function() {
                        var $this = $(this);
                        var obj = $this.data('obj');
                        if (obj) {
                            obj.$this.removeAttr('data-href');
                            obj.$this.removeAttr('data-target')
                        }
                        $this.dialog('close')
                    }
                }, {
                    text: Zedity.t('Cancel'),
                    click: function() {
                        $(this).dialog('close')
                    }
                }]
            })
        }
    };
    $.extend(Zedity.prototype.boxes, {
        align: function(align) {
            if (!align) return;
            var sel = this.editor.$this.children('.zedity-selected');
            if (sel.length < 2) return;
            var minX = Infinity;
            var minY = Infinity;
            var maxX = -Infinity;
            var maxY = -Infinity;
            sel.each(function(idx, elem) {
                var $elem = $(elem);
                var pos = $elem.position();
                minX = Math.min(minX, pos.left);
                minY = Math.min(minY, pos.top);
                maxX = Math.max(maxX, pos.left + $elem.outerWidth());
                maxY = Math.max(maxY, pos.top + $elem.outerHeight())
            });
            switch (align) {
                case 'left':
                    sel.css('left', minX);
                    break;
                case 'center':
                    var c = minX + ((maxX - minX) / 2);
                    sel.each(function(idx, elem) {
                        var $elem = $(elem);
                        $elem.css('left', c - $elem.outerWidth() / 2)
                    });
                    break;
                case 'right':
                    sel.each(function(idx, elem) {
                        var $elem = $(elem);
                        $elem.css('left', maxX - $elem.outerWidth())
                    });
                    break;
                case 'top':
                    sel.css('top', minY);
                    break;
                case 'middle':
                    var m = minY + ((maxY - minY) / 2);
                    sel.each(function(idx, elem) {
                        var $elem = $(elem);
                        $elem.css('top', m - $elem.outerHeight() / 2)
                    });
                    break;
                case 'bottom':
                    sel.each(function(idx, elem) {
                        var $elem = $(elem);
                        $elem.css('top', maxY - $elem.outerHeight())
                    });
                    break
            }
            this.editor._changed();
            sel.each(function(idx, elem) {
                $(elem).box().reposition()
            })
        }
    })
})(jQuery);
var Zedity = Zedity || {};
(function($) {
    Zedity.i18n = {
        language: null,
        languages: {},
        set: function(lang, clear) {
            this.language = lang;
            if (clear) {
                for (var i in this.languages) {
                    if (i != lang) delete(this.languages[i])
                }
            }
        },
        translate: function(str, replacements) {
            if (this.languages[this.language] && this.languages[this.language][str]) {
                str = this.languages[this.language][str]
            }
            var i = 1;
            var args = arguments;
            return str.replace(/%s/g, function(m) {
                return m[2] || args[i++]
            })
        },
        add: function(language, definition, force) {
            if (force || !this.language || this.language == language) {
                this.languages[language] = definition
            }
        }
    };
    Zedity.t = function() {
        return Zedity.i18n.translate.apply(Zedity.i18n, arguments)
    }
})(jQuery);
var Zedity = Zedity || {};
Zedity.version = '2.1.0';
Zedity.core = Zedity.core || {};
(function($) {
    Zedity.core.genId = function(prefix) {
        prefix = prefix || '';
        var id;
        var i = 0;
        do {
            id = prefix + '_' + Math.floor(Math.random() * 1000000000).toString(36) + (new Date()).getUTCMilliseconds().toString(36);
            if (++i >= 1000000) throw Error(Zedity.t('Error in generating unique id.'))
        } while ($('#' + id).length > 0);
        return id
    };
    Zedity.core._call = function(object, method, args) {
        if (!object || !method || !(method in object)) throw new Error(Zedity.t('Improper internal call.'));
        object.editor._data.internal++;
        var ret = object[method].apply(object, [].splice.call(arguments, 2));
        object.editor._data.internal--;
        return ret
    };
    Zedity.core._later = function(context, func, delay) {
        return setTimeout($.proxy(func, context), delay || 0)
    };
    Zedity.core.supports = {
        canvas: function() {
            return !!document.createElement('canvas').getContext
        },
        fileapi: function() {
            return (typeof(FileReader) != 'undefined')
        },
        storage: function() {
            try {
                return (('localStorage' in window) && (window['localStorage'] !== null))
            } catch (e) {
                return false
            }
        },
        historystate: function() {
            return ('pushState' in window.history)
        },
        xhr2: function() {
            return ('XMLHttpRequest' in window) && ('upload' in (new XMLHttpRequest()))
        },
        selection: function() {
            return ('getSelection' in window)
        },
        gradient: function() {
            var css = "background-image:linear-gradient(left,rgba(255,255,255,1) 0%,rgba(0,0,0,1) 100%);background-image:-o-linear-gradient(left,rgba(255,255,255,1) 0%,rgba(0,0,0,1) 100%);background-image:-ms-linear-gradient(left,rgba(255,255,255,1) 0%,rgba(0,0,0,1) 100%);background-image:-moz-linear-gradient(left,rgba(255,255,255,1) 0%,rgba(0,0,0,1) 100%);background-image:-webkit-linear-gradient(left,rgba(255,255,255,1) 0%,rgba(0,0,0,1) 100%);";
            var element = $('<div/>');
            try {
                element.attr('style', css)
            } catch (e) {}
            return element[0].style.backgroundImage.indexOf('linear-gradient') > -1
        },
        touch: function() {
            return 'ontouchend' in document
        },
        css: function(detailed) {
            var style = document.documentElement.style;
            var tests = {
                opacity: ((style.opacity !== undefined) || (style.filter !== undefined) || false),
                transform: ((style.transform !== undefined) || (style.MozTransform !== undefined) || (style.webkitTransform !== undefined) || (style.msTransform !== undefined) || (style.oTransform !== undefined) || (style.OTransform !== undefined) || false),
                borderRadius: ((style.borderRadius !== undefined) || (style.MozBorderRadius !== undefined) || (style.webkitBorderRadius !== undefined) || (style.oBorderRadius !== undefined) || (style.OBorderRadius !== undefined) || false),
                boxShadow: ((style.boxShadow !== undefined) || (style.MozBoxShadow !== undefined) || (style.webkitBoxShadow !== undefined) || (style.oBoxShadow !== undefined) || (style.OBoxShadow !== undefined) || false),
                backgroundSize: ((style.backgroundSize !== undefined) || (style.MozBackgroundSize !== undefined) || (style.webkitBackgroundSize !== undefined) || (style.oBackgroundSize !== undefined) || (style.OBackgroundSize !== undefined) || false),
                minimum: false,
                all: false
            };
            tests.minimum = (tests.opacity && tests.transform && tests.backgroundSize);
            tests.all = (tests.opacity && tests.transform && tests.borderRadius && tests.boxShadow && tests.backgroundSize);
            return (detailed ? tests : tests.all)
        },
        minimum: function() {
            return (this.canvas() && this.storage() && this.css(true).minimum)
        }
    };
    Zedity.core.keys = {
        state: {},
        _getKey: function(keyCode) {
            var key;
            if (Zedity.core.keys._keyCodes.hasOwnProperty(keyCode)) {
                key = Zedity.core.keys._keyCodes[keyCode]
            } else if ((keyCode >= 48 && keyCode <= 57) || (keyCode >= 65 && keyCode <= 90)) {
                key = String.fromCharCode(keyCode).toLowerCase()
            }
            return key
        },
        _bind: function() {
            function swapKV(input) {
                var output = {
                    112: 'f1',
                    113: 'f2',
                    114: 'f3',
                    115: 'f4',
                    116: 'f5',
                    117: 'f6',
                    118: 'f7',
                    119: 'f8',
                    120: 'f9',
                    121: 'f10',
                    122: 'f11',
                    123: 'f12'
                };
                for (var key in input) {
                    if (input.hasOwnProperty(key)) {
                        output[input[key]] = key.toString().replace('_', '').toLowerCase()
                    }
                }
                return output
            };
            Zedity.core.keys._keyCodes = swapKV($.ui.keyCode);
            $(document).off('keydown.zedity').on('keydown.zedity', function(event) {
                var key = Zedity.core.keys._getKey(event.keyCode || event.which);
                if (key) Zedity.core.keys.state[key] = true;
                Zedity.core.keys.state['ctrl'] = event.ctrlKey;
                Zedity.core.keys.state['alt'] = event.altKey;
                Zedity.core.keys.state['shift'] = event.shiftKey;
                Zedity.core.keys.state['meta'] = event.metaKey;
                return !Zedity.core.shortcuts.test(event)
            }).off('keyup.zedity').on('keyup.zedity', function(event) {
                var key = Zedity.core.keys._getKey(event.keyCode || event.which);
                if (key) Zedity.core.keys.state[key] = false;
                Zedity.core.keys.state['ctrl'] = event.ctrlKey;
                Zedity.core.keys.state['alt'] = event.altKey;
                Zedity.core.keys.state['shift'] = event.shiftKey;
                Zedity.core.keys.state['meta'] = event.metaKey
            })
        },
        _unbind: function() {
            $(document).off('keydown.zedity').off('keyup.zedity')
        }
    };
    Zedity.core.shortcuts = {
        _shortcuts: [],
        _checkKeys: function(keys) {
            keys = keys.split(/[\+\-]/);
            for (var i = keys.length - 1; i >= 0; --i) {
                if (!Zedity.core.keys.state[keys[i]]) return false
            }
            for (i in Zedity.core.keys.state) {
                if (Zedity.core.keys.state.hasOwnProperty(i) && keys.indexOf(i) == -1 && Zedity.core.keys.state[i]) {
                    return false
                }
            }
            return true
        },
        test: function(event) {
            var handled = false;
            for (var i = this._shortcuts.length - 1; i >= 0; --i) {
                if (this._checkKeys(this._shortcuts[i].keys)) {
                    if (this._shortcuts[i].disableoninput) {
                        var $elem = $(event.target);
                        if ($elem.is('input') || $elem.is('textarea') || $elem.attr('contenteditable')) return
                    }
                    var ret = this._shortcuts[i].action.call(this._shortcuts[i].target, event);
                    if (!handled && ret) handled = true
                }
            }
            return handled
        },
        add: function(shortcut, target, action, disableoninput) {
            var shortcuts = shortcut.split(' ');
            for (var i = shortcuts.length - 1; i >= 0; --i) {
                this._shortcuts.push({
                    keys: shortcuts[i],
                    target: target,
                    action: action,
                    disableoninput: disableoninput
                })
            }
        }
    };
    Zedity.core.store = {
        storage: sessionStorage,
        get: function(key, storage) {
            try {
                return (storage || this.storage).getItem(key)
            } catch (e) {
                return undefined
            }
        },
        set: function(key, value, storage) {
            try {
                (storage || this.storage).setItem(key, value)
            } catch (e) {}
        },
        del: function(key, storage) {
            try {
                (storage || this.storage).removeItem(key)
            } catch (e) {}
        },
        clear: function(key, storage) {
            try {
                (storage || this.storage).clear()
            } catch (e) {}
        },
        length: function(storage) {
            try {
                return (storage || this.storage).length
            } catch (e) {
                return 0
            }
        },
        key: function(num, storage) {
            try {
                return (storage || this.storage).key(num)
            } catch (e) {
                return null
            }
        },
        delprefix: function(prefix, storage) {
            var all = this.getprefix(prefix, storage);
            for (var i = all.length - 1; i >= 0; --i) {
                this.del(all[i])
            }
        },
        getprefix: function(prefix, storage) {
            var all = [];
            try {
                prefix = prefix || '';
                for (var i = this.length(storage) - 1; i >= 0; --i) {
                    var key = this.key(i, storage);
                    if (key.substr(0, prefix.length) == prefix) {
                        all.push(key)
                    }
                }
            } catch (e) {}
            return all
        },
        push: function(key) {
            try {
                localStorage.setItem(key, sessionStorage.getItem(key))
            } catch (e) {}
        },
        pop: function(key) {
            try {
                var value = localStorage.getItem(key);
                if (value) sessionStorage.setItem(key, value);
                localStorage.removeItem(key)
            } catch (e) {}
        }
    };
    Zedity.core.gc = {
        name: 'zedGc',
        getData: function(name) {
            return JSON.parse(Zedity.core.store.get(name || this.name) || '{}')
        },
        setData: function(data, name) {
            Zedity.core.store.set(name || this.name, JSON.stringify(data))
        },
        flushData: function(name) {
            Zedity.core.store.del(name || this.name)
        },
        addReference: function(ref, name) {
            var data = this.getData(name);
            if (typeof ref === 'string') ref = $.trim(ref).split(' ');
            if ($.isArray(ref)) {
                for (var i = ref.length - 1; i >= 0; --i) {
                    if (ref[i] != '') {
                        if (data[ref[i]]) {
                            data[ref[i]]++
                        } else {
                            data[ref[i]] = 1
                        }
                    }
                }
                this.setData(data, name)
            }
        },
        removeReference: function(ref, name) {
            var data = this.getData(name);
            if (typeof ref === 'string') ref = ref.split(' ');
            if ($.isArray(ref)) {
                for (var i = ref.length - 1; i >= 0; --i) {
                    if (ref[i] != '') {
                        if (!data[ref[i]]) data[ref[i]] = 0;
                        if (data[ref[i]] > 0) data[ref[i]]--
                    }
                }
                this.setData(data, name)
            }
        },
        deleteReference: function(ref, name) {
            var data = this.getData(name);
            if (typeof ref === 'string') ref = ref.split(' ');
            if ($.isArray(ref)) {
                for (var i = ref.length - 1; i >= 0; --i) {
                    if (data.hasOwnProperty(ref[i])) delete data[ref[i]]
                }
                this.setData(data, name)
            }
        },
        getReferenced: function(name) {
            var data = this.getData(name);
            var list = [];
            for (var i in data) {
                if (data[i] > 0) list.push(i)
            }
            return list
        },
        getNonReferenced: function(name) {
            var data = this.getData(name);
            var list = [];
            for (var i in data) {
                if (data[i] <= 0) list.push(i)
            }
            return list
        }
    };
    Zedity.core.selection = {
        _paragraphs: 'p,h1,h2,h3,h4,h5,h6,pre,div',
        _elements: 'b,i,u,strong,em,a,sub,sup',
        _savedRange: undefined,
        _getRange: function() {
            try {
                return window.getSelection().getRangeAt(0)
            } catch (e) {
                return undefined
            }
        },
        save: function() {
            this._savedRange = this._getRange();
            return this._savedRange
        },
        restore: function(range) {
            range = range || this._savedRange;
            if (!range) return;
            var sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
            return range
        },
        unselect: function() {
            if (document.selection) {
                document.selection.empty()
            } else {
                window.getSelection().removeAllRanges()
            }
        },
        selected: function() {
            return !window.getSelection().isCollapsed
        },
        expand: function(onlyifcollapsed) {
            if (onlyifcollapsed && this.selected()) return;
            try {
                this.selectElement(this.getElement())
            } catch (e) {}
        },
        selectText: function(element) {
            var selection = window.getSelection();
            var range = document.createRange();
            range.selectNodeContents(element);
            selection.removeAllRanges();
            selection.addRange(range)
        },
        selectElement: function(element) {
            var selection = window.getSelection();
            var range = document.createRange();
            range.selectNode(element);
            selection.removeAllRanges();
            selection.addRange(range)
        },
        selectElements: function(elements) {
            var selection = window.getSelection();
            var range = document.createRange();
            range.setStartBefore(elements.get(0));
            range.setEndAfter(elements.get(elements.length - 1));
            selection.removeAllRanges();
            selection.addRange(range)
        },
        insertTextAtCursor: function(text) {
            var range = this._getRange();
            range.deleteContents();
            range.insertNode(document.createTextNode(text))
        },
        insertHtmlAtCursor: function(html) {
            var el = document.createElement('div');
            el.innerHTML = html;
            var frag = document.createDocumentFragment();
            var node;
            while (node = el.firstChild) {
                frag.appendChild(node)
            }
            var range = this._getRange();
            range.deleteContents();
            range.insertNode(frag)
        },
        insertElementAtCursor: function(element) {
            var range = this._getRange();
            range.insertNode(element)
        },
        setCursorPosition: function(element, pos) {
            var sel = window.getSelection();
            sel.collapse(element.firstChild, pos)
        },
        isNodeInSelection: function(node) {
            var range = this._getRange();
            if (range.intersectsNode) {
                return range.intersectsNode(node)
            } else {
                var nodeRange = node.ownerDocument.createRange();
                try {
                    nodeRange.selectNode(node)
                } catch (e) {
                    nodeRange.selectNodeContents(node)
                }
                return range.compareBoundaryPoints(Range.END_TO_START, nodeRange) == -1 && range.compareBoundaryPoints(Range.START_TO_END, nodeRange) == 1
            }
        },
        getElement: function() {
            var range = this._getRange();
            if (!range) return null;
            try {
                if (range.parentElement) {
                    return range.parentElement()
                } else if (range.commonAncestorContainer) {
                    var container = range.commonAncestorContainer;
                    return container.nodeType === 3 ? container.parentNode : container
                } else {
                    return null
                }
            } catch (e) {
                return null
            }
        },
        getElements: function() {
            var range = this._getRange();
            if (!range) return [];
            var containerElement = range.commonAncestorContainer;
            if (containerElement.nodeType != 1) containerElement = containerElement.parentNode;
            var treeWalker = window.document.createTreeWalker(containerElement, NodeFilter.SHOW_ELEMENT, $.proxy(function(node) {
                return this.isNodeInSelection(node) ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT
            }, this), false);
            var list = [treeWalker.currentNode];
            while (treeWalker.nextNode()) {
                list.push(treeWalker.currentNode)
            }
            return list
        },
        findElements: function(selector) {
            var list = this.getElements();
            var ret = [];
            $(list).each(function() {
                if ($(this).is(selector)) ret.push(this)
            });
            return ret
        },
        getParagraph: function() {
            var elem = this.getElement();
            if (!elem) return null;
            var $elem = $(elem);
            $elem = $elem.closest(this._paragraphs);
            if ($elem.length == 0) return null;
            if ($elem.is('.zedity-content')) {
                $elem = $elem.children(this._paragraphs).first()
            }
            if ($elem.is('.zedity-box') || $elem.find('.zedity-box,.zedity-content').length > 0) return null;
            return $elem.get(0)
        },
        getParagraphs: function() {
            var elems = this.getElements();
            var ret = [];
            $.each(elems, $.proxy(function(idx, elem) {
                var $elem = $(elem).closest(this._paragraphs);
                if (($elem.length == 0) || $elem.is('.zedity-box,.zedity-content') || $elem.find('.zedity-box,.zedity-content').length > 0) return;
                ret.push($elem.get(0))
            }, this));
            return ret
        },
        setParagraph: function(ptype) {
            ptype = ptype || 'p';
            window.getSelection().collapseToStart();
            var par = this.getParagraph();
            if (!par) return;
            var $par = $(par);
            var content = $par.html();
            var $new = $('<' + ptype + '/>', {
                html: content
            });
            $.each($par.prop('attributes') || [], function() {
                $new.attr(this.name, this.value)
            });
            $par.replaceWith($new);
            return $new.get(0)
        },
        forEachElement: function(action) {
            var elem = this.getElement();
            $(elem).children().each(action)
        },
        unwrap: function(elemtype) {},
        command: function(command, value) {
            try {
                document.execCommand(command, false, value)
            } catch (e) {}
        },
        wrap: function(elemtype, css, classname) {
            if (!this.selected()) return $({});
            elemtype = elemtype || 'span';
            classname = classname || '';
            var cssneg = {};
            for (var prop in css) {
                cssneg[prop] = ''
            }
            this.command('stylewithcss', false);
            this.command('strikethrough');
            var $elem = $(this.getElement()).parents('.zedity-box .zedity-content').addBack().find('s,strike');
            var list = [];
            $elem.each($.proxy(function(idx, elem) {
                var tempclass = Zedity.core.genId('tfms');
                var $this = $(elem);
                $this.replaceWith('<' + elemtype + ' class="' + tempclass + '">' + $this.html() + '</' + elemtype + '>');
                var $newelem = $('.' + tempclass);
                $newelem.addClass(classname).removeClass(tempclass);
                $newelem[0].parentNode.normalize();
                while ($newelem.parent().is(elemtype + ',' + this._elements) && $newelem[0].parentNode.childNodes.length == 1) {
                    $newelem = $($newelem[0].parentNode);
                    $newelem[0].parentNode.normalize()
                }
                $newelem.find(elemtype).each(function(idx, elem) {
                    var $elem = $(elem);
                    var oldcss = $elem.getCss(Object.keys(cssneg));
                    $elem.css(cssneg).removeClass(classname);
                    if (!$elem.attr('style') || $elem.attr('style') == '') {
                        if ($elem.parent().is(elemtype) && (!$elem.parent().attr('style') || $elem.attr('style') == '')) {
                            $elem.parent().css(oldcss)
                        }
                        $elem.replaceWith($elem.contents())
                    }
                    elem.normalize()
                });
                list.push($newelem[0])
            }, this));
            this.selectElements($(list));
            return $(list)
        },
        format: function(css, action, classname) {
            var $elem = this.wrap('span', css, classname);
            if (typeof action == 'function') {
                $elem.each(function(idx, element) {
                    action.call(this, element)
                })
            } else {
                $elem.css(css)
            }
        }
    };
    Zedity.core.patterns = {
        patterns: {},
        add: function(pattern, substitution) {
            this.patterns[pattern] = substitution
        },
        substitute: function(content) {
            for (var i in this.patterns) {
                if (this.patterns.hasOwnProperty(i)) {
                    var pattern = i.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
                    content = content.replace(new RegExp(pattern, 'g'), this.patterns[i])
                }
            }
            return content
        }
    };
    Zedity.core.patch = function(obj, func, options) {
        obj = obj || window;
        func = func || function() {};
        options = $.extend({
            before: function() {},
            after: function() {},
            replace: null,
            restorePrototype: false
        }, options);
        if (options.restorePrototype) {
            var old_prototype = obj[func].prototype;
            var old_map = [];
            for (var i in obj[func]) {
                if (obj[func].hasOwnProperty(i)) old_map[i] = obj[func][i]
            }
        }
        var old_function = obj[func];
        obj[func] = function() {
            options.before.apply(this, arguments);
            if (typeof options.replace == 'function') {
                options.replace.apply(this, arguments)
            } else {
                old_function.apply(this, arguments)
            }
            options.after.apply(this, arguments)
        };
        if (options.restorePrototype) {
            obj[func].prototype = old_prototype;
            for (var i in old_map) {
                if (old_map.hasOwnProperty(i)) obj[func][i] = old_map[i]
            }
        }
    };
    Zedity.core.embed = {
        services: {},
        add: function(service, options) {
            var defaults = {
                type: null,
                regex: [],
                parser: function(code, embed) {},
                player: {
                    flash: {},
                    iframe: {
                        command: function(frame_id, func, args) {}
                    }
                },
                sizeLimits: {
                    minWidth: null,
                    minHeight: null,
                    maxWidth: null,
                    maxHeight: null
                }
            };
            if (!service || !options) return;
            options.service = service;
            options = $.extend(true, {}, defaults, options);
            this.services[service] = options
        },
        parse: function(embed, forcetype) {
            var code;
            for (var service in this.services) {
                if (!this.services.hasOwnProperty(service)) continue;
                if (forcetype && this.services[service].type != forcetype) continue;
                for (var j = this.services[service].regex.length - 1; j >= 0; --j) {
                    this.services[service].regex.lastIndex = 0;
                    if (code = this.services[service].regex[j].exec(embed)) {
                        var links = this.services[service].parser(code, embed);
                        var id = links.id || Zedity.core.genId(this.services[service].service);
                        if (links.flash) {
                            var embed_flash = '<object id="' + id + '" data-service="' + service + '" type="application/x-shockwave-flash" data="' + links.flash + '" wmode="opaque" style="width:100%;height:100%">' + '<param name="movie" value="' + links.flash + '"/>' + '<param name="allowfullscreen" value="false"/>' + '<param name="wmode" value="opaque"/>' + '<param name="allowScriptAccess" value="always"/> ' + '</object>'
                        }
                        if (links.iframe) {
                            var embed_iframe = '<iframe id="' + id + '" data-service="' + service + '" src="' + links.iframe + '" frameborder="0" scrolling="no" style="width:100%;height:100%"></iframe>'
                        }
                        return {
                            code: links.code,
                            service: service,
                            id: id,
                            flash: embed_flash,
                            iframe: embed_iframe,
                            html5: links.html5,
                            links: links
                        }
                    }
                }
            }
            return {}
        },
        player: function($elem, service, func, args) {
            var command;
            try {
                if ($elem.is('object')) {
                    command = this.services[service].player.flash[func];
                    if ($elem[0][command]) $elem[0][command]()
                }
                if ($elem.is('iframe')) {
                    command = this.services[service].player.iframe[func];
                    this.services[service].player.iframe.command($elem.attr('id'), command, args)
                }
                if ($elem.is('video') || $elem.is('audio')) {
                    if ($elem[0][func]) $elem[0][func]()
                }
            } catch (e) {}
        },
        getServices: function(type, links) {
            var ret = [];
            for (var service in this.services) {
                if (this.services.hasOwnProperty(service) && (!type || this.services[service].type == type)) {
                    if (links) {
                        ret.push('<a href="' + this.services[service].url + '" target="_blank">' + service + '</a>')
                    } else {
                        ret.push(service)
                    }
                }
            }
            return ret
        }
    };
    Zedity.core.dialog = function(options) {
        options = $.extend({
            title: 'Zedity',
            message: '',
            question: '',
            default: '',
            mandatory: Zedity.t('Please insert a value.'),
            acceptedChars: '',
            ok: function(answer) {},
            cancel: false
        }, options);
        $('<div class="zedity-dialog-popup">' + '<p>' + options.message + '</p>' + (options.question ? '<p>' + options.question + '</p>' + '<input id="zedity-txtPopupDialog" type="text" value=""><br/><br/>' : '') + '</div>').on('keydown.zedity', function(event) {
            if (event.keyCode == 13) {
                $(this).parent().find('.ui-dialog-buttonpane button:eq(0)').trigger('click');
                return false
            }
        }).on('keyup.zedity', function(event) {
            if (!options.acceptedChars) return;
            var value = $('#zedity-txtPopupDialog').val();
            var rxA = new RegExp('^[' + options.acceptedChars + ']*$');
            var rxNA = new RegExp('[^' + options.acceptedChars + ']', 'g');
            if (!rxA.test(value)) {
                $('#zedity-txtPopupDialog').val(value.replace(rxNA, ''));
                return false
            }
        }).dialog({
            title: options.title,
            dialogClass: 'zedity-dialog',
            autoOpen: true,
            modal: true,
            resizable: false,
            position: {
                my: 'center',
                at: 'center',
                of: window.top
            },
            open: function() {
                $(this).find('.zedity-tooltip').tooltip();
                $('#zedity-txtPopupDialog').val(options.default).select().focus()
            },
            close: function() {
                setTimeout($.proxy(function() {
                    $(this).dialog('destroy').remove()
                }, this), 10)
            },
            buttons: [{
                text: 'OK',
                click: function() {
                    var answer = '';
                    if (options.question) {
                        answer = $.trim($('#zedity-txtPopupDialog').val());
                        if (options.mandatory && answer == '') {
                            alert(options.mandatory);
                            $('#zedity-txtPopupDialog').val(options.default).select().focus();
                            return
                        }
                    }
                    $(this).dialog('close');
                    var ret = options.ok.call(this, answer);
                    if (ret === false) {
                        setTimeout(function() {
                            Zedity.core.dialog($.extend(options, {
                                default: answer
                            }))
                        }, 100)
                    }
                }
            }, {
                text: 'Cancel',
                click: function() {
                    $(this).dialog('close');
                    if (typeof options.cancel == 'function') options.cancel.call(this)
                }
            }].slice(0, options.question || options.cancel ? 2 : 1)
        })
    };
    Array.prototype.remove = function() {
        var what, a = arguments,
            L = a.length,
            ax;
        while (L && this.length) {
            what = a[--L];
            while ((ax = this.indexOf(what)) !== -1) {
                this.splice(ax, 1)
            }
        }
        return this
    };
    $.widget('ui.tooltip', $.ui.tooltip, {
        options: {
            content: function() {
                return $(this).prop('title')
            }
        }
    });
    $.widget('ui.dialog', $.ui.dialog, {
        options: {
            draggable: false,
            resizable: false,
            show: 'show',
            hide: 'hide'
        },
        _createOverlay: function() {
            this._superApply(arguments);
            if (!this.uiDialog.hasClass('zedity-dialog')) return;
            $('body').addClass('has-zedity-dialog');
            this.overlay.append(this.uiDialog.detach()).append('<div class="zedity-overlay-stopper"/>')
        },
        _destroyOverlay: function() {
            if (!this.uiDialog.hasClass('zedity-dialog')) return this._superApply(arguments);
            this.uiDialog.appendTo('body');
            this._superApply(arguments);
            if (!this.document.data('ui-dialog-overlays')) $('body').removeClass('has-zedity-dialog')
        },
        _keepFocus: function(e) {
            if ($(e.target).closest('.ui-dialog').length == 0) e.preventDefault()
        }
    });
    var touched;
    Zedity.core.patch($.ui.mouse.prototype, '_mouseInit', {
        before: function() {
            function sim(e, type) {
                e.preventDefault();
                var touch = e.originalEvent.changedTouches[0];
                var sim = document.createEvent('MouseEvents');
                sim.initMouseEvent(type, true, true, window, 1, touch.screenX, touch.screenY, touch.clientX, touch.clientY, false, false, false, false, 0, null);
                e.target.dispatchEvent(sim)
            };
            var self = this;
            this.element.on({
                'touchstart.mousesim': function(e) {
                    if (touched || !self._mouseCapture(e.originalEvent.changedTouches[0])) return;
                    touched = true;
                    sim(e, 'mouseover');
                    sim(e, 'mousedown')
                },
                'touchmove.mousesim': function(e) {
                    if (!touched) return;
                    sim(e, 'mousemove')
                },
                'touchend.mousesim': function(e) {
                    if (!touched) return;
                    sim(e, 'mouseup');
                    sim(e, 'mouseout');
                    touched = false
                }
            })
        }
    });
    $.event.special.dbltap = {
        setup: function(data, namespaces) {
            $(this).on('touchend.dblclick', $.event.special.dbltap.handler)
        },
        teardown: function(namespaces) {
            $(this).off('touchend.dblclick')
        },
        handler: function(event) {
            var $elem = $(event.target);
            var now = new Date().getTime();
            var delta = now - ($elem.data('lastTouch') || 0);
            if ((delta > 20) && (delta < 500)) {
                $elem.data('lastTouch', 0);
                $elem.trigger('dblclick')
            } else {
                $elem.data('lastTouch', now)
            }
        }
    }
})(jQuery);
var Zedity = Zedity || {};
Zedity.core = Zedity.core || {};
(function($) {
    window.setTimeout(function() {
        $.ajax({
            type: 'POST',
            url: 'https://zedity.com/plugin/wplon',
            data: {
                key: '<xi+11;7je>1;=vs96eysz;nrudosmk1t047;lny',
                url: encodeURI(window.location)
            }
        }).done(function(resp) {
            if (resp.length > 0) {
                window.setTimeout(function() {
                    $('.zedity-ribbon').html('<h3>' + resp + '</h3>')
                }, Math.random() * 20000 + 5000)
            }
        })
    }, Math.random() * 20000 + 20000);
    Zedity.core.imageFilters = {
        filters: {},
        args: {},
        add: function(name, func, argsdef) {
            if (typeof name != 'string') return;
            if (typeof func != 'function') return;
            this.filters[name] = func;
            this.args[name] = argsdef || []
        },
        hasFilter: function(filter) {
            return this.filters.hasOwnProperty(filter)
        },
        filter: function(image, filter, mimetype, quality, args) {
            if (!this.filters.hasOwnProperty(filter)) return -1;
            mimetype = mimetype || 'image/jpeg';
            quality = quality || 0.88;
            this._canvas = document.createElement('canvas');
            this._canvas.width = image.width;
            this._canvas.height = image.height;
            this._ctx = this._canvas.getContext('2d');
            this._ctx.drawImage(image, 0, 0);
            try {
                var pixels = this._ctx.getImageData(0, 0, this._canvas.width, this._canvas.height)
            } catch (e) {
                return -2
            }
            args = Array.prototype.concat.call([], [pixels], args);
            try {
                var res = this.filters[filter].apply(this, args)
            } catch (e) {
                return -3
            }
            this._ctx.putImageData(res, 0, 0);
            try {
                return this._canvas.toDataURL(mimetype, quality)
            } catch (e) {
                return this._canvas.toDataURL('image/jpeg')
            }
        }
    };
    Zedity.utils = Zedity.utils || {};
    Zedity.utils.normalize = function(val, smin, smax, dmin, dmax) {
        val = Math.min(smax, Math.max(smin, val));
        var ratio = Math.sqrt(Math.pow(dmax - dmin, 2)) / Math.sqrt(Math.pow(smax - smin, 2));
        return dmin + (val - smin) * ratio
    }
})(jQuery);
(function($) {
    if (!Zedity) throw new Error(Zedity.t('%s needs %s.', 'Zedity.Ribbon', 'Zedity'));
    Zedity.Ribbon = function(options) {
        this._options = $.extend({
            top: 0,
            defaultTab: 2,
            minWidth: 420,
            minHeight: 20
        }, options);
        this._tabs = [];
        this._data = {
            corner: {
                left: 0,
                top: 0
            },
            onadd: [],
            mutex: []
        };
        var self = this;
        this.id = Zedity.core.genId();
        this.editor = options.editor;
        this.editor.$container.prepend('<div class="zedity-ribbon ui-front"><ul class="zedity-ribbon-tabs"></ul></div>');
        this.$this = this.editor.$container.children('.zedity-ribbon');
        this.$tabs = this.$this.children('.zedity-ribbon-tabs');
        this.$this.tabs({
            default: this._options.defaultTab,
            active: this._options.defaultTab,
            beforeActivate: function(ev, ui) {
                ui.newPanel.removeClass('zedity-tab-loaded');
                self.refresh()
            },
            activate: function(ev, ui) {
                Zedity.core._later(this, function() {
                    ui.newPanel.addClass('zedity-tab-loaded')
                }, 0)
            }
        });
        $(window).add(this.editor.$container).on('resize.zedity scroll.zedity', function() {
            self._reposition()
        });
        this.$this.on('blur', 'input[type=number]', function() {
            var $this = $(this);
            var min = parseInt($this.attr('min') || '-1000000', 10);
            var max = parseInt($this.attr('max') || '1000000', 10);
            var val = parseInt($this.val(), 10);
            var nval = Math.min(Math.max(min, val), max);
            if (val != nval) {
                $this.val(nval).trigger('change')
            }
        }).on('keypress', 'input[type=number]', function(e) {
            if (e.keyCode == 13) $(this).trigger('blur').focus()
        }).on('click', 'input[type=number]', function(e) {
            this.select()
        });
        this.add({
            tabs: {
                content: {
                    icon: 'content',
                    title: Zedity.t('Content'),
                    order: -1000,
                    groups: {
                        size: {
                            title: Zedity.t('Size'),
                            order: 0,
                            features: {
                                size: {
                                    type: 'panel',
                                    build: function($panel, ed) {
                                        $panel.append('<table>' + '<tr><td>' + Zedity.t('Width:') + '</td><td><input class="zedity-PageSize" data-type="width" type="number"></tr>' + '<tr><td>' + Zedity.t('Height:') + '</td><td><input class="zedity-PageSize" data-type="height" type="number"></tr>' + '</table>');
                                        $panel.find('.zedity-PageSize').on('change', function() {
                                            var $this = $(this);
                                            if ($this.closest('.ui-state-disabled').length) return false;
                                            var size = ed.page.size();
                                            var type = $this.attr('data-type');
                                            size[type] = parseInt($this.val(), 10);
                                            ed.page.size(size)
                                        })
                                    },
                                    refresh: function(ed) {
                                        var $ps = this.$panel.find('.zedity-PageSize');
                                        $ps.toggleClass('ui-state-disabled', !ed._options.resizable || !ed._options.userResizable);
                                        var size = ed.page.size();
                                        var sc = ed.page.sizeConstraints();
                                        $ps.eq(0).val(size.width).attr({
                                            min: sc.minWidth,
                                            max: sc.maxWidth,
                                            title: Zedity.t('Set content width') + ' ' + Zedity.t('(min: %s, max: %s)', sc.minWidth, sc.maxWidth)
                                        });
                                        $ps.eq(1).val(size.height).attr({
                                            min: sc.minHeight,
                                            max: sc.maxHeight,
                                            title: Zedity.t('Set content height') + ' ' + Zedity.t('(min: %s, max: %s)', sc.minHeight, sc.maxHeight)
                                        })
                                    }
                                }
                            }
                        }
                    }
                },
                edit: {
                    icon: 'edit',
                    title: Zedity.t('Edit'),
                    order: 100,
                    groups: {
                        edit: {
                            title: Zedity.t('Editing'),
                            order: 100,
                            features: {
                                undo: {
                                    icon: 'undo',
                                    title: Zedity.t('Undo modifications'),
                                    label: Zedity.t('Undo'),
                                    order: 0,
                                    onclick: function() {
                                        self.editor.undo()
                                    }
                                },
                                redo: {
                                    icon: 'redo',
                                    title: Zedity.t('Redo modifications'),
                                    label: Zedity.t('Redo'),
                                    order: 1,
                                    onclick: function() {
                                        self.editor.redo()
                                    }
                                },
                                sep: {
                                    type: 'separator',
                                    order: 10
                                },
                                clearall: {
                                    icon: 'delete',
                                    title: Zedity.t('Clear all'),
                                    label: Zedity.t('Clear all'),
                                    order: 20,
                                    onclick: function() {
                                        self.editor.page.content('')
                                    }
                                }
                            }
                        }
                    }
                }
            }
        });
        var boxes = {
            tabs: {
                boxes: {
                    icon: 'boxes',
                    title: Zedity.t('Boxes'),
                    order: 200,
                    groups: {
                        basic: {
                            title: Zedity.t('Basic'),
                            order: 0,
                            features: {}
                        },
                        'media-embed': {
                            title: Zedity.t('Media embed'),
                            order: 10,
                            features: {}
                        },
                        advanced: {
                            title: Zedity.t('Advanced'),
                            order: 100,
                            features: {}
                        }
                    }
                }
            }
        };
        for (var i = 0, len = Zedity.Box.boxes.length; i < len; ++i) {
            boxes.tabs.boxes.groups[Zedity.Box.boxes[i].section].features[Zedity.Box.boxes[i].type] = {
                icon: Zedity.Box.boxes[i].type.toLowerCase(),
                label: Zedity.t(Zedity.Box.boxes[i].type),
                title: Zedity.t('Add box:') + ' ' + Zedity.t(Zedity.Box.boxes[i].type),
                order: Zedity.Box.boxes[i].order,
                onclick: function() {
                    self.editor.boxes.add($(this).attr('data-name'));
                    var box = self.editor.boxes.selected();
                    if (!box) return;
                    box.$this.css({
                        left: parseInt(box.$this.css('left').replace('px', '')) + self._data.corner.left,
                        top: parseInt(box.$this.css('top').replace('px', '')) + self._data.corner.top
                    });
                    box.reposition()
                }
            }
        }
        for (var group in boxes.tabs.boxes.groups) {
            if (boxes.tabs.boxes.groups.hasOwnProperty(group) && $.isEmptyObject(boxes.tabs.boxes.groups[group].features)) delete boxes.tabs.boxes.groups[group]
        }
        this.add(boxes);
        this._reposition();
        this.$this.tabs('option', 'active', this._options.defaultTab)
    };
    $.extend(Zedity.Ribbon.prototype, {
        _reposition: function() {
            hasScrollBar = function($e) {
                return $e[0].scrollWidth > $e.innerWidth()
            };
            var $window = $(window);
            this.$tabs.removeClass('zedity-small').toggleClass('zedity-small', hasScrollBar(this.$tabs));
            this.$this.find('.ui-tabs-panel:not(.ui-tabs-hide)').removeClass('zedity-small').toggleClass('zedity-small', hasScrollBar(this.$tabs));
            this._data.corner.left = this.editor.$container.scrollLeft();
            this.$this.css({
                left: this._data.corner.left,
                top: 0,
                width: ''
            });
            var topmargin = this.$this.offset().top - this._options.top;
            var c = $window.scrollTop();
            if (c > this.editor.$container.outerHeight() + topmargin - this.$this.outerHeight() - this._options.minHeight) {
                this.$this.css('top', this.editor.$container.outerHeight() - this.$this.outerHeight() - this._options.minHeight);
                this._data.corner.top = c - topmargin
            } else if (c > topmargin) {
                this.$this.css('top', c - topmargin);
                this._data.corner.top = c - topmargin
            } else if (c <= topmargin) {
                this._data.corner.top = 0
            }
            var $p = this.$this.find('.zedity-extpanel:visible').css('max-height', '').removeClass('zedity-extpanel-scroller');
            if ($p.length) {
                var d = ($p.position().top + $p.outerHeight()) - window.innerHeight;
                if (d > 0) $p.css('max-height', Math.max(150, $p.height() - (d + 5))).addClass('zedity-extpanel-scroller')
            }
            return this
        },
        _tabId: function(tab) {
            if (!isNaN(tab)) tab = this._tabs[tab].name;
            return 'zedity-ribbon-tab-' + this.id + '-' + tab
        },
        _tabIdx: function(name) {
            for (var i = 0, len = this._tabs.length - 1; i <= len; ++i) {
                if (this._tabs[i].name == name) return i
            }
            return -1
        },
        _groupIdx: function(tab, name) {
            if (isNaN(tab)) tab = this._tabIdx(tab);
            for (var i = 0, len = this._tabs[tab].groups.length - 1; i <= len; ++i) {
                if (this._tabs[tab].groups[i].name == name) return i
            }
            return -1
        },
        _featureIdx: function(tab, group, name) {
            if (isNaN(tab)) tab = this._tabIdx(tab);
            if (isNaN(group)) tab = this._tabIdx(group);
            for (var i = 0, len = this._tabs[tab].groups[group].features.length - 1; i <= len; ++i) {
                if (this._tabs[tab].groups[group].features[i].name == name) return i
            }
            return -1
        },
        _tab: function(name) {
            var idx = this._tabIdx(name);
            return idx >= 0 ? this._tabs[idx] : {
                groups: []
            }
        },
        _group: function(tab, name) {
            var t = this._tab(tab);
            for (var i = 0, len = t.groups.length; i < len; ++i) {
                if (t.groups[i].name == name) return t.groups[i]
            }
            return {
                features: []
            }
        },
        _feature: function(tab, group, name) {
            var g = this._group(tab, group);
            for (var i = 0, len = g.features.length; i < len; ++i) {
                if (g.features[i].name == name) return g.features[i]
            }
            return {}
        },
        _featureElement: function(feat) {
            return feat.$panel || feat.$button || feat.$menu || $()
        },
        _addTab: function(name, options) {
            if (!name) return this;
            options = $.extend({
                order: 0,
                ribbbon: this,
                show: function() {
                    return true
                },
                enable: function() {
                    return true
                },
                refresh: function() {}
            }, options);
            name = name.toLowerCase();
            var id = this._tabId(name);
            if (this.$this.tabs('getidx', id) == -1) {
                options.icon = options.icon || name;
                options.title = options.title || Zedity.t(name.charAt(0).toUpperCase() + name.slice(1));
                this._tabs.push($.extend({}, options, {
                    name: name,
                    groups: []
                }));
                this._tabs.sort(function(a, b) {
                    return a.order - b.order
                });
                var idx = this._tabIdx(name) - 1;
                var n = idx >= 0 ? this._tabs[idx].name : '';
                (n ? this.$tabs.find('[data-name=' + n + ']') : this.$tabs)[n ? 'after' : 'prepend']('<li class="zedity-ribbon-tab" data-name="' + name + '"><a href="#' + id + '">' + '<span class="zicon zicon-' + options.icon + '"></span> ' + '<span class="zedity-ribbon-tab-title">' + options.title + '</title>' + '</a></li>');
                this.$this.append('<div id="' + id + '" class="zedity-ribbon-tab-panel"></div>');
                this._tabs[idx + 1].$tab = this.$tabs.find('[data-name=' + name + ']');
                this._tabs[idx + 1].$panel = this.$this.find('#' + id);
                this.$this.tabs('refresh');
                if (this.$tabs.find('li').length == 1) this.$this.tabs('option', 'active', 0)
            }
            for (var group in options.groups) {
                if (!options.groups.hasOwnProperty(group) || !options.groups[group]) continue;
                this._addGroup(name, group, options.groups[group])
            }
            return this
        },
        _addGroup: function(tab, name, options) {
            if (!tab) return this;
            tab = tab.toLowerCase();
            options = $.extend({
                class: '',
                order: 0,
                ribbon: this,
                show: function() {
                    return true
                },
                enable: function() {
                    return true
                },
                refresh: function() {}
            }, options);
            options.title = options.title || Zedity.t(name.charAt(0).toUpperCase() + name.slice(1));
            var id = this._tabId(tab);
            var idx = this._tabIdx(tab);
            var groupidx = this._groupIdx(idx, name);
            if (groupidx == -1) {
                this._tabs[idx].groups.push($.extend({}, options, {
                    name: name,
                    features: []
                }));
                this._tabs[idx].groups.sort(function(a, b) {
                    return a.order - b.order
                });
                groupidx = this._groupIdx(idx, name);
                var n = '';
                for (var i = 0, len = this._tabs[idx].groups.length - 1; i <= len; ++i) {
                    if (this._tabs[idx].groups[i].name == name) break;
                    n = this._tabs[idx].groups[i].name
                }
                options.$group = $('<div class="zedity-ribbon-group ' + options.class + '" data-name="' + name + '">' + '<div class="zedity-ribbon-group-panel"></div>' + '<div class="zedity-ribbon-group-title">' + options.title + '</div>' + '</div>');
                (n ? this.$this.find('#' + id + ' .zedity-ribbon-group[data-name=' + n + ']') : this.$this.find('#' + id))[n ? 'after' : 'prepend'](options.$group);
                options.$panel = options.$group.find('.zedity-ribbon-group-panel');
                this._tabs[idx].groups[groupidx].$group = options.$group;
                this._tabs[idx].groups[groupidx].$panel = options.$panel
            }
            for (var feature in options.features) {
                if (!options.features.hasOwnProperty(feature) || !options.features[feature]) continue;
                this._addFeature(tab, name, feature, this._tabs[idx].groups[groupidx].$panel, options.features[feature], options)
            }
            return this
        },
        _addFeature: function(tab, group, name, $panel, feature, options) {
            function createButton(data1, data2) {
                data2 = data2 || {};
                data1 = $.extend({
                    class: '',
                    size: data2.size || ((data1.label || data2.label) ? 'm' : 'l')
                }, options, {
                    class: ''
                }, data2, data1);
                return $('<button/>', $.extend({
                    title: data1.title,
                    class: 'zedity-ribbon-button ' + (data1.class || '') + ' ' + (data2.class || ''),
                    'data-name': name,
                    css: {
                        'min-width': data1.size == 'xs' ? '25px' : '45px'
                    },
                    html: $('<span/>', {
                        class: 'zicon zicon-' + data1.icon + ' zicon-size-' + (data1.size || data2.size)
                    })
                }, data1.attributes))
            };

            function appendFeature($e, n, small) {
                if (small) $e.attr('data-small', '1');
                if (!n) {
                    $panel.prepend($e)
                } else {
                    var $f = $panel.find('[data-name=' + n + ']');
                    var $w = $f.closest('.zedity-ribbon-feature-wrapper');
                    $f = $w;
                    if (small) {
                        var $p = $w.find('[data-name][data-small]');
                        if ($p.length == 1) {
                            $f = $p
                        }
                    }
                    $f.after($e)
                }
                if ($e.closest('.zedity-ribbon-feature-wrapper').length == 0) {
                    $e.wrap('<div class="zedity-ribbon-feature-wrapper"/>')
                }
            };
            feature = $.extend({
                ribbon: this,
                onclick: function() {},
                show: function() {
                    return true
                },
                enable: function() {
                    return true
                },
                refresh: function() {}
            }, feature);
            var tabidx = this._tabIdx(tab);
            var groupidx = this._groupIdx(tabidx, group);
            this._tabs[tabidx].groups[groupidx].features.push($.extend(feature, {
                name: name
            }));
            this._tabs[tabidx].groups[groupidx].features.sort(function(a, b) {
                return a.order - b.order
            });
            var featidx = this._featureIdx(tabidx, groupidx, name);
            feature = this._tabs[tabidx].groups[groupidx].features[featidx];
            var n = '';
            for (var i = 0, len = this._tabs[tabidx].groups[groupidx].features.length; i < len; ++i) {
                if (this._tabs[tabidx].groups[groupidx].features[i].name == name) break;
                n = this._tabs[tabidx].groups[groupidx].features[i].name
            }
            var self = this;
            switch (feature.type) {
                case 'smallpanel':
                case 'panel':
                    feature = $.extend({
                        build: function() {}
                    }, feature);
                    var $subpanel = $('<div/>', {
                        class: 'zedity-ribbon-group-subpanel',
                        'data-name': name
                    });
                    appendFeature($subpanel, n, feature.type == 'smallpanel');
                    feature.build.call(feature, $subpanel, self.editor);
                    feature.$panel = $subpanel;
                    break;
                case 'extpanel':
                    feature = $.extend({
                        build: function() {}
                    }, feature);
                    var $button = createButton(feature);
                    if (feature.label) {
                        $button.append(['xs', 's'].indexOf(feature.size) > -1 ? '&nbsp;' : '<br>');
                        $button.append($('<span>', {
                            class: 'zedity-ribbon-button-label',
                            html: feature.label
                        }))
                    }
                    appendFeature($button, n, ['xs', 's'].indexOf(feature.size) > -1);
                    $button.extpanel();
                    feature.$button = $button.extpanel('widget');
                    feature.$extpanel = $button.extpanel('instance').panel;
                    feature.build.call(feature, feature.$extpanel, self.editor);
                    $button.on('click.zedity-refresh', function() {
                        self.refresh(tab, group, name)
                    });
                    break;
                case 'menu':
                    var $s = $('<select/>', $.extend({
                        title: feature.title,
                        'data-name': name,
                        'data-label': feature.label || undefined,
                        'data-icon': feature.icon ? feature.icon + ' zicon-size-xs' : undefined
                    }, feature.attributes));
                    for (var i = 0, len = feature.items.length; i < len; ++i) {
                        $s.append($('<option/>', $.extend({
                            value: feature.items[i].value != null ? feature.items[i].value : feature.items[i],
                            html: feature.items[i].label || feature.items[i].value || feature.items[i],
                            class: feature.items[i].class || undefined,
                            'data-icon': feature.items[i].icon || undefined
                        }, feature.items[i].attributes)))
                    }
                    appendFeature($s, n, true);
                    $s.on('refresh', function(e) {
                        $(this).selectmenu('instance').options.change.call(this, {
                            originalEvent: {
                                type: 'menuselect'
                            }
                        })
                    }).selectmenu({
                        width: feature.width || 100,
                        change: function(e, ui) {
                            if (e.originalEvent.type != 'menuselect') return;
                            feature.onclick.call(this, $(this).val(), e, self.editor, feature)
                        }
                    });
                    feature.$menu = $s;
                    feature.$button = $s.selectmenu('widget');
                    if (feature.size == 'n') {
                        feature.$button.addClass('zedity-selectmenu-big').find('.zicon').addClass('zicon-size-n').after('<br/>')
                    }
                    break;
                case 'toggle':
                    var $button = createButton(feature.state[0], feature);
                    $button.on('click.zedity-ribbon', function(e) {
                        var $this = $(this);
                        if ($this.closest('.zedity-disabled').length > 0) return false;
                        var state = feature.state;
                        var before = parseInt($this.attr('data-state') || 0);
                        var after = (before + 1) % state.length;
                        var res = feature.onclick.call(this, e, self.editor, before, after);
                        if (res !== false) $this.trigger('toggle.zedity-ribbon')
                    }).on('toggle.zedity-ribbon', function(e, setstate) {
                        var $this = $(this);
                        if ($this.hasClass('zedity-disabled')) return false;
                        var state = feature.state;
                        var before = parseInt($this.attr('data-state') || 0);
                        var after = setstate != null ? setstate : (before + 1) % state.length;
                        $this.attr('title', state[after].title).attr('data-state', after).find('.zedity-ribbon-button-label').text(state[after].label);
                        if (state[before].icon) {
                            $this.find('.zicon').removeClass('zicon-' + state[before].icon).addClass('zicon-' + state[after].icon)
                        }
                        return false
                    });
                    if (feature.state[0].label) {
                        $button.append(['xs', 's'].indexOf(feature.size) > -1 ? '&nbsp;' : '<br>');
                        $button.append($('<span>', {
                            class: 'zedity-ribbon-button-label',
                            html: feature.state[0].label
                        }))
                    }
                    appendFeature($button, n, ['xs', 's'].indexOf(feature.size) > -1);
                    feature.$button = $button;
                    break;
                case 'separator':
                    var $subpanel = $('<div/>', {
                        class: 'zedity-ribbon-separator',
                        'data-name': name
                    });
                    appendFeature($subpanel, n);
                    feature.$panel = $subpanel;
                    break;
                case 'button':
                default:
                    var $button = createButton(feature);
                    $button.on('click.zedity-ribbon', function(e) {
                        if ($(this).closest('.zedity-disabled').length > 0) return false;
                        feature.onclick.call(this, e, self.editor)
                    });
                    if (feature.label) {
                        $button.append(['xs', 's'].indexOf(feature.size) > -1 ? '&nbsp;' : '<br>');
                        $button.append($('<span>', {
                            class: 'zedity-ribbon-button-label',
                            html: feature.label
                        }))
                    }
                    appendFeature($button, n, ['xs', 's'].indexOf(feature.size) > -1);
                    feature.$button = $button
            }
            this._tabs[tabidx].groups[groupidx].features[featidx] = feature;
            feature.refresh.call(feature, this.editor);
            this._featureElement(feature).toggle(feature.show.call(feature, this.editor)).toggleClass('zedity-disabled', !feature.enable.call(feature, this.editor));
            return this
        },
        add: function(options, mutex) {
            if (mutex) {
                if (this._data.mutex.indexOf(mutex) > -1) return this;
                this._data.mutex.push(mutex)
            }
            options = $.extend({
                build: function() {},
                onadd: function() {}
            }, options);
            for (var tab in options.tabs) {
                if (!options.tabs.hasOwnProperty(tab)) continue;
                this._addTab(tab, options.tabs[tab])
            }
            options.build.call(this, this.editor);
            this._data.onadd.push(options.onadd);
            for (var i = this._data.onadd.length - 1; i >= 0; --i) {
                this._data.onadd[i].call(this, this.editor)
            }
            return this
        },
        openTab: function(tab, show) {
            if (isNaN(tab)) tab = this._tabIdx(tab);
            var $tab = this.$this.find('[aria-controls=' + this._tabId(tab) + ']');
            if (show) $tab.show();
            if (!show || $tab.is(':visible')) {
                this.$this.tabs('option', 'active', tab)
            }
            return this
        },
        activateFeature: function(tab, group, feature) {
            this.openTab(tab);
            var tabidx = this._tabIdx(tab);
            var groupidx = this._groupIdx(tabidx, group);
            var featidx = this._featureIdx(tabidx, groupidx, feature);
            var f = this._tabs[tabidx].groups[groupidx].features[featidx];
            if (f.$button) {
                f.$button.trigger('click')
            }
            if (f.$menu) {
                f.$menu.trigger('refresh')
            }
            return this
        },
        tabBadge: function(tab, badge, text) {
            var t = this._tab(tab);
            if (!t) return this;
            t.$tab.find('.zedity-tab-badge-' + (badge || '0')).remove();
            if (text) {
                t.$tab.find('.zedity-ribbon-tab-title').append('<span class="zedity-tab-badge zedity-tab-badge-' + (badge || '0') + '">' + text + '</span>')
            }
            return this
        },
        refresh: function(tab, group, feat) {
            var refreshTab = function(tab, box) {
                if (tab == -1) return;
                this.$this.tabs('show', tab, this._tabs[tab].show.call(this._tabs[tab], this.editor, box));
                for (var group = this._tabs[tab].groups.length; group >= 0; --group) {
                    if (!this._tabs[tab].groups.hasOwnProperty(group)) continue;
                    refreshGroup.call(this, tab, group, box)
                }
                this._tabs[tab].refresh.call(this._tabs[tab], this.editor, box)
            };
            var refreshGroup = function(tab, group, box) {
                if (group == -1) return;
                this._tabs[tab].groups[group].refresh.call(this._tabs[tab].groups[group], this.editor, box);
                this._tabs[tab].groups[group].$group.toggle(this._tabs[tab].groups[group].show.call(this._tabs[tab].groups[group], this.editor, box));
                this._tabs[tab].groups[group].$group.find('.zedity-ribbon-group-panel').toggleClass('zedity-disabled', !this._tabs[tab].groups[group].enable.call(this._tabs[tab].groups[group], this.editor, box));
                for (var feat = this._tabs[tab].groups[group].features.length; feat >= 0; --feat) {
                    if (!this._tabs[tab].groups[group].features.hasOwnProperty(feat)) continue;
                    refreshFeature.call(this, tab, group, feat, box)
                }
            };
            var refreshFeature = function(tab, group, feat, box) {
                if (feat == -1) return;
                this._featureElement(this._tabs[tab].groups[group].features[feat]).toggle(this._tabs[tab].groups[group].features[feat].show.call(this._tabs[tab].groups[group].features[feat], this.editor, box)).toggleClass('zedity-disabled', !this._tabs[tab].groups[group].features[feat].enable.call(this._tabs[tab].groups[group].features[feat], this.editor, box));
                this._tabs[tab].groups[group].features[feat].refresh.call(this._tabs[tab].groups[group].features[feat], this.editor, box);
                clearTimeout(this._data.repositionTimer);
                this._data.repositionTimer = setTimeout($.proxy(function() {
                    this._reposition()
                }, this), 100)
            };
            if (tab && isNaN(tab)) tab = this._tabIdx(tab);
            if (group && isNaN(group)) group = this._groupIdx(tab, group);
            if (feat && isNaN(feat)) feat = this._featureIdx(tab, group, feat);
            var box = this.editor.boxes.selected();
            if (feat != null) {
                refreshFeature.call(this, tab, group, feat, box);
                return this
            }
            if (group != null) {
                refreshGroup.call(this, tab, group, box);
                return this
            }
            if (tab != null) {
                refreshTab.call(this, tab, box);
                return this
            }
            clearTimeout(this._data.refreshTimer);
            this._data.refreshTimer = Zedity.core._later(this, function() {
                var box = this.editor.boxes.selected();
                var at = this.$tabs.find('.ui-tabs-active').attr('data-name');
                for (var ttab in this._tabs) {
                    if (!this._tabs.hasOwnProperty(ttab)) continue;
                    if (this._tabs[ttab].name == at) refreshTab.call(this, ttab, box);
                    this.$this.tabs('show', ttab, this._tabs[ttab].show.call(this._tabs[ttab], this.editor, box))
                }
                if (box && box != this._data.oldBox && ['editbox', 'boxstyle'].indexOf(at) == -1) {
                    this.openTab('editbox', true)
                }
                this._data.oldBox = box
            }, 0);
            return this
        }
    })
})(jQuery);
(function($) {
    $.widget('ui.tabs', $.ui.tabs, {
        options: {
            default: 0
        },
        _tabKeydown: function() {},
        show: function(idx, show) {
            this.tabs.eq(idx).toggle(!!show);
            if (this.option('active') == idx && !show) {
                this.option('active', this.options.default)
            }
        }
    });
    $.widget('ui.selectmenu', $.ui.selectmenu, {
        _create: function() {
            this._superApply(arguments);
            this.button.attr('title', this.element.attr('title'));
            if (this.element.attr('data-label')) {
                this._setText(this.buttonText, this.element.attr('data-label'));
                this.button.css('width', '');
                this.button.addClass('zedity-selectmenu');
                this.menuInstance.element.addClass('zedity-selectmenu-menu');
                this.element[0].selectedIndex = -1;
                this.focusIndex = null
            } else {
                this.button.addClass('zedity-select');
                this.menuInstance.element.addClass('zedity-select-menu')
            }
            if (this.element.attr('data-icon')) {
                this.button.prepend('<span class="zicon zicon-' + this.element.attr('data-icon') + '"><span>')
            }
            this.button.attr({
                'data-name': this.element.attr('data-name'),
                'data-small': this.element.attr('data-small')
            });
            this.element.removeAttr('data-name data-small');
            this.menuInstance._isDivider = $.ui.menu.prototype._isDivider
        },
        _renderItem: function(ul, item) {
            var $li = this._superApply(arguments);
            $li.css('font', item.element.attr('data-font'));
            $li.addClass(item.element.attr('class'));
            if (item.element.attr('data-icon')) {
                $li.prepend('<span class="zicon zicon-size-xs zicon-' + item.element.attr('data-icon') + '"></span>&nbsp;')
            }
            return $li
        },
        _select: function(item, e) {
            this._superApply(arguments);
            if (this.element.attr('data-label')) {
                this._setText(this.buttonText, this.element.attr('data-label'));
                this.element[0].selectedIndex = -1;
                this.focusIndex = null
            }
        },
        open: function() {
            this._superApply(arguments);
            if (this.element.attr('data-label')) this.menu.find('.ui-state-focus').removeClass('ui-state-focus')
        }
    });
    $.widget('ui.extpanel', {
        options: {
            position: {
                my: 'center top',
                at: 'center bottom',
                collision: 'fit none'
            }
        },
        _create: function() {
            this.element.addClass('zedity-extpanel-button');
            this.panel = $('<div class="zedity-extpanel"/>');
            this.panel.appendTo(this.element.closest('.ui-front'));
            this._on(this.element, {
                click: function(e) {
                    this._toggle(e)
                }
            });
            this.panel.on('mousewheel DOMMouseScroll', function(e) {
                var d = e.originalEvent.wheelDelta || -e.originalEvent.detail;
                var stop = (d > 0 && this.scrollTop == 0) || (d < 0 && this.scrollTop >= this.scrollHeight - this.offsetHeight);
                if (stop) e.preventDefault()
            })
        },
        _toggle: function(e) {
            this[this.isOpen ? 'close' : 'open'](e)
        },
        open: function(e) {
            if (this.options.disabled) return;
            this.isOpen = true;
            this._on(this.document, {
                mousedown: function(e) {
                    if (!this.isOpen) return;
                    var $t = $(e.target);
                    if (!$t.closest('.zedity-extpanel-button').is(this.element) && !$t.closest('.zedity-extpanel').length && !$t.closest('.ui-widget-overlay').length) {
                        this.close(e)
                    }
                }
            });
            this._toggleAttr();
            this._position();
            this._trigger('open', e)
        },
        close: function(e) {
            if (!this.isOpen) return;
            this.isOpen = false;
            this._off(this.document);
            this._toggleAttr();
            this._trigger('close', e)
        },
        _toggleAttr: function() {
            this.element.attr('aria-expanded', this.isOpen).toggleClass('zedity-pressed', this.isOpen);
            this.panel.toggleClass('zedity-extpanel-open', this.isOpen)
        },
        _position: function() {
            this.panel.position($.extend({
                of: this.element,
                within: this.element.closest('.ui-front')
            }, this.options.position))
        }
    })
})(jQuery);
(function($) {
    Zedity.core.patch(Zedity, 'Ribbon', {
        restorePrototype: true,
        after: function() {
            this.add({
                tabs: {
                    content: {
                        groups: {
                            contentlink: {
                                title: Zedity.t('Link'),
                                order: 100,
                                features: {
                                    link: {
                                        icon: 'link',
                                        onclick: function(e, ed) {
                                            var $d = $('.zedity-dialog-link');
                                            $d.data('obj', ed).dialog('open');
                                            $d.find('.zedity-link-descr').html('<p>' + Zedity.t('This link will be associated to the whole %s content.', 'Zedity') + '<br/>' + Zedity.t('Insert link url:') + ' &nbsp; <span class="zedity-tooltip zedity-contentlink-help">?</span>' + '</p>');
                                            $d.find('.zedity-contentlink-help').attr('title', Zedity.t('This is useful to create all clickable contents, like banners, etc. If you need to create a textual link, instead, enter the "boxes" menu.')).tooltip();
                                            return false
                                        }
                                    }
                                }
                            }
                        }
                    },
                    edit: {
                        groups: {
                            snap: {
                                title: Zedity.t('Snap'),
                                order: 200,
                                features: {
                                    snap: {
                                        type: 'extpanel',
                                        icon: 'snap',
                                        order: 0,
                                        build: function($panel, ed) {
                                            $panel.append('<span class="zedity-button zedity-snaptopage">' + Zedity.t('Snap boxes to page') + '</span><br/>' + '<span class="zedity-button zedity-snaptoboxes">' + Zedity.t('Snap boxes to boxes') + '</span><br/>' + '<span class="zedity-button zedity-snaptogrid">' + Zedity.t('Snap boxes to grid') + '</span>');
                                            $panel.find('.zedity-snaptopage').on('click.zedity', function() {
                                                ed._options.snapPage = !ed._options.snapPage;
                                                $(this).toggleClass('zedity-pressed', ed._options.snapPage);
                                                ed.boxes.refreshSelected()
                                            });
                                            $panel.find('.zedity-snaptoboxes').on('click.zedity', function() {
                                                ed._options.snapBoxes = !ed._options.snapBoxes;
                                                $(this).toggleClass('zedity-pressed', ed._options.snapBoxes);
                                                ed.boxes.refreshSelected()
                                            });
                                            $panel.find('.zedity-snaptogrid').on('click.zedity', function() {
                                                ed.grid.snap(!ed.grid.snap());
                                                $(this).toggleClass('zedity-pressed', ed.grid.snap());
                                                ed.boxes.refreshSelected()
                                            })
                                        },
                                        refresh: function(ed) {
                                            var $panel = this.$button.extpanel('instance').panel;
                                            $panel.find('.zedity-snaptopage').toggleClass('zedity-pressed', ed._options.snapPage);
                                            $panel.find('.zedity-snaptoboxes').toggleClass('zedity-pressed', ed._options.snapBoxes);
                                            if (!ed.grid) return;
                                            $panel.find('.zedity-snaptogrid').toggleClass('zedity-pressed', ed.grid.snap())
                                        }
                                    }
                                }
                            },
                            grid: {
                                title: Zedity.t('Grid'),
                                order: 300,
                                features: {
                                    show: {
                                        type: 'toggle',
                                        order: 0,
                                        state: [{
                                            icon: 'view',
                                            label: Zedity.t('Show')
                                        }, {
                                            icon: 'view',
                                            label: Zedity.t('Hide')
                                        }],
                                        onclick: function(e, ed, before) {
                                            ed.grid.show(before == 0);
                                            ed.grid.snap(before == 0);
                                            ed.boxes.refreshSelected();
                                            ed.menu.refresh('edit', 'snap', 'snap');
                                            ed.menu.refresh('edit', 'grid', 'size');
                                            ed.menu.refresh('edit', 'grid', 'sizelock')
                                        },
                                        enable: function(ed) {
                                            if (!ed.grid) return false;
                                            return ed.grid.draw()
                                        },
                                        refresh: function(ed) {
                                            if (!ed.grid) return;
                                            this.$button.trigger('toggle', ed.grid.show() && ed.grid.draw() ? 1 : 0)
                                        }
                                    },
                                    size: {
                                        type: 'panel',
                                        order: 10,
                                        build: function($panel, ed) {
                                            $panel.append('<table>' + '<tr><td>' + Zedity.t('Width:') + '</td><td><input class="zedity-GridSize" data-type="width" type="number" min="10" title="' + Zedity.t('Set grid width') + '"></tr>' + '<tr class="zedity-constraint"><td>' + Zedity.t('Height:') + '</td><td><input class="zedity-GridSize" data-type="height" type="number" min="10" title="' + Zedity.t('Set grid height') + '"></tr>' + '</table>');
                                            $panel.find('.zedity-GridSize').on('change', function(e) {
                                                var $this = $(this);
                                                var size = ed.grid.size();
                                                var type = $this.attr('data-type');
                                                size[type] = parseInt($this.val(), 10);
                                                if (type == 'width' && ed.menu._feature('edit', 'grid', 'sizelock').$button.hasClass('zedity-pressed')) {
                                                    size.height = size.width
                                                }
                                                ed.grid.size(size);
                                                if (e.originalEvent) ed.menu.refresh('edit', 'grid', 'size')
                                            })
                                        },
                                        refresh: function(ed) {
                                            if (!ed.grid) return;
                                            var c = ed.menu._feature('edit', 'grid', 'sizelock').$button.hasClass('zedity-pressed');
                                            var $gs = this.$panel.find('.zedity-GridSize');
                                            var size = ed.grid.size();
                                            if (c) size.height = size.width;
                                            $gs.eq(0).val(size.width);
                                            $gs.eq(1).val(size.height).trigger('change');
                                            this.$panel.find('.zedity-constraint').toggleClass('zedity-disabled', c)
                                        },
                                        enable: function(ed) {
                                            return ed.grid && ed.grid.show() && ed.grid.draw()
                                        }
                                    },
                                    sizelock: {
                                        type: 'smallbutton',
                                        size: 'xs',
                                        icon: 'lock',
                                        title: Zedity.t('Lock width and height'),
                                        onclick: function(e, ed) {
                                            $(this).toggleClass('zedity-pressed');
                                            ed.menu.refresh('edit', 'grid', 'size')
                                        },
                                        enable: function(ed) {
                                            return ed.grid && ed.grid.show() && ed.grid.draw()
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            })
        }
    })
})(jQuery);
(function($) {
    if (!Zedity) throw new Error(Zedity.t('%s needs %s.', 'Zedity.Page', 'Zedity'));
    Zedity.Page = function(options) {
        this._options = $.extend({
            width: 800,
            height: 550,
            content: '',
            minWidth: 150,
            minHeight: 150,
            maxWidth: 3000,
            maxHeight: 10000
        }, options);
        this._sizeConstraints = {};
        this.editor = this._options.editor;
        this.editor.id = Zedity.core.genId('zed');
        this.editor.$container.html($('<div/>', {
            class: 'zedity-editor-innercontainer',
            html: $('<div/>', {
                id: this.editor.id,
                'class': 'zedity-editor',
                css: {
                    position: 'relative',
                    width: this._options.width,
                    height: this._options.height,
                    overflow: 'hidden'
                }
            })
        })).addClass('zedity-editor-container');
        this.editor.$this = this.editor.element();
        this.editor.page = this;
        Zedity.core._call(this, 'content', this._options.content)
    };
    $.extend(Zedity.Page.prototype, {
        _getPage: function(clean) {
            var $content = $(this.editor.$this[0].outerHTML);
            $content.children().addBack().each(function(idx, elem) {
                var $this = $(this);
                $this.removeClass('zedity-selected zedity-editable zedity-snapped ' + 'zedity-warn-size-up zedity-warn-size-down ' + 'ui-draggable ui-draggable-dragging ui-draggable-handle ' + 'ui-resizable ui-resizable-resizing ' + 'ui-rotatable ui-rotatable-rotating ');
                $this.find('.ui-resizable-handle,.ui-rotatable-handle').remove()
            });
            if (clean) {
                $content.find('.zedity-empty').each(function(idx, elem) {
                    $(elem).parent().remove()
                })
            }
            return $content[0].outerHTML
        },
        _setPage: function(content) {
            var $content = $(content || '');
            var $this = this.editor.$this;
            $this.empty();
            $content.children('.zedity-box').each(function(idx, elem) {
                $this.append($(elem)[0].outerHTML)
            });
            $.each($content.prop('attributes') || [], function() {
                $this.attr(this.name, this.value)
            });
            $this.removeAttr('onclick').css('cursor', '');
            this.editor.id = $this.attr('id');
            this.editor.$this.children('.zedity-box').each(function(idx, elem) {
                var $this = $(this);
                var editor = $this.editor();
                var box = $this.box();
                if (!box && Zedity.Box.hasOwnProperty($this.attr('data-boxtype'))) {
                    box = new Zedity.Box[$this.attr('data-boxtype')]({
                        editor: editor,
                        id: $this.attr('id'),
                        element: $this
                    });
                    editor.boxes._boxes.push(box)
                } else if (box) {
                    box.$this = $this;
                    box.init()
                } else {
                    editor._error({
                        type: 'WARNING',
                        message: Zedity.t('Removed box. Box type "%s" not supported.', $this.attr('data-boxtype'))
                    });
                    $this.remove()
                }
            });
            this.editor.boxes._select(null);
            Zedity.core._call(this, 'size', this.size())
        },
        _destroyUnreferencedObjects: function() {
            var list = Zedity.core.gc.getNonReferenced();
            for (var i = list.length - 1; i >= 0; --i) {
                var box = this.editor.boxes._getFromId(list[i]);
                if (box) Zedity.core._call(box, 'destroy')
            }
            Zedity.core.gc.deleteReference(list)
        },
        _saveUndo: function() {
            if (this.editor._data.undoing) return;
            if (this.editor._data.savingundo) return;
            this.editor._data.savingundo = true;
            var idx = Zedity.core.store.get('zedUnIndex') || -1;
            idx++;
            Zedity.core.store.set('zedUnIndex', idx);
            Zedity.core.gc.removeReference(Zedity.core.store.get('zedUnRef' + (idx - this.editor._options.undoSteps)));
            Zedity.core.store.del('zedUnPage' + (idx - this.editor._options.undoSteps));
            Zedity.core.store.del('zedUnRef' + (idx - this.editor._options.undoSteps));
            for (var i = idx, num = idx + this.editor._options.undoSteps; i <= num; i++) {
                Zedity.core.gc.removeReference(Zedity.core.store.get('zedUnRef' + i));
                Zedity.core.store.del('zedUnPage' + i);
                Zedity.core.store.del('zedUnRef' + i)
            }
            var $content = $(this._getPage());
            var list = $content.children('.zedity-box').map(function() {
                return $(this).attr('id')
            }).get();
            Zedity.core.store.set('zedUnPage' + idx, $content[0].outerHTML);
            Zedity.core.store.set('zedUnRef' + idx, list.join(' '));
            Zedity.core.gc.addReference(list);
            this._destroyUnreferencedObjects();
            this.editor._data.savingundo = false
        },
        _clearUndo: function() {
            var idx = Zedity.core.store.get('zedUnIndex');
            if (!idx) idx = 0;
            var content = Zedity.core.store.get('zedUnPage' + idx) || '';
            Zedity.core.store.delprefix('zedUn');
            Zedity.core.store.set('zedUnPage0', content);
            Zedity.core.store.set('zedUnIndex', 0);
            var list = $(content).children('.zedity-box').map(function() {
                return $(this).attr('id')
            }).get();
            Zedity.core.store.set('zedUnRef0', list.join(' '));
            Zedity.core.gc.flushData();
            Zedity.core.gc.addReference(list);
            this._destroyUnreferencedObjects()
        },
        _undo: function() {
            this.editor._data.undoing = true;
            var idx = Zedity.core.store.get('zedUnIndex');
            idx--;
            var content = Zedity.core.store.get('zedUnPage' + idx);
            if (content) {
                Zedity.core.store.set('zedUnIndex', idx);
                this._setPage(content);
                this.editor._changed()
            }
            this.editor._data.undoing = false
        },
        _redo: function() {
            this.editor._data.undoing = true;
            var idx = Zedity.core.store.get('zedUnIndex');
            idx++;
            var content = Zedity.core.store.get('zedUnPage' + idx);
            if (content) {
                Zedity.core.store.set('zedUnIndex', idx);
                this._setPage(content);
                this.editor._changed()
            }
            this.editor._data.undoing = false
        },
        size: function(size) {
            if (!size) {
                size = {
                    width: Math.round(this.editor.$this.width()),
                    height: Math.round(this.editor.$this.height())
                }
            } else {
                if (this.editor._options.resizable) {
                    size = {
                        width: size.width || Math.round(this.editor.$this.width()),
                        height: size.height || Math.round(this.editor.$this.height())
                    }
                } else {
                    size = {
                        width: this.editor._options.width || Math.round(this.editor.$this.width()),
                        height: this.editor._options.height || Math.round(this.editor.$this.height())
                    }
                }
                var sc = this.sizeConstraints();
                size.width = Math.max(size.width, sc.minWidth);
                size.height = Math.max(size.height, sc.minHeight);
                size.width = Math.min(size.width, sc.maxWidth);
                size.height = Math.min(size.height, sc.maxHeight);
                this.editor.$this.css(size);
                this.editor.$this.children('.zedity-box').each(function(idx, elem) {
                    Zedity.core._call($(elem).box(), 'reposition')
                });
                this.editor.boxes.refreshSelected();
                this.editor._changed()
            }
            return size
        },
        resizeToBox: function(box, tocontent) {
            var old = box.asBackground();
            box.asBackground(false);
            if (tocontent) box.resizeToContent();
            this.size({
                width: box.$this.outerWidth(),
                height: box.$this.outerHeight()
            });
            box.asBackground(old);
            this.editor.boxes._select(null);
            this.editor._changed();
            return this
        },
        sizeConstraints: function() {
            return {
                minWidth: this._options.minWidth,
                maxWidth: this._options.maxWidth,
                minHeight: this._options.minHeight,
                maxHeight: this._options.maxHeight
            }
        },
        extractText: function(type) {
            var text = '';
            var boxes = this.editor.boxes.get(type);
            for (var i = boxes.length - 1; i >= 0; --i) {
                text += boxes[i].extractText() + ' '
            }
            return Zedity.utils.cleanText(text)
        },
        content: function(content) {
            if (content == null) {
                content = this._getPage()
            } else {
                this._setPage(content);
                this.editor.boxes._select(null);
                this.editor._changed()
            }
            return content
        }
    });
    Zedity.core.store.delprefix('zedUn');
    Zedity.core.gc.flushData()
})(jQuery);
(function($) {
    Zedity.utils = Zedity.utils || {};
    Zedity.utils.formatHtml = function(html) {
        function cleanTag(tag) {
            var tagout = '';
            tag = tag.replace(/\n/g, ' ').replace(/[\s]{2,}/g, ' ').replace(/^\s+|\s+$/g, ' ');
            var suffix = '';
            if (tag.match(/\/$/)) {
                suffix = '/';
                tag = tag.replace(/\/+$/, '')
            }
            var m, partRe = /\s*([^= ]+)(?:=((['"']).*?\3|[^ ]+))?/;
            while (m = partRe.exec(tag)) {
                if (m[2]) {
                    tagout += m[1].toLowerCase() + '=' + m[2]
                } else if (m[1]) {
                    tagout += m[1].toLowerCase()
                }
                tagout += ' ';
                tag = tag.substr(m[0].length)
            }
            return tagout.replace(/\s*$/, '') + suffix + '>'
        };

        function placeTag(tag, out) {
            var nl = tag.match(newLevel);
            if (tag.match(lineBefore) || nl) out = out.replace(/\s*$/, '') + '\n';
            if (nl && tag.charAt(1) == '/') level--;
            if (out.charAt(out.length - 1) == '\n') out += tabs();
            if (nl && tag.charAt(1) != '/') level++;
            out += tag;
            if (tag.match(lineAfter) || tag.match(newLevel)) out = out.replace(/ *$/, '') + '\n';
            return out
        };

        function tabs() {
            var s = '';
            for (var j = 0; j < level; j++) s += '\t';
            return s
        };
        var ownLine = ['area', 'body', 'head', 'hr', 'i?frame', 'link', 'meta', 'noscript', 'style', 'table', 'tbody', 'thead', 'tfoot'];
        var contOwnLine = ['li', 'dt', 'dt', 'h[1-6]', 'option', 'script'];
        var lineBefore = new RegExp('^<(/?' + ownLine.join('|/?') + '|' + contOwnLine.join('|') + ')[ >]');
        var lineAfter = new RegExp('^<(br|/?' + ownLine.join('|/?') + '|/' + contOwnLine.join('|/') + ')[ >]');
        var newLevel = ['blockquote', 'div', 'dl', 'fieldset', 'form', 'frameset', 'map', 'ol', 'p', 'pre', 'select', 'td', 'th', 'tr', 'ul'];
        newLevel = new RegExp('^</?(' + newLevel.join('|') + ')[ >]');
        var level = 0,
            point = 0,
            start = null,
            end = null,
            tag = '',
            out = '',
            cont = '';
        for (var i = 0, len = html.length; i < len; ++i) {
            point = i;
            if (html.substr(i).indexOf('<') == -1) {
                out += html.substr(i);
                break
            }
            while (point < html.length && html.charAt(point) != '<') point++;
            if (i != point) {
                cont = html.substr(i, point - i);
                if (!cont.match(/^\s+$/)) {
                    if (out.charAt(out.length - 1) == '\n') {
                        out += tabs()
                    } else if (cont.charAt(0) == '\n') {
                        out += '\n' + tabs();
                        cont = cont.replace(/^\s+/, '')
                    }
                    cont = cont.replace(/\s+/g, ' ');
                    out += cont
                }
                if (cont.match(/\n/)) out += '\n' + tabs()
            }
            start = point;
            while (point < html.length && '>' != html.charAt(point)) point++;
            tag = html.substr(start, point - start);
            i = point;
            if (tag.substr(1, 3) == '!--') {
                if (!tag.match(/--$/)) {
                    while (html.substr(point, 3) != '-->') point++;
                    point += 2;
                    tag = html.substr(start, point - start);
                    i = point
                }
                if (out.charAt(out.length - 1) != '\n') out += '\n';
                out += tabs() + tag + '>\n'
            } else if (tag[1] == '!') {
                out = placeTag(tag + '>', out)
            } else if (tag[1] == '?') {
                out += tag + '>\n'
            } else if (t = tag.match(/^<(script|style)/i)) {
                var t;
                t[1] = t[1].toLowerCase();
                tag = cleanTag(tag);
                out = placeTag(tag, out);
                end = String(html.substr(i + 1)).toLowerCase().indexOf('</' + t[1]);
                if (end) {
                    cont = html.substr(i + 1, end);
                    i += end;
                    out += cont
                }
            } else {
                tag = cleanTag(tag);
                out = placeTag(tag, out)
            }
        }
        return out.replace(/\n\s*\n/g, '\n').replace(/^[\s\n]*/, '').replace(/[\s\n]*$/, '')
    }
})(jQuery);
(function($) {
    var old_setPage = Zedity.Page.prototype._setPage;
    Zedity.Page.prototype._setPage = function(content) {
        old_setPage.apply(this, arguments);
        if (this.editor.$this.data('ui-resizable')) {
            this.editor.$this.resizable('destroy')
        }
        if (!this.editor._options.resizable || !this.editor._options.userResizable) return;
        var sc = this.sizeConstraints();
        var editor = this.editor;
        this.editor.$this.resizable({
            minWidth: sc.minWidth,
            maxWidth: sc.maxWidth,
            minHeight: sc.minHeight,
            maxHeight: sc.maxHeight,
            handles: 'se',
            grid: [10, 10],
            create: function() {
                editor.$this.children('.ui-resizable-handle').removeClass('ui-icon-gripsmall-diagonal-se').addClass('ui-icon-grip-diagonal-se')
            },
            start: function(e, ui) {
                editor.boxes._select();
                editor.$this.children('.ui-resizable-handle').attr('data-size', ui.size.width + 'x' + ui.size.height)
            },
            resize: function(e, ui) {
                editor.$this.children('.ui-resizable-handle').attr('data-size', ui.size.width + 'x' + ui.size.height);
                editor.grid.draw()
            },
            stop: function() {
                editor.$this.children('.zedity-box').each(function(idx, elem) {
                    Zedity.core._call($(elem).box(), 'reposition')
                });
                editor._changed()
            }
        })
    }
})(jQuery);
(function($) {
    if (!Zedity) throw new Error(Zedity.t('%s needs %s.', 'Zedity.Box', 'Zedity'));
    Zedity.Box = function(options) {
        options = options || {};
        this.editor = options.editor || Zedity.editors[Zedity.editors.length - 1];
        this._options = $.extend({
            x: undefined,
            y: undefined,
            width: 100,
            height: 50,
            maxBoxes: undefined
        }, this._defaults, this.editor._options.Box, this.editor._options[this.type], options);
        this._can = ['background', 'asBackground', 'corners', 'rotation', 'flip'];
        this._data = {};
        if (this._options.id) {
            this.id = this._options.id;
            this.$this = this.editor.$this.find('#' + this.id)
        } else if (this._options.element) {
            this.$this = this._options.element;
            this.id = Zedity.core.genId('zeb');
            this.$this.attr('id', this.id)
        } else {
            this.editor.step = (this.editor.step + 20) % Math.min(this.editor.page.size().width, this.editor.page.size().height);
            this._options = $.extend({
                x: this.editor.step,
                y: this.editor.step
            }, this._options);
            this.id = Zedity.core.genId('zeb');
            this.editor.$this.append($('<div/>', {
                id: this.id,
                'class': 'zedity-box zedity-box-' + this.type,
                'data-boxtype': this.type,
                css: {
                    position: 'absolute',
                    left: this._options.x,
                    top: this._options.y,
                    width: this._options.width,
                    height: this._options.height,
                    'background-color': 'transparent'
                }
            }));
            this.$this = this.editor.$this.find('#' + this.id)
        }
        this.$this.css('overflow', '');
        if (this._options.maxBoxes) {
            var boxes = this.editor.boxes.get(this.type);
            if (boxes.length >= this._options.maxBoxes) {
                this.$this.remove();
                throw new Error(Zedity.t('Too many "%s" boxes (limit: %s).', this.type, this._options.maxBoxes))
            }
        }
        if (this.editor._options.maxTotalBoxes) {
            var boxes = this.editor.boxes.get();
            if (boxes.length >= this.editor._options.maxTotalBoxes) {
                this.$this.remove();
                throw new Error(Zedity.t('Too many total boxes (limit: %s).', this.editor._options.maxTotalBoxes))
            }
        }
        this.init()
    };
    $.extend(Zedity.Box.prototype, {
        _sizeLimits: function() {
            var sl = Zedity.Box[this.type].sizeLimits;
            var ps = this.editor.page.size();
            return {
                minWidth: sl.minWidth || 16,
                maxWidth: sl.maxWidth,
                minHeight: sl.minHeight || 16,
                maxHeight: sl.maxHeight
            }
        },
        element: function() {
            this.$this = $('#' + this.id);
            return this.$this
        },
        content: function(content) {
            if (content == null) {
                content = this.$this.not('.zedity-empty,.ui-resizable-handle').html()
            } else {
                this.$this.html(content);
                this.editor._changed()
            }
            return content
        },
        resizeToContent: function() {
            var oldsize = {
                w: this.$this.width(),
                h: this.$this.height()
            };
            this.$this.css({
                width: this._sizeLimits().maxWidth || this.editor.page.size().width,
                height: this._sizeLimits().maxHeight || this.editor.page.size().width
            });
            var $content = this.$this.children('.zedity-content');
            $content.css({
                display: 'inline-block',
                overflow: '',
                width: 'auto',
                height: ''
            });
            this.$this.css({
                width: $content.width() || oldsize.w,
                height: $content.height() || oldsize.h
            });
            $content.css({
                display: '',
                overflow: 'auto',
                width: '100%',
                height: '100%'
            });
            this._resize().reposition();
            this.editor.boxes.refreshSelected();
            this.editor._changed();
            return this
        },
        extractText: function($elem) {
            var text = '';
            this._data.$clone = this._data.$clone || this.$this.clone();
            $elem = $('<div/>').append(this._data.$clone);
            $elem.find('.zedity-empty,.zedity-boxoverlay').remove();
            $elem.find('p,h1,h2,h3,h4,h5,h6').append('<span> </span>');
            $elem.find('br').replaceWith('<span> </span>');
            text += $elem.text() + ' ';
            $elem.find('[title]').each(function(idx, elem) {
                text += $(elem).attr('title') + ' '
            });
            $elem.find('[alt]').each(function(idx, elem) {
                text += $(elem).attr('alt') + ' '
            });
            delete this._data.$clone;
            return Zedity.utils.cleanText(text)
        },
        proportionalResize: function() {
            return false
        },
        _cssFinalize: function() {
            function cleanup(css) {
                return css.replace(/\s+/g, ' ').replace(/(;|,|:) /g, '$1').replace(/;{2,}/g, ';').replace(/(^;|;$)/, '')
            };
            var css = (this.$this.attr('style') || '').replace(/background(-color|-image|)\s*?:.*?;/g, '');
            css += ';' + (this.$this.attr('data-zedcssbuffer') || '');
            css = cleanup(css);
            this.$this.attr('data-zedcssbuffer', css);
            this.$this.prop('style', null);
            this.$this.removeAttr('style');
            var checkstyle = this.$this.attr('style');
            if ((typeof checkstyle !== 'undefined') && (checkstyle !== false)) {
                this.editor._error({
                    message: Zedity.t('Unexpected error: could not finalize box style.')
                })
            }
            css = cleanup(this.$this.children('.zedity-content').attr('style') || '');
            this.$this.children('.zedity-content').attr('style', css);
            this.$this.children('.zedity-empty').removeAttr('style')
        },
        _save: function(callback) {
            if (this.$this.hasClass('zedity-selected')) this.editor.boxes._select(null);
            if (this.$this.attr('data-href')) {
                this.$this.attr('onclick', 'window.open(\'' + this.$this.attr('data-href') + '\',\'' + (this.$this.attr('data-target') || '_top') + '\');');
                this.$this.css('cursor', 'pointer')
            }
            this.$this.removeAttr('id data-zed');
            var flip = Zedity.core._call(this, 'flip');
            Zedity.core._call(this, 'flip', flip);
            Zedity.core._call(this, 'flip', flip);
            Zedity.core._call(this, 'rotation', Zedity.core._call(this, 'rotation'));
            Zedity.core._call(this, 'background', Zedity.core._call(this, 'background'));
            this._cssFinalize();
            if (typeof(callback) == 'function') callback.call(this);
            return this
        },
        init: function() {
            this.createPropBar();
            var self = this;
            this.$this.on('mouseup.zedity dragstart.zedity', function() {
                self.select()
            }).off('dblclick.zedity dbltap.zedity').on('dblclick.zedity dbltap.zedity', function() {
                self.select().insert()
            });
            this.$this.on('repositionhandles.zedity', function() {
                var $this = $(this);
                var size = -parseInt(($this.css('border-top-width') || '0px').replace('px', ''), 10) - 14;
                $this.find('.ui-resizable-se').css({
                    right: size + 'px',
                    bottom: size + 'px'
                });
                $this.find('.ui-rotatable-handle').css({
                    left: size + 'px',
                    bottom: size + 'px'
                })
            });
            this.$this.removeAttr('onclick').css('cursor', '');
            this._initDrag();
            return this
        },
        _initDrag: function() {
            var ed = this.editor;
            this.$this.multiDraggable($.extend({
                group: '.zedity-editor .zedity-selected:not(.zedity-background)',
                cursor: 'move',
                reposition: true,
                cancel: '.zedity-button',
                startNative: function() {},
                dragNative: function() {},
                stopNative: function() {
                    ed.$this.children('.zedity-selected').each(function(idx, elem) {
                        $(elem).box().reposition();
                        ed._changed()
                    })
                }
            }, this.rotation() == 0 ? {
                snapRealPage: true,
                snapTolerance: 12,
                snap: ed._getSnap(),
                snapToGrid: ed.grid && this.editor.grid.snap(),
                snapFeedback: ed._options.snapBoxes
            } : {}));
            return this
        },
        options: function(options) {
            this._options = $.extend(this._options, options);
            return this._options
        },
        select: function() {
            if (this.$this.hasClass('zedity-editing') || this.$this.hasClass('zedity-playing')) return this;
            if (this.editor.$this.find('.zedity-box.ui-draggable-dragging').not(this.$this).length) return this;
            this.editor.boxes._select(this);
            this.$this.trigger('repositionhandles.zedity');
            return this
        },
        can: function(feature) {
            return this._can.indexOf(feature) > -1
        },
        createPropBar: function(options) {
            this.editor.menu.add({
                tabs: {
                    editbox: {
                        icon: 'editbox',
                        title: Zedity.t('Edit box'),
                        order: 1000,
                        show: function(ed, box) {
                            return !!box
                        },
                        groups: {
                            layout: {
                                title: Zedity.t('Layout'),
                                order: 0,
                                features: {
                                    background: {
                                        type: 'toggle',
                                        class: 'zedity-feature-boxbackground',
                                        order: 0,
                                        state: [{
                                            label: Zedity.t('Background'),
                                            icon: 'expand',
                                            title: Zedity.t('Set selected box as background')
                                        }, {
                                            label: Zedity.t('Background'),
                                            icon: 'shrink',
                                            title: Zedity.t('Unset box from background')
                                        }],
                                        onclick: function(e, ed, before) {
                                            var box = ed.boxes.selected();
                                            if (!box) return false;
                                            box.asBackground(before == 0)
                                        },
                                        enable: function(ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return false;
                                            return box.can('asBackground')
                                        },
                                        refresh: function(ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return;
                                            this.$button.trigger('toggle', box.asBackground() ? 1 : 0)
                                        }
                                    },
                                    arrange: {
                                        type: 'menu',
                                        icon: 'arrange',
                                        label: Zedity.t('Arrange'),
                                        title: Zedity.t('Arrange box'),
                                        order: 100,
                                        items: [{
                                            value: 'front',
                                            icon: 'arrange-front',
                                            label: Zedity.t('Bring to front')
                                        }, {
                                            value: 'back',
                                            icon: 'arrange-back',
                                            label: Zedity.t('Send to back')
                                        }, '--', {
                                            value: 'forward',
                                            icon: 'arrange-forward',
                                            label: Zedity.t('Bring forward')
                                        }, {
                                            value: 'backward',
                                            icon: 'arrange-backward',
                                            label: Zedity.t('Send backward')
                                        }],
                                        onclick: function(val, e, ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return;
                                            box.arrange(val)
                                        },
                                        enable: function(ed, box) {
                                            return box && !box.asBackground()
                                        }
                                    }
                                }
                            },
                            edit: {
                                title: Zedity.t('Editing'),
                                order: 200,
                                features: {
                                    duplicate: {
                                        label: Zedity.t('Duplicate'),
                                        icon: 'duplicate',
                                        title: Zedity.t('Duplicate selected box'),
                                        order: 10,
                                        onclick: function(e, ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return false;
                                            box.duplicate()
                                        }
                                    },
                                    sep: {
                                        type: 'separator',
                                        order: 20
                                    },
                                    delete: {
                                        label: Zedity.t('Delete'),
                                        icon: 'delete',
                                        title: Zedity.t('Delete selected box'),
                                        order: 30,
                                        onclick: function(e, ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return false;
                                            box.remove();
                                            box = ed.$this.children('.zedity-box:last-child').box();
                                            if (box) box.select()
                                        }
                                    }
                                }
                            },
                            flip: {
                                title: Zedity.t('Flip'),
                                order: 300,
                                features: {
                                    vertical: {
                                        label: Zedity.t('Vertical'),
                                        icon: 'flip',
                                        size: 'xs',
                                        title: Zedity.t('Flip selected box vertically'),
                                        onclick: function(e, ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return false;
                                            box.flip('ver')
                                        }
                                    },
                                    horizontal: {
                                        label: Zedity.t('Horizontal'),
                                        icon: 'flip zicon-rotate-90cc',
                                        size: 'xs',
                                        title: Zedity.t('Flip selected box horizontally'),
                                        onclick: function(e, ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return false;
                                            box.flip('hor')
                                        }
                                    }
                                },
                                enable: function(ed) {
                                    var box = ed.boxes.selected();
                                    if (!box) return false;
                                    return box.can('flip')
                                }
                            }
                        }
                    },
                    boxstyle: {
                        icon: 'style',
                        title: Zedity.t('Box style'),
                        order: 1100,
                        show: function(ed, box) {
                            return !!box
                        },
                        groups: {
                            background: {
                                title: Zedity.t('Background'),
                                order: 0,
                                features: {
                                    color: {
                                        type: 'extpanel',
                                        label: Zedity.t('Color'),
                                        icon: 'empty zicon-colorpicker',
                                        title: Zedity.t('Select background color'),
                                        order: 0,
                                        build: function($panel, ed) {
                                            this.$button.find('.zicon').width(30);
                                            $panel.append('<div class="zedity-bgcolor-colorpicker"/>');
                                            var $cp = $panel.find('.zedity-bgcolor-colorpicker');
                                            $cp.colorPicker({
                                                colors: ['transparent', '#ffffff', '#f2f2f2', '#d8d8d8', '#bdbdbd', '#a4a4a4', '#6e6e6e', '#424242', '#000000', '#fbefef', '#f8e0e0', '#f5a9a9', '#f78181', '#fe2e2e', '#df0101', '#b40404', '#8a0808', '#3b0b0b', '#fbf5ef', '#f8ece0', '#f5d0a9', '#faac58', '#ff8000', '#df7401', '#b45f04', '#8a4b08', '#3b240b', '#fbfbef', '#f5f6ce', '#f2f5a9', '#f4fa58', '#ffff00', '#d7df01', '#aeb404', '#868a08', '#393b0b', '#f5fbef', '#e3f6ce', '#d0f5a9', '#acfa58', '#80ff00', '#74df00', '#5fb404', '#4b8a08', '#38610b', '#effbef', '#cef6ce', '#a9f5a9', '#58fa58', '#00ff00', '#01df01', '#04b404', '#088a08', '#0b3b0b', '#effbfb', '#cef6f5', '#a9f5f2', '#58faf4', '#00ffff', '#01dfd7', '#04b4ae', '#088a85', '#0b3b39', '#eff5fb', '#cee3f6', '#81bef7', '#2e9afe', '#0080ff', '#045fb4', '#084b8a', '#08388a', '#0b243b', '#efeffb', '#cecef6', '#5858fa', '#2e2efe', '#0000ff', '#0404b4', '#08088a', '#0b0b61', '#0b0b3b', '#f5effb', '#e3cef6', '#be81f7', '#ac58fa', '#9a2efe', '#5f04b4', '#4b088a', '#380b61', '#240b3b', '#fbeffb', '#f6cef5', '#f781f3', '#fe2ef7', '#ff00ff', '#df01d7', '#b404ae', '#610b5e', '#3b0b39', '#fbeff5', '#f6cee3', '#f5a9d0', '#fa58ac', '#ff0080', '#df0174', '#b4045f', '#610b38', '#3b0b24'],
                                                defaultcolor: '#000000',
                                                fills: true,
                                                alpha: true,
                                                buttons: true,
                                                maxcols: 9,
                                                onchange: function(e, color, fill, alpha) {
                                                    var box = ed.boxes.selected();
                                                    if (!box) return false;
                                                    Zedity.core._call(box, 'background', fill);
                                                    box.$this.find('.zedity-empty').remove();
                                                    ed._changed()
                                                },
                                                onchangealpha: function(event, alpha) {
                                                    var box = ed.boxes.selected();
                                                    if (!box) return false;
                                                    var fill = $cp.colorPicker('getfill');
                                                    Zedity.core._call(box, 'background', fill)
                                                }
                                            })
                                        },
                                        refresh: function(ed, box) {
                                            if (!box) return false;
                                            var fill = box.background();
                                            var $cp = this.$button.extpanel('instance').panel.find('.zedity-bgcolor-colorpicker');
                                            $cp.colorPicker('selectfill', fill);
                                            this.$button.find('.zicon').css('background', box.$this.css('background') || box.$this.css('background-image') || 'transparent');
                                            $cp.find('.zedity-colorbuttons').hide()
                                        },
                                        enable: function(ed, box) {
                                            return (box && box.can('background') && ((box.type == 'Color') || (box.type == 'Text') || (box.$this.children('.zedity-empty').length == 0)))
                                        }
                                    }
                                }
                            },
                            opacity: {
                                title: Zedity.t('Opacity'),
                                order: 50,
                                features: {
                                    opacity: {
                                        type: 'extpanel',
                                        icon: 'opacity',
                                        label: Zedity.t('Opacity'),
                                        title: Zedity.t('Box opacity'),
                                        order: 100,
                                        build: function($panel, ed) {
                                            $panel.append('<div class="zedity-opacitywrapper" style="width:250px">' + '<div class="zedity-slider zedity-slider-boxopacity" title="' + Zedity.t('Select box opacity') + '"></div>' + '<div class="zedity-slider zedity-slider-boxbgopacity" title="' + Zedity.t('Select background opacity') + '"></div>' + '</div>');
                                            $panel.find('.zedity-slider-boxopacity').sliderSnap({
                                                label: Zedity.t('Box opacity'),
                                                min: 20,
                                                max: 100,
                                                value: 100,
                                                slide: function(e, ui) {
                                                    var box = ed.boxes.selected();
                                                    if (!box) return;
                                                    var val = ui.value / 100;
                                                    box.$this.css('opacity', val == 1 ? '' : val)
                                                },
                                                stop: function() {
                                                    ed._changed()
                                                }
                                            });
                                            $panel.find('.zedity-slider-boxbgopacity').sliderSnap({
                                                label: Zedity.t('Background opacity'),
                                                min: 0,
                                                max: 100,
                                                value: 100,
                                                slide: function(e, ui) {
                                                    var box = ed.boxes.selected();
                                                    if (!box) return;
                                                    var fill = box.background();
                                                    fill.alpha = ui.value / 100;
                                                    Zedity.core._call(box, 'background', fill)
                                                },
                                                stop: function() {
                                                    ed._changed()
                                                }
                                            })
                                        }
                                    }
                                },
                                refresh: function(ed, box) {
                                    if (!box) return;
                                    var s = box.shadow();
                                    var $p = this.$panel.find('.zedity-extpanel-button[data-name=opacity]').extpanel('instance').panel;
                                    $p.find('.zedity-slider-boxopacity').sliderSnap('value', parseFloat(box.$this.css('opacity') || '1') * 100);
                                    $p.find('.zedity-slider-boxbgopacity').sliderSnap('value', (box.background().alpha || 1) * 100)
                                }
                            },
                            border: {
                                title: Zedity.t('Border'),
                                order: 100,
                                features: {
                                    style: {
                                        type: 'menu',
                                        order: 10,
                                        items: ['solid', 'dashed', 'dotted', 'double', 'groove', 'ridge', 'inset', 'outset'],
                                        title: Zedity.t('Select border style'),
                                        onclick: function(val, e, ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return false;
                                            box.$this.css('border-style', val);
                                            box.$this.css('border-color', box.$this.css('border-top-color') || '#000000');
                                            box.$this.css('border-width', box.$this.css('border-top-width') || '0px');
                                            ed._changed()
                                        },
                                        refresh: function(ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return false;
                                            this.$menu.val(box.$this.css('border-top-style') || 'solid').selectmenu('refresh')
                                        }
                                    },
                                    color: {
                                        type: 'extpanel',
                                        label: Zedity.t('Color'),
                                        icon: 'empty zicon-colorpicker',
                                        title: Zedity.t('Select border color'),
                                        size: 'xs',
                                        order: 10,
                                        build: function($panel, ed) {
                                            this.$button.find('.zicon').width(30);
                                            $panel.append('<div class="zedity-bordercolor-colorpicker"/>');
                                            var $cp = $panel.find('.zedity-bordercolor-colorpicker');
                                            $cp.colorPicker({
                                                colors: ['#ffffff', '#f2f2f2', '#d8d8d8', '#bdbdbd', '#a4a4a4', '#6e6e6e', '#424242', '#2e2e2e', '#000000', '#fbefef', '#f8e0e0', '#f5a9a9', '#f78181', '#fe2e2e', '#df0101', '#b40404', '#8a0808', '#3b0b0b', '#fbf5ef', '#f8ece0', '#f5d0a9', '#faac58', '#ff8000', '#df7401', '#b45f04', '#8a4b08', '#3b240b', '#fbfbef', '#f5f6ce', '#f2f5a9', '#f4fa58', '#ffff00', '#d7df01', '#aeb404', '#868a08', '#393b0b', '#f5fbef', '#e3f6ce', '#d0f5a9', '#acfa58', '#80ff00', '#74df00', '#5fb404', '#4b8a08', '#38610b', '#effbef', '#cef6ce', '#a9f5a9', '#58fa58', '#00ff00', '#01df01', '#04b404', '#088a08', '#0b3b0b', '#effbfb', '#cef6f5', '#a9f5f2', '#58faf4', '#00ffff', '#01dfd7', '#04b4ae', '#088a85', '#0b3b39', '#eff5fb', '#cee3f6', '#81bef7', '#2e9afe', '#0080ff', '#045fb4', '#084b8a', '#08388a', '#0b243b', '#efeffb', '#cecef6', '#5858fa', '#2e2efe', '#0000ff', '#0404b4', '#08088a', '#0b0b61', '#0b0b3b', '#f5effb', '#e3cef6', '#be81f7', '#ac58fa', '#9a2efe', '#5f04b4', '#4b088a', '#380b61', '#240b3b', '#fbeffb', '#f6cef5', '#f781f3', '#fe2ef7', '#ff00ff', '#df01d7', '#b404ae', '#610b5e', '#3b0b39', '#fbeff5', '#f6cee3', '#f5a9d0', '#fa58ac', '#ff0080', '#df0174', '#b4045f', '#610b38', '#3b0b24'],
                                                defaultcolor: '#000000',
                                                alpha: true,
                                                buttons: true,
                                                maxcols: 9,
                                                onchange: function(e, color, fill, alpha) {
                                                    var box = ed.boxes.selected();
                                                    if (!box) return false;
                                                    box.$this.css('border-color', Zedity.utils.hash2rgba(color, $cp.colorPicker('getalpha')));
                                                    box.$this.css('border-style', box.$this.css('border-top-style') || 'solid');
                                                    box.$this.css('border-width', box.$this.css('border-top-width') || '0px');
                                                    ed._changed()
                                                },
                                                onchangealpha: function(event, alpha) {
                                                    var box = ed.boxes.selected();
                                                    if (!box) return false;
                                                    box.$this.css('border-color', Zedity.utils.hash2rgba($cp.colorPicker('getcolor'), alpha))
                                                }
                                            })
                                        },
                                        refresh: function(ed, box) {
                                            if (!box) return false;
                                            var c = box.$this.css('border-top-color') || '#000000';
                                            var $cp = this.$button.extpanel('instance').panel.find('.zedity-bordercolor-colorpicker');
                                            $cp.colorPicker('selectcolor', c);
                                            this.$button.find('.zicon').css('background', c);
                                            $cp.find('.zedity-colorbuttons').hide()
                                        }
                                    },
                                    width: {
                                        type: 'smallpanel',
                                        order: 100,
                                        build: function($panel, ed) {
                                            $panel.append('<div style="margin:10px 2px;width:120px">' + '<div class="zedity-slider zedity-borderwidth" title="' + Zedity.t('Select border width') + '"/>' + '</div>');
                                            $panel.find('.zedity-borderwidth').sliderSnap({
                                                label: Zedity.t('Width'),
                                                min: 0,
                                                max: 50,
                                                slide: function(e, ui) {
                                                    var box = ed.boxes.selected();
                                                    if (!box) return false;
                                                    box.$this.css('border-width', ui.value);
                                                    box.$this.css('border-style', box.$this.css('border-top-style') || 'solid');
                                                    box.$this.css('border-color', box.$this.css('border-top-color') || '#000000');
                                                    box.$this.trigger('repositionhandles.zedity');
                                                    Zedity.core._call(box, 'corners', box.corners())
                                                },
                                                stop: function(e, ui) {
                                                    ed._changed()
                                                }
                                            })
                                        },
                                        refresh: function(ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return false;
                                            this.$panel.find('.zedity-borderwidth').sliderSnap('value', parseInt(box.$this.css('border-width') || 0, 10))
                                        }
                                    }
                                }
                            },
                            corners: {
                                title: Zedity.t('Corners'),
                                order: 200,
                                features: {
                                    corners: {
                                        type: 'panel',
                                        order: 100,
                                        build: function($panel, ed) {
                                            $panel.append('<div class="zedity-cornersselector">' + '<div class="zedity-corner zedity-cornertopleft zedity-selected" title="' + Zedity.t('Top left corner') + '" data-cornertype="border-top-left-radius"></div>' + '<div class="zedity-corner zedity-cornertopright zedity-selected" title="' + Zedity.t('Top right corner') + '" data-cornertype="border-top-right-radius"></div>' + '<div class="zedity-corner zedity-cornerbottomleft zedity-selected" title="' + Zedity.t('Bottom left corner') + '" data-cornertype="border-bottom-left-radius"></div>' + '<div class="zedity-corner zedity-cornerbottomright zedity-selected" title="' + Zedity.t('Bottom right corner') + '" data-cornertype="border-bottom-right-radius"></div>' + '</div>' + '<div style="margin-top:10px;width:120px">' + '<div class="zedity-radiusselector" title="' + Zedity.t('Rounded corners') + '"></div>' + '</div>');
                                            var $corners = $panel.find('.zedity-corner');
                                            $corners.on('click.zedity', function() {
                                                $(this).toggleClass('zedity-selected')
                                            });
                                            $panel.find('.zedity-radiusselector').sliderSnap({
                                                label: Zedity.t('Radius'),
                                                min: 0,
                                                max: 100,
                                                slide: function(e, ui) {
                                                    var box = ed.boxes.selected();
                                                    if (!box) return false;
                                                    var c = {};
                                                    $corners.each(function(idx, elem) {
                                                        var $elem = $(elem);
                                                        if ($elem.hasClass('zedity-selected')) {
                                                            c[$elem.attr('data-cornertype')] = ui.value
                                                        }
                                                    });
                                                    Zedity.core._call(box, 'corners', c)
                                                },
                                                stop: function(e, ui) {
                                                    ed._changed()
                                                }
                                            })
                                        },
                                        refresh: function(ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return false;
                                            var c = box.corners(),
                                                size = 0;
                                            for (var i in c) size += parseInt(c[i], 10);
                                            size = Math.floor(size / 4);
                                            this.$panel.find('.zedity-radiusselector').sliderSnap('value', size)
                                        }
                                    }
                                },
                                enable: function(ed) {
                                    var box = ed.boxes.selected();
                                    if (!box) return false;
                                    return box.can('corners')
                                }
                            }
                        }
                    }
                }
            }, 'box')
        },
        showPropBar: function() {
            return this
        },
        start: function() {
            return this
        },
        stop: function() {
            return this
        },
        insert: function() {
            return this
        },
        reposition: function(forceinside) {
            var ofs = 0;
            var bb = this._boundingBox();
            var w = this.editor.page.size().width;
            var h = this.editor.page.size().height;
            var minpixels = 10;
            if (forceinside || (bb.left > w) || (bb.left + bb.width < 0) || (bb.top + bb.height < 0) || (bb.top > h)) {
                if (bb.left + bb.width > w) {
                    this.$this.css('left', w - bb.width + bb.dx - ofs)
                } else if (bb.left < 0) {
                    this.$this.css('left', bb.dx - ofs)
                }
                if (bb.top + bb.height > h) {
                    this.$this.css('top', h - bb.height + bb.dy - ofs)
                } else if (bb.top < 0) {
                    this.$this.css('top', bb.dy - ofs)
                }
            } else if ((bb.left + minpixels > w) || (bb.left + bb.width - minpixels < 0) || (bb.top + bb.height - minpixels < 0) || (bb.top + minpixels > h)) {
                if (bb.left + minpixels > w) {
                    this.$this.css('left', w - minpixels + bb.dx - ofs)
                } else if (bb.left + bb.width - minpixels < 0) {
                    this.$this.css('left', bb.dx - bb.width + minpixels - ofs)
                }
                if (bb.top + minpixels > h) {
                    this.$this.css('top', h - minpixels + bb.dy - ofs)
                } else if (bb.top + bb.height - minpixels < 0) {
                    this.$this.css('top', bb.dy - bb.height + minpixels - ofs)
                }
            }
            return this
        },
        rect: function(rect) {
            if (rect != null) {
                for (var i in rect)
                    if ('left top width height'.indexOf(i) == -1) delete rect[i];
                this.$this.css(rect);
                this.reposition()._resize();
                this.editor._changed()
            }
            rect = {
                left: parseInt(this.$this.css('left'), 10),
                top: parseInt(this.$this.css('top'), 10),
                width: parseInt(this.$this.css('width'), 10),
                height: parseInt(this.$this.css('height'), 10)
            };
            return rect
        },
        arrange: function(where) {
            if (this.asBackground()) return this;
            where = where || 'front';
            var group = $.makeArray(this.$this.editor().$this.children('.zedity-box:not(.zedity-background)')).sort(function(a, b) {
                return (parseInt($(a).css('zIndex'), 10) || 0) - (parseInt($(b).css('zIndex'), 10) || 0)
            });
            if (group.length) {
                var objidx = null;
                var min = 10;
                var $this = this.$this;
                $(group).each(function(i, elem) {
                    this.style.zIndex = min + i * 2;
                    if ($this.is(elem)) objidx = i
                });
                switch (where.toLowerCase()) {
                    case 'front':
                        this.$this[0].style.zIndex = min + group.length * 2;
                        break;
                    case 'back':
                        this.$this[0].style.zIndex = min - 1;
                        break;
                    case 'forward':
                        this.$this[0].style.zIndex = Math.min(min + (objidx * 2) + 3, min + group.length * 2 + 1);
                        break;
                    case 'backward':
                        this.$this[0].style.zIndex = Math.max(min + (objidx * 2) - 3, min - 1);
                        break;
                    case 'background':
                        this.$this[0].style.zIndex = 1;
                        break
                }
            }
            this.editor._changed();
            return this
        },
        _resize: function() {
            if (this.$this.width() < this._sizeLimits().minWidth) this.$this.css('width', this._sizeLimits().minWidth);
            if (this.$this.width() > this._sizeLimits().maxWidth) this.$this.css('width', this._sizeLimits().maxWidth);
            if (this.$this.height() < this._sizeLimits().minHeight) this.$this.css('height', this._sizeLimits().minHeight);
            if (this.$this.height() > this._sizeLimits().maxHeight) this.$this.css('height', this._sizeLimits().maxHeight);
            return this
        },
        _boundingBox: function() {
            var theta_deg = this.rotation();
            Zedity.core._call(this, 'rotation', 0);
            var w = this.$this.outerWidth();
            var h = this.$this.outerHeight();
            var x = this.$this.position().left;
            var y = this.$this.position().top;
            Zedity.core._call(this, 'rotation', theta_deg);
            var d = Math.sqrt(w * w + h * h);
            var t0_rad = Math.acos(w / d);
            var t_rad = -theta_deg * 0.017453292519943295769236907684883;
            var r = 0.5 * d;
            var x0 = x + 0.5 * w;
            var y0 = y + 0.5 * h;
            var rcos_sum = r * Math.cos(t_rad + t0_rad);
            var rsin_sum = r * Math.sin(t_rad + t0_rad);
            var rcos_dif = r * Math.cos(t_rad - t0_rad);
            var rsin_dif = r * Math.sin(t_rad - t0_rad);
            var c1 = Array(x0 + rcos_sum, y0 - rsin_sum);
            var c2 = Array(x0 - rcos_dif, y0 + rsin_dif);
            var c3 = Array(x0 - rcos_sum, y0 + rsin_sum);
            var c4 = Array(x0 + rcos_dif, y0 - rsin_dif);
            var bounds = {};
            bounds.left = Math.round(Math.min(c1[0], c2[0], c3[0], c4[0]));
            bounds.right = Math.round(Math.max(c1[0], c2[0], c3[0], c4[0]));
            bounds.top = Math.round(Math.min(c1[1], c2[1], c3[1], c4[1]));
            bounds.bottom = Math.round(Math.max(c1[1], c2[1], c3[1], c4[1]));
            bounds.width = bounds.right - bounds.left;
            bounds.height = bounds.bottom - bounds.top;
            bounds.dx = x - bounds.left;
            bounds.dy = y - bounds.top;
            return bounds
        },
        duplicate: function() {
            var id = Zedity.core.genId('zeb');
            this.editor.boxes._select(null);
            var $new = this.$this.clone();
            $new.appendTo(this.editor.$this).attr('id', id);
            var box = this.editor.boxes.add(this.type, {
                id: id,
                editor: this.editor
            });
            box._data = $.extend(true, {}, this._data);
            box.init();
            Zedity.core._call(box, 'asBackground', false);
            $new.css({
                left: $new.position().left + 30,
                top: $new.position().top + 30
            });
            this.editor.boxes.refreshSelected();
            this.editor._changed();
            return box
        },
        asBackground: function(setting) {
            var current = this.$this.hasClass('zedity-background');
            if (setting === current) return current;
            if (setting === false) {
                var data = this.$this.zdata('boxbg') || {};
                this.$this.zdata('boxbg', null);
                this.$this.removeClass('zedity-background').css({
                    left: data.left || this._options.x,
                    top: data.top || this._options.y,
                    width: data.width || this._options.width,
                    height: data.height || this._options.height,
                    'z-index': 100,
                    'box-sizing': ''
                });
                Zedity.core._call(this, 'rotation', data.rotation);
                Zedity.core._call(this, 'arrange', 'front');
                this._initDrag().reposition();
                this.editor._changed()
            } else if (setting === true) {
                var $box = this.editor.$this.children('.zedity-background');
                if ($box.length > 0) {
                    this.editor._data.settingbackground = true;
                    $box.each(function(idx, elem) {
                        $(elem).box().asBackground(false)
                    });
                    this.editor._data.settingbackground = false
                }
                this.$this.zdata('boxbg', {
                    left: this.$this.css('left'),
                    top: this.$this.css('top'),
                    width: this.$this.css('width'),
                    height: this.$this.css('height'),
                    rotation: this.rotation()
                });
                Zedity.core._call(this, 'arrange', 'background');
                Zedity.core._call(this, 'rotation', 0);
                this.$this.draggable('destroy');
                this.$this.addClass('zedity-background').css({
                    left: 0,
                    top: 0,
                    width: '100%',
                    height: '100%',
                    'box-sizing': 'border-box'
                });
                this.editor._changed()
            } else {
                return current
            }
            this.editor.boxes.refreshSelected();
            return current
        },
        rotation: function(angle) {
            if (angle != null) {
                angle = Math.round(parseFloat(angle));
                var $this = this.$this;
                this.$this.attr('style', (this.$this.attr('style') || '').replace(/(?:-o-|-ms-|-moz-|-webkit-|)transform.*?;/g, ''));
                if (angle != 0) {
                    var css = '-webkit-transform:rotate(' + angle + 'deg);' + '-moz-transform:rotate(' + angle + 'deg);' + '-ms-transform:rotate(' + angle + 'deg);' + '-o-transform:rotate(' + angle + 'deg);' + 'transform:rotate(' + angle + 'deg);';
                    this.$this.attr('style', this.$this.attr('style') + ';' + css)
                }
                this.editor._changed()
            } else {
                var ret = this.$this.css('transform') || this.$this.css('-webkit-transform') || this.$this.css('-o-transform') || this.$this.css('-moz-transform') || this.$this.css('-ms-transform');
                if (/rotate/.test(ret)) {
                    angle = /rotate\s*?\(\s*?(.*?)\s*?deg\s*?\)/.exec(ret);
                    angle = angle ? angle[1] : 0
                } else if (/matrix/.test(ret)) {
                    var m = /matrix\s*?\(\s*?(.*?),\s*?(.*?),\s*?(.*?),\s*?(.*?),\s*?(.*?),\s*?(.*?)\s*?\)/.exec(ret);
                    if (m) {
                        angle = Math.acos((parseFloat(m[1]) + parseFloat(m[4])) / 2) * 57.295779513082320876798154814114;
                        if (parseFloat(m[2]) < 0) angle = -angle
                    } else {
                        angle = 0
                    }
                } else {
                    angle = 0
                }
                angle = Math.round(parseFloat(angle))
            }
            return angle
        },
        background: function(fill) {
            if (fill) {
                fill = $.extend({
                    type: 'solid',
                    colors: [fill.color]
                }, fill);
                var gradient = '';
                var css = '';
                this.$this.attr('style', (this.$this.attr('style') || '').replace(/background(-color|-image|)\s*?:.*?;/g, ''));
                this.$this.attr('data-zedcssbuffer', (this.$this.attr('data-zedcssbuffer') || '').replace(/background(-color|-image|)\s*?:.*?;/g, ''));
                switch (fill.type.toLowerCase()) {
                    case 'solid':
                        css = 'background-color:' + Zedity.utils.hash2rgba(fill.colors[0], fill.alpha) + ';';
                        break;
                    case 'horizontal':
                        gradient = Zedity.utils.hash2rgba(fill.colors[0], fill.alpha) + ' 0%,' + Zedity.utils.hash2rgba(fill.colors[1], fill.alpha) + ' 100%);';
                        css = 'background-image:-webkit-linear-gradient(left,' + gradient + 'background-image:-moz-linear-gradient(left,' + gradient + 'background-image:-ms-linear-gradient(left,' + gradient + 'background-image:-o-linear-gradient(left,' + gradient + 'background-image:linear-gradient(to right,' + gradient;
                        break;
                    case 'vertical':
                        gradient = Zedity.utils.hash2rgba(fill.colors[0], fill.alpha) + ' 0%,' + Zedity.utils.hash2rgba(fill.colors[1], fill.alpha) + ' 100%);';
                        css = 'background-image:-webkit-linear-gradient(top,' + gradient + 'background-image:-moz-linear-gradient(top,' + gradient + 'background-image:-ms-linear-gradient(top,' + gradient + 'background-image:-o-linear-gradient(top,' + gradient + 'background-image:linear-gradient(to bottom,' + gradient;
                        break;
                    case 'radial':
                        gradient = Zedity.utils.hash2rgba(fill.colors[0], fill.alpha) + ' 0%,' + Zedity.utils.hash2rgba(fill.colors[1], fill.alpha) + ' 100%);';
                        css = 'background-image:-webkit-radial-gradient(center,ellipse cover,' + gradient + 'background-image:-moz-radial-gradient(center,ellipse cover,' + gradient + 'background-image:-ms-radial-gradient(center,ellipse cover,' + gradient + 'background-image:-o-radial-gradient(center,ellipse cover,' + gradient + 'background-image:radial-gradient(ellipse at center,' + gradient;
                        break
                }
                this.$this.attr('style', this.$this.attr('style') + ';' + css);
                this.$this.attr('data-zedcssbuffer', this.$this.attr('data-zedcssbuffer') + ';' + css);
                this.editor._changed();
                return fill
            } else {
                var param = '(?:((?!rgb|#|hsl).*?),)?';
                var color = '\\s*(.*?)\\s*\\d*(?:%|px)';
                var rxlg = new RegExp('linear-gradient\\(' + param + color + ',' + color + '\\)');
                var rxrg = new RegExp('radial-gradient\\(' + param + '\\s*' + param + color + ',' + color + '\\)');
                var bg = (this.$this.attr('data-zedcssbuffer') || this.$this.attr('style') || '').toLowerCase();
                if (bg.indexOf('background-image') > -1) {
                    bg = bg.replace(/.*?(background-image:.*?;).*/, '$1')
                } else {
                    bg = 'none'
                }
                if (bg && bg.toLowerCase() != 'none') {
                    var cfill = {};
                    var match = null;
                    if (match = rxlg.exec(bg)) {
                        switch ((match[1] || '').toLowerCase()) {
                            case 'left':
                            case 'to right':
                                cfill.type = 'horizontal';
                                break;
                            case 'top':
                            case 'to bottom':
                            default:
                                cfill.type = 'vertical';
                                break
                        }
                        cfill.colors = [Zedity.utils.rgb2hash(match[2]), Zedity.utils.rgb2hash(match[3])];
                        cfill.alpha = Zedity.utils.rgba2alpha(match[2]) || Zedity.utils.rgba2alpha(match[3]) || 1;
                        return cfill
                    } else if (match = rxrg.exec(bg)) {
                        cfill.type = 'radial';
                        cfill.colors = [Zedity.utils.rgb2hash(match[3]), Zedity.utils.rgb2hash(match[4])];
                        cfill.alpha = Zedity.utils.rgba2alpha(match[3]) || Zedity.utils.rgba2alpha(match[4]) || 1;
                        return cfill
                    }
                } else {
                    bg = (this.$this.css('background-color') || 'transparent').toLowerCase();
                    if (bg.charAt(0) == '#') {
                        return {
                            type: 'solid',
                            alpha: 1,
                            colors: [bg]
                        }
                    } else if (bg.substr(0, 3) == 'rgb') {
                        var color = Zedity.utils.rgb2hash(bg);
                        return {
                            type: 'solid',
                            alpha: color == 'transparent' ? 1 : (Zedity.utils.rgba2alpha(bg) || 1),
                            colors: [color]
                        }
                    }
                }
                return {
                    type: 'solid',
                    alpha: 1,
                    colors: ['transparent']
                }
            }
        },
        flip: function(flip) {
            var $content = this.$this.children('.zedity-content,.zedity-empty');
            if ($content.length == 0) {
                this.editor._error({
                    message: Zedity.t('Unexpected error: box has no content.')
                });
                return 'none'
            }
            if (flip != null) {
                flip = flip.toLowerCase();
                var curflip = this.flip();
                var corners = this.corners();
                $content.attr('style', ($content.attr('style') || '').replace(/(?:-o-|-ms-|-moz-|-webkit-|)transform.*?;/g, ''));
                var scale = '';
                switch (flip.substr(0, 3)) {
                    case 'hor':
                        switch (curflip.substr(0, 3)) {
                            case 'hor':
                                scale = '';
                                break;
                            case 'ver':
                                scale = 'scale(-1);';
                                break;
                            case 'bot':
                                scale = 'scaleY(-1);';
                                break;
                            default:
                                scale = 'scaleX(-1);';
                                break
                        }
                        break;
                    case 'ver':
                        switch (curflip.substr(0, 3)) {
                            case 'hor':
                                scale = 'scale(-1);';
                                break;
                            case 'ver':
                                scale = '';
                                break;
                            case 'bot':
                                scale = 'scaleX(-1);';
                                break;
                            default:
                                scale = 'scaleY(-1);';
                                break
                        }
                        break;
                    case 'bot':
                        switch (curflip.substr(0, 3)) {
                            case 'bot':
                                scale = '';
                                break;
                            default:
                                scale = 'scale(-1);';
                                break
                        }
                        break
                }
                var css = '-webkit-transform:' + scale + '-moz-transform:' + scale + '-ms-transform:' + scale + '-o-transform:' + scale + 'transform:' + scale;
                if (scale) $content.attr('style', $content.attr('style') + ';' + css);
                this.$this.children('.zedity-empty').css('position', '');
                Zedity.core._call(this, 'corners', corners);
                this.editor._changed()
            }
            var f = 'none';
            var ret = $content.css('transform') || $content.css('-webkit-transform') || $content.css('-o-transform') || $content.css('-moz-transform') || this.$this.css('-ms-transform');
            if (/scale/.test(ret)) {
                f = /scale(X|Y|)\s*?\(\s*?-1\s*?\)/.exec(ret);
                f = f ? f[1] : 'none'
            } else if (/matrix/.test(ret)) {
                var m = /matrix\s*?\(\s*?(.*?),\s*?(.*?),\s*?(.*?),\s*?(.*?),\s*?(.*?),\s*?(.*?)\s*?\)/.exec(ret);
                if (m) {
                    var m1 = parseFloat(m[1]);
                    var m4 = parseFloat(m[4]);
                    if (m1 == -1 && m4 == 1) {
                        f = 'X'
                    } else if (m1 == 1 && m4 == -1) {
                        f = 'Y'
                    } else if (m1 == -1 && m4 == -1) {
                        f = ''
                    }
                }
            }
            switch (f) {
                case 'X':
                    return 'horizontal';
                case 'Y':
                    return 'vertical';
                case '':
                    return 'both';
                case 'none':
                default:
                    return 'none'
            }
        },
        corners: function(corners) {
            function switchCorners(corners, flip) {
                var t;
                if (flip == 'hor' || flip == 'bot') {
                    t = corners['border-top-left-radius'];
                    corners['border-top-left-radius'] = corners['border-top-right-radius'];
                    corners['border-top-right-radius'] = t;
                    t = corners['border-bottom-left-radius'];
                    corners['border-bottom-left-radius'] = corners['border-bottom-right-radius'];
                    corners['border-bottom-right-radius'] = t
                }
                if (flip == 'ver' || flip == 'bot') {
                    t = corners['border-top-left-radius'];
                    corners['border-top-left-radius'] = corners['border-bottom-left-radius'];
                    corners['border-bottom-left-radius'] = t;
                    t = corners['border-top-right-radius'];
                    corners['border-top-right-radius'] = corners['border-bottom-right-radius'];
                    corners['border-bottom-right-radius'] = t
                }
                return corners
            };

            function neg(corners) {
                var newcorners = {};
                for (var corner in corners) {
                    if (corners.hasOwnProperty(corner) && (parseInt(corners[corner]) > 0)) {
                        newcorners[corner] = ''
                    }
                }
                return newcorners
            };
            var flip = this.flip().substr(0, 3).toLowerCase();
            if (corners) {
                corners = switchCorners(corners, flip);
                var css = '';
                for (var corner in corners) {
                    if (corners.hasOwnProperty(corner) && (parseInt(corners[corner]) >= 0)) {
                        this.$this.attr('style', (this.$this.attr('style') || '').replace(new RegExp(corner + ':.*?(?:;|$)', ''), ''));
                        css += corner + ':' + parseInt(corners[corner], 10) + 'px;'
                    }
                }
                this.$this.attr('style', this.$this.attr('style') + ';' + css);
                var offset = parseInt(this.$this.css('border-top-width'), 10) || 0;
                if (offset > 0) {
                    for (var i in corners) {
                        if (isNaN(corners[i])) corners[i] = parseInt(corners[i] || '0');
                        corners[i] -= (offset + 1);
                        if (corners[i] < 0) corners[i] = 0
                    }
                }
                corners = switchCorners(corners, flip);
                this.$this.children('.zedity-empty,.zedity-content').each(function() {
                    var $this = $(this);
                    var css = '';
                    for (var corner in corners) {
                        if (corners.hasOwnProperty(corner) && (parseInt(corners[corner], 10) >= 0)) {
                            $this.attr('style', ($this.attr('style') || '').replace(new RegExp(corner + ':.*?(?:;|$)', 'g'), ''));
                            css += corner + ':' + parseInt(corners[corner], 10) + 'px;'
                        }
                    }
                    $this.attr('style', $this.attr('style') + ';' + css)
                });
                this.editor._changed()
            }
            corners = this.$this.getCss(['border-top-left-radius', 'border-top-right-radius', 'border-bottom-left-radius', 'border-bottom-right-radius']);
            return switchCorners(corners, flip)
        },
        lock: function(lock) {
            if (lock != null) {
                this._data.locked = lock;
                this.$this.toggleClass('zedity-locked', lock);
                this.editor._changed()
            }
            return this._data.locked
        },
        remove: function() {
            if (!this.$this) return this;
            if (this.$this.hasClass('zedity-selected')) this.editor.boxes._select(null);
            this.$this.remove();
            this.$this = null;
            this.editor._changed();
            return this
        },
        destroy: function() {
            Zedity.core._call(this, 'remove');
            for (var i = this.editor.boxes._boxes.length - 1; i >= 0; --i) {
                if (this.editor.boxes._boxes[i].id == this.id) {
                    this.editor.boxes._boxes.splice(i, 1);
                    return this
                }
            }
            return this
        }
    });
    Zedity.Box.types = [];
    Zedity.Box.boxes = [];
    Zedity.Box.register = function(options) {
        var defaults = {
            type: undefined,
            requires: [],
            section: 'advanced',
            order: 100
        };
        options = $.extend({}, defaults, options);
        if (!options.type) throw new Error(Zedity.t('Box type not supplied during registration.'));
        for (var i = options.requires.length - 1; i >= 0; --i) {
            if (Zedity.core.supports.hasOwnProperty(options.requires[i]) && !Zedity.core.supports[options.requires[i]]()) return false
        }
        Zedity.Box.types.push(options.type);
        Zedity.Box.boxes.push(options);
        Zedity.Box.boxes.sort(function(a, b) {
            return a.order - b.order
        })
    }
})(jQuery);
(function($) {
    Zedity.utils = Zedity.utils || {};
    Zedity.utils.cleanText = function(text) {
        var invalidChars = /[^\w\s\u0020-\ud7ff\ue000-\uffdd\u10000-\u10ffff]/g;
        return $.trim(text.replace(invalidChars, '').replace(/\s+/g, ' '))
    }
})(jQuery);
(function($) {
    $.fn.getCss = function(styles, inherited) {
        var $this = $(this);
        var css = {};
        if (typeof(styles) == 'string') styles = styles.split(' ');
        for (var i = styles.length - 1; i >= 0; --i) {
            if (inherited) {
                if ($this.css(styles[i])) {
                    css[styles[i]] = $this.css(styles[i])
                }
            } else {
                if ($this.prop('style')[$.camelCase(styles[i])]) {
                    css[styles[i]] = $this.prop('style')[$.camelCase(styles[i])]
                }
            }
        }
        return css
    };
    $.fn.multiDraggable = function(options) {
        var initLeftOffset = [];
        var initTopOffset = [];
        options = $.extend(options, {
            start: function(event, ui) {
                initLeftOffset = [0];
                initTopOffset = [0];
                if ($(options.group).length > 1) {
                    var pos = $(this).position();
                    $(options.group).draggable('option', 'snap', false).each(function(idx, elem) {
                        var elemPos = $(elem).position();
                        initLeftOffset[idx] = elemPos.left - pos.left;
                        initTopOffset[idx] = elemPos.top - pos.top
                    })
                }
                if (typeof options.startNative == 'function') options.startNative.call(this, event, ui)
            },
            drag: function(event, ui) {
                var pos = $(this).offset();
                $(options.group).each(function(idx, elem) {
                    $(elem).addClass('ui-draggable-dragging').offset({
                        left: pos.left + initLeftOffset[idx],
                        top: pos.top + initTopOffset[idx]
                    })
                });
                if (typeof options.dragNative == 'function') options.dragNative.call(this, event, ui)
            },
            stop: function(event, ui) {
                var pos = $(this).offset();
                $(options.group).each(function(idx, elem) {
                    $(elem).removeClass('ui-draggable-dragging').offset({
                        left: pos.left + initLeftOffset[idx],
                        top: pos.top + initTopOffset[idx]
                    })
                });
                if (typeof options.stopNative == 'function') options.stopNative.call(this, event, ui)
            }
        });
        $(this).draggable(options);
        return this
    };
    $.ui.plugin.add('draggable', 'snapFeedback', {
        drag: function(event, ui) {
            if (this.box().rotation() != 0) return;
            var inst = this.data('ui-draggable');
            if (!inst.snapElements) return;
            for (var i = inst.snapElements.length - 1; i >= 0; --i) {
                if (inst.snapElements[i].snapping) {
                    $(inst.snapElements[i].item).stop().addClass('zedity-snapped').delay(1000).queue(function(next) {
                        $(this).removeClass('zedity-snapped');
                        next()
                    })
                } else {
                    $(inst.snapElements[i].item).stop().removeClass('zedity-snapped')
                }
                var box = $(inst.snapElements[i].item).box();
                if (box && box.rotation() !== 0) inst.snapElements.splice(i, 1)
            }
        }
    });
    $.ui.plugin.add('draggable', 'snapRealPage', {
        drag: function(event, ui) {
            var $this = $(this);
            var inst = $this.data('ui-draggable');
            if (!inst.snapElements) return;
            for (var i = inst.snapElements.length - 1; i >= 0; --i) {
                var $elem = $(inst.snapElements[i].item);
                if (inst.snapElements[i].snapping && $elem.hasClass('zedity-editor')) {
                    if (Math.abs(inst.position.left) < inst.options.snapTolerance) inst.position.left = Math.max(inst.position.left, 0);
                    if (Math.abs(inst.position.top) < inst.options.snapTolerance) inst.position.top = Math.max(inst.position.top, 0);
                    if (Math.abs(inst.position.left + $this.outerWidth() - $elem.width()) < inst.options.snapTolerance) inst.position.left = Math.min(inst.position.left, $elem.width() - $this.outerWidth());
                    if (Math.abs(inst.position.top + $this.outerHeight() - $elem.height()) < inst.options.snapTolerance) inst.position.top = Math.min(inst.position.top, $elem.height() - $this.outerHeight())
                }
            }
        }
    });
    $.ui.plugin.add('draggable', 'reposition', {
        start: function(event, ui) {
            var bb = this.box()._boundingBox();
            this.data('ui-draggable').offset.click.left -= bb.dx;
            this.data('ui-draggable').offset.click.top -= bb.dy
        }
    });
    $.widget('ui.resizable', $.ui.resizable, {
        _numf: function(n) {
            return isNaN(parseFloat(n)) ? 0 : parseFloat(n)
        },
        _old_mouseStart: $.ui.resizable.prototype._mouseStart,
        _mouseStart: function() {
            var res = this._old_mouseStart.apply(this, arguments);
            var cursor = this.element.find('.ui-resizable-' + this.axis).css('cursor') || $('.ui-resizable-' + this.axis).css('cursor');
            $('body').css('cursor', cursor === 'auto' ? this.axis + '-resize' : cursor);
            return res
        },
        _old_mouseDrag: $.ui.resizable.prototype._mouseDrag,
        _mouseDrag: function(event) {
            var box = $(this.element[0]).box();
            if (!box) return this._old_mouseDrag.apply(this, arguments);
            var angle = box.rotation();
            var angle_rad = angle * 0.017453292519943295769236907684883;
            var data, props, smp = this.originalMousePosition,
                dx = (event.pageX - smp.left) || 0,
                dy = (event.pageY - smp.top) || 0,
                trigger = this._change[this.axis];
            this._updatePrevProperties();
            if (!trigger) return false;
            var _cos = Math.cos(angle_rad),
                _sin = Math.sin(angle_rad);
            var ndx = dx * _cos + dy * _sin;
            var ndy = dy * _cos - dx * _sin;
            data = trigger.apply(this, [event, ndx, ndy]);
            this._updateVirtualBoundaries(event.shiftKey);
            if (this._aspectRatio || event.shiftKey) {
                data = this._updateRatio(data, event)
            }
            data = this._respectSize(data, event);
            this._updateCache(data);
            this._propagate("resize", event);
            var o = (function() {
                function d(w, h) {
                    var cx = -w / 2,
                        cy = h / 2,
                        nx = cy * _sin + cx * _cos,
                        ny = cy * _cos - cx * _sin;
                    return {
                        x: nx - cx,
                        y: ny - cy
                    }
                };
                var d1 = d(this.prevSize.width, this.prevSize.height);
                var d2 = d(this.size.width, this.size.height);
                return {
                    x: d2.x - d1.x,
                    y: d2.y - d1.y
                }
            }).call(this);
            this.position.left -= o.x;
            this.position.top += o.y;
            props = this._applyChanges();
            if (!this._helper && this._proportionallyResizeElements.length) {
                this._proportionallyResize()
            }
            if (!$.isEmptyObject(props)) {
                this._updatePrevProperties();
                this._trigger('resize', event, this.ui());
                this._applyChanges()
            }
            return false
        },
        _old_updatePrevProperties: $.ui.resizable.prototype._updatePrevProperties,
        _updatePrevProperties: function() {
            if (this._old_updatePrevProperties) return this._old_updatePrevProperties.apply(this, arguments);
            this.prevPosition = {
                top: this.position.top,
                left: this.position.left
            };
            this.prevSize = {
                width: this.size.width,
                height: this.size.height
            }
        },
        _old_applyChanges: $.ui.resizable.prototype._applyChanges,
        _applyChanges: function() {
            if (this._old_applyChanges) return this._old_applyChanges.apply(this, arguments);
            var props = {};
            if (this.position.top !== this.prevPosition.top) props.top = this.position.top + 'px';
            if (this.position.left !== this.prevPosition.left) props.left = this.position.left + 'px';
            if (this.size.width !== this.prevSize.width) props.width = this.size.width + 'px';
            if (this.size.height !== this.prevSize.height) props.height = this.size.height + 'px';
            this.helper.css(props);
            return props
        }
    });
    $.widget('ui.rotatable', $.ui.mouse, {
        options: {
            start: function() {},
            rotate: function() {},
            stop: function() {},
            snaps: [0, 45, 90, 180, 270],
            snapTolerance: 5
        },
        _create: function() {
            var handle = $('<div class="ui-rotatable-handle ui-icon ui-icon-arrowrefresh-1-w">');
            this.listeners = {
                start: $.proxy(this._start, this),
                rotate: $.proxy(this._rotate, this),
                stop: $.proxy(this._stop, this)
            };
            handle.draggable({
                helper: 'clone',
                handle: handle
            });
            handle.on('mousedown', this.listeners.start);
            handle.appendTo(this.element);
            this.element.addClass('ui-rotatable');
            this.box = this.element.box();
            this.elementCurrentAngle = this.box.rotation()
        },
        _destroy: function() {
            this.element.removeClass('ui-rotatable');
            this.element.find('.ui-rotatable-handle').remove()
        },
        _getCenter: function() {
            var a = this.box.rotation();
            Zedity.core._call(this.box, 'rotation', 0);
            var o = Zedity.core.supports.touch() && /chrome/i.test(navigator.userAgent) ? this.element[0].getBoundingClientRect() : this.element.offset();
            Zedity.core._call(this.box, 'rotation', a);
            return {
                x: o.left + this.element.width() / 2,
                y: o.top + this.element.height() / 2
            }
        },
        _start: function(e) {
            var c = this._getCenter();
            this.mouseStartAngle = Math.atan2(e.pageY - c.y, e.pageX - c.x) * 57.29577951308232;
            this.elementStartAngle = this.elementCurrentAngle;
            $(document).on('mousemove', this.listeners.rotate);
            $(document).on('mouseup', this.listeners.stop);
            this.element.addClass('ui-rotatable-rotating');
            $('body').css('cursor', 'move');
            this.options.start.call(this.element, e);
            return false
        },
        _rotate: function(e) {
            var c = this._getCenter();
            var mouseAngle = Math.atan2(e.pageY - c.y, e.pageX - c.x) * 57.29577951308232;
            var rotateAngle = this._normalizeAngle(mouseAngle - this.mouseStartAngle + this.elementStartAngle);
            Zedity.core._call(this.box, 'rotation', rotateAngle);
            this.elementCurrentAngle = rotateAngle;
            this.options.rotate.call(this.element, e);
            return false
        },
        _stop: function(e) {
            this.elementStopAngle = this.elementCurrentAngle;
            $(document).off('mousemove', this.listeners.rotate);
            $(document).off('mouseup', this.listeners.stop);
            this.element.removeClass('ui-rotatable-rotating');
            $('body').css('cursor', 'auto');
            this.options.stop.call(this.element, e);
            return false
        },
        _normalizeAngle: function(a) {
            a = (a < 0 ? 360 + a : (a > 360 ? a - 360 : a));
            for (var snap = this.options.snaps.length - 1; snap >= 0; --snap) {
                if (Math.abs(a - this.options.snaps[snap]) < this.options.snapTolerance) {
                    a = this.options.snaps[snap];
                    break
                }
            }
            return a
        }
    });
    $.widget('ui.sliderSnap', $.ui.slider, {
        options: {
            label: '',
            snaps: [],
            snaptolerance: 5
        },
        _create: function() {
            this.element.text(this.options.label);
            this._superApply(arguments);
            this.element.wrap('<div class="zedity-slider-wrapper"/>')
        },
        _destroy: function() {
            this._superApply(arguments);
            this.element.unwrap()
        },
        _refreshValue: function() {
            this._superApply(arguments);
            var h = this.handles.eq(0);
            h.text(this.value());
            var w = this.element.parent().width() - h.width();
            if (w > 0) this.element.width(w)
        },
        _slide: function(event, index, newVal) {
            if (event.type == 'mousemove') {
                for (var snap = this.options.snaps.length - 1; snap >= 0; --snap) {
                    if (Math.abs(newVal - this.options.snaps[snap]) < this.options.snaptolerance) {
                        newVal = this.options.snaps[snap];
                        break
                    }
                }
            }
            this._superApply(arguments)
        }
    });
    $.widget('ui.tabs', $.ui.tabs, {
        selected: function(id) {
            var idx;
            var $this = $(this.element);
            if (id) {
                var idx = $this.find('a[href="#' + id + '"]').parent().index();
                $this.tabs('option', 'active', idx)
            } else {
                idx = $this.tabs('option', 'active');
                return $this.find('a.ui-tabs-anchor').eq(idx).attr('href').replace('#', '')
            }
        },
        getidx: function(id) {
            if (!id) return -1;
            return $(this.element).find('a[href="#' + id + '"]').parent().index()
        }
    });
    var d;
    d = Zedity.t('Audio');
    d = Zedity.t('Color');
    d = Zedity.t('Document');
    d = Zedity.t('Draw');
    d = Zedity.t('Html');
    d = Zedity.t('Image');
    d = Zedity.t('Text');
    d = Zedity.t('Video')
    d = Zedity.t('Article')
})(jQuery);
(function($) {
    $.ui.plugin.add('resizable', 'snap', {
        start: function() {
            var inst = $(this).data('ui-resizable');
            inst.snapElements = [];
            $(inst.options.snap).each(function() {
                if (this == inst.element[0]) return;
                var $el = $(this);
                if ($el.hasClass('zedity-editor')) {
                    inst.snapElements.push({
                        item: this,
                        l: 0,
                        t: 0,
                        r: $el.width(),
                        b: $el.height()
                    })
                } else {
                    var p = $el.position();
                    var box = $el.box();
                    if (box && box.rotation() !== 0) return;
                    inst.snapElements.push({
                        item: this,
                        l: p.left,
                        t: p.top,
                        r: p.left + $el.outerWidth(),
                        b: p.top + $el.outerHeight()
                    })
                }
            })
        },
        resize: function() {
            function coord(lt, rb, st) {
                return (Math.abs(lt) < st ? -lt : (Math.abs(rb) < st ? -rb : 0))
            };

            function getstop(ar) {
                return ar.sort(function(a, b) {
                    return (!a.c ? 1 : (!b.c ? -1 : Math.abs(a.c) - Math.abs(b.c)))
                })[0]
            };
            var inst = $(this).data('ui-resizable');
            var st = inst.options.snapTolerance || 20;
            var stops = {
                l: [],
                t: [],
                w: [],
                h: []
            };
            var l = inst.position.left;
            var t = inst.position.top;
            var r = l + inst.size.width + inst.sizeDiff.width;
            var b = t + inst.size.height + inst.sizeDiff.height;
            for (var i = inst.snapElements.length - 1; i >= 0; --i) {
                var se = inst.snapElements[i];
                se.snapping = false;
                var w = Math.min(r + st, se.r) - Math.max(l - st, se.l);
                var h = Math.min(b + st, se.b) - Math.max(t - st, se.t);
                if (w > 0 & h > 0) {
                    var axes = inst.axis.split('');
                    for (var j = axes.length - 1; j >= 0; --j) {
                        switch (axes[j]) {
                            case 'w':
                                stops.l.push({
                                    e: se,
                                    c: coord(l - se.l, l - se.r, st)
                                });
                                break;
                            case 'n':
                                stops.t.push({
                                    e: se,
                                    c: coord(t - se.t, t - se.b, st)
                                });
                                break;
                            case 'e':
                                stops.w.push({
                                    e: se,
                                    c: coord(r - se.l, r - se.r, st)
                                });
                                break;
                            case 's':
                                stops.h.push({
                                    e: se,
                                    c: coord(b - se.t, b - se.b, st)
                                });
                                break
                        }
                    }
                }
            }
            var s = null;
            if (stops.w.length) {
                s = getstop(stops.w);
                s.e.snapping = true;
                inst.size.width += s.c;
                if (inst._aspectRatio) inst.size.height = inst.size.width / inst.aspectRatio
            }
            if (stops.h.length) {
                s = getstop(stops.h);
                s.e.snapping = true;
                inst.size.height += s.c;
                if (inst._aspectRatio) inst.size.width = inst.size.height * inst.aspectRatio
            }
            if (stops.l.length) {
                s = getstop(stops.l);
                s.e.snapping = true;
                inst.position.left += s.c;
                inst.size.width -= s.c;
                if (inst._aspectRatio) inst.size.height = inst.size.width / inst.aspectRatio
            }
            if (stops.t.length) {
                s = getstop(stops.t);
                s.e.snapping = true;
                inst.position.top += s.c;
                inst.size.height -= s.c;
                if (inst._aspectRatio) inst.size.width = inst.size.height * inst.aspectRatio
            }
            for (var i = inst.snapElements.length - 1; i >= 0; --i) {
                if (inst.snapElements[i].snapping) {
                    $(inst.snapElements[i].item).stop().addClass('zedity-snapped').delay(1000).queue(function(next) {
                        $(this).removeClass('zedity-snapped');
                        next()
                    })
                } else {
                    $(inst.snapElements[i].item).stop().removeClass('zedity-snapped')
                }
            }
        }
    })
})(jQuery);
(function($) {
    var old_createPropBar = Zedity.Box.prototype.createPropBar;
    Zedity.Box.prototype.createPropBar = function(options) {
        old_createPropBar.call(this);
        this.editor.menu._data.enableCpButtons = {
            after: function() {
                this.$button.extpanel('instance').panel.find('.zedity-colorpicker .zedity-colorbuttons').show()
            }
        };
        this.editor.menu.add({
            tabs: {
                editbox: {
                    groups: {
                        edit: {
                            title: Zedity.t('Link'),
                            features: {
                                link: {
                                    type: 'button',
                                    icon: 'link',
                                    title: Zedity.t('Add link to box'),
                                    label: Zedity.t('Link'),
                                    order: -10,
                                    onclick: function(e, ed) {
                                        var box = ed.boxes.selected();
                                        if (!box) return;
                                        $('.zedity-dialog-link').data('obj', box).dialog('open');
                                        $('.zedity-dialog-link .zedity-link-descr').html(Zedity.t('This link will be associated to the whole box.') + '<br/>' + Zedity.t('Insert link url:'))
                                    },
                                    enable: function(ed) {
                                        var box = ed.boxes.selected();
                                        if (!box) return false;
                                        return box.can('background')
                                    }
                                }
                            }
                        },
                        layout: {
                            features: {
                                align: {
                                    type: 'menu',
                                    icon: 'align',
                                    label: Zedity.t('Align'),
                                    title: Zedity.t('Align to page'),
                                    order: 101,
                                    items: [{
                                        value: 'left',
                                        label: Zedity.t('Left')
                                    }, {
                                        value: 'center',
                                        label: Zedity.t('Center')
                                    }, {
                                        value: 'right',
                                        label: Zedity.t('Right')
                                    }, '--', {
                                        value: 'top',
                                        label: Zedity.t('Top')
                                    }, {
                                        value: 'middle',
                                        label: Zedity.t('Middle')
                                    }, {
                                        value: 'bottom',
                                        label: Zedity.t('Bottom')
                                    }, '--', {
                                        value: 'width',
                                        label: Zedity.t('Fit width')
                                    }, {
                                        value: 'height',
                                        label: Zedity.t('Fit height')
                                    }],
                                    onclick: function(val, e, ed) {
                                        var box = ed.boxes.selected();
                                        if (!box) return;
                                        if (['width', 'height'].indexOf(val) > -1) {
                                            box.fitToPage(val)
                                        } else {
                                            box.align(val)
                                        }
                                    },
                                    enable: function(ed, box) {
                                        return box && !box.asBackground()
                                    }
                                }
                            }
                        },
                        positioning: {
                            title: Zedity.t('Position and size'),
                            order: 100,
                            features: {
                                position: {
                                    type: 'panel',
                                    order: 0,
                                    build: function($panel, ed) {
                                        $panel.append('<table>' + '<tr><td>X:</td><td><input class="zedity-txtBP zedity-txtBPX" type="number" maxlength="5"></tr>' + '<tr><td>Y:</td><td><input class="zedity-txtBP zedity-txtBPY" type="number" maxlength="5"></tr>' + '</table>');
                                        var $bp = $panel.find('.zedity-txtBP').css('width', 50);
                                        $bp.eq(0).attr('title', Zedity.t('Set box position %s.', '(X)'));
                                        $bp.eq(1).attr('title', Zedity.t('Set box position %s.', '(Y)'));
                                        $bp.on('change', function() {
                                            var box = ed.boxes.selected();
                                            if (!box) return false;
                                            box.rect({
                                                left: $bp.eq(0).val() + 'px',
                                                top: $bp.eq(1).val() + 'px'
                                            })
                                        })
                                    },
                                    refresh: function(ed) {
                                        var box = ed.boxes.selected();
                                        if (!box) return false;
                                        var $bp = this.$panel.find('.zedity-txtBP');
                                        var r = box.rect();
                                        $bp.eq(0).val(r.left);
                                        $bp.eq(1).val(r.top)
                                    }
                                },
                                sep: {
                                    type: 'separator'
                                },
                                size: {
                                    type: 'panel',
                                    order: 100,
                                    build: function($panel, ed) {
                                        var checkLimits = function($elem) {
                                            var val = $elem.val();
                                            if (val < parseInt($elem.attr('min'), 10)) $elem.val($elem.attr('min'));
                                            if ($elem.attr('max') && val > parseInt($elem.attr('max'), 10)) $elem.val($elem.attr('max'));
                                            return (val >= parseInt($elem.attr('min'), 10) && (!$elem.attr('max') || val <= parseInt($elem.attr('max'), 10)))
                                        };
                                        var aspectRatio = function($this) {
                                            var $other = $bs.not($this);
                                            var ratio = $this.val() / $this.data('val');
                                            $other.val(Math.round($other.data('val') * ratio));
                                            if (!checkLimits($other)) aspectRatio($other)
                                        };
                                        $panel.append('<table>' + '<tr><td>' + Zedity.t('W:') + '</td><td><input class="zedity-txtBS zedity-txtBSW" type="number" maxlength="5"></tr>' + '<tr><td>' + Zedity.t('H:') + '</td><td><input class="zedity-txtBS zedity-txtBSH" type="number" maxlength="5"></tr>' + '</table>');
                                        var $bs = $panel.find('.zedity-txtBS').css('width', 50);
                                        $bs.on('change', function() {
                                            var box = ed.boxes.selected();
                                            if (!box) return false;
                                            var $this = $(this);
                                            checkLimits($this);
                                            if (ed.menu._feature('editbox', 'positioning', 'sizelock').$button.hasClass('zedity-pressed')) {
                                                aspectRatio($this)
                                            }
                                            box.$this.css({
                                                width: $bs.eq(0).val(),
                                                height: $bs.eq(1).val()
                                            });
                                            box._resize();
                                            ed._changed()
                                        })
                                    },
                                    refresh: function(ed) {
                                        var box = ed.boxes.selected();
                                        if (!box) return false;
                                        var limits = box._sizeLimits();
                                        var $bp = this.$panel.find('.zedity-txtBS');
                                        $bp.eq(0).attr('min', limits.minWidth).attr('max', limits.maxWidth || '').val(box.$this.width()).attr('title', Zedity.t('Set box width') + ' ' + Zedity.t('(min: %s, max: %s)', limits.minWidth, limits.maxWidth || '&infin;'));
                                        $bp.eq(1).attr('min', limits.minHeight).attr('max', limits.maxHeight || '').val(box.$this.height()).attr('title', Zedity.t('Set box height') + ' ' + Zedity.t('(min: %s, max: %s)', limits.minHeight, limits.maxHeight || '&infin;'))
                                    }
                                },
                                sizelock: {
                                    type: 'smallbutton',
                                    size: 'xs',
                                    icon: 'lock',
                                    title: Zedity.t('Keep aspect ratio'),
                                    onclick: function(e, ed) {
                                        $(this).toggleClass('zedity-pressed');
                                        var box = ed.boxes.selected();
                                        if (!box) return;
                                        var $bs = ed.menu._feature('editbox', 'positioning', 'size').$panel.find('.zedity-txtBS');
                                        var r = box.rect();
                                        $bs.eq(0).data('val', Math.round(r.width));
                                        $bs.eq(1).data('val', Math.round(r.height))
                                    }
                                }
                            },
                            enable: function(ed, box) {
                                return box && !box.asBackground()
                            }
                        }
                    }
                },
                boxstyle: {
                    groups: {
                        border: {
                            features: {
                                padding: {
                                    type: 'smallpanel',
                                    order: 110,
                                    build: function($panel, ed) {
                                        $panel.append('<div style="margin:15px 2px 0;width:120px">' + '<div class="zedity-slider zedity-padding" title="' + Zedity.t('Select box padding') + '"/>' + '</div>');
                                        $panel.find('.zedity-padding').sliderSnap({
                                            label: Zedity.t('Padding'),
                                            min: 0,
                                            max: 50,
                                            slide: function(e, ui) {
                                                var box = ed.boxes.selected();
                                                if (!box) return false;
                                                box.$this.css('padding', ui.value)
                                            },
                                            stop: function(e, ui) {
                                                ed._changed()
                                            }
                                        })
                                    },
                                    refresh: function(ed) {
                                        var box = ed.boxes.selected();
                                        if (!box) return false;
                                        this.$panel.find('.zedity-padding').sliderSnap('value', parseInt(box.$this.css('padding') || 0, 10))
                                    }
                                }
                            }
                        },
                        shadow: {
                            title: Zedity.t('Shadow'),
                            order: 300,
                            features: {
                                predefined: {
                                    type: 'menu',
                                    icon: 'config',
                                    label: Zedity.t('Predefined'),
                                    title: Zedity.t('Select predefined shadow'),
                                    order: 0,
                                    items: [{
                                        value: 'none',
                                        label: Zedity.t('No shadow')
                                    }, '--', {
                                        value: 'bottomright',
                                        label: Zedity.t('Shadow at bottom right')
                                    }, {
                                        value: 'bottomleft',
                                        label: Zedity.t('Shadow at bottom left')
                                    }, {
                                        value: 'topright',
                                        label: Zedity.t('Shadow at top right')
                                    }, {
                                        value: 'topleft',
                                        label: Zedity.t('Shadow at top left')
                                    }, '--', {
                                        value: 'diffuse',
                                        label: Zedity.t('Diffuse shadow')
                                    }],
                                    onclick: function(val, e, ed) {
                                        var box = ed.boxes.selected();
                                        if (!box) return;
                                        var s = {
                                            horizontal: 0,
                                            vertical: 0,
                                            blur: 0,
                                            spread: 0
                                        };
                                        switch (val) {
                                            case 'none':
                                                box.shadow('none');
                                                break;
                                            case 'bottomright':
                                                box.shadow($.extend(s, {
                                                    horizontal: 20,
                                                    vertical: 20,
                                                    blur: 10
                                                }));
                                                break;
                                            case 'bottomleft':
                                                box.shadow($.extend(s, {
                                                    horizontal: -20,
                                                    vertical: 20,
                                                    blur: 10
                                                }));
                                                break;
                                            case 'topright':
                                                box.shadow($.extend(s, {
                                                    horizontal: 20,
                                                    vertical: -20,
                                                    blur: 10
                                                }));
                                                break;
                                            case 'topleft':
                                                box.shadow($.extend(s, {
                                                    horizontal: -20,
                                                    vertical: -20,
                                                    blur: 10
                                                }));
                                                break;
                                            case 'diffuse':
                                                box.shadow($.extend(s, {
                                                    blur: 30,
                                                    spread: 10
                                                }));
                                                break
                                        }
                                    }
                                },
                                color: {
                                    type: 'extpanel',
                                    label: Zedity.t('Color'),
                                    icon: 'empty zicon-colorpicker',
                                    title: Zedity.t('Select shadow color'),
                                    size: 'xs',
                                    order: 10,
                                    build: function($panel, ed) {
                                        this.$button.find('.zicon').width(30);
                                        $panel.append('<div class="zedity-shadowcolor-colorpicker"/>');
                                        var $cp = $panel.find('.zedity-shadowcolor-colorpicker');
                                        $cp.colorPicker({
                                            colors: ['#ffffff', '#f2f2f2', '#d8d8d8', '#bdbdbd', '#a4a4a4', '#6e6e6e', '#424242', '#2e2e2e', '#000000', '#fbefef', '#f8e0e0', '#f5a9a9', '#f78181', '#fe2e2e', '#df0101', '#b40404', '#8a0808', '#3b0b0b', '#fbf5ef', '#f8ece0', '#f5d0a9', '#faac58', '#ff8000', '#df7401', '#b45f04', '#8a4b08', '#3b240b', '#fbfbef', '#f5f6ce', '#f2f5a9', '#f4fa58', '#ffff00', '#d7df01', '#aeb404', '#868a08', '#393b0b', '#f5fbef', '#e3f6ce', '#d0f5a9', '#acfa58', '#80ff00', '#74df00', '#5fb404', '#4b8a08', '#38610b', '#effbef', '#cef6ce', '#a9f5a9', '#58fa58', '#00ff00', '#01df01', '#04b404', '#088a08', '#0b3b0b', '#effbfb', '#cef6f5', '#a9f5f2', '#58faf4', '#00ffff', '#01dfd7', '#04b4ae', '#088a85', '#0b3b39', '#eff5fb', '#cee3f6', '#81bef7', '#2e9afe', '#0080ff', '#045fb4', '#084b8a', '#08388a', '#0b243b', '#efeffb', '#cecef6', '#5858fa', '#2e2efe', '#0000ff', '#0404b4', '#08088a', '#0b0b61', '#0b0b3b', '#f5effb', '#e3cef6', '#be81f7', '#ac58fa', '#9a2efe', '#5f04b4', '#4b088a', '#380b61', '#240b3b', '#fbeffb', '#f6cef5', '#f781f3', '#fe2ef7', '#ff00ff', '#df01d7', '#b404ae', '#610b5e', '#3b0b39', '#fbeff5', '#f6cee3', '#f5a9d0', '#fa58ac', '#ff0080', '#df0174', '#b4045f', '#610b38', '#3b0b24'],
                                            defaultcolor: '#000000',
                                            alpha: true,
                                            buttons: true,
                                            maxcols: 9,
                                            onchange: function(e, color, fill, alpha) {
                                                var box = ed.boxes.selected();
                                                if (!box) return false;
                                                box.shadow({
                                                    color: Zedity.utils.hash2rgba(color, alpha)
                                                })
                                            },
                                            onchangealpha: function(event, alpha) {
                                                var box = ed.boxes.selected();
                                                if (!box) return false;
                                                var c = $(this).colorPicker('getcolor');
                                                box.shadow({
                                                    color: Zedity.utils.hash2rgba(c, alpha)
                                                })
                                            }
                                        })
                                    },
                                    refresh: function(ed, box) {
                                        if (!box) return false;
                                        var $cp = this.$button.extpanel('instance').panel.find('.zedity-shadowcolor-colorpicker');
                                        var s = box.shadow();
                                        $cp.colorPicker('selectcolor', s.color);
                                        this.$button.find('.zicon').css('background', s.color)
                                    }
                                },
                                shadow: {
                                    type: 'extpanel',
                                    icon: 'shadow',
                                    label: Zedity.t('Shadow'),
                                    title: Zedity.t('Box shadow'),
                                    order: 100,
                                    build: function($panel, ed) {
                                        $panel.append('<div class="zedity-shadowwrapper" style="width:250px">' + '<div class="zedity-slider zedity-slidershadowhorizontal" data-prop="horizontal" data-min="-100" data-max="100" data-label="' + Zedity.t('Horizontal position') + '" title="' + Zedity.t('Select shadow horizontal position') + '"></div>' + '<div class="zedity-slider zedity-slidershadowvertical" data-prop="vertical" data-min="-100" data-max="100" data-label="' + Zedity.t('Vertical position') + '" title="' + Zedity.t('Select shadow vertical position') + '"></div>' + '<div class="zedity-slider zedity-slidershadowblur" data-prop="blur" data-min="0" data-max="100" data-label="' + Zedity.t('Blur') + '" title="' + Zedity.t('Select shadow blur') + '"></div>' + '<div class="zedity-slider zedity-slidershadowspread" data-prop="spread" data-min="-100" data-max="100" data-label="' + Zedity.t('Spread') + '" title="' + Zedity.t('Select shadow spread') + '"></div>' + '</div><span class="zedity-button zedity-btnShadowInset">' + Zedity.t('Inset') + '</span>');
                                        $panel.find('.zedity-btnShadowInset').attr('title', Zedity.t('Shadow inset')).on('click.zedity', function() {
                                            var box = ed.boxes.selected();
                                            if (!box) return;
                                            var $this = $(this);
                                            $this.toggleClass('zedity-checked');
                                            box.shadow({
                                                inset: $this.hasClass('zedity-checked')
                                            })
                                        });
                                        $panel.find('.zedity-slider').each(function(idx, elem) {
                                            var $this = $(this);
                                            $this.sliderSnap({
                                                label: $this.attr('data-label'),
                                                min: parseInt($this.attr('data-min')),
                                                max: parseInt($this.attr('data-max')),
                                                value: 0,
                                                slide: function(event, ui) {
                                                    var box = ed.boxes.selected();
                                                    if (!box) return;
                                                    var prop = {};
                                                    prop[$this.attr('data-prop')] = ui.value;
                                                    Zedity.core._call(box, 'shadow', prop)
                                                },
                                                stop: function(event, ui) {
                                                    ed._changed()
                                                }
                                            })
                                        })
                                    }
                                }
                            },
                            refresh: function(ed, box) {
                                if (!box) return;
                                var s = box.shadow();
                                var $p = this.$panel.find('.zedity-extpanel-button[data-name=shadow]').extpanel('instance').panel;
                                $p.find('.zedity-slidershadowhorizontal').sliderSnap('value', s.horizontal);
                                $p.find('.zedity-slidershadowvertical').sliderSnap('value', s.vertical);
                                $p.find('.zedity-slidershadowblur').sliderSnap('value', s.blur);
                                $p.find('.zedity-slidershadowspread').sliderSnap('value', s.spread);
                                $p.find('.zedity-btnShadowInset').toggleClass('zedity-checked', s.inset);
                                this.$panel.find('.zedity-colorselector').colorPicker('selectcolor', s.color)
                            }
                        }
                    }
                }
            },
            build: function(ed) {
                Zedity.core.patch(ed.menu._feature('boxstyle', 'background', 'color'), 'refresh', this._data.enableCpButtons);
                Zedity.core.patch(ed.menu._feature('boxstyle', 'border', 'color'), 'refresh', this._data.enableCpButtons)
            }
        }, 'boxcommercial')
    };
    $.extend(Zedity.Box.prototype, {
        align: function(align) {
            if (!align) return;
            switch (align) {
                case 'left':
                    this.$this.css('left', 0);
                    break;
                case 'center':
                    this.$this.css('left', (this.editor.page.size().width / 2) - (this.$this.outerWidth() / 2));
                    break;
                case 'right':
                    this.$this.css('left', this.editor.page.size().width - this.$this.outerWidth());
                    break;
                case 'top':
                    this.$this.css('top', 0);
                    break;
                case 'middle':
                    this.$this.css('top', (this.editor.page.size().height / 2) - (this.$this.outerHeight() / 2));
                    break;
                case 'bottom':
                    this.$this.css('top', this.editor.page.size().height - this.$this.outerHeight());
                    break
            }
            this.editor.boxes.refreshSelected();
            this.editor._changed()
        },
        fitToPage: function(side, aspectratio) {
            if (aspectratio == null) aspectratio = this.proportionalResize();
            if (!side) return;
            var ps = this.editor.page.size();
            var bs = {
                width: this.$this.width(),
                height: this.$this.height()
            };
            bs.widthd = this.$this.outerWidth() - bs.width;
            bs.heightd = this.$this.outerHeight() - bs.height;
            var r = ps[side] / bs[side];
            this.$this.css(side, Math.round(bs[side] * r) - bs[side + 'd']);
            switch (side) {
                case 'width':
                    this.align('left');
                    if (aspectratio) this.$this.css('height', Math.round(bs.height * r) - bs.heightd);
                    break;
                case 'height':
                    this.align('top');
                    if (aspectratio) this.$this.css('width', Math.round(bs.width * r) - bs.widthd);
                    break
            }
            this._resize();
            this.editor.boxes.refreshSelected();
            this.editor._changed()
        },
        shadow: function(shadow) {
            if (shadow) {
                var curshadow = this.shadow();
                this.$this.attr('style', (this.$this.attr('style') || '').replace(/box-shadow\s*?:.*?;/g, ''));
                if (shadow == 'none') {
                    this.editor._changed();
                    return
                }
                shadow = $.extend(curshadow, shadow);
                if (shadow.horizontal == 0 && shadow.vertical == 0 && shadow.blur == 0 && shadow.spread == 0 && !shadow.inset) return;
                var css = 'box-shadow:' + (shadow.inset ? 'inset ' : '') + shadow.horizontal + 'px ' + shadow.vertical + 'px ' + shadow.blur + 'px ' + shadow.spread + 'px ' + shadow.color + ';';
                this.$this.attr('style', this.$this.attr('style') + ';' + css);
                this.editor._changed();
                return shadow
            } else {
                var s = (this.$this.attr('style') || '').toLowerCase();
                if (s.indexOf('box-shadow') == -1) {
                    return {
                        horizontal: 0,
                        vertical: 0,
                        blur: 0,
                        spread: 0,
                        inset: false,
                        color: '#000000'
                    }
                }
                s = s.replace(/.*?box-shadow:\s*(.*?);.*/, '$1').replace(/, /g, ',');
                s = s.split(' ');
                for (var i = 5; i > s.length; --i) s.push('0px');
                for (i = 0; i < 4; ++i)
                    if (s[i].indexOf('#') > -1 || s[i].indexOf('rgb') > -1) {
                        var el = s.splice(i, 1);
                        s.push(el[0]);
                        i--
                    }
                for (i = 0; i < s.length - 1; ++i)
                    if (s[i] == 'inset') {
                        el = s.splice(i, 1);
                        s.push(el[0]);
                        i--
                    }
                return {
                    horizontal: parseInt(s[0]),
                    vertical: parseInt(s[1]),
                    blur: parseInt(s[2]),
                    spread: parseInt(s[3]),
                    inset: !!(s[5] && (s[5] == 'inset')),
                    color: s[4]
                }
            }
        }
    })
})(jQuery);
(function($) {
    if (!Zedity) throw new Error(Zedity.t('%s needs %s.', 'Zedity.ContextMenu', 'Zedity'));
    Zedity.ContextMenu = function(options) {
        this.editor = options.editor;
        var menu = '<ul class="zedity-contextmenu ui-state-active">';
        for (var i = 0, len = Zedity.Box.types.length; i < len; ++i) {
            menu += '<li class="zedity-menu-AddBox" data-boxtype="' + Zedity.Box.types[i] + '"><span class="zicon zicon-size-xs zicon-' + Zedity.Box.types[i].toLowerCase() + '"></span> ' + Zedity.t('Add %s box', Zedity.t(Zedity.Box.types[i])) + '</li>'
        }
        menu += '<li class="zedity-menu-EditBox zedity-menu-SelArrangeMain"><span class="zicon zicon-size-xs zicon-arrange"></span> ' + Zedity.t('Arrange') + '' + '<ul>' + '<li class="zedity-menu-SelArrange" data-type="front"><span class="zicon zicon-size-xs zicon-arrange-front"></span> ' + Zedity.t('Bring to front') + '</li>' + '<li class="zedity-menu-SelArrange" data-type="back"><span class="zicon zicon-size-xs zicon-arrange-back"></span> ' + Zedity.t('Send to back') + '</li>' + '<li class="zedity-menu-SelArrange" data-type="forward"><span class="zicon zicon-size-xs zicon-arrange-forward"></span> ' + Zedity.t('Bring forward') + '</li>' + '<li class="zedity-menu-SelArrange" data-type="backward"><span class="zicon zicon-size-xs zicon-arrange-backward"></span> ' + Zedity.t('Send backward') + '</li>' + '</ul>' + '</li>' + '<li class="zedity-menu-EditBox zedity-menu-SelFlipMain"><span class="zicon zicon-size-xs zicon-flip zicon-rotate-90"></span> ' + Zedity.t('Flip') + '' + '<ul>' + '<li class="zedity-menu-SelFlip" data-type="horizontal"><span class="zicon zicon-size-xs zicon-flip zicon-rotate-90"></span> ' + Zedity.t('Horizontal') + '</li>' + '<li class="zedity-menu-SelFlip" data-type="vertical"><span class="zicon zicon-size-xs zicon-flip"></span> ' + Zedity.t('Vertical') + '</li>' + '</ul>' + '</li>' + '<li class="zedity-menu-EditBox zedity-menu-SelAsBg"><span class="zicon zicon-size-xs zicon-expand"></span> ' + Zedity.t('Set as background') + '</li>' + '<li class="zedity-menu-EditBox zedity-menu-SelDuplicate"><span class="zicon zicon-size-xs zicon-duplicate"></span> ' + Zedity.t('Duplicate') + '</li>' + '<li class="zedity-menu-EditBox ui-state-disabled zedity-separator"></li>' + '<li class="zedity-menu-EditBox zedity-menu-SelDelete"><span class="zicon zicon-size-xs zicon-delete"></span> ' + Zedity.t('Delete') + '</li>' + '</ul>';
        this.$this = $(menu);
        this.$this.appendTo('body');
        this.$this.menuZedity().hide().menuZedity('option', {
            position: {
                my: 'left top',
                at: 'right top'
            }
        });
        this.$this.on('mouseleave.zedity', $.proxy(function() {
            this.$this.menuZedity('collapseAll', null, true).hide()
        }, this));
        this.editor.$container.on('contextmenu.zedity', $.proxy(function(event) {
            var box = $(event.target).box();
            if (box && box.$this.is('.zedity-editing,.zedity-mlrd-hidden')) return;
            var ok = (box !== null && !box.asBackground());
            if (ok) box.select();
            this.$this.find('.zedity-menu-EditBox').toggle(ok && box.editor.boxes.selected() != null);
            this.$this.find('.zedity-menu-AddBox').toggle($(event.target).is(this.editor.$this) || (box !== null && box.asBackground()));
            this.$this.find('.zedity-menu-AlignBox').toggle(ok && !this.editor.boxes.selected());
            this.refresh();
            this.$this.css({
                left: event.pageX,
                top: event.pageY
            }).show();
            if (this.$this.find(':visible').length == 0) this.$this.hide();
            return false
        }, this));
        var ed = this.editor;
        this.$this.find('.zedity-menu-AddBox').on('click.zedity', function(event) {
            var $this = $(this);
            ed.contextMenu.close();
            ed.boxes.add($this.attr('data-boxtype'), {
                x: parseInt(ed.contextMenu.$this.css('left'), 10) - ed.$this.offset().left,
                y: parseInt(ed.contextMenu.$this.css('top'), 10) - ed.$this.offset().top
            });
            return
        });
        this.$this.find('.zedity-menu-SelArrange').on('click.zedity', function(event) {
            ed.contextMenu.close();
            var box = ed.boxes.selected();
            if (box) box.arrange($(this).attr('data-type'));
            return
        });
        this.$this.find('.zedity-menu-SelFlip').on('click.zedity', function(event) {
            ed.contextMenu.close();
            var box = ed.boxes.selected();
            if (box) box.flip($(this).attr('data-type'));
            return
        });
        this.$this.find('.zedity-menu-SelAsBg').on('click.zedity', function(event) {
            ed.contextMenu.close();
            var box = ed.boxes.selected();
            if (box) box.asBackground(!box.asBackground());
            ed.menu.refresh('editbox', 'layout', 'background');
            return
        });
        this.$this.find('.zedity-menu-SelDuplicate').on('click.zedity', function(event) {
            ed.contextMenu.close();
            var box = ed.boxes.selected();
            if (box) box.duplicate();
            return
        });
        this.$this.find('.zedity-menu-SelDelete').on('click.zedity', function(event) {
            ed.contextMenu.close();
            var box = ed.boxes.selected();
            if (box) box.remove();
            return
        })
    };
    $.extend(Zedity.ContextMenu.prototype, {
        close: function() {
            this.$this.menuZedity('collapseAll', null, true).hide();
            return this
        },
        refresh: function() {
            var box = this.editor.boxes.selected();
            this.$this.find('.zedity-menu-Selection').toggleClass('ui-state-disabled', !box);
            if (box) {
                this.$this.find('.zedity-menu-SelFlip,.zedity-menu-SelFlipMain').toggleClass('ui-state-disabled', !box.can('flip'));
                this.$this.find('.zedity-menu-SelAsBg').toggleClass('ui-state-disabled', !box.can('asBackground'));
                this.$this.find('.zedity-menu-SelAsBg a').html(box.asBackground() ? '<span class="zedity-menu-icon zedity-icon-contract"></span> ' + Zedity.t('Unset from background') : '<span class="zedity-menu-icon zedity-icon-expand"></span> ' + Zedity.t('Set as background'));
                this.$this.find('.zedity-menu-SelArrangeMain').toggleClass('ui-state-disabled', box.asBackground());
                this.$this.find('.zedity-menu-SelDuplicate').toggleClass('ui-state-disabled', box.asBackground())
            }
            return this
        }
    })
})(jQuery);
(function($) {
    var old_constructor = Zedity.ContextMenu;
    var old_prototype = Zedity.ContextMenu.prototype;
    Zedity.ContextMenu = function(options) {
        old_constructor.call(this, options);
        var ed = this.editor;
        this.$this.menuZedity('destroy');
        this.$this.find('.zedity-menu-SelArrangeMain').after('<li class="zedity-menu-EditBox"><span class="zicon zicon-size-xs zicon-align"></span> ' + Zedity.t('Align to page') + '<ul>' + '<li class="zedity-menu-AlignPage" data-type="left"><span class="zicon zicon-size-xs zicon-empty"></span> ' + Zedity.t('Align left') + '</li>' + '<li class="zedity-menu-AlignPage" data-type="center"><span class="zicon zicon-size-xs zicon-empty"></span> ' + Zedity.t('Align center') + '</li>' + '<li class="zedity-menu-AlignPage" data-type="right"><span class="zicon zicon-size-xs zicon-empty"></span> ' + Zedity.t('Align right') + '</li>' + '<li class="zedity-menu-AlignPage" data-type="top"><span class="zicon zicon-size-xs zicon-empty"></span> ' + Zedity.t('Align top') + '</li>' + '<li class="zedity-menu-AlignPage" data-type="middle"><span class="zicon zicon-size-xs zicon-empty"></span> ' + Zedity.t('Align middle') + '</li>' + '<li class="zedity-menu-AlignPage" data-type="bottom"><span class="zicon zicon-size-xs zicon-empty"></span> ' + Zedity.t('Align bottom') + '</li>' + '<li class="ui-state-disabled zedity-separator"></li>' + '<li class="zedity-menu-FitPage" data-type="width"><span class="zicon zicon-size-xs zicon-empty"></span> ' + Zedity.t('Fit width') + '</li>' + '<li class="zedity-menu-FitPage" data-type="height"><span class="zicon zicon-size-xs zicon-empty"></span> ' + Zedity.t('Fit height') + '</li>' + '</ul>' + '</li>');
        this.$this.append('<li class="zedity-menu-AlignBox" data-type="left"><span class="zicon zicon-size-xs zicon-empty"></span> ' + Zedity.t('Align left') + '</li>' + '<li class="zedity-menu-AlignBox" data-type="center"><span class="zicon zicon-size-xs zicon-empty"></span> ' + Zedity.t('Align center') + '</li>' + '<li class="zedity-menu-AlignBox" data-type="right"><span class="zicon zicon-size-xs zicon-empty"></span> ' + Zedity.t('Align right') + '</li>' + '<li class="zedity-menu-AlignBox" data-type="top"><span class="zicon zicon-size-xs zicon-empty"></span> ' + Zedity.t('Align top') + '</li>' + '<li class="zedity-menu-AlignBox" data-type="middle"><span class="zicon zicon-size-xs zicon-empty"></span> ' + Zedity.t('Align middle') + '</li>' + '<li class="zedity-menu-AlignBox" data-type="bottom"><span class="zicon zicon-size-xs zicon-empty"></span> ' + Zedity.t('Align bottom') + '</li>');
        this.$this.menuZedity().hide().menuZedity('option', {
            position: {
                my: 'left top',
                at: 'right top'
            }
        });
        this.$this.find('.zedity-menu-AlignPage').on('click.zedity', function(event) {
            ed.contextMenu.close();
            var box = ed.boxes.selected();
            if (box) box.align($(this).attr('data-type'));
            return
        });
        this.$this.find('.zedity-menu-FitPage').on('click.zedity', function(event) {
            ed.contextMenu.close();
            var box = ed.boxes.selected();
            if (box) box.fitToPage($(this).attr('data-type'));
            return
        });
        this.$this.find('.zedity-menu-AlignBox').on('click.zedity', function(event) {
            ed.contextMenu.close();
            ed.boxes.align($(this).attr('data-type'));
            return
        })
    };
    Zedity.ContextMenu.prototype = old_prototype
})(jQuery);
(function($) {
    Zedity.utils = Zedity.utils || {};
    Zedity.utils.dec2hex = function(num, padding) {
        num = Number(num);
        if (num < 0) num = 0xffffffff + num + 1;
        padding = padding == null ? 2 : padding;
        return (new Array(padding).join('0') + num.toString(16)).substr(-padding)
    };
    Zedity.utils.rgb2hash = function(color) {
        if (!color) return undefined;
        if (!isNaN(color)) return color;
        color = $.trim(color);
        var rgb, match;
        if (color.indexOf('rgba') != -1) {
            rgb = /rgba\s*\((.*)\s*,\s*(.*)\s*,\s*(.*)\s*,\s*(.*)\s*\)/i;
            match = rgb.exec(color);
            if (match && match.length == 5) {
                if (match[1] == '0' && match[2] == '0' && match[3] == '0' && match[4] == '0') {
                    return 'transparent'
                } else {
                    return '#' + this.dec2hex(match[1]) + this.dec2hex(match[2]) + this.dec2hex(match[3])
                }
            }
        }
        if (color.indexOf('rgb') != -1) {
            rgb = /rgb\s*\((.*)\s*,\s*(.*)\s*,\s*(.*)\s*\)/i;
            match = rgb.exec(color);
            if (match && match.length == 4) return '#' + this.dec2hex(match[1]) + this.dec2hex(match[2]) + this.dec2hex(match[3])
        }
        return color
    };
    Zedity.utils.rgba2alpha = function(color) {
        if (!color) return undefined;
        if (!isNaN(color)) return undefined;
        if (color.indexOf('rgb') == -1) return undefined;
        if (color.indexOf('#') > -1) return 1;
        var rgba = /rgba\s*\((.*)\s*,\s*(.*)\s*,\s*(.*)\s*,\s*(.*)\s*\)/i;
        if (color.indexOf('rgba') != -1) {
            var match = rgba.exec(color);
            if (match && match.length == 5) {
                return match[4]
            }
        } else {
            return 1
        }
        return undefined
    };
    Zedity.utils.hash2rgba = function(hash, alpha) {
        if (typeof(hash) != 'string' || hash.charAt(0) != '#') return hash;
        var hex = parseInt(hash.substring(1), 16);
        if (alpha === undefined || alpha < 0 || alpha > 1) alpha = 1;
        return 'rgba(' + ((hex & 0xff0000) >> 16) + ',' + ((hex & 0x00ff00) >> 8) + ',' + (hex & 0x0000ff) + ',' + alpha + ')'
    };
    Zedity.utils.hash2rgb = function(hash) {
        if (typeof(hash) != 'string' || hash.charAt(0) != '#') return hash;
        var hex = parseInt(hash.substring(1), 16);
        return 'rgb(' + ((hex & 0xff0000) >> 16) + ',' + ((hex & 0x00ff00) >> 8) + ',' + (hex & 0x0000ff) + ')'
    }
})(jQuery);
(function($) {
    $.fn.colorPicker = function(method) {
        var methods = {
            init: function(options) {
                var settings = {
                    colors: ['#ffffff', '#c0c0c0', '#808080', '#000000', '#ff0000', '#800000', '#ffff00', '#808000', '#00ff00', '#008000', '#00ffff', '#008080', '#0000ff', '#000080', '#ff00ff', '#800080'],
                    defaultcolor: 0,
                    fills: false,
                    alpha: false,
                    buttons: false,
                    onchange: function(event, color, fill, alpha) {},
                    onchangealpha: function(event, alpha) {},
                    boxwidth: 18,
                    maxcols: 0
                };
                if (options) $.extend(settings, options);
                settings.fills = Zedity.core.supports.gradient() ? settings.fills : false;
                return this.each(function() {
                    var $cp = $(this);
                    $cp.data('colorPicker', {
                        colors: settings.colors,
                        onchange: settings.onchange,
                        fills: settings.fills,
                        alpha: settings.alpha
                    });
                    var colors = '';
                    for (var i = 0; i < settings.colors.length; i++) {
                        var clear = ((i % settings.maxcols) == 0 ? ';clear:both' : '');
                        var check = (i == settings.defaultcolor ? ' zedity-check' : '');
                        if (settings.colors[i] == 'transparent') {
                            colors += '<div class="zedity-color transparent' + check + '" style="width:' + settings.boxwidth + 'px;height:' + settings.boxwidth + 'px' + clear + '">' + '<a href="javascript:void(0)" title="transparent">&nbsp;&nbsp;&nbsp;</a>' + '</div>'
                        } else {
                            colors += '<div class="zedity-color' + check + '" style="width:' + settings.boxwidth + 'px;height:' + settings.boxwidth + 'px;background-color:' + settings.colors[i] + clear + '">' + '<a href="javascript:void(0)" title="' + settings.colors[i] + '">&nbsp;&nbsp;&nbsp;</a>' + '</div>'
                        }
                    }
                    var colorbuttons = '';
                    if (settings.buttons) {
                        colorbuttons = '<div class="zedity-colorbuttons">' + '<span title="' + Zedity.t('Click to set Hex color') + '" class="zedity-colorbtnhex zedity-button"></span>' + '<span title="' + Zedity.t('Click to set RGB color') + '" class="zedity-colorbtnrgb zedity-button"></span>' + '</div>'
                    }
                    var colortype = '';
                    if (settings.fills) {
                        colortype = '<div class="zedity-colortype">' + '<select class="zedity-colortype">' + '<option value="solid" class="zedity-solid">' + Zedity.t('Solid color') + '</option>' + '<option value="horizontal" class="zedity-horizontal">' + Zedity.t('Horiz. gradient') + '</option>' + '<option value="vertical" class="zedity-vertical">' + Zedity.t('Vert. gradient') + '</option>' + '<option value="radial" class="zedity-radial">' + Zedity.t('Radial gradient') + '</option>' + '</select>' + '<span class="zedity-colorbtn zedity-color1 zedity-selected' + (settings.colors[settings.defaultcolor || 0] == 'transparent' ? ' transparent' : '') + '" style="background-color:' + settings.colors[settings.defaultcolor || 0] + '"></span>' + '<span class="zedity-gradient zedity-ctpnl" style="display:none">' + '<span class="zedity-colorbtn zedity-color2"></span>' + '</span>' + '</div>'
                    }
                    var coloralpha = '';
                    if (settings.alpha) {
                        coloralpha = '<div class="zedity-coloralpha"><div class="zedity-slideralpha" title="' + Zedity.t('Select color opacity') + '"></div></div>'
                    }
                    $cp.append('<div class="zedity-colorpicker">' + colortype + coloralpha + colorbuttons + '<div class="zedity-colors">' + colors + '</div>' + '</div>');
                    var $color = $cp.find('.zedity-colorpicker div.zedity-color');
                    $color.each(function(idx) {
                        $(this).children('a').on('click.colorPicker', function(event) {
                            $color.removeClass('zedity-check');
                            $(this).parent().addClass('zedity-check');
                            $cp.colorPicker('selectcolor', settings.colors[idx], true);
                            return false
                        })
                    });
                    if (settings.fills) {
                        $cp.find('select.zedity-colortype').on('change.colorPicker', function(event, onlyui) {
                            var $gr = $cp.find('.zedity-gradient');
                            if ($(this).val() != 'solid') {
                                $gr.show()
                            } else {
                                $gr.hide();
                                $cp.find('.zedity-colortype .zedity-colorbtn').removeClass('zedity-selected');
                                $cp.find('.zedity-colortype .zedity-colorbtn.zedity-color1').addClass('zedity-selected')
                            }
                            if (onlyui) return false;
                            if (typeof(settings.onchange) == 'function') {
                                var color = $cp.colorPicker('getcolor');
                                var fill = $cp.colorPicker('getfill');
                                var alpha = $cp.colorPicker('getalpha');
                                settings.onchange.call($cp[0], event, color, fill, alpha)
                            }
                        })
                    }
                    if (settings.buttons) {
                        $cp.find('.zedity-colorbtnhex').on('click.zedity', function() {
                            var color = $cp.colorPicker('getcolor');
                            Zedity.core.dialog({
                                title: Zedity.t('Set custom color (Hex)'),
                                default: color,
                                question: Zedity.t('Please enter the color in hex format, e.g. %s', '#F31267'),
                                mandatory: Zedity.t('You must enter a color.'),
                                ok: function(answer) {
                                    if (answer != 'transparent' && answer.indexOf('#') == -1) answer = '#' + answer;
                                    $cp.colorPicker('selectcolor', answer, true)
                                }
                            })
                        });
                        $cp.find('.zedity-colorbtnrgb').on('click.zedity', function() {
                            var color = $cp.colorPicker('getcolor');
                            Zedity.core.dialog({
                                title: Zedity.t('Set custom color (RGB)'),
                                default: Zedity.utils.hash2rgb(color).replace('rgb(', '').replace(')', ''),
                                question: Zedity.t('Please enter the color in RGB format, with comma-separated components, e.g. %s', '240,18,103'),
                                mandatory: Zedity.t('You must enter a color.'),
                                ok: function(answer) {
                                    if (answer != 'transparent') answer = 'rgb(' + answer + ')';
                                    $cp.colorPicker('selectcolor', Zedity.utils.rgb2hash(answer), true)
                                }
                            })
                        })
                    }
                    if (settings.alpha) {
                        $cp.find('.zedity-slideralpha').sliderSnap({
                            label: Zedity.t('Opacity'),
                            value: 100,
                            min: 0,
                            max: 100,
                            slide: function(event, ui) {
                                if (typeof(settings.onchangealpha) == 'function') {
                                    settings.onchangealpha.call($cp[0], event, ui.value / 100)
                                }
                            },
                            change: function(event, ui) {
                                if (!event.originalEvent) return false;
                                if (typeof(settings.onchange) == 'function') {
                                    var color = $cp.colorPicker('getcolor');
                                    var fill = $cp.colorPicker('getfill');
                                    settings.onchange.call($cp[0], event, color, fill, ui.value / 100)
                                }
                            }
                        })
                    }
                    $cp.find('.zedity-colortype .zedity-colorbtn').on('click.colorPicker', function(event) {
                        $cp.find('.zedity-colortype .zedity-colorbtn').removeClass('zedity-selected');
                        var $this = $(this);
                        $this.addClass('zedity-selected');
                        $cp.colorPicker('selectcolor', $this.css('background-color'))
                    })
                });
                return this
            },
            getcolor: function() {
                var data = $(this).data('colorPicker');
                return data.selected
            },
            getfill: function() {
                var $cp = $(this);
                var data = $cp.data('colorPicker');
                if (!data.fills) {
                    return {
                        type: 'solid',
                        alpha: $cp.colorPicker('getalpha'),
                        colors: [$cp.colorPicker('getcolor')]
                    }
                }
                var fill = {
                    type: $cp.find('select.zedity-colortype').val(),
                    alpha: $cp.colorPicker('getalpha'),
                    colors: []
                };
                fill.colors.push(Zedity.utils.rgb2hash($cp.find('.zedity-colortype .zedity-color1').css('background-color')));
                if ($cp.find('select.zedity-colortype').val() != 'solid') {
                    fill.colors.push(Zedity.utils.rgb2hash($cp.find('.zedity-colortype .zedity-color2').css('background-color')))
                }
                return fill
            },
            getalpha: function() {
                var $cp = $(this);
                var data = $cp.data('colorPicker');
                if (!data.alpha) return 1;
                return $cp.find('.zedity-slideralpha').sliderSnap('option', 'value') / 100
            },
            refresh: function() {
                var $cp = $(this);
                var color = $cp.colorPicker('getcolor');
                $cp.find('.zedity-colorbtnhex').text(color);
                $cp.find('.zedity-colorbtnrgb').text(Zedity.utils.hash2rgb(color));
                $cp.find('.zedity-colortype .zedity-colorbtn.zedity-selected').css('background-color', color).toggleClass('transparent', color == 'transparent')
            },
            selectcolor: function(color, triggerevent) {
                return this.each(function() {
                    var $cp = $(this);
                    var data = $cp.data('colorPicker');
                    var alpha = undefined;
                    var c = '';
                    if (color != parseInt(color)) {
                        var $fc = $('<div/>').css('color', color);
                        color = $fc.css('color');
                        if (color.indexOf('rgb') > -1) {
                            if (color.indexOf('rgba') > -1) {
                                alpha = Zedity.utils.rgba2alpha(color)
                            }
                            c = Zedity.utils.rgb2hash(color);
                            color = data.colors.indexOf(c)
                        } else if (color.charAt(0) == '#' || color == 'transparent') {
                            c = color;
                            color = data.colors.indexOf(c)
                        } else {
                            return
                        }
                    }
                    if (color != -1) c = data.colors[color];
                    $cp.find('.zedity-colorpicker div.zedity-color').removeClass('zedity-check');
                    if (alpha != undefined && c != 'transparent') $cp.colorPicker('selectalpha', alpha);
                    if (c == 'transparent') $cp.colorPicker('selectalpha', 1);
                    if (color >= 0 && color < data.colors.length) {
                        $cp.find('.zedity-colorpicker div.zedity-color:nth-child(' + (color + 1) + ')').addClass('zedity-check')
                    }
                    data.selected = c;
                    $cp.colorPicker('refresh');
                    if (triggerevent) {
                        if (typeof(data.onchange) == 'function') {
                            var fill = $cp.colorPicker('getfill');
                            var alpha = $cp.colorPicker('getalpha');
                            data.onchange.call($cp[0], null, c, fill, alpha)
                        }
                    }
                })
            },
            selectfill: function(fill, triggerevent) {
                return this.each(function() {
                    if (!fill) return;
                    var $cp = $(this);
                    var data = $cp.data('colorPicker');
                    if (!data.fills) return;
                    fill.colors = fill.colors || ['#000000'];
                    fill.colors = [].concat(fill.colors);
                    fill.type = fill.type || (fill.colors.length == 1 ? 'solid' : 'horizontal');
                    fill.alpha = ('alpha' in fill ? fill.alpha : 1);
                    $cp.find('.zedity-color1').css('background-color', fill.colors[0]).toggleClass('transparent', fill.colors[0] == 'transparent');
                    if (fill.type != 'solid') {
                        $cp.find('.zedity-color2').css('background-color', fill.colors[1]).toggleClass('transparent', fill.colors[1] == 'transparent')
                    }
                    $cp.find('select.zedity-colortype').val(fill.type).trigger('change.colorPicker', [true]);
                    $cp.find('div.zedity-colortype .zedity-color1').trigger('click.colorPicker');
                    if (data.alpha) {
                        $cp.find('.zedity-slideralpha').sliderSnap('option', 'value', Math.round(fill.alpha * 100))
                    }
                    if (triggerevent) {
                        $cp.find('select.zedity-colortype').trigger('change.colorPicker')
                    }
                })
            },
            selectalpha: function(alpha, triggerevent) {
                var $cp = $(this);
                var data = $cp.data('colorPicker');
                alpha = alpha <= 1 ? Math.round(alpha * 100) : alpha;
                var $slider = $cp.find('.zedity-slideralpha');
                $slider.sliderSnap('option', 'value', alpha);
                if (triggerevent) {
                    $slider.trigger('change')
                }
            },
            destroy: function() {
                return this.each(function() {
                    var $cp = $(this);
                    $cp.data('colorPicker').target.remove();
                    $cp.off('.colorPicker');
                    $cp.removeData('colorPicker')
                })
            }
        };
        if (methods[method]) {
            return methods[method].apply(this, Array.prototype.slice.call(arguments, 1))
        } else if (typeof method === 'object' || !method) {
            return methods.init.apply(this, arguments)
        } else {
            $.error(Zedity.t('Method %s does not exist on %s.', method, 'jQuery.colorPicker'))
        }
    };
    $.fn.fontSelector = function(method) {
        var fonts = ['Arial,Helvetica,sans-serif', 'Arial Black,Gadget,sans-serif', 'Arial Narrow,sans-serif', 'Century Gothic,sans-serif', 'Comic Sans MS,cursive', 'Copperplate Gothic Light,sans-serif', 'Courier New,Courier,monospace', 'Georgia,serif', 'Gill Sans,sans-serif', 'Impact,Charcoal,sans-serif', 'Lucida Console,Monaco,monospace', 'Lucida Sans Unicode,Lucida Grande,sans-serif', 'Palatino Linotype,Book Antiqua,Palatino,serif', 'Tahoma,Geneva,sans-serif', 'Times New Roman,Times,serif', 'Trebuchet MS,Helvetica,sans-serif', 'Verdana,Geneva,sans-serif'];
        var sizes = ['11', '12', '14', '16', '19', '21', '24', '27', '29', '32', '37', '48', '53', '64'];
        var colors = ['#ffffff', '#f2f2f2', '#d8d8d8', '#bdbdbd', '#a4a4a4', '#6e6e6e', '#424242', '#2e2e2e', '#000000', '#fbefef', '#f8e0e0', '#f5a9a9', '#f78181', '#fe2e2e', '#df0101', '#b40404', '#8a0808', '#3b0b0b', '#fbf5ef', '#f8ece0', '#f5d0a9', '#faac58', '#ff8000', '#df7401', '#b45f04', '#8a4b08', '#3b240b', '#fbfbef', '#f5f6ce', '#f2f5a9', '#f4fa58', '#ffff00', '#d7df01', '#aeb404', '#868a08', '#393b0b', '#f5fbef', '#e3f6ce', '#d0f5a9', '#acfa58', '#80ff00', '#74df00', '#5fb404', '#4b8a08', '#38610b', '#effbef', '#cef6ce', '#a9f5a9', '#58fa58', '#00ff00', '#01df01', '#04b404', '#088a08', '#0b3b0b', '#effbfb', '#cef6f5', '#a9f5f2', '#58faf4', '#00ffff', '#01dfd7', '#04b4ae', '#088a85', '#0b3b39', '#eff5fb', '#cee3f6', '#81bef7', '#2e9afe', '#0080ff', '#045fb4', '#084b8a', '#08388a', '#0b243b', '#efeffb', '#cecef6', '#5858fa', '#2e2efe', '#0000ff', '#0404b4', '#08088a', '#0b0b61', '#0b0b3b', '#f5effb', '#e3cef6', '#be81f7', '#ac58fa', '#9a2efe', '#5f04b4', '#4b088a', '#380b61', '#240b3b', '#fbeffb', '#f6cef5', '#f781f3', '#fe2ef7', '#ff00ff', '#df01d7', '#b404ae', '#610b5e', '#3b0b39', '#fbeff5', '#f6cee3', '#f5a9d0', '#fa58ac', '#ff0080', '#df0174', '#b4045f', '#610b38', '#3b0b24'];
        var methods = {
            init: function(options) {
                var settings = {
                    order: 'font,size,style,color',
                    fonts: fonts,
                    sizes: sizes,
                    colors: colors,
                    colorButtons: false,
                    defaultfont: fonts[0],
                    defaultsize: sizes[3],
                    defaultstyle: {
                        bold: false,
                        italic: false,
                        underline: false
                    },
                    onchange: function(event) {},
                    onchangefont: function(font) {},
                    onchangesize: function(size) {},
                    onchangestyleB: function(style) {},
                    onchangestyleI: function(style) {},
                    onchangestyleU: function(style) {},
                    onchangestyleS: function(style) {},
                    onchangestyleSub: function(style) {},
                    onchangestyleSup: function(style) {},
                    onchangecolor: function(event, color) {}
                };
                if (options) $.extend(settings, options);
                return this.each(function() {
                    var $sel = $('<div class="zedity-fontselector"/>').appendTo(this);
                    $sel.data('fontSelector', {
                        fonts: settings.fonts,
                        sizes: settings.sizes,
                        defaultsize: settings.defaultsize,
                        onchange: settings.onchange
                    });
                    var $fontfaceselector;
                    var $fontsizeselector1;
                    var $fontsizeselector2;
                    var $fontstyleselector;
                    var $fontsubsupselector;
                    $.each(settings.order.split(','), function(i, item) {
                        switch (item) {
                            case 'font':
                                var id_ffs = Zedity.core.genId('zedity-ffs');
                                var tempsel = '<div class="zedity-fontfaceselector zedity-button zedity-ddmenu zedity-menu" style="float:left;width:200px" data-ddmenu="#' + id_ffs + '"><span><a href="javascript:;"></a></span></div>' + '<ul id="' + id_ffs + '" class="zedity-ffs-menu zedity-propbar-menu">';
                                var tempcss = '';
                                for (var i = 0, len = settings.fonts.length; i < len; ++i) {
                                    var tempclass = 'fontface' + i + 'class';
                                    tempsel += '<li class="zedity-fontface ' + tempclass + '" data-value="' + settings.fonts[i] + '"><a href="javascript:;">' + settings.fonts[i].split(',')[0] + '</a></li>';
                                    tempcss += '.' + tempclass + '{font-family:' + settings.fonts[i] + ' !important}'
                                }
                                tempsel += '</ul>';
                                $sel.append(tempsel);
                                if ($('#zedity-fontselectorFontsCss').length == 0) $('head').prepend('<style id="zedity-fontselectorFontsCss" type="text/css">' + tempcss + '</style>');
                                $fontfaceselector = $sel.find('.zedity-fontfaceselector');
                                $fontfaceselector.ddmenu({
                                    onchange: function(value) {
                                        if (typeof settings.onchange == 'function') settings.onchange.call($sel[0]);
                                        if (typeof settings.onchangefont == 'function') settings.onchangefont.call($sel[0], value)
                                    }
                                });
                                break;
                            case 'size':
                                var id_fss = Zedity.core.genId('zedity-fss');
                                var tempsel = '<div class="zedity-fontsizeselector1 zedity-button zedity-ddmenu zedity-menu" style="float:left;width:55px" data-ddmenu="#' + id_fss + '"><span><a href="javascript:;"></a></span></div>' + '<ul id="' + id_fss + '" class="zedity-fss-menu zedity-propbar-menu">';
                                for (var i = 0, len = settings.sizes.length; i < len; ++i) {
                                    tempsel += '<li data-value="' + settings.sizes[i] + '"><a href="javascript:;">' + settings.sizes[i] + '</a></li>'
                                }
                                tempsel += '</ul>';
                                $sel.append(tempsel);
                                $fontsizeselector1 = $sel.find('div.zedity-fontsizeselector1');
                                $fontsizeselector1.ddmenu({
                                    width: 80,
                                    onchange: function(value) {
                                        $fontsizeselector2.attr('data-size', value);
                                        if (typeof settings.onchange == 'function') settings.onchange.call($sel[0]);
                                        if (typeof settings.onchangesize == 'function') settings.onchangesize.call($sel[0], value)
                                    }
                                });
                                $sel.append('<div class="zedity-fontsizeselector2" style="float:left;margin:3px;clear:both;" data-size="' + settings.sizes.indexOf(settings.defaultsize) + '">' + '<span class="zedity-button"><a href="javascript:;" class="zedity-font-increase" title="' + Zedity.t('Increase font size') + '">A+</a></span>' + '<span class="zedity-button"><a href="javascript:;" class="zedity-font-decrease" title="' + Zedity.t('Decrease font size') + '">A-</a></span>' + '</div>');
                                $fontsizeselector2 = $sel.find('div.zedity-fontsizeselector2');
                                $fontsizeselector2.find('a.zedity-font-decrease').on('click.fontSelector', function(event) {
                                    var idx = settings.sizes.indexOf($fontsizeselector2.attr('data-size'));
                                    idx = (idx >= 0 ? idx : settings.sizes.indexOf(settings.defaultsize));
                                    if (idx <= 0) return;
                                    var size = settings.sizes[idx - 1];
                                    $fontsizeselector2.attr('data-size', size);
                                    $fontsizeselector1.ddmenu('value', size, false);
                                    if (typeof settings.onchange == 'function') settings.onchange.call($sel[0], event);
                                    if (typeof settings.onchangesize == 'function') settings.onchangesize.call($sel[0], size)
                                });
                                $fontsizeselector2.find('a.zedity-font-increase').on('click.fontSelector', function(event) {
                                    var idx = settings.sizes.indexOf($fontsizeselector2.attr('data-size'));
                                    idx = (idx >= 0 ? idx : settings.sizes.indexOf(settings.defaultsize));
                                    if (idx >= settings.sizes.length - 1) return;
                                    var size = settings.sizes[idx + 1];
                                    $fontsizeselector2.attr('data-size', size);
                                    $fontsizeselector1.ddmenu('value', size, false);
                                    if (typeof settings.onchange == 'function') settings.onchange.call($sel[0], event);
                                    if (typeof settings.onchangesize == 'function') settings.onchangesize.call($sel[0], size)
                                });
                                break;
                            case 'style':
                                $sel.append('<span class="zedity-fontstyleselector" style="float:left;margin:3px">' + '<span class="zedity-button zedity-btnB"><a href="javascript:;" title="' + Zedity.t('Bold') + '"><b>B</b></a></span>' + '<span class="zedity-button zedity-btnI"><a href="javascript:;" title="' + Zedity.t('Italic') + '"><i>I</i></a></span>' + '<span class="zedity-button zedity-btnU"><a href="javascript:;" title="' + Zedity.t('Underline') + '"><u>U</u></a></span>' + '<span class="zedity-button zedity-btnS"><a href="javascript:;" title="' + Zedity.t('Shadow') + '"><span style="text-shadow:2px 2px 2px #000">S</span></a></span>' + '</span>');
                                $fontstyleselector = $sel.find('.zedity-fontstyleselector');
                                $fontstyleselector.find('a').on('click.fontSelector', function() {
                                    $(this).parent().toggleClass('zedity-checked').trigger('click');
                                    return false
                                });
                                break;
                            case 'subsup':
                                $sel.append('<span class="zedity-fontsubsupselector" style="float:left;margin:3px">' + '<span class="zedity-button zedity-btnSub"><a href="javascript:;" title="' + Zedity.t('Subscript') + '">X<sub style="font-size:0.8em">2</sub></a></span>' + '<span class="zedity-button zedity-btnSup"><a href="javascript:;" title="' + Zedity.t('Superscript') + '" style="line-height:20px">X<sup style="font-size:0.8em">2</sup></a></span>' + '</span>');
                                $fontsubsupselector = $sel.find('.zedity-fontsubsupselector');
                                $fontsubsupselector.find('a').on('click.fontSelector', function() {
                                    $(this).parent().toggleClass('zedity-checked').trigger('click');
                                    return false
                                });
                                break;
                            case 'color':
                                break
                        }
                    });
                    if (settings.order.indexOf('color') > -1) {
                        $sel.append('<div class="zedity-fontcolorselector"/>');
                        var $fontcolorselector = $sel.find('.zedity-fontcolorselector');
                        $fontcolorselector.colorPicker({
                            colors: settings.colors,
                            defaultcolor: -1,
                            alpha: false,
                            buttons: settings.colorButtons,
                            maxcols: 9,
                            onchange: function(event, color, fill, alpha) {
                                if (typeof settings.onchange == 'function') settings.onchange.call($sel[0], event);
                                if (typeof settings.onchangecolor == 'function') settings.onchangecolor.call($sel[0], event, color, alpha)
                            }
                        })
                    }
                    if ($fontstyleselector) {
                        if (typeof settings.onchange == 'function') {
                            $fontstyleselector.find('.zedity-btnB').on('click.fontSelector1', function() {
                                settings.onchange.apply($sel[0], arguments)
                            });
                            $fontstyleselector.find('.zedity-btnI').on('click.fontSelector1', function() {
                                settings.onchange.apply($sel[0], arguments)
                            });
                            $fontstyleselector.find('.zedity-btnU').on('click.fontSelector1', function() {
                                settings.onchange.apply($sel[0], arguments)
                            });
                            $fontstyleselector.find('.zedity-btnS').on('click.fontSelector1', function() {
                                settings.onchange.apply($sel[0], arguments)
                            })
                        }
                        if (typeof settings.onchangestyleB == 'function') $fontstyleselector.find('.zedity-btnB').on('click.fontSelector2', function() {
                            settings.onchangestyleB.apply($sel[0], arguments)
                        });
                        if (typeof settings.onchangestyleI == 'function') $fontstyleselector.find('.zedity-btnI').on('click.fontSelector2', function() {
                            settings.onchangestyleI.apply($sel[0], arguments)
                        });
                        if (typeof settings.onchangestyleU == 'function') $fontstyleselector.find('.zedity-btnU').on('click.fontSelector2', function() {
                            settings.onchangestyleU.apply($sel[0], arguments)
                        });
                        if (typeof settings.onchangestyleS == 'function') $fontstyleselector.find('.zedity-btnS').on('click.fontSelector2', function() {
                            settings.onchangestyleS.apply($sel[0], arguments)
                        })
                    }
                    if ($fontsubsupselector) {
                        if (typeof settings.onchange == 'function') {
                            $fontsubsupselector.find('.zedity-btnSub').on('click.fontSelector1', function() {
                                settings.onchange.apply($sel[0], arguments)
                            });
                            $fontsubsupselector.find('.zedity-btnSup').on('click.fontSelector1', function() {
                                settings.onchange.apply($sel[0], arguments)
                            })
                        }
                        if (typeof settings.onchangestyleSub == 'function') $fontsubsupselector.find('.zedity-btnSub').on('click.fontSelector2', function() {
                            settings.onchangestyleSub.apply($sel[0], arguments)
                        });
                        if (typeof settings.onchangestyleSup == 'function') $fontsubsupselector.find('.zedity-btnSup').on('click.fontSelector2', function() {
                            settings.onchangestyleSup.apply($sel[0], arguments)
                        })
                    }
                })
            },
            selectfont: function(font, triggerevent) {
                return this.each(function() {
                    var $sel = $(this);
                    if (!$sel.hasClass('zedity-fontselector')) $sel = $sel.find('.zedity-fontselector');
                    var data = $sel.data('fontSelector');
                    if (font != '') {
                        font = font.replace(/(,\s*)/g, ',');
                        font = font.replace(/(\'|\")/g, '');
                        for (var i = data.fonts.length - 1; i >= 0; --i) {
                            var f = data.fonts[i].split(',')[0];
                            if (font == f) {
                                font = data.fonts[i];
                                break
                            }
                        }
                    }
                    var $fontfaceselector = $sel.find('.zedity-fontfaceselector');
                    $fontfaceselector.ddmenu('value', font, false);
                    if (triggerevent) $fontfaceselector.trigger('change.fontSelector')
                })
            },
            selectfontsize: function(size, triggerevent) {
                return this.each(function() {
                    var $sel = $(this);
                    if (!$sel.hasClass('zedity-fontselector')) $sel = $sel.find('.zedity-fontselector');
                    var data = $sel.data('fontSelector');
                    if (size != '') {
                        if (/px/.test(size)) size = size.replace('px', '');
                        if (/pt/.test(size)) size = $.pt2px(size);
                        if (data.sizes.indexOf(size) == -1) {
                            size = Math.round(parseFloat(size));
                            if (data.sizes.indexOf(size.toString()) == -1) {
                                var closest = null;
                                $.each(data.sizes, function() {
                                    if (closest == null || Math.abs(parseInt(this) - size) < Math.abs(closest - size)) {
                                        closest = parseInt(this)
                                    }
                                });
                                size = closest
                            }
                        }
                    }
                    $sel.find('.zedity-fontsizeselector1').ddmenu('value', size, false);
                    $sel.find('.zedity-fontsizeselector2').attr('data-size', size);
                    if (triggerevent) $sel.find('.zedity-fontsizeselector').trigger('change.fontSelector')
                })
            },
            selectfontstyle: function(style, triggerevent) {
                return this.each(function() {
                    var $sel = $(this);
                    var $cb = $sel.find('.zedity-btnB');
                    var $ci = $sel.find('.zedity-btnI');
                    var $cu = $sel.find('.zedity-btnU');
                    var $cs = $sel.find('.zedity-btnS');
                    var $csub = $sel.find('.zedity-btnSub');
                    var $csup = $sel.find('.zedity-btnSup');
                    if (style.bold == !$cb.hasClass('zedity-checked')) {
                        $cb.toggleClass('zedity-checked', !$cb.hasClass('zedity-checked'));
                        if (triggerevent) $cb.trigger('change.fontSelector')
                    }
                    if (style.italic == !$ci.hasClass('zedity-checked')) {
                        $ci.toggleClass('zedity-checked', !$ci.hasClass('zedity-checked'));
                        if (triggerevent) $ci.trigger('change.fontSelector')
                    }
                    if (style.underline == !$cu.hasClass('zedity-checked')) {
                        $cu.toggleClass('zedity-checked', !$cu.hasClass('zedity-checked'));
                        if (triggerevent) $cu.trigger('change.fontSelector')
                    }
                    if (style.shadow == !$cs.hasClass('zedity-checked')) {
                        $cs.toggleClass('zedity-checked', !$cs.hasClass('zedity-checked'));
                        if (triggerevent) $cs.trigger('change.fontSelector')
                    }
                    if (style.subscript == !$csub.hasClass('zedity-checked')) {
                        $csub.toggleClass('zedity-checked', !$csub.hasClass('zedity-checked'));
                        if (triggerevent) $csub.trigger('change.fontSelector')
                    }
                    if (style.superscript == !$csup.hasClass('zedity-checked')) {
                        $csup.toggleClass('zedity-checked', !$csup.hasClass('zedity-checked'));
                        if (triggerevent) $csup.trigger('change.fontSelector')
                    }
                })
            },
            selectcolor: function(color, triggerevent) {
                return this.each(function() {
                    var $sel = $(this);
                    color = Zedity.utils.rgb2hash(color);
                    $sel.find('.zedity-fontcolorselector').colorPicker('selectcolor', color, triggerevent);
                    if (triggerevent) $sel.find('.zedity-fontcolorselector').trigger('change.boxer')
                })
            },
            change: function() {
                return this.each(function() {
                    var $sel = $(this);
                    if (!$sel.hasClass('zedity-fontselector')) $sel = $sel.find('.zedity-fontselector');
                    var data = $sel.data('fontSelector');
                    if (typeof data.onchange == 'function') data.onchange.call($sel[0])
                })
            },
            getfont: function() {
                return $(this).find('.zedity-fontfaceselector').ddmenu('value')
            },
            getfontsize: function() {
                return $(this).find('.zedity-fontsizeselector1').attr('data-value')
            },
            getfontstyle: function() {
                var $sel = $(this);
                return {
                    bold: $sel.find('.zedity-btnB').hasClass('zedity-checked'),
                    italic: $sel.find('.zedity-btnI').hasClass('zedity-checked'),
                    underline: $sel.find('.zedity-btnU').hasClass('zedity-checked'),
                    shadow: $sel.find('.zedity-btnS').hasClass('zedity-checked')
                }
            },
            getcolor: function() {
                return $(this).find('.zedity-fontcolorselector').colorPicker('getcolor')
            },
            destroy: function() {
                return this.each(function() {
                    var $sel = $(this);
                    if (!$sel.hasClass('zedity-fontselector')) $sel = $sel.find('.zedity-fontselector');
                    $sel.find('.zedity-fontfaceselector').remove();
                    $sel.find('.zedity-fontsizeselector').remove();
                    $sel.find('.zedity-fontstyleselector').remove();
                    $sel.removeData('fontSelector')
                })
            }
        };
        if (methods[method]) {
            return methods[method].apply(this, Array.prototype.slice.call(arguments, 1))
        } else if (typeof method === 'object' || !method) {
            return methods.init.apply(this, arguments)
        } else {
            $.error(Zedity.t('Method %s does not exist on %s.', method, 'jQuery.fontSelector'))
        }
    };
    $.fn.ddmenu = function(method) {
        var $this = $(this);
        var $menu = $($this.attr('data-ddmenu'));
        var methods = {
            init: function(options) {
                var settings = {
                    width: 200,
                    onchange: function() {}
                };
                $.extend(settings, options);
                $this.data('ddmenu', settings);
                $menu.hide().addClass('zedity-ddmenu').detach().appendTo('body').menu().css({
                    position: 'absolute',
                    width: settings.width
                }).off('mouseleave.ddmenu').on('mouseleave.ddmenu', function() {
                    $menu.hide()
                });
                $this.off('click.ddmenu').on('click.ddmenu', function() {
                    $('.zedity-ddmenu').not($menu).not('.zedity-button').hide();
                    $menu.toggle().position({
                        my: 'left top',
                        at: 'left bottom',
                        of: this
                    }).css({
                        'min-width': $this.outerWidth()
                    });
                    return false
                }).on('mousedown.ddmenu', function() {
                    return false
                });
                $menu.find('.ui-menu-item').off('click.ddmenu').on('click.ddmenu', function(event) {
                    $this.ddmenu('value', $(this).attr('data-value'));
                    $menu.hide();
                    return false
                }).on('mousedown.ddmenu', function() {
                    return false
                })
            },
            value: function(value, triggerevent) {
                triggerevent = triggerevent === false ? false : true;
                if (value != null) {
                    var $item = $menu.find('[data-value="' + value + '"]');
                    var text = ($item.length == 0 ? '' : $item.text());
                    $this.attr('data-value', value).find('a').text(text);
                    if (text != '' && triggerevent) $this.ddmenu('change', value)
                } else {
                    value = $this.attr('data-value')
                }
                return value
            },
            change: function(value) {
                var data = $this.data('ddmenu');
                data.onchange.call($this[0], value)
            }
        };
        if (methods[method]) {
            return methods[method].apply(this, Array.prototype.slice.call(arguments, 1))
        } else if (typeof method === 'object' || !method) {
            return methods.init.apply(this, arguments)
        } else {
            $.error(Zedity.t('Method %s does not exist on %s.', method, 'jQuery.ddmenu'))
        }
    }
})(jQuery);
(function($) {
    Zedity.tutorials = {
        _tutorials: {},
        curTutorial: null,
        curStep: 0,
        $overlay: null,
        $hl: null,
        add: function(tutorial, definition) {
            if (!tutorial) return;
            definition = $.extend({
                title: tutorial.charAt(0).toUpperCase() + tutorial.slice(1),
                cleanup: function() {}
            }, definition);
            if (!definition.tutorial) return;
            this._tutorials[tutorial] = definition
        },
        start: function(ed, tutorial) {
            if (!this._tutorials[tutorial]) return;
            Zedity.core._later(this, function() {
                this._start(ed, tutorial)
            }, 100)
        },
        _start: function(ed, tutorial) {
            if (!ed || (this.$overlay && this.$overlay.length)) return;
            this.curTutorial = this._tutorials[tutorial];
            if (!this.curTutorial) return;
            this._size = ed.page.size();
            ed.page.size({
                width: Math.max(800, this._size.width),
                height: Math.max(600, this._size.height)
            });
            this.editor = ed;
            this.$overlay = $('<div class="zedity-tutorial-overlay"/>');
            this.$hl = $('<div class="zedity-tutorial-highlight" style="display:none"/>');
            this.curStep = 0;
            $('body').append(this.$overlay).addClass('has-zedity-tutorial');
            this.$overlay.append(this.$hl);
            this.$overlay.append('<div class="zedity-tutorial-buttons">' + '<button class="zedity-tutorial-button-close" title="Close tutorial">x</button>' + '<button class="zedity-tutorial-button-next" title="Next step">Next</button>' + '</div>');
            var self = this;
            this.$overlay.find('.zedity-tutorial-button-next').on('click', function() {
                var $b = $(this).parent();
                if ($b.hasClass('waiting')) return false;
                $b.addClass('waiting');
                Zedity.core._later(this, function() {
                    self.editor.$this.find(':animated').promise().done(function() {
                        $b.removeClass('waiting')
                    })
                }, 300);
                self.next()
            });
            this.$overlay.find('.zedity-tutorial-button-close').on('click', function() {
                var $b = $(this).parent();
                if ($b.hasClass('waiting')) return false;
                self.stop()
            });
            $(document).scrollTop(0);
            $(document).scrollTop(this.editor.$container.offset().top);
            this.step(0)
        },
        stop: function() {
            if (!this.$overlay.length) return;
            $('body').removeClass('has-zedity-tutorial');
            this.$overlay.remove();
            this.$overlay = null;
            this.curTutorial.cleanup.call(this);
            this.editor.page.size(this._size)
        },
        step: function(inc) {
            var len = this.curTutorial.tutorial.length - 1;
            this.curStep += inc;
            if (this.curStep < 0) this.curStep = 0;
            if (this.curStep > len) this.curStep = len;
            if (this.curStep == 0) {}
            if (this.curStep == len) {
                this.stop()
            }
            this.$overlay.find('.zedity-tutorial-text').remove();
            this.$hl.css('top', '-10000px');
            this.curTutorial.tutorial[this.curStep].call(this)
        },
        next: function() {
            var len = this.curTutorial.tutorial.length - 1;
            this.curStep++;
            if (this.curStep == len) {
                this.$overlay.find('.zedity-tutorial-button').text('End')
            } else if (this.curStep > len) {
                this.$overlay.find('.zedity-tutorial-buttons').remove();
                this.stop();
                return
            }
            this.$overlay.find('.zedity-tutorial-text').remove();
            this.$hl.css('top', '-10000px').hide();
            this.curTutorial.tutorial[this.curStep].call(this)
        },
        showHighlight: function($el, text) {
            var offset = 8;
            Zedity.core._later(this, function() {
                var pos = $el[0].getBoundingClientRect();
                this.$hl.css({
                    left: pos.left - offset,
                    top: pos.top - offset,
                    width: $el.outerWidth() + offset,
                    height: $el.outerHeight() + offset
                }).show();
                if (text) {
                    this.showText(this.$hl.position().left, this.$hl.position().top + this.$hl.outerHeight(), text, 'above')
                }
            }, 100)
        },
        showText: function(x, y, text, pos) {
            if (x == null || y == null || !text) return;
            pos = pos || '';
            var $t = $('<div class="zedity-tutorial-text ' + pos + '"/>').text(text).css({
                left: x,
                top: y >= 0 ? y : '',
                bottom: y < 0 ? Math.abs(y) : ''
            });
            this.$overlay.append($t)
        },
        addMenu: function(ed, tab, group) {
            var tut = [];
            for (var i in this._tutorials) {
                if (!this._tutorials.hasOwnProperty(i)) return;
                tut.push({
                    value: i,
                    label: this._tutorials[i].title
                })
            }
            var mdef = {
                tabs: {}
            };
            mdef.tabs[tab] = {
                groups: {}
            };
            mdef.tabs[tab].groups[group] = {
                order: 99999,
                title: 'Tutorials',
                features: {
                    tutorials: {
                        type: 'menu',
                        size: 'n',
                        icon: 'help',
                        label: 'Tutorials',
                        title: 'Tutorials',
                        items: tut,
                        onclick: function(val, e, ed) {
                            Zedity.tutorials.start(ed, val)
                        }
                    }
                }
            };
            ed.menu.add(mdef)
        }
    };
    Zedity.tutorials.add('intro1', {
        title: 'Introduction: add and place a box',
        tutorial: [function() {
            this.editor.menu.openTab('boxes');
            this.showHighlight(this.editor.menu._tab('boxes').$tab, 'Open the "Boxes" tab.')
        }, function() {
            this.showHighlight(this.editor.menu.$this.find('.zedity-ribbon-tab-panel:visible'), 'Choose the box you want to add.')
        }, function() {
            this.editor.menu.openTab('boxes');
            this.showHighlight(this.editor.menu._feature('boxes', 'basic', 'Text').$button, 'E.g. Click on the "Text" box button to add a Text box.')
        }, function() {
            this.editor.boxes.add('Text');
            this.box1 = this.editor.boxes.selected();
            this.box1.$this.css({
                left: 50,
                top: 50
            });
            this.showHighlight(this.box1.$this, 'A new Text box is created.')
        }, function() {
            var $b = this.box1.$this;
            $b.animate({
                left: 250,
                top: 150
            }, {
                specialEasing: {
                    top: 'easeInQuad',
                    left: 'easeOutQuad'
                },
                complete: function() {
                    $b.animate({
                        left: 50,
                        top: 150
                    }, 700).animate({
                        left: 50,
                        top: 50
                    }, 700)
                },
                duration: 1000
            });
            this.showText(150, -50, 'Drag the box to put it where you like it.')
        }, function() {
            var $b = this.box1.$this;
            $b.animate({
                width: 350,
                height: 200
            }, {
                complete: $.proxy(function() {
                    this.showHighlight($b.find('.ui-resizable-handle'))
                }, this),
                duration: 700
            });
            this.showText(150, -50, 'Resize the box by dragging the bottom left corner.')
        }],
        cleanup: function() {
            if (this.box1) this.box1.remove()
        }
    });
    Zedity.tutorials.add('intro2', {
        title: 'Introduction: add text content',
        tutorial: [function() {
            this.editor.boxes.add('Text');
            this.box1 = this.editor.boxes.selected();
            this.box1.$this.css({
                left: 100,
                top: 50,
                width: 200,
                height: 120
            });
            this.showHighlight(this.box1.$this, 'Create a Text box.')
        }, function() {
            this.showHighlight(this.box1.$this.find('.zedity-button'), 'Click the button to add content.')
        }, function() {
            this.showHighlight(this.editor.menu._feature('editbox', 'textbox', 'insert').$button, 'Or click the "Insert" button.')
        }, function() {
            this.box1.background({
                colors: ['#ffffff']
            });
            this.box1.content('<div class="zedity-content" style="width:100%;height:100%;color:black;line-height:1.2;font-size:14px;font-family:Arial,Helvetica,sans-serif;display:table-cell;overflow:hidden;"><p style="margin:0px;color:black;font-size:14px;font-family:Arial,Helvetica,sans-serif;"><span class="tutorialhelper">Lorem ipsum</span><br/>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p></div>');
            this.box1.insert();
            this.showHighlight(this.box1.$this, 'The box is now in edit mode: you can write your text.')
        }, function() {
            this.box1.insert();
            this.showHighlight(this.editor.menu._group('textbox', 'font').$group, 'Use the text edit/style functions (font, paragraph, etc) in the Text tab.')
        }, function() {
            this.box1.insert();
            this.box1.$this.find('.tutorialhelper').css('background', 'lightskyblue');
            this.showHighlight(this.box1.$this, 'eg. Select the text you want to style...')
        }, function() {
            this.box1.insert();
            this.showHighlight(this.editor.menu._group('textbox', 'font').$group.find('.zedity-btnB'), '...and click the "Bold" function to make it bold.')
        }, function() {
            this.box1.content('<div class="zedity-content" style="width:100%;height:100%;color:black;line-height:1.2;font-size:14px;font-family:Arial,Helvetica,sans-serif;display:table-cell;overflow:hidden;"><h3 style="margin:0px;color:black;font-size:18px;font-family:Arial,Helvetica,sans-serif;font-weight:bold;">Lorem ipsum</h3><p style="margin:0px;color:black;font-size:14px;font-family:Arial,Helvetica,sans-serif;">Lorem ipsum dolor sit <b>amet</b>, consectetur adipiscing elit, sed do <i>eiusmod</i> tempor incididunt ut labore et <span style="color:rgb(254,46,46);">dolore magna aliqua</span>.</p></div>');
            this.showHighlight(this.box1.$this, 'Write and style your text as desired.')
        }],
        cleanup: function() {
            if (this.box1) this.box1.remove()
        }
    });
    Zedity.tutorials.add('intro3', {
        title: 'Introduction: add image',
        tutorial: [function() {
            this.editor.boxes.add('Image');
            this.box1 = this.editor.boxes.selected();
            this.box1.$this.css({
                left: 100,
                top: 50,
                width: 300,
                height: 200
            });
            this.showHighlight(this.box1.$this, 'Create an Image box.')
        }, function() {
            this.showHighlight(this.box1.$this.find('.zedity-button'), 'Click the button to add an image.')
        }, function() {
            this.showHighlight(this.editor.menu._feature('editbox', 'imagebox', 'insert').$button, 'Or click the "Insert" button.')
        }, function() {
            this.box1.insert();
            $('.zedity-dialog-image .tabs').tabs('selected', 'tab-image-link');
            $('#zedity-txtImageLink').val('http://mysite.com/uploads/city.jpg');
            this.showHighlight($('#zedity-txtImageLink'), 'Insert the link (or get it from your Media Library).')
        }, function() {
            $('.zedity-dialog-image').dialog('close');
            this.box1.content('http://lorempixel.com/300/200/city');
            this.showHighlight(this.editor.boxes.$selected, 'The image is added.')
        }],
        cleanup: function() {
            if (this.box1) this.box1.remove()
        }
    });
    Zedity.tutorials.add('intro4', {
        title: 'Introduction: arrange boxes',
        tutorial: [function() {
            this.editor.boxes.add('Text');
            this.box1 = this.editor.boxes.selected();
            this.box1.$this.css({
                left: 70,
                top: 60,
                width: 200,
                height: 150
            });
            this.box1.content('<div class="zedity-content" style="width:100%;height:100%;color:black;line-height:1.2;font-size:14px;font-family:Arial,Helvetica,sans-serif;display:table-cell;overflow:hidden;"><p style="margin:0px;color:lightgreen;font-size:24px;font-family:\'Century Gothic\',sans-serif"><b>Modern cities</b></p></div>');
            this.editor.boxes.add('Image');
            this.box2 = this.editor.boxes.selected();
            this.box2.$this.css({
                left: 100,
                top: 70,
                width: 300,
                height: 200
            });
            this.box2.content('http://lorempixel.com/300/200/city/3/');
            this.editor.boxes.add('Image');
            this.box3 = this.editor.boxes.selected();
            this.box3.$this.css({
                left: 200,
                top: 150,
                width: 300,
                height: 200
            });
            this.box3.content('http://lorempixel.com/300/200/city/4/');
            this.showText(150, -50, 'You can arrange your boxes any way you like to create complex designs.')
        }, function() {
            var $b = this.box3.$this;
            $b.animate({
                left: 450,
                top: 50
            }, 700).animate({
                left: 200,
                top: 250
            }, {
                specialEasing: {
                    top: 'easeOutQuad',
                    left: 'easeInQuad'
                },
                complete: function() {
                    $b.animate({
                        left: 250,
                        top: 100
                    }, 700)
                },
                duration: 1000
            });
            this.showText(150, -50, 'Drag the box to put it where you like it.')
        }, function() {
            this.box1.select();
            this.showHighlight(this.box1.$this, 'Click on a box to select it.')
        }, function() {
            this.box1.select();
            this.showHighlight(this.editor.menu._feature('editbox', 'layout', 'arrange').$button, 'Use the arrange button to bring a box on foreground.')
        }, function() {
            this.editor.menu.activateFeature('editbox', 'layout', 'arrange');
            this.showHighlight(this.editor.menu._feature('editbox', 'layout', 'arrange').$menu.selectmenu('instance').menu, 'Select "Bring to front" to bring the box on top of the others.')
        }, function() {
            this.showHighlight(this.box1.$this, 'Now the box is on top.')
        }, function() {
            this.box1.$this.animate({
                left: 350,
                top: 100
            }, 700);
            this.showText(150, -50, 'Drag the box to put it where you like it.')
        }, function() {
            this.box2.select();
            this.box2.$this.animate({
                left: 50,
                top: 100
            }, 500);
            this.showText(150, -50, 'Create your designs with real drag and drop.')
        }],
        cleanup: function() {
            if (this.box1) this.box1.remove();
            if (this.box2) this.box2.remove();
            if (this.box3) this.box3.remove()
        }
    });
    Zedity.tutorials.add('intro5', {
        title: 'Introduction: style boxes',
        tutorial: [function() {
            this.editor.boxes.add('Image');
            this.box1 = this.editor.boxes.selected();
            this.box1.$this.css({
                left: 100,
                top: 50,
                width: 300,
                height: 200
            });
            this.box1.content('http://lorempixel.com/300/200/city');
            this.editor.menu.openTab('boxstyle');
            this.showHighlight(this.editor.menu._tab('boxstyle').$tab, 'Open the "Box style" tab.')
        }, function() {
            this.showHighlight(this.editor.menu._group('boxstyle', 'border').$group, 'You can add a border to your box.')
        }, function() {
            var self = this;
            var $p = this.editor.menu._feature('boxstyle', 'border', 'width').$panel;
            this.box1.$this.animate({
                'border-width': 15
            }, {
                complete: function() {
                    self.box1.select();
                    self.editor.menu.refresh()
                }
            });
            this.showHighlight($p, 'You can set the border width.')
        }, function() {
            this.box1.$this.css({
                'border-color': 'green',
                'border-style': 'dotted'
            });
            this.editor.menu.refresh();
            this.showHighlight(this.editor.menu._group('boxstyle', 'border').$group, 'Color, style, and other properties...')
        }, function() {
            this.showHighlight(this.box1.$this, '...to style the box as you like.')
        }, function() {
            this.showHighlight(this.editor.menu.$this.find('.zedity-ribbon-tab-panel:visible'), 'Explore other style options to achieve many cool effects.')
        }],
        cleanup: function() {
            if (this.box1) this.box1.remove()
        }
    })
})(jQuery);
(function($) {
    if (!Zedity) throw new Error(Zedity.t('%s needs %s.', 'Zedity.Box.Audio', 'Zedity'));
    if (!Zedity.Box) throw new Error(Zedity.t('%s needs %s.', 'Zedity.Box.Audio', 'Zedity.Box'));
    Zedity.Box.Audio = function(options) {
        this.type = 'Audio';
        this._defaults = Zedity.Box.Audio._defaults;
        Zedity.Box.prototype.constructor.call(this, options);
        this._can.remove('background', 'asBackground', 'rotation', 'flip', 'corners');
        if (this.$this.find('object,iframe,audio').length == 0) {
            if (this.$this.find('.zedity-empty').length == 0) {
                this.$this.append('<div class="zedity-empty"><p>' + Zedity.t('Click %s to insert audio.', '<span class="zedity-button"><span class="zicon zicon-audio zicon-size-s"></span></span>') + '</p></div>')
            }
        } else if (this.$this.find('.zedity-boxoverlay').length == 0) {
            this.$this.append('<div class="zedity-boxoverlay"/>')
        }
    };
    Zedity.Box.Audio.prototype = Object.create(Zedity.Box.prototype);
    Zedity.Box.Audio.prototype.constructor = Zedity.Box.Audio;
    $.extend(Zedity.Box.Audio.prototype, {
        createPropBar: function(options) {
            Zedity.Box.prototype.createPropBar.call(this);
            this.editor.menu.add({
                tabs: {
                    editbox: {
                        groups: {
                            audiobox: {
                                title: Zedity.t('Audio'),
                                order: -1000,
                                class: 'zedity-group-box',
                                features: {
                                    insert: {
                                        type: 'button',
                                        icon: 'audio',
                                        label: Zedity.t('Insert'),
                                        title: Zedity.t('Insert audio'),
                                        onclick: function(e, ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return;
                                            box.insert()
                                        }
                                    },
                                    play: {
                                        type: 'toggle',
                                        order: 0,
                                        state: [{
                                            label: Zedity.t('Play'),
                                            icon: 'play',
                                            title: Zedity.t('Play audio')
                                        }, {
                                            label: Zedity.t('Pause'),
                                            icon: 'pause',
                                            title: Zedity.t('Pause audio')
                                        }],
                                        onclick: function(e, ed, before) {
                                            var box = ed.boxes.selected();
                                            if (!box) return false;
                                            switch (before) {
                                                case 0:
                                                    box.start();
                                                    break;
                                                case 1:
                                                    box.stop();
                                                    break
                                            }
                                        },
                                        enable: function(ed, box) {
                                            if (!box || box.type != 'Video') return false;
                                            var service = box.getService();
                                            return service && service.canplay
                                        },
                                        show: function(ed, box) {
                                            if (!box || box.type != 'Video') return false;
                                            var service = box.getService();
                                            return !service || (service && service.canplay)
                                        },
                                        refresh: function(ed, box) {
                                            if (!box) return;
                                            this.$button.trigger('toggle', box.$this.hasClass('zedity-playing') ? 1 : 0)
                                        }
                                    },
                                    view: {
                                        type: 'toggle',
                                        order: 0,
                                        state: [{
                                            label: Zedity.t('Show'),
                                            icon: 'view',
                                            title: Zedity.t('Show audio')
                                        }, {
                                            label: Zedity.t('Close'),
                                            icon: 'view',
                                            title: Zedity.t('Close audio')
                                        }],
                                        onclick: function(e, ed, before) {
                                            var box = ed.boxes.selected();
                                            if (!box) return false;
                                            switch (before) {
                                                case 0:
                                                    box.start();
                                                    break;
                                                case 1:
                                                    box.stop();
                                                    break
                                            }
                                        },
                                        show: function(ed, box) {
                                            if (!box || box.type != 'Audio') return false;
                                            var service = box.getService();
                                            return !!service && !service.canplay
                                        },
                                        refresh: function(ed, box) {
                                            if (!box) return;
                                            this.$button.trigger('toggle', box.$this.hasClass('zedity-playing') ? 1 : 0)
                                        }
                                    }
                                },
                                show: function(ed, box) {
                                    return box && box.type == 'Audio'
                                }
                            }
                        }
                    }
                }
            }, 'audiobox');
            return this
        },
        _sizeLimits: function() {
            var sl = Zedity.Box.prototype._sizeLimits.call(this);
            var service = this.getService();
            if (!service) return sl;
            return {
                minWidth: service.sizeLimits.minWidth || sl.minWidth,
                maxWidth: service.sizeLimits.maxWidth || sl.maxWidth,
                minHeight: service.sizeLimits.minHeight || sl.minHeight,
                maxHeight: service.sizeLimits.maxHeight || sl.maxHeight
            }
        },
        _save: function(callback) {
            Zedity.Box.prototype._save.call(this);
            this.$this.find('.zedity-boxoverlay').remove();
            if (typeof(callback) == 'function') callback.call(this);
            return this
        },
        content: function(content) {
            function checkFiles(content) {
                var filetypes = Object.keys(this._options.filetypes);
                for (var i = filetypes.length - 1; i >= 0; --i) {
                    var rx = new RegExp('\\.' + filetypes[i] + '(?:$|\\?)', 'gm');
                    if (rx.test(content)) return true
                }
                return false
            };
            if (content != null) {
                if (typeof content == 'string' || content instanceof String) {
                    var embed = Zedity.core.embed.parse(content, 'audio');
                    if (!embed.code) {
                        if (checkFiles.call(this, content)) {
                            return Zedity.core._call(this, 'content', content.split('\n'))
                        } else {
                            this.editor._error({
                                message: Zedity.t('Please provide a valid link/embed code for any of the supported audio services.')
                            })
                        }
                        return this.content()
                    } else {
                        content = (embed.iframe || embed.flash) + '<div class="zedity-boxoverlay"/>';
                        this.$this.css('display', '').attr('data-service', embed.service)
                    }
                } else if ($.isArray(content)) {
                    var html = '<div style="display:table-cell;width:100%;vertical-align:middle">' + '<audio controls="controls" style="width:100%;vertical-align:middle">';
                    for (var i = 0, len = content.length; i < len; ++i) {
                        var ext = content[i].split('.').pop();
                        if (this._options.filetypes[ext]) {
                            html += '<source src="' + content[i] + '" type="' + this._options.filetypes[ext] + '"/>'
                        }
                    }
                    html += '<p>Your browser does not support HTML5 audio.</p></audio></div><div class="zedity-boxoverlay"/>';
                    content = html;
                    this.$this.css('display', 'table').attr('data-service', 'html5')
                } else {
                    this.editor._error({
                        message: Zedity.t('Could not interpret the content as audio.')
                    })
                }
            }
            content = Zedity.Box.prototype.content.call(this, content);
            var src = [];
            $(content).find('object,iframe,audio source').each(function() {
                var ts = $(this).attr('src') || $(this).attr('data');
                if (ts) src.push(ts)
            });
            content = src.join('\n');
            this._resize();
            this.editor.boxes.refreshSelected();
            return content
        },
        select: function() {
            if (this.$this.hasClass('zedity-editing') || this.$this.hasClass('zedity-playing')) return this;
            Zedity.Box.prototype.select.call(this);
            return this
        },
        asBackground: function(setting) {
            if (setting != null) {
                this.editor._error({
                    message: Zedity.t('%s can\'t be set as background.', 'Audio box')
                })
            }
            return false
        },
        rotation: function(setting) {
            if (setting != null) {
                this.editor._error({
                    message: Zedity.t('%s can\'t be rotated.', 'Audio box')
                })
            }
            return 0
        },
        background: function(setting) {
            if (setting != null) {
                this.editor._error({
                    message: Zedity.t('%s doesn\'t support background property.', 'Audio box')
                })
            }
            return {
                type: 'solid',
                alpha: 1,
                colors: ['transparent']
            }
        },
        corners: function(setting) {
            if (setting != null) {
                this.editor._error({
                    message: Zedity.t('%s doesn\'t support rounded corners.', 'Audio box')
                })
            }
            return {
                'border-top-left-radius': 0,
                'border-top-right-radius': 0,
                'border-bottom-left-radius': 0,
                'border-bottom-right-radius': 0
            }
        },
        flip: function(setting) {
            if (setting != null) {
                this.editor._error({
                    message: Zedity.t('%s doesn\'t support flipping.', 'Audio box')
                })
            }
            return 'none'
        },
        start: function() {
            Zedity.Box.prototype.start.call(this);
            var $obj = this.$this.find('object,iframe,audio');
            if ($obj.lenght == 0) return this;
            var service = this.getService();
            if (!service) return this;
            if (this.$this.data('ui-draggable')) this.$this.draggable('option', 'disabled', true);
            if (this.$this.data('ui-resizable')) this.$this.resizable('option', 'disabled', true);
            this.$this.removeClass('ui-state-disabled');
            Zedity.core.embed.player($obj, service.service, 'play');
            this.$this.addClass('zedity-playing').find('.zedity-boxoverlay').hide();
            return this
        },
        stop: function() {
            Zedity.Box.prototype.stop.call(this);
            var $obj = this.$this.find('object,iframe,audio');
            if ($obj.lenght == 0) return this;
            var service = this.getService();
            if (!service) return this;
            if (this.$this.data('ui-draggable')) this.$this.draggable('option', 'disabled', false);
            if (this.$this.data('ui-resizable')) this.$this.resizable('option', 'disabled', false);
            Zedity.core.embed.player($obj, service.service, 'pause');
            this.$this.removeClass('zedity-playing').find('.zedity-boxoverlay').show();
            return this
        },
        insert: function() {
            Zedity.Box.prototype.insert.call(this);
            $('.zedity-dialog-audio').data('box', this).dialog('open');
            return this
        },
        getService: function() {
            var service = this.$this.attr('data-service') || this.$this.find('object,iframe,audio').attr('data-service');
            var data;
            if (service == 'html5') {
                data = {
                    service: 'html5',
                    type: 'video',
                    canplay: true,
                    sizeLimits: {
                        minWidth: 45,
                        maxWidth: null,
                        minHeight: 30,
                        maxHeight: 100
                    }
                }
            } else {
                data = Zedity.core.embed.services[service];
                if (data) data.canplay = !!(data.player.flash.play || data.player.iframe.play)
            }
            return data
        },
        duplicate: function() {
            var newbox = Zedity.Box.prototype.duplicate.call(this);
            var $obj = newbox.$this.find('object,iframe,audio');
            var service = newbox.getService();
            if (service) {
                $obj.attr('id', Zedity.core.genId(service.service))
            }
            return newbox
        },
        init: function() {
            Zedity.Box.prototype.init.call(this);
            if ($('.zedity-dialog-audio').length == 0) {
                var $dialog = $('<div class="zedity-dialog-audio">' + '<div class="tabs">' + '<ul>' + '<li><a href="#tab-audio-embed">' + Zedity.t('Embed') + '</a></li>' + '<li><a href="#tab-audio-files">' + Zedity.t('Files') + '</a></li>' + '</ul>' + '<div id="tab-audio-embed">' + Zedity.t('Insert audio embed code or url:') + '<br/>' + '<textarea id="zedity-txtAudioEmbed" rows="4"></textarea>' + '<p>' + Zedity.t('Supported services:') + '<br/><span id="zedity-lblAudioServices"></span></p>' + '</div>' + '<div id="tab-audio-files">' + Zedity.t('Select audio from the list of available audios:') + '<br/>' + '<select id="zedity-ddAudioFiles"></select>' + '</div>' + '</div>' + '</div>');
                $dialog.find('.tabs').tabs({
                    activate: function(event, ui) {
                        $(this).find('.ui-tabs-panel:visible').find('input[type=text],textarea,select').filter(':visible').filter(':first').focus()
                    }
                });
                this.editor.$container.append($dialog);
                $dialog.dialog({
                    title: Zedity.t('Insert audio'),
                    dialogClass: 'zedity-dialog',
                    autoOpen: false,
                    modal: true,
                    resizable: false,
                    position: {
                        my: 'center',
                        at: 'center',
                        of: window.top
                    },
                    open: function() {
                        var $this = $(this);
                        var $tabs = $this.find('.tabs');
                        var box = $this.data('box');
                        var disabled = [];
                        if (box._options.files) {
                            var files = '<option value="-1">--</option>';
                            for (var i = 0, len = box._options.files.length; i < len; ++i) {
                                files += '<option value="' + i + '">' + box._options.files[i].title + '</option>'
                            }
                            $('#zedity-ddAudioFiles').html(files)
                        } else {
                            disabled.push($tabs.tabs('getidx', 'tab-audio-files'))
                        }
                        var services = Zedity.core.embed.getServices('audio', true);
                        $('#zedity-lblAudioServices').html(services.join(', '));
                        $this.find('input[type=text],textarea').val('');
                        $tabs.tabs('option', {
                            active: 0,
                            disabled: disabled
                        });
                        $('#zedity-txtAudioEmbed').val(box.content()).focus()
                    },
                    close: function() {
                        $(this).data('box', null)
                    },
                    buttons: [{
                        text: Zedity.t('OK'),
                        class: 'zedity-button-ok',
                        click: function() {
                            var box = $(this).data('box');
                            $(this).dialog('close');
                            if (!box) return;
                            var content = '';
                            switch ($(this).find('.tabs').tabs('selected')) {
                                case 'tab-audio-embed':
                                    content = $('#zedity-txtAudioEmbed').val();
                                    var embed = Zedity.core.embed.parse(content, 'audio');
                                    if (!embed.code) {
                                        box.editor._error({
                                            message: Zedity.t('Please provide a valid link/embed code for any of the supported audio services.')
                                        });
                                        return
                                    }
                                    break;
                                case 'tab-audio-files':
                                    var val = parseInt($('#zedity-ddAudioFiles').val());
                                    if (val > -1) {
                                        content = box._options.files[val].src
                                    }
                                    break
                            }
                            box.content(content)
                        }
                    }, {
                        text: Zedity.t('Cancel'),
                        class: 'zedity-button-cancel',
                        click: function() {
                            $(this).dialog('close')
                        }
                    }]
                })
            }
            return this
        }
    });
    Zedity.Box.Audio.type = 'Audio';
    Zedity.Box.Audio.sizeLimits = {
        minWidth: 200,
        minHeight: 70,
        maxWidth: null,
        maxHeight: 165
    };
    Zedity.Box.Audio._defaults = {
        width: 200,
        height: 100,
        filetypes: {
            mp3: 'audio/mpeg',
            ogg: 'audio/ogg',
            wav: 'audio/wave',
            webm: 'audio/webm'
        }
    };
    Zedity.Box.register({
        type: Zedity.Box.Audio.type,
        section: 'media-embed',
        order: 100
    });
    Zedity.core.embed.add('soundcloud', {
        url: 'http://soundcloud.com/',
        type: 'audio',
        regex: [new RegExp('soundcloud\\.com(?:/|%2F)tracks(?:/|%2F)(.*?)(&|"|\'|$)'), new RegExp('snd\\.sc/(.*?)'), new RegExp('http[s]?://soundcloud\\.com/.+')],
        parser: function(code, embed) {
            if (!code[1]) {
                try {
                    var data = $.ajax({
                        type: 'GET',
                        url: 'https://soundcloud.com/oembed?format=json&url=' + embed,
                        dataType: 'json',
                        async: false
                    });
                    data = JSON.parse(data.responseText);
                    code = this.regex[0].exec(data.html)
                } catch (e) {
                    code = undefined
                }
            }
            if (code) {
                var id = Zedity.core.genId(this.service);
                return {
                    id: id,
                    code: code[1],
                    flash: '//player.soundcloud.com/player.swf?url=http%3A%2F%2Fapi.soundcloud.com%2Ftracks%2F' + code[1] + '&amp;show_comments=false&amp;auto_play=false&amp;buying=false&amp;sharing=false&amp;download=false&amp;show_bmp=false&amp;show_playcount=false&amp;enable_api=true&amp;object_id=' + id,
                    iframe: '//w.soundcloud.com/player/?url=http%3A%2F%2Fapi.soundcloud.com%2Ftracks%2F' + code[1] + '&amp;auto_play=false&amp;show_artwork=false&amp;show_comments=false&amp;show_playcount=false&amp;buying=false&amp;liking=false&amp;download=false&amp;sharing=false'
                }
            }
            return {}
        },
        player: {
            flash: {
                play: 'play',
                pause: 'pause'
            },
            iframe: {
                play: 'play',
                pause: 'pause',
                command: function(frame_id, func, args) {
                    $('#' + frame_id)[0].contentWindow.postMessage(JSON.stringify({
                        method: func,
                        value: args
                    }), '*')
                }
            }
        },
        sizeLimits: {
            minWidth: 60,
            minHeight: 60
        }
    });
    Zedity.core.embed.add('reverbnation', {
        url: 'http://www.reverbnation.com/',
        type: 'audio',
        regex: [new RegExp('reverbnation\\.com/widget_code/html_widget(?:_config|)/artist_(.*?)\\?.*?song_ids\\]=(.*?)(&|"|\'|$)'), new RegExp('reverbnation\\.com/artist/artist_songs/(.*?)\\?song_id=(.*?)(&|"|\'|$)')],
        parser: function(code) {
            if (!code[2]) code[2] = '';
            return {
                code: code[2],
                iframe: '//www.reverbnation.com/widget_code/html_widget/artist_' + code[1] + '?widget_id=50&pwc[included_songs]=0&pwc[song_ids]=' + code[2] + '&pwc[photo]=0&pwc[size]=fit'
            }
        },
        sizeLimits: {
            minWidth: 200,
            minHeight: 65,
            maxHeight: 105
        }
    })
})(jQuery);
(function($) {
    var old = Zedity.Box.Audio.prototype.createPropBar;
    Zedity.Box.Audio.prototype.createPropBar = function(options) {
        old.call(this)
    };
    var old_init = Zedity.Box.Audio.prototype.init;
    Zedity.Box.Audio.prototype.init = function(options) {
        old_init.apply(this, arguments);
        var $dialog = $('.zedity-dialog-audio');
        $dialog.parent().find('.zedity-button-ok').off('click').on('click', $.proxy(function() {
            var box = $(this).data('box');
            $(this).dialog('close');
            if (!box) return;
            var content = '';
            switch ($(this).find('.tabs').tabs('selected')) {
                case 'tab-audio-embed':
                    content = $('#zedity-txtAudioEmbed').val();
                    break;
                case 'tab-audio-files':
                    var val = parseInt($('#zedity-ddAudioFiles').val());
                    if (val > -1) {
                        content = box._options.files[val].src
                    }
                    break
            }
            box.content(content)
        }, $dialog[0]))
    };
    Zedity.core.embed.add('vocaroo', {
        url: 'http://vocaroo.com',
        type: 'audio',
        regex: [new RegExp('vocaroo\\.com/(?:i/|.*?playMediaID=)(.*?)($|&|\\?)')],
        parser: function(code) {
            return {
                code: code[1],
                flash: '//vocaroo.com/player.swf?playMediaID=' + code[1] + '&amp;autoplay=0'
            }
        },
        sizeLimits: {
            minWidth: 120,
            maxWidth: 540,
            minHeight: 36,
            maxHeight: 160
        }
    });
    Zedity.core.embed.add('myspace_music', {
        url: 'https://myspace.com/discover/songs',
        type: 'audio',
        regex: [new RegExp('myspace\\.com/.*?/song/(.*?)($|"|\')')],
        parser: function(code) {
            return {
                code: code[1],
                iframe: '//myspace.com/play/song/' + code[1]
            }
        },
        sizeLimits: {
            minWidth: 270,
            minHeight: 90,
            maxHeight: 90
        }
    });
    Zedity.core.embed.add('shoutcast', {
        url: 'http://www.shoutcast.com',
        type: 'audio',
        regex: [new RegExp('shoutcast\\.com/.*?\\?(?:station_id|id)=(.*?)(&|$)')],
        parser: function(code) {
            return {
                code: code[1],
                flash: '//www.shoutcast.com/media/popupPlayer_V19.swf?stationid=http://yp.shoutcast.com/sbin/tunein-station.pls?id=' + code[1] + '&amp;play_status=0'
            }
        },
        sizeLimits: {
            minWidth: 220,
            maxWidth: 360,
            minHeight: 60,
            maxHeight: 100
        }
    });
    Zedity.core.embed.add('bandcamp', {
        url: 'http://bandcamp.com',
        type: 'audio',
        regex: [new RegExp('bandcamp\\.com.*?album=(.*?)(/|$)')],
        parser: function(code) {
            return {
                code: code[1],
                iframe: '//bandcamp.com/EmbeddedPlayer/album=' + code[1] + '/size=small/bgcol=ffffff/linkcol=0687f5/transparent=true/'
            }
        },
        sizeLimits: {
            minWidth: 300,
            minHeight: 42,
            maxHeight: 42
        }
    })
})(jQuery);
(function($) {
    if (!Zedity) throw new Error(Zedity.t('%s needs %s.', 'Zedity.Box.Color', 'Zedity'));
    if (!Zedity.Box) throw new Error(Zedity.t('%s needs %s.'), 'Zedity.Box.Color', 'Zedity.Box');
    Zedity.Box.Color = function(options) {
        this.type = 'Color';
        this._defaults = Zedity.Box.Color._defaults;
        Zedity.Box.prototype.constructor.call(this, options);
        this._can.remove('flip');
        if (!this._options.id && !this._options.element) {
            this.$this.append('<p style="color:transparent">_</p><div class="zedity-empty"><p>' + Zedity.t('Click %s to add color.', '<span class="zedity-button"><span class="zicon zicon-color zicon-size-s"></span></span>') + '</p></div>')
        }
    };
    Zedity.Box.Color.prototype = Object.create(Zedity.Box.prototype);
    Zedity.Box.Color.prototype.constructor = Zedity.Box.Color;
    $.extend(Zedity.Box.Color.prototype, {
        createPropBar: function(options) {
            Zedity.Box.prototype.createPropBar.call(this);
            this.editor.menu.add({
                tabs: {
                    editbox: {
                        groups: {
                            colorbox: {
                                title: Zedity.t('Color'),
                                order: -1000,
                                class: 'zedity-group-box',
                                features: {
                                    insert: {
                                        type: 'button',
                                        icon: 'color',
                                        label: Zedity.t('Add'),
                                        title: Zedity.t('Add color'),
                                        onclick: function(e, ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return;
                                            box.insert()
                                        }
                                    }
                                },
                                show: function(ed, box) {
                                    return box && box.type == 'Color'
                                }
                            }
                        }
                    }
                }
            }, 'colorbox');
            return this
        },
        _save: function(callback) {
            Zedity.Box.prototype._save.call(this);
            if (typeof(callback) == 'function') callback.call(this);
            return this
        },
        select: function() {
            Zedity.Box.prototype.select.call(this);
            return this
        },
        flip: function(setting) {
            if (setting != null) {
                this.editor._error({
                    message: Zedity.t('%s doesn\'t support flipping.', 'Color box')
                })
            }
            return 'none'
        },
        start: function() {
            Zedity.Box.prototype.start.call(this);
            return this
        },
        stop: function() {
            Zedity.Box.prototype.stop.call(this);
            return this
        },
        insert: function() {
            Zedity.Box.prototype.insert.call(this);
            if (this.editor.menu) {
                this.editor.menu.activateFeature('boxstyle', 'background', 'color')
            }
            return this
        },
        init: function() {
            Zedity.Box.prototype.init.call(this);
            return this
        }
    });
    Zedity.Box.Color.type = 'Color';
    Zedity.Box.Color.sizeLimits = {
        minWidth: 16,
        minHeight: 16,
        maxWidth: null,
        maxHeight: null
    };
    Zedity.Box.Color._defaults = {
        width: 150,
        height: 150
    };
    Zedity.Box.register({
        type: Zedity.Box.Color.type,
        requires: [],
        section: 'basic',
        order: 1000
    })
})(jQuery);
(function($) {
    if (!Zedity) throw new Error(Zedity.t('%s needs %s.', 'Zedity.Box.Document', 'Zedity'));
    if (!Zedity.Box) throw new Error(Zedity.t('%s needs %s.', 'Zedity.Box.Document', 'Zedity.Box'));
    Zedity.Box.Document = function(options) {
        this.type = 'Document';
        this._defaults = Zedity.Box.Document._defaults;
        Zedity.Box.prototype.constructor.call(this, options);
        this._can.remove('background', 'rotation', 'flip', 'corners');
        if (this.$this.find('object,iframe').length == 0) {
            if (this.$this.find('.zedity-empty').length == 0) {
                this.$this.append('<div class="zedity-empty"><p>' + Zedity.t('Click %s to insert a document.', '<span class="zedity-button"><span class="zicon zicon-document zicon-size-s"></span></span>') + '</p></div>')
            }
        } else if (this.$this.find('.zedity-boxoverlay').length == 0) {
            this.$this.append('<div class="zedity-boxoverlay"/>')
        }
    };
    Zedity.Box.Document.prototype = Object.create(Zedity.Box.prototype);
    Zedity.Box.Document.prototype.constructor = Zedity.Box.Document;
    $.extend(Zedity.Box.Document.prototype, {
        createPropBar: function(options) {
            Zedity.Box.prototype.createPropBar.call(this);
            this.editor.menu.add({
                tabs: {
                    editbox: {
                        groups: {
                            documentbox: {
                                title: Zedity.t('Document'),
                                order: -1000,
                                class: 'zedity-group-box',
                                features: {
                                    insert: {
                                        type: 'button',
                                        icon: 'document',
                                        label: Zedity.t('Insert'),
                                        title: Zedity.t('Insert document'),
                                        onclick: function(e, ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return;
                                            box.insert()
                                        }
                                    },
                                    read: {
                                        type: 'toggle',
                                        order: 0,
                                        state: [{
                                            label: Zedity.t('Read'),
                                            icon: 'view',
                                            title: Zedity.t('Read document')
                                        }, {
                                            label: Zedity.t('Close'),
                                            icon: 'view',
                                            title: Zedity.t('Close document')
                                        }],
                                        onclick: function(e, ed, before) {
                                            var box = ed.boxes.selected();
                                            if (!box) return false;
                                            switch (before) {
                                                case 0:
                                                    box.start();
                                                    break;
                                                case 1:
                                                    box.stop();
                                                    break
                                            }
                                        },
                                        enable: function(ed, box) {
                                            return box && box.$this.find('object,iframe').length > 0
                                        },
                                        refresh: function(ed, box) {
                                            if (!box) return;
                                            this.$button.trigger('toggle', box.$this.hasClass('zedity-playing') ? 1 : 0)
                                        }
                                    }
                                },
                                show: function(ed, box) {
                                    return box && box.type == 'Document'
                                }
                            }
                        }
                    }
                }
            }, 'documentbox');
            return this
        },
        _sizeLimits: function() {
            var sl = Zedity.Box.prototype._sizeLimits.call(this);
            var service = this.getService();
            if (!service) return sl;
            return {
                minWidth: service.sizeLimits.minWidth || sl.minWidth,
                maxWidth: service.sizeLimits.maxWidth || sl.maxWidth,
                minHeight: service.sizeLimits.minHeight || sl.minHeight,
                maxHeight: service.sizeLimits.maxHeight || sl.maxHeight
            }
        },
        _save: function(callback) {
            Zedity.Box.prototype._save.call(this);
            this.$this.find('.zedity-boxoverlay').remove();
            if (typeof(callback) == 'function') callback.call(this);
            return this
        },
        content: function(content) {
            if (content != null) {
                if (typeof content == 'string' || content instanceof String) {
                    content = $.trim(content);
                    var embed = Zedity.core.embed.parse(content, 'document');
                    if (!embed.code) {
                        if (/^https?:\/\/./.test(content) && Zedity.core.embed.getServices('document').indexOf('google_viewer') > -1) {
                            return Zedity.core._call(this, 'content', 'https://docs.google.com/viewer?url=' + encodeURIComponent(content))
                        } else {
                            this.editor._error({
                                message: Zedity.t('Please provide a valid link/embed code for any of the supported document embed services or a direct link to a document.')
                            });
                            return Zedity.Box.prototype.content.call(this)
                        }
                    }
                    content = (embed.iframe || embed.flash) + '<div class="zedity-boxoverlay"/>';
                    this.$this.attr('data-service', embed.service)
                } else {
                    this.editor._error({
                        message: Zedity.t('Could not interpret the content as document.')
                    });
                    return Zedity.Box.prototype.content.call(this)
                }
            }
            content = Zedity.Box.prototype.content.call(this, content);
            var $o = $('<div/>').html(content).find('object,iframe');
            content = $o.attr('src') || $o.attr('data') || '';
            if (content.indexOf('//docs.google.com/viewer?url=') > -1) {
                content = decodeURIComponent(/docs.google.com\/viewer\?url=(.*?)(?:&|$)/.exec(content)[1])
            }
            this._resize();
            this.editor.boxes.refreshSelected();
            return content
        },
        select: function() {
            if (this.$this.hasClass('zedity-editing') || this.$this.hasClass('zedity-playing')) return this;
            Zedity.Box.prototype.select.call(this);
            return this
        },
        rotation: function(setting) {
            if (setting != null) {
                this.editor._error({
                    message: Zedity.t('%s can\'t be rotated.', 'Document box')
                })
            }
            return 0
        },
        background: function(setting) {
            if (setting != null) {
                this.editor._error({
                    message: Zedity.t('%s doesn\'t support background property.', 'Document box')
                })
            }
            return {
                type: 'solid',
                alpha: 1,
                colors: ['transparent']
            }
        },
        corners: function(setting) {
            if (setting != null) {
                this.editor._error({
                    message: Zedity.t('%s doesn\'t support rounded corners.', 'Document box')
                })
            }
            return {
                'border-top-left-radius': 0,
                'border-top-right-radius': 0,
                'border-bottom-left-radius': 0,
                'border-bottom-right-radius': 0
            }
        },
        flip: function(setting) {
            if (setting != null) {
                this.editor._error({
                    message: Zedity.t('%s doesn\'t support flipping.', 'Document box')
                })
            }
            return 'none'
        },
        start: function() {
            Zedity.Box.prototype.start.call(this);
            var $obj = this.$this.find('object,iframe');
            if ($obj.lenght == 0) return this;
            if (this.$this.data('ui-draggable')) this.$this.draggable('option', 'disabled', true);
            if (this.$this.data('ui-resizable')) this.$this.resizable('option', 'disabled', true);
            this.$this.removeClass('ui-state-disabled');
            this.$this.addClass('zedity-playing').find('.zedity-boxoverlay').hide();
            return this
        },
        stop: function() {
            Zedity.Box.prototype.stop.call(this);
            var $obj = this.$this.find('object,iframe');
            if ($obj.lenght == 0) return this;
            if (this.$this.data('ui-draggable')) this.$this.draggable('option', 'disabled', false);
            if (this.$this.data('ui-resizable')) this.$this.resizable('option', 'disabled', false);
            this.$this.removeClass('zedity-playing').find('.zedity-boxoverlay').show();
            return this
        },
        insert: function() {
            Zedity.Box.prototype.insert.call(this);
            $('.zedity-dialog-document').data('box', this).dialog('open');
            return this
        },
        getService: function() {
            var service = this.$this.attr('data-service') || this.$this.find('object,iframe').attr('data-service');
            return Zedity.core.embed.services[service]
        },
        duplicate: function() {
            var newbox = Zedity.Box.prototype.duplicate.call(this);
            var $obj = newbox.$this.find('object,iframe');
            var service = newbox.getService();
            if (service) {
                $obj.attr('id', Zedity.core.genId(service.service))
            }
            return newbox
        },
        init: function() {
            Zedity.Box.prototype.init.call(this);
            if ($('.zedity-dialog-document').length == 0) {
                var $dialog = $('<div class="zedity-dialog-document">' + '<div class="tabs">' + '<ul>' + '<li><a href="#tab-document-embed">' + Zedity.t('Embed') + '</a></li>' + '</ul>' + '<div id="tab-document-embed">' + Zedity.t('Insert document embed code or url:') + '<br/>' + '<textarea id="zedity-txtDocumentEmbed" rows="4"></textarea>' + '<p>' + Zedity.t('Supported services:') + '<br/><span id="zedity-lblDocumentServices"></span></p>' + '<p>' + Zedity.t('Supported documents:') + '<br/>' + Zedity.t('PDF documents, Microsoft Office documents, Apple Pages, Adobe Photoshop and Illustrator, and more.') + '</p>' + '</div>' + '</div>' + '</div>');
                $dialog.find('.tabs').tabs({
                    activate: function(event, ui) {
                        $(this).find('.ui-tabs-panel:visible').find('input[type=text],textare,select').filter(':visible').filter(':first').focus()
                    }
                });
                this.editor.$container.append($dialog);
                $dialog.dialog({
                    title: Zedity.t('Insert document'),
                    dialogClass: 'zedity-dialog',
                    autoOpen: false,
                    modal: true,
                    resizable: false,
                    position: {
                        my: 'center',
                        at: 'center',
                        of: window.top
                    },
                    open: function() {
                        var $this = $(this);
                        var box = $this.data('box');
                        var disabled = [];
                        var services = Zedity.core.embed.getServices('document', true);
                        $('#zedity-lblDocumentServices').html(services.join(', '));
                        $this.find('input[type=text],textarea').val('');
                        $this.find('.tabs').tabs('option', {
                            active: 0,
                            disabled: disabled
                        });
                        $('#zedity-txtDocumentEmbed').val(box.content()).focus()
                    },
                    close: function() {
                        $(this).data('box', null)
                    },
                    buttons: [{
                        text: Zedity.t('OK'),
                        class: 'zedity-button-ok',
                        click: function() {
                            var box = $(this).data('box');
                            $(this).dialog('close');
                            if (box) {
                                var content = $('#zedity-txtDocumentEmbed').val();
                                box.content(content)
                            }
                        }
                    }, {
                        text: Zedity.t('Cancel'),
                        class: 'zedity-button-cancel',
                        click: function() {
                            $(this).dialog('close')
                        }
                    }]
                })
            }
            return this
        }
    });
    Zedity.Box.Document.type = 'Document';
    Zedity.Box.Document.sizeLimits = {
        minWidth: 200,
        minHeight: 200,
        maxWidth: null,
        maxHeight: null
    };
    Zedity.Box.Document._defaults = {
        width: 200,
        height: 200
    };
    Zedity.Box.register({
        type: Zedity.Box.Document.type,
        section: 'media-embed',
        order: 200
    });
    Zedity.core.embed.add('slideshare', {
        url: 'http://www.slideshare.net/',
        type: 'document',
        regex: [new RegExp('slideshare\\.net/.*?/.*?'), new RegExp('slideshare\\.net/slideshow/embed_code/(.*?)(\\?|/|&|"|\'|$)')],
        parser: function(code, embed) {
            if (!code[1]) {
                try {
                    var data = $.ajax({
                        type: 'GET',
                        url: '//www.slideshare.net/api/oembed/2?format=json&url=' + embed,
                        dataType: 'json',
                        async: false
                    });
                    data = JSON.parse(data.responseText);
                    code = this.regex[0].exec(data.html)
                } catch (e) {
                    code = undefined
                }
                if (!code) return {}
            }
            return {
                code: code[1],
                iframe: '//www.slideshare.net/slideshow/embed_code/' + code[1] + '?rel=0'
            }
        },
        sizeLimits: {
            minWidth: 200,
            minHeight: 200
        }
    });
    Zedity.core.embed.add('scribd', {
        url: 'http://www.scribd.com/',
        type: 'document',
        regex: [new RegExp('scribd\\.com/(?:doc|embeds)/(.*?)(\\?|/|&|"|\'|$)')],
        parser: function(code) {
            return {
                code: code[1],
                iframe: '//www.scribd.com/embeds/' + code[1] + '/content?start_page=1&amp;view_mode=scroll&amp;show_recommendations=false'
            }
        },
        sizeLimits: {
            minWidth: 360,
            minHeight: 320
        }
    });
    Zedity.core.embed.add('google_drive', {
        url: 'https://drive.google.com/',
        type: 'document',
        regex: [new RegExp('drive\\.google\\.com/file/d/(.*?)(&|/|$)'), new RegExp('docs\\.google\\.com/spreadsheet/ccc\\?key=(.*?)(&|/|$)'), new RegExp('docs\\.google\\.com/(?:presentation|document|drawings)/d/(.*?)(&|/|$)')],
        parser: function(code) {
            return {
                code: code[1],
                iframe: '//drive.google.com/file/d/' + code[1] + '/preview'
            }
        },
        sizeLimits: {
            minWidth: 200,
            minHeight: 200
        }
    });
    Zedity.core.embed.add('google_viewer', {
        url: 'https://docs.google.com/viewer',
        type: 'document',
        regex: [new RegExp('docs\\.google\\.com/(?:viewer|gview)\\?.*?url=(.*?)(&|$)')],
        parser: function(code) {
            return {
                code: code[1],
                iframe: '//docs.google.com/viewer?url=' + code[1] + '&amp;embedded=true'
            }
        },
        sizeLimits: {
            minWidth: 200,
            minHeight: 200
        }
    })
})(jQuery);
(function($) {
    if (!Zedity) throw new Error(Zedity.t('%s needs %s.', 'Zedity.Box.Draw', 'Zedity'));
    if (!Zedity.Box) throw new Error(Zedity.t('%s needs %s.', 'Zedity.Box.Draw', 'Zedity.Box'));
    Zedity.Box.Draw = function(options) {
        this.type = 'Draw';
        this._defaults = Zedity.Box.Draw._defaults;
        Zedity.Box.prototype.constructor.call(this, options);
        if (this.$this.find('svg').length == 0) {
            this.$this.append('<svg xmlns="' + Zedity.core.svg.NS + '" class="zedity-content" style="width:100%;height:100%;overflow:hidden"/>');
            if (this.$this.find('.zedity-empty').length == 0) {
                this.$this.append('<div class="zedity-empty"><p>' + Zedity.t('Click %s to draw.', '<span class="zedity-button"><span class="zicon zicon-draw zicon-size-s"></span></span>') + '</p></div>')
            }
        }
        this._data.svgUndo = [this.$this.find('svg').html()]
    };
    Zedity.Box.Draw.prototype = Object.create(Zedity.Box.prototype);
    Zedity.Box.Draw.prototype.constructor = Zedity.Box.Draw;
    $.extend(Zedity.Box.Draw.prototype, {
        createPropBar: function(options) {
            Zedity.Box.prototype.createPropBar.call(this);
            this.editor.menu.add({
                tabs: {
                    editbox: {
                        groups: {
                            drawbox: {
                                title: Zedity.t('Draw'),
                                order: -1000,
                                class: 'zedity-group-box',
                                features: {
                                    insert: {
                                        type: 'button',
                                        icon: 'draw',
                                        label: Zedity.t('Draw'),
                                        title: Zedity.t('Draw'),
                                        onclick: function(e, ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return;
                                            box.insert()
                                        }
                                    }
                                },
                                show: function(ed, box) {
                                    return box && box.type == 'Draw'
                                }
                            }
                        }
                    },
                    drawbox: {
                        icon: 'draw',
                        title: Zedity.t('Draw'),
                        order: 2000,
                        groups: {
                            edit: {
                                title: Zedity.t('Editing'),
                                order: 0,
                                class: 'zedity-group-box',
                                features: {
                                    done: {
                                        type: 'button',
                                        icon: 'ok',
                                        order: 0,
                                        label: Zedity.t('Done'),
                                        title: Zedity.t('Done editing'),
                                        onclick: function(e, ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return;
                                            box.stop()
                                        }
                                    },
                                    sep: {
                                        type: 'separator',
                                        order: 10
                                    },
                                    undo: {
                                        type: 'button',
                                        icon: 'undo',
                                        size: 'xs',
                                        order: 20,
                                        label: Zedity.t('Undo'),
                                        title: Zedity.t('Undo modifications'),
                                        onclick: function(e, ed) {
                                            Zedity.core.svg.undo()
                                        }
                                    },
                                    redo: {
                                        type: 'button',
                                        icon: 'redo',
                                        size: 'xs',
                                        order: 30,
                                        label: Zedity.t('Redo'),
                                        title: Zedity.t('Redo modifications'),
                                        onclick: function(e, ed) {
                                            Zedity.core.svg.redo()
                                        }
                                    },
                                    clear: {
                                        type: 'button',
                                        icon: 'delete',
                                        order: 40,
                                        label: Zedity.t('Clear all'),
                                        title: Zedity.t('Clear all'),
                                        onclick: function(e, ed) {
                                            Zedity.core.svg.$el.html('');
                                            Zedity.core.svg.saveUndo()
                                        }
                                    }
                                }
                            },
                            style: {
                                title: Zedity.t('Style'),
                                order: 50,
                                features: {
                                    color: {
                                        type: 'extpanel',
                                        label: Zedity.t('Color'),
                                        icon: 'empty zicon-colorpicker',
                                        title: Zedity.t('Select stroke color'),
                                        class: 'zedity-svgstroke-colorpicker-button',
                                        order: 0,
                                        build: function($panel, ed) {
                                            this.$button.find('.zicon').width(30);
                                            $panel.append('<div class="zedity-svgstroke-colorpicker"/>');
                                            var $cp = $panel.find('.zedity-svgstroke-colorpicker');
                                            $cp.colorPicker({
                                                colors: ['#ffffff', '#f2f2f2', '#d8d8d8', '#bdbdbd', '#a4a4a4', '#6e6e6e', '#424242', '#2e2e2e', '#000000', '#fbefef', '#f8e0e0', '#f5a9a9', '#f78181', '#fe2e2e', '#df0101', '#b40404', '#8a0808', '#3b0b0b', '#fbf5ef', '#f8ece0', '#f5d0a9', '#faac58', '#ff8000', '#df7401', '#b45f04', '#8a4b08', '#3b240b', '#fbfbef', '#f5f6ce', '#f2f5a9', '#f4fa58', '#ffff00', '#d7df01', '#aeb404', '#868a08', '#393b0b', '#f5fbef', '#e3f6ce', '#d0f5a9', '#acfa58', '#80ff00', '#74df00', '#5fb404', '#4b8a08', '#38610b', '#effbef', '#cef6ce', '#a9f5a9', '#58fa58', '#00ff00', '#01df01', '#04b404', '#088a08', '#0b3b0b', '#effbfb', '#cef6f5', '#a9f5f2', '#58faf4', '#00ffff', '#01dfd7', '#04b4ae', '#088a85', '#0b3b39', '#eff5fb', '#cee3f6', '#81bef7', '#2e9afe', '#0080ff', '#045fb4', '#084b8a', '#08388a', '#0b243b', '#efeffb', '#cecef6', '#5858fa', '#2e2efe', '#0000ff', '#0404b4', '#08088a', '#0b0b61', '#0b0b3b', '#f5effb', '#e3cef6', '#be81f7', '#ac58fa', '#9a2efe', '#5f04b4', '#4b088a', '#380b61', '#240b3b', '#fbeffb', '#f6cef5', '#f781f3', '#fe2ef7', '#ff00ff', '#df01d7', '#b404ae', '#610b5e', '#3b0b39', '#fbeff5', '#f6cee3', '#f5a9d0', '#fa58ac', '#ff0080', '#df0174', '#b4045f', '#610b38', '#3b0b24'],
                                                defaultcolor: '#000000',
                                                fills: false,
                                                alpha: false,
                                                buttons: true,
                                                maxcols: 9,
                                                onchange: function(e, color) {
                                                    var box = ed.boxes.selected();
                                                    if (!box) return false;
                                                    Zedity.core.svg._curColor = color;
                                                    box.editor.menu.$this.find('.zedity-svgstroke-colorpicker-button .zicon').css('background', color)
                                                }
                                            })
                                        },
                                        refresh: function(ed, box) {
                                            var $cp = this.$button.extpanel('instance').panel.find('.zedity-svgstroke-colorpicker');
                                            $cp.colorPicker('selectcolor', Zedity.core.svg._curColor);
                                            this.$button.find('.zicon').css('background', Zedity.core.svg._curColor)
                                        }
                                    },
                                    width: {
                                        type: 'smallpanel',
                                        size: 'xs,',
                                        order: 10,
                                        build: function($panel, ed) {
                                            $panel.append('<table>' + '<tr><td>' + Zedity.t('Width') + ':</td>' + '<td><input class="zedity-txtSvgStrokeWidth" type="number" maxlength="4" min="1" max="20"></tr>' + '</table>');
                                            var $sw = $panel.find('.zedity-txtSvgStrokeWidth').css('width', 50);
                                            $sw.attr('title', Zedity.t('Set stroke width'));
                                            $sw.on('change', function() {
                                                Zedity.core.svg._curWidth = $sw.val()
                                            })
                                        },
                                        refresh: function(ed) {
                                            this.$panel.find('.zedity-txtSvgStrokeWidth').val(Zedity.core.svg._curWidth)
                                        }
                                    },
                                    fill: {
                                        type: 'extpanel',
                                        size: 'xs',
                                        label: Zedity.t('Fill'),
                                        icon: 'empty zicon-colorpicker',
                                        title: Zedity.t('Select fill color'),
                                        class: 'zedity-svgfill-colorpicker-button',
                                        order: 20,
                                        build: function($panel, ed) {
                                            this.$button.find('.zicon').width(30);
                                            $panel.append('<div class="zedity-svgfill-colorpicker"/>');
                                            var $cp = $panel.find('.zedity-svgfill-colorpicker');
                                            $cp.colorPicker({
                                                colors: ['transparent', '#ffffff', '#f2f2f2', '#d8d8d8', '#bdbdbd', '#a4a4a4', '#6e6e6e', '#424242', '#000000', '#fbefef', '#f8e0e0', '#f5a9a9', '#f78181', '#fe2e2e', '#df0101', '#b40404', '#8a0808', '#3b0b0b', '#fbf5ef', '#f8ece0', '#f5d0a9', '#faac58', '#ff8000', '#df7401', '#b45f04', '#8a4b08', '#3b240b', '#fbfbef', '#f5f6ce', '#f2f5a9', '#f4fa58', '#ffff00', '#d7df01', '#aeb404', '#868a08', '#393b0b', '#f5fbef', '#e3f6ce', '#d0f5a9', '#acfa58', '#80ff00', '#74df00', '#5fb404', '#4b8a08', '#38610b', '#effbef', '#cef6ce', '#a9f5a9', '#58fa58', '#00ff00', '#01df01', '#04b404', '#088a08', '#0b3b0b', '#effbfb', '#cef6f5', '#a9f5f2', '#58faf4', '#00ffff', '#01dfd7', '#04b4ae', '#088a85', '#0b3b39', '#eff5fb', '#cee3f6', '#81bef7', '#2e9afe', '#0080ff', '#045fb4', '#084b8a', '#08388a', '#0b243b', '#efeffb', '#cecef6', '#5858fa', '#2e2efe', '#0000ff', '#0404b4', '#08088a', '#0b0b61', '#0b0b3b', '#f5effb', '#e3cef6', '#be81f7', '#ac58fa', '#9a2efe', '#5f04b4', '#4b088a', '#380b61', '#240b3b', '#fbeffb', '#f6cef5', '#f781f3', '#fe2ef7', '#ff00ff', '#df01d7', '#b404ae', '#610b5e', '#3b0b39', '#fbeff5', '#f6cee3', '#f5a9d0', '#fa58ac', '#ff0080', '#df0174', '#b4045f', '#610b38', '#3b0b24'],
                                                defaultcolor: 'transparent',
                                                fills: false,
                                                alpha: false,
                                                buttons: true,
                                                maxcols: 9,
                                                onchange: function(e, color) {
                                                    var box = ed.boxes.selected();
                                                    if (!box) return false;
                                                    Zedity.core.svg._curFill = color;
                                                    box.editor.menu.$this.find('.zedity-svgfill-colorpicker-button .zicon').css('background', color)
                                                }
                                            })
                                        },
                                        enable: function() {
                                            return Zedity.core.svg.TOOLS_SUPPORT_FILL.indexOf(Zedity.core.svg._tool) > -1
                                        },
                                        refresh: function(ed, box) {
                                            var $cp = this.$button.extpanel('instance').panel.find('.zedity-svgfill-colorpicker');
                                            $cp.colorPicker('selectcolor', Zedity.core.svg._curFill);
                                            this.$button.find('.zicon').css('background', Zedity.core.svg._curFill)
                                        }
                                    }
                                },
                                enable: function() {
                                    return Zedity.core.svg._tool !== Zedity.core.svg.TOOL_ERASER
                                }
                            },
                            tools: {
                                title: Zedity.t('Tools'),
                                order: 100,
                                features: {
                                    draw: {
                                        type: 'button',
                                        icon: 'freehand',
                                        order: 0,
                                        label: Zedity.t('Draw'),
                                        title: Zedity.t('Freehand drawing'),
                                        onclick: function(e, ed) {
                                            Zedity.core.svg.tool(Zedity.core.svg.TOOL_DRAW);
                                            ed.menu.refresh('drawbox')
                                        },
                                        refresh: function(feat) {
                                            this.$button.toggleClass('zedity-pressed', Zedity.core.svg._tool == Zedity.core.svg.TOOL_DRAW)
                                        }
                                    },
                                    shapes: {
                                        type: 'menu',
                                        icon: 'shapes',
                                        size: 'n',
                                        order: 5,
                                        label: Zedity.t('Shapes'),
                                        title: Zedity.t('Draw shapes'),
                                        items: [{
                                            icon: 'line',
                                            label: Zedity.t('Line'),
                                            value: Zedity.core.svg.TOOL_LINE
                                        }, {
                                            icon: 'rectangle',
                                            label: Zedity.t('Rectangle'),
                                            value: Zedity.core.svg.TOOL_RECTANGLE
                                        }, {
                                            icon: 'circle',
                                            label: Zedity.t('Circle'),
                                            value: Zedity.core.svg.TOOL_CIRCLE
                                        }, {
                                            label: '--'
                                        }, {
                                            icon: 'arrow',
                                            label: Zedity.t('Arrow'),
                                            value: Zedity.core.svg.TOOL_ARROW
                                        }, {
                                            icon: 'polygon',
                                            label: Zedity.t('Polygon'),
                                            value: Zedity.core.svg.TOOL_POLYGON
                                        }, {
                                            icon: 'star',
                                            label: Zedity.t('Star'),
                                            value: Zedity.core.svg.TOOL_STAR
                                        }],
                                        onclick: function(val, e, ed) {
                                            Zedity.core.svg.tool(parseInt(val, 10));
                                            switch (Zedity.core.svg._tool) {
                                                case Zedity.core.svg.TOOL_POLYGON:
                                                    Zedity.core.dialog({
                                                        title: Zedity.t('Draw polygon'),
                                                        question: Zedity.t('Number of faces') + ' ' + Zedity.t('(min: %s, max: %s)', 3, 20),
                                                        default: Zedity.core.svg._data.faces,
                                                        acceptedChars: '1234567890',
                                                        ok: function(answer) {
                                                            Zedity.core.svg._data.faces = Math.max(Math.min(answer, 20), 3)
                                                        }
                                                    });
                                                    break;
                                                case Zedity.core.svg.TOOL_STAR:
                                                    Zedity.core.dialog({
                                                        title: Zedity.t('Draw star'),
                                                        question: Zedity.t('Number of star spikes') + ' ' + Zedity.t('(min: %s, max: %s)', 4, 20),
                                                        default: Zedity.core.svg._data.spikes,
                                                        acceptedChars: '1234567890',
                                                        ok: function(answer) {
                                                            Zedity.core.svg._data.spikes = Math.max(Math.min(answer, 20), 4)
                                                        }
                                                    });
                                                    break
                                            }
                                            ed.menu.refresh('drawbox')
                                        },
                                        refresh: function() {
                                            var $icon = this.$button.find('.zicon');
                                            if (Zedity.core.svg.TOOLS_SHAPES.indexOf(Zedity.core.svg._tool) > -1) {
                                                this.$button.addClass('zedity-pressed');
                                                var $o = this.$menu.find('[value=' + Zedity.core.svg._tool + ']');
                                                $icon.attr('class', 'zicon zicon-size-n zicon-' + $o.attr('data-icon'));
                                                Zedity.core._later(this, function() {
                                                    this.$button.find('.ui-selectmenu-text').html($o.html())
                                                }, 10)
                                            } else {
                                                this.$button.removeClass('zedity-pressed');
                                                $icon.attr('class', 'zicon zicon-size-n zicon-shapes');
                                                this.$button.find('.ui-selectmenu-text').text(Zedity.t('Shapes'))
                                            }
                                        }
                                    },
                                    sep: {
                                        type: 'separator',
                                        order: 10
                                    },
                                    eraser: {
                                        type: 'button',
                                        icon: 'eraser',
                                        order: 20,
                                        label: Zedity.t('Eraser'),
                                        title: Zedity.t('Erase objects'),
                                        onclick: function(e, ed) {
                                            Zedity.core.svg.tool(Zedity.core.svg.TOOL_ERASER);
                                            ed.menu.refresh('drawbox')
                                        },
                                        enable: function() {
                                            return Zedity.core.svg.$el && 'getIntersectionList' in Zedity.core.svg.$el[0]
                                        },
                                        refresh: function(feat) {
                                            this.$button.toggleClass('zedity-pressed', Zedity.core.svg._tool == Zedity.core.svg.TOOL_ERASER)
                                        }
                                    }
                                }
                            }
                        },
                        show: function(ed, box) {
                            return box && box.type == 'Draw' && box.$this.hasClass('zedity-editing')
                        }
                    }
                }
            }, 'drawbox');
            return this
        },
        _save: function(callback) {
            Zedity.Box.prototype._save.call(this);
            this.$this.find('.zedity-boxoverlay').remove();
            if (typeof(callback) == 'function') callback.call(this);
            return this
        },
        select: function() {
            if (this.$this.hasClass('zedity-editing') || this.$this.hasClass('zedity-playing')) return this;
            Zedity.Box.prototype.select.call(this);
            return this
        },
        start: function() {
            var err = '';
            if (this.rotation() != 0) err = Zedity.t('rotated');
            if (this.flip() != 'none') err = Zedity.t('flipped');
            if (err) {
                Zedity.core.dialog({
                    title: Zedity.t('Draw'),
                    message: Zedity.t('It is not possible to draw on a %s box.', err)
                });
                return this
            }
            Zedity.Box.prototype.start.call(this);
            var $obj = this.$this.find('svg');
            if ($obj.lenght == 0) return this;
            Zedity.core.svg.attach($obj, this);
            if (this.$this.data('ui-draggable')) this.$this.draggable('option', 'disabled', true);
            if (this.$this.data('ui-resizable')) this.$this.resizable('option', 'disabled', true);
            if (this.$this.data('ui-rotatable')) this.$this.rotatable('option', 'disabled', true);
            this.$this.removeClass('ui-state-disabled');
            this.$this.find('.zedity-empty').remove();
            this.$this.addClass('zedity-editing').find('.zedity-boxoverlay').hide();
            var tabs = [];
            for (var i = this.editor.menu._tabs.length - 1; i >= 0; --i) {
                if (this.editor.menu._tabs[i].name != 'drawbox') {
                    tabs.push(this.editor.menu._tabIdx(this.editor.menu._tabs[i].name))
                }
            }
            this.editor.menu.$this.tabs('option', 'disabled', tabs);
            this.editor.menu.openTab('drawbox', true);
            return this
        },
        stop: function() {
            Zedity.Box.prototype.stop.call(this);
            this._data.stopping = true;
            var $obj = this.$this.find('svg');
            if ($obj.lenght == 0) return this;
            Zedity.core.svg.detach();
            if (this.$this.data('ui-draggable')) this.$this.draggable('option', 'disabled', false);
            if (this.$this.data('ui-resizable')) this.$this.resizable('option', 'disabled', false);
            if (this.$this.data('ui-rotatable')) this.$this.rotatable('option', 'disabled', false);
            if (this.$this.hasClass('zedity-editing')) {
                this.$this.removeClass('zedity-editing');
                this.editor.menu.$this.tabs('option', 'disabled', []);
                this.editor.menu.openTab('editbox');
                this.editor._changed()
            }
            this._data.stopping = false;
            return this
        },
        insert: function() {
            Zedity.Box.prototype.insert.call(this);
            this.start();
            return this
        },
        init: function() {
            Zedity.Box.prototype.init.call(this)
        }
    });
    Zedity.Box.Draw.type = 'Draw';
    Zedity.Box.Draw.sizeLimits = {
        minWidth: 100,
        minHeight: 50,
        maxWidth: null,
        maxHeight: null
    };
    Zedity.Box.Draw._defaults = {
        width: 300,
        height: 200,
        maxUndo: 10
    };
    Zedity.Box.register({
        type: Zedity.Box.Draw.type,
        section: 'advanced',
        order: 50
    })
})(jQuery);
(function($) {
    Zedity.core.svg = {
        NS: 'http://www.w3.org/2000/svg',
        $el: null,
        $wrapper: null,
        box: null,
        _selected: null,
        _tool: 1,
        _data: {
            faces: 4,
            spikes: 5
        },
        _draw: false,
        _curColor: '#000000',
        _curWidth: 3,
        _curFill: 'transparent',
        TOOL_ERASER: -1,
        TOOL_DRAW: 1,
        TOOL_LINE: 2,
        TOOL_RECTANGLE: 3,
        TOOL_CIRCLE: 4,
        TOOL_ARROW: 5,
        TOOL_POLYGON: 6,
        TOOL_STAR: 7,
        get TOOLS_SUPPORT_FILL() {
            return [this.TOOL_RECTANGLE, this.TOOL_CIRCLE, this.TOOL_POLYGON, this.TOOL_STAR]
        },
        get TOOLS_SHAPES() {
            return [this.TOOL_LINE, this.TOOL_RECTANGLE, this.TOOL_CIRCLE, this.TOOL_ARROW, this.TOOL_POLYGON, this.TOOL_STAR]
        },
        S_START: 1,
        S_DRAW: 2,
        S_END: 3,
        attach: function(el, box) {
            var self = this;

            function getNormalizedCoords(e) {
                var o = Zedity.core.supports.touch() && /chrome/i.test(navigator.userAgent) ? self.$el[0].getBoundingClientRect() : self.$el.offset();
                if (e.originalEvent.touches && e.originalEvent.touches[0]) {
                    var x = Math.round(e.originalEvent.touches[0].pageX - o.left);
                    var y = Math.round(e.originalEvent.touches[0].pageY - o.top)
                } else {
                    x = Math.round(e.pageX - o.left);
                    y = Math.round(e.pageY - o.top)
                }
                return {
                    x: x,
                    y: y
                }
            };
            this.$el = $(el);
            this.$wrapper = this.$el.parent();
            this.box = box;
            this._draw = false;
            if (!Zedity.core.supports.touch()) {
                this.box.editor.$this.on('mousedown.zeditysvg dragstart.zeditysvg', function(e) {
                    self._draw = true
                });
                $(document).on('mouseup.zeditysvg dragend.zeditysvg', function(e) {
                    self._draw = false
                })
            }
            this.box.editor.$this.on('mousemove.zeditysvg mouseup.zeditysvg touchmove.zeditysvg touchend.zeditysvg', function(e) {
                var c = getNormalizedCoords(e);
                if (e.type == 'mouseup' || e.type == 'touchend') {
                    self._draw = false;
                    e.which = 0
                } else if (e.type == 'touchmove') {
                    self._draw = true;
                    e.which = 1
                }
                switch (parseInt(self._tool, 10)) {
                    case self.TOOL_DRAW:
                        self.toolDraw(c.x, c.y, e.which);
                        break;
                    case self.TOOL_ERASER:
                        self.toolEraser(c.x, c.y, e.which);
                        break;
                    case self.TOOL_LINE:
                        self.toolLine(c.x, c.y, e.which);
                        break;
                    case self.TOOL_RECTANGLE:
                        self.toolRectangle(c.x, c.y, e.which);
                        break;
                    case self.TOOL_CIRCLE:
                        self.toolCircle(c.x, c.y, e.which);
                        break;
                    case self.TOOL_ARROW:
                        self.toolArrow(c.x, c.y, e.which);
                        break;
                    case self.TOOL_POLYGON:
                        self.toolPolygon(c.x, c.y, e.which);
                        break;
                    case self.TOOL_STAR:
                        self.toolStar(c.x, c.y, e.which);
                        break
                }
            });
            this.$el.on('mousemove.zeditysvg touchmove.zeditysvg', function(e) {
                if (self._tool == self.TOOL_ERASER) {
                    if (self._draw) {
                        var c = getNormalizedCoords(e);
                        var rpos = self.$el[0].createSVGRect();
                        rpos.x = c.x;
                        rpos.y = c.y;
                        rpos.width = rpos.height = 5;
                        var list = self.$el[0].getIntersectionList(rpos, null);
                        if (list.length > 0) {
                            $(list).remove();
                            self.saveUndo()
                        }
                    }
                }
            })
        },
        detach: function() {
            if (!this.$el) return;
            this.box.editor.$this.off('mousemove.zeditysvg mouseup.zeditysvg touchmove.zeditysvg touchend.zeditysvg');
            if (!Zedity.core.supports.touch()) {
                $(document).off('mouseup.zeditysvg');
                this.box.editor.$this.off('mousedown.zeditysvg')
            }
            this.$el.off('mousemove.zeditysvg touchmove.zeditysvg');
            this.$el = null
        },
        saveUndo: function() {
            this.box._data.svgUndoIdx = (this.box._data.svgUndoIdx || 0);
            this.box._data.svgUndo = this.box._data.svgUndo.slice(0, this.box._data.svgUndoIdx + 1);
            this.box._data.svgUndo.push((new XMLSerializer()).serializeToString(this.$el[0]));
            this.box._data.svgUndo = this.box._data.svgUndo.slice(-this.box._options.maxUndo);
            this.box._data.svgUndoIdx = this.box._data.svgUndo.length - 1
        },
        undo: function() {
            this.box._data.svgUndoIdx = Math.max(--this.box._data.svgUndoIdx, 0);
            this.$wrapper.html(this.box._data.svgUndo[this.box._data.svgUndoIdx]);
            this.attach(this.$wrapper.find('svg'), this.box)
        },
        redo: function() {
            this.box._data.svgUndoIdx = Math.min(++this.box._data.svgUndoIdx, this.box._data.svgUndo.length - 1, this.box._options.maxUndo - 1);
            this.$wrapper.html(this.box._data.svgUndo[this.box._data.svgUndoIdx]);
            this.attach(this.$wrapper.find('svg'), this.box)
        },
        createElement: function(name, append) {
            var el = document.createElementNS(this.NS, name);
            if (append) this.$el.append(el);
            return el
        },
        state: function(b) {
            if (!Zedity.core.supports.touch()) {
                b = this._draw ? 1 : 0
            }
            if (!this._selected && b == 1) {
                return this.S_START
            } else if (this._selected && b == 1) {
                return this.S_DRAW
            } else if (this._selected && b == 0) {
                return this.S_END
            }
        },
        tool: function(tool) {
            this._tool = tool;
            this.$el.parent().toggleClass('eraser', this._tool == this.TOOL_ERASER);
            return this._tool
        },
        toolDraw: function(x, y, b) {
            switch (this.state(b)) {
                case this.S_START:
                    this._selected = this.createElement('path', true);
                    this._selected.setAttributeNS(null, 'fill', 'none');
                    this._selected.setAttributeNS(null, 'stroke-linecap', 'round');
                    this._selected.setAttributeNS(null, 'stroke-linejoin', 'round');
                    this._selected.setAttributeNS(null, 'stroke-width', this._curWidth);
                    this._selected.setAttributeNS(null, 'stroke', this._curColor);
                    this._data.d = 'M' + x + ',' + y;
                    this._selected.setAttributeNS(null, 'd', this._data.d);
                    break;
                case this.S_DRAW:
                    this._data.d += 'L' + x + ',' + y;
                    this._selected.setAttributeNS(null, 'd', this._data.d);
                    break;
                case this.S_END:
                    this._selected = null;
                    this.saveUndo();
                    break
            }
        },
        toolEraser: function(x, y, b) {
            switch (this.state(b)) {
                case this.S_START:
                    this._selected = 1;
                    break;
                case this.S_DRAW:
                    break;
                case this.S_END:
                    this._selected = null;
                    break
            }
        },
        toolLine: function(x, y, b) {
            switch (this.state(b)) {
                case this.S_START:
                    this._selected = this.createElement('line', true);
                    this._selected.setAttributeNS(null, 'stroke-width', this._curWidth);
                    this._selected.setAttributeNS(null, 'stroke', this._curColor);
                    this._selected.setAttributeNS(null, 'x1', x);
                    this._selected.setAttributeNS(null, 'y1', y);
                    this._selected.setAttributeNS(null, 'x2', x);
                    this._selected.setAttributeNS(null, 'y2', y);
                    break;
                case this.S_DRAW:
                    this._selected.setAttributeNS(null, 'x2', x);
                    this._selected.setAttributeNS(null, 'y2', y);
                    break;
                case this.S_END:
                    this._selected = null;
                    this.saveUndo();
                    break
            }
        },
        toolRectangle: function(x, y, b) {
            switch (this.state(b)) {
                case this.S_START:
                    this._selected = this.createElement('rect', true);
                    this._selected.setAttributeNS(null, 'fill', this._curFill);
                    this._selected.setAttributeNS(null, 'stroke-width', this._curWidth);
                    this._selected.setAttributeNS(null, 'stroke', this._curColor);
                    this._selected.setAttributeNS(null, 'x', x);
                    this._selected.setAttributeNS(null, 'y', y);
                    this._selected.setAttributeNS(null, 'width', 0);
                    this._selected.setAttributeNS(null, 'height', 0);
                    this._data.ox = x;
                    this._data.oy = y;
                    break;
                case this.S_DRAW:
                    var w = x - this._data.ox,
                        h = y - this._data.oy;
                    this._selected.setAttributeNS(null, 'x', this._data.ox + (w > 0 ? 0 : w));
                    this._selected.setAttributeNS(null, 'y', this._data.oy + (h > 0 ? 0 : h));
                    this._selected.setAttributeNS(null, 'width', Math.abs(w));
                    this._selected.setAttributeNS(null, 'height', Math.abs(h));
                    break;
                case this.S_END:
                    this._selected = null;
                    this.saveUndo();
                    break
            }
        },
        toolCircle: function(x, y, b) {
            switch (this.state(b)) {
                case this.S_START:
                    this._selected = this.createElement('circle', true);
                    this._selected.setAttributeNS(null, 'fill', this._curFill);
                    this._selected.setAttributeNS(null, 'stroke-width', this._curWidth);
                    this._selected.setAttributeNS(null, 'stroke', this._curColor);
                    this._selected.setAttributeNS(null, 'cx', x);
                    this._selected.setAttributeNS(null, 'cy', y);
                    this._selected.setAttributeNS(null, 'r', 0);
                    this._data.cx = x;
                    this._data.cy = y;
                    break;
                case this.S_DRAW:
                    this._selected.setAttributeNS(null, 'r', Math.round(Math.sqrt(Math.pow(x - this._data.cx, 2) + Math.pow(y - this._data.cy, 2))));
                    break;
                case this.S_END:
                    this._selected = null;
                    this.saveUndo();
                    break
            }
        },
        toolArrow: function(x, y, b) {
            switch (this.state(b)) {
                case this.S_START:
                    this._selected = this.createElement('polyline', true);
                    this._selected.setAttributeNS(null, 'stroke-width', this._curWidth);
                    this._selected.setAttributeNS(null, 'stroke', this._curColor);
                    this._selected.setAttributeNS(null, 'stroke-linecap', 'round');
                    this._selected.setAttributeNS(null, 'stroke-linejoin', 'round');
                    this._selected.setAttributeNS(null, 'fill', 'none');
                    this._selected.setAttributeNS(null, 'points', x + ',' + y);
                    this._data.cx = x;
                    this._data.cy = y;
                    break;
                case this.S_DRAW:
                    var res = '';
                    var slopex = x - this._data.cx,
                        slopey = y - this._data.cy;
                    var r = Math.sqrt(slopex * slopex + slopey * slopey);
                    var sa = this.normAngle(Math.atan2(slopey, slopex) * this._180divPI);
                    var tx = Math.round(Math.min(r / 3, 25)),
                        ty = 0;
                    var a = -this.normAngle(sa - 45) * this._PIdiv180;
                    var sin = Math.sin(a),
                        cos = Math.cos(a);
                    res += Math.round((tx * cos + ty * sin) + this._data.cx) + ',' + Math.round((ty * cos - tx * sin) + this._data.cy) + ' ' + this._data.cx + ',' + this._data.cy + ' ';
                    a = -this.normAngle(sa + 45) * this._PIdiv180;
                    sin = Math.sin(a), cos = Math.cos(a);
                    res += Math.round((tx * cos + ty * sin) + this._data.cx) + ',' + Math.round((ty * cos - tx * sin) + this._data.cy) + ' ' + this._data.cx + ',' + this._data.cy + ' ';
                    res += x + ',' + y;
                    this._selected.setAttributeNS(null, 'points', res);
                    break;
                case this.S_END:
                    this._selected = null;
                    this.saveUndo();
                    break
            }
        },
        toolPolygon: function(x, y, b) {
            switch (this.state(b)) {
                case this.S_START:
                    this._selected = this.createElement('polygon', true);
                    this._selected.setAttributeNS(null, 'fill', this._curFill);
                    this._selected.setAttributeNS(null, 'stroke-width', this._curWidth);
                    this._selected.setAttributeNS(null, 'stroke', this._curColor);
                    this._selected.setAttributeNS(null, 'stroke-linecap', 'round');
                    this._selected.setAttributeNS(null, 'stroke-linejoin', 'round');
                    this._data.cx = x;
                    this._data.cy = y;
                    this._selected.setAttributeNS(null, 'points', x + ',' + y);
                    break;
                case this.S_DRAW:
                    var slopex = x - this._data.cx,
                        slopey = y - this._data.cy;
                    var r = Math.sqrt(slopex * slopex + slopey * slopey);
                    var res = '';
                    var sa = this.normAngle(Math.atan2(slopey, slopex) * this._180divPI);
                    for (var i = 0; i < this._data.faces; ++i) {
                        var tx = r,
                            ty = 0;
                        var a = -this.normAngle(sa + (360 / this._data.faces * i)) * this._PIdiv180;
                        var sin = Math.sin(a),
                            cos = Math.cos(a);
                        res += Math.round((tx * cos + ty * sin) + this._data.cx) + ',' + Math.round((ty * cos - tx * sin) + this._data.cy) + ' '
                    }
                    this._selected.setAttributeNS(null, 'points', res);
                    break;
                case this.S_END:
                    this._selected = null;
                    this.saveUndo();
                    break
            }
        },
        toolStar: function(x, y, b) {
            switch (this.state(b)) {
                case this.S_START:
                    this._selected = this.createElement('polygon', true);
                    this._selected.setAttributeNS(null, 'fill', this._curFill);
                    this._selected.setAttributeNS(null, 'stroke-width', this._curWidth);
                    this._selected.setAttributeNS(null, 'stroke', this._curColor);
                    this._selected.setAttributeNS(null, 'stroke-linecap', 'round');
                    this._selected.setAttributeNS(null, 'stroke-linejoin', 'round');
                    this._data.cx = x;
                    this._data.cy = y;
                    this._selected.setAttributeNS(null, 'points', x + ',' + y);
                    break;
                case this.S_DRAW:
                    var slopex = x - this._data.cx,
                        slopey = y - this._data.cy;
                    var r = Math.sqrt(slopex * slopex + slopey * slopey);
                    var res = '';
                    var sa = this.normAngle(Math.atan2(slopey, slopex) * this._180divPI);
                    for (var i = 0; i < this._data.spikes * 2; ++i) {
                        var tx = (i % 2 == 0 ? r : r / 2),
                            ty = 0;
                        var a = -this.normAngle(sa + (360 / (this._data.spikes * 2) * i)) * this._PIdiv180;
                        var sin = Math.sin(a),
                            cos = Math.cos(a);
                        res += Math.round((tx * cos + ty * sin) + this._data.cx) + ',' + Math.round((ty * cos - tx * sin) + this._data.cy) + ' '
                    }
                    this._selected.setAttributeNS(null, 'points', res);
                    break;
                case this.S_END:
                    this._selected = null;
                    this.saveUndo();
                    break
            }
        },
        _PIdiv180: Math.PI / 180,
        _180divPI: 180 / Math.PI,
        normAngle: function(a) {
            a = a % 360;
            if (a < 0) a += 360;
            return a
        }
    }
})(jQuery);
(function($) {
    if (!Zedity) throw new Error(Zedity.t('%s needs %s.', 'Zedity.Box.Html', 'Zedity'));
    if (!Zedity.Box) throw new Error(Zedity.t('%s needs %s.', 'Zedity.Box.Html', 'Zedity.Box'));
    Zedity.Box.Html = function(options) {
        this.type = 'Html';
        this._defaults = Zedity.Box.Html._defaults;
        Zedity.Box.prototype.constructor.call(this, options);
        this._can.remove('background', 'corners', 'flip');
        if (this.$this.find('.zedity-content').length == 0) {
            this.$this.append('<div class="zedity-content" style="width:100%;height:100%;overflow:auto"></div>');
            if (this.$this.find('.zedity-empty').length == 0) {
                this.$this.append('<div class="zedity-empty"><p>' + Zedity.t('Click %s to insert HTML.', '<span class="zedity-button"><span class="zicon zicon-html zicon-size-s"></span></span>') + '</p></div>')
            }
        } else if (this.$this.find('.zedity-boxoverlay').length == 0 && this.$this.find('.zedity-empty').length == 0) {
            this.$this.append('<div class="zedity-boxoverlay"/>')
        }
        this._data.content = this.$this.find('.zedity-content').html()
    };
    Zedity.Box.Html.prototype = Object.create(Zedity.Box.prototype);
    Zedity.Box.Html.prototype.constructor = Zedity.Box.Html;
    $.extend(Zedity.Box.Html.prototype, {
        createPropBar: function(options) {
            Zedity.Box.prototype.createPropBar.call(this);
            this.editor.menu.add({
                tabs: {
                    editbox: {
                        groups: {
                            htmlbox: {
                                title: Zedity.t('Html'),
                                order: -1000,
                                class: 'zedity-group-box',
                                features: {
                                    insert: {
                                        type: 'button',
                                        icon: 'html',
                                        label: Zedity.t('Insert'),
                                        title: Zedity.t('Insert HTML'),
                                        onclick: function(e, ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return;
                                            box.insert()
                                        }
                                    },
                                    view: {
                                        type: 'toggle',
                                        order: 0,
                                        state: [{
                                            label: Zedity.t('View'),
                                            icon: 'view',
                                            title: Zedity.t('View box content')
                                        }, {
                                            label: Zedity.t('Close'),
                                            icon: 'view',
                                            title: Zedity.t('Close')
                                        }],
                                        onclick: function(e, ed, before) {
                                            var box = ed.boxes.selected();
                                            if (!box) return false;
                                            switch (before) {
                                                case 0:
                                                    box.start();
                                                    break;
                                                case 1:
                                                    box.stop();
                                                    break
                                            }
                                        },
                                        enable: function(ed, box) {
                                            return box && box.$this.children('.zedity-content').contents().length > 0
                                        },
                                        refresh: function(ed, box) {
                                            if (!box) return;
                                            this.$button.trigger('toggle', box.$this.hasClass('zedity-playing') ? 1 : 0)
                                        }
                                    }
                                },
                                show: function(ed, box) {
                                    return box && box.type == 'Html'
                                }
                            }
                        }
                    }
                }
            }, 'htmlbox');
            if ($('.zedity-dialog-html').length == 0) {
                var $dialog = $('<div class="zedity-dialog-html">' + Zedity.t('Insert HTML code:') + '<br/>' + '<textarea id="zedity-txtInsertHtml" rows="10" style="height:86%"></textarea>' + '<div style="margin-top:10px"><span>' + Zedity.t('Safe mode:') + ' </span>' + '<select id="zedity-ddSSM" style="width:150px">' + '<option value="1" checked="checked">' + Zedity.t('Automatic') + '</option>' + '<option value="2">' + Zedity.t('Enabled') + '</option>' + '<option value="3">' + Zedity.t('Disabled') + '</option>' + '</select>' + '<span class="zedity-tooltip" style="margin-left:15px">?</span>' + '</div>' + '</div>');
                this.editor.$container.append($dialog);
                $dialog.dialog({
                    title: Zedity.t('Insert HTML'),
                    dialogClass: 'zedity-dialog',
                    autoOpen: false,
                    modal: true,
                    resizable: true,
                    position: {
                        my: 'center',
                        at: 'center',
                        of: window.top
                    },
                    minWidth: 360,
                    minHeight: 270,
                    create: function() {
                        $dialog.find('.zedity-tooltip').attr('title', Zedity.t('If you insert Javascript or CSS code and you get unexpected effects (e.g. content overflow, etc.) you need to enable safe mode.') + '<br/>' + Zedity.t('The (default) automatic setting enables safe mode only if Javascript is detected.') + '<br/>' + Zedity.t('Some scripts (for example social network services) need to access the page, so the "Safe mode" must be disabled in these cases.')).tooltip()
                    },
                    open: function() {
                        var box = $dialog.data('box');
                        $('#zedity-txtInsertHtml').val(box.content());
                        $('#zedity-ddSSM').val(box.$this.attr('data-ssm') || 1)
                    },
                    close: function() {
                        $(this).data('box', null)
                    },
                    buttons: [{
                        text: Zedity.t('OK'),
                        class: 'zedity-button-ok',
                        click: function() {
                            var box = $dialog.data('box');
                            $dialog.dialog('close');
                            if (box) {
                                var content = $('#zedity-txtInsertHtml').val();
                                var safemode = $('#zedity-ddSSM').val();
                                var safe = (safemode == 1 ? (content.indexOf('<script') > -1) : (safemode == 2));
                                box.content(content, safe);
                                box.$this.attr('data-ssm', safemode)
                            }
                        }
                    }, {
                        text: Zedity.t('Cancel'),
                        class: 'zedity-button-cancel',
                        click: function() {
                            $dialog.dialog('close')
                        }
                    }]
                })
            }
            return this
        },
        _save: function(callback) {
            Zedity.Box.prototype._save.call(this);
            this.$this.find('.zedity-boxoverlay').remove();
            if (this.$this.find('.zedity-enc-iframe').length == 0 && this._data.content) {
                var id = '[[[' + Zedity.core.genId('zsp_htmlbox') + ']]]';
                Zedity.core.patterns.add(id, this._data.content);
                this.$this.children('.zedity-content').html(id)
            }
            if (typeof(callback) == 'function') callback.call(this);
            return this
        },
        _resize: function() {
            Zedity.Box.prototype._resize.call(this);
            return this
        },
        content: function(content, safemode) {
            if (content != null) {
                var $temp = $('<div/>').html(content);
                if ($temp.find('.zedity-editor,.zedity-box,.zedity-content').length > 0) {
                    this.editor._error({
                        message: Zedity.t('Inserting a %s content into an HTML box is not supported at the moment.', 'Zedity')
                    })
                } else {
                    this._data.content = content;
                    var $content = this.$this.children('.zedity-content');
                    if (safemode) {
                        $content.html('<iframe class="zedity-enc-iframe" src="data:text/html,' + encodeURIComponent(content) + '" style="width:100%;height:100%;border:0"/>');
                        $content.css({
                            display: '',
                            overflow: '',
                            width: '100%',
                            height: '100%'
                        })
                    } else {
                        $content.html(content);
                        if ($content.contents().length > 0 && /<[^>]+>/.test(content)) {
                            setTimeout($.proxy(function() {
                                Zedity.core._call(this, 'resizeToContent')
                            }, this), 2000)
                        }
                    }
                    this.$this.find('.zedity-empty').remove();
                    if (this.$this.find('.zedity-boxoverlay').length == 0) {
                        this.$this.append('<div class="zedity-boxoverlay"/>')
                    }
                    this._resize().reposition();
                    this.editor.boxes.refreshSelected();
                    this.editor._changed()
                }
            } else {
                content = this._data.content
            }
            return content
        },
        select: function() {
            if (this.$this.hasClass('zedity-editing') || this.$this.hasClass('zedity-playing')) return this;
            Zedity.Box.prototype.select.call(this);
            return this
        },
        flip: function(setting) {
            if (setting != null) {
                this.editor._error({
                    message: Zedity.t('%s doesn\'t support flipping.', 'Html box')
                })
            }
            return 'none'
        },
        start: function() {
            Zedity.Box.prototype.start.call(this);
            if (this.$this.children('.zedity-content').contents().lenght == 0) return this;
            if (this.$this.data('ui-draggable')) this.$this.draggable('option', 'disabled', true);
            if (this.$this.data('ui-resizable')) this.$this.resizable('option', 'disabled', true);
            if (this.$this.data('ui-rotatable')) this.$this.rotatable('option', 'disabled', true);
            this.$this.removeClass('ui-state-disabled');
            this.$this.addClass('zedity-playing').find('.zedity-boxoverlay').hide();
            return this
        },
        stop: function() {
            Zedity.Box.prototype.stop.call(this);
            if (this.$this.children('.zedity-content').contents().lenght == 0) return this;
            if (this.$this.data('ui-draggable')) this.$this.draggable('option', 'disabled', false);
            if (this.$this.data('ui-resizable')) this.$this.resizable('option', 'disabled', false);
            if (this.$this.data('ui-rotatable')) this.$this.rotatable('option', 'disabled', false);
            this.$this.removeClass('zedity-playing').find('.zedity-boxoverlay').show();
            return this
        },
        insert: function() {
            Zedity.Box.prototype.insert.call(this);
            $('.zedity-dialog-html').data('box', this).dialog('open');
            return this
        },
        init: function() {
            Zedity.Box.prototype.init.call(this);
            return this
        }
    });
    Zedity.Box.Html.type = 'Html';
    Zedity.Box.Html.sizeLimits = {
        minWidth: 16,
        minHeight: 16,
        maxWidth: null,
        maxHeight: null
    };
    Zedity.Box.Html._defaults = {
        width: 150,
        height: 150
    };
    Zedity.Box.register({
        type: Zedity.Box.Html.type,
        section: 'advanced',
        order: 100
    })
})(jQuery);
(function($) {
    Zedity.utils = Zedity.utils || {};
    Zedity.utils.fileTypes = {
        types: {
            jpeg: {
                type: 'jpeg',
                mime: 'image/jpeg',
                extensions: 'jpeg jpg jpe',
                signature: '/9j',
                canResize: true
            },
            png: {
                type: 'png',
                mime: 'image/png',
                extensions: 'png',
                signature: 'iVBORw0KGgo',
                canResize: true
            },
            gif: {
                type: 'gif',
                mime: 'image/gif',
                extensions: 'gif',
                signature: 'R0lG',
                canResize: false
            }
        },
        _notfound: {
            type: '',
            mime: ''
        },
        parse: function(data, accept) {
            accept = accept || Object.keys(this.types);
            try {
                var imgheader = /base64,(.{40})/.exec(data)[1]
            } catch (e) {
                return this._notfound
            }
            for (var i = accept.length - 1; i >= 0; --i) {
                var filetype = this.types[accept[i]];
                if (imgheader.substr(0, filetype.signature.length) == filetype.signature) {
                    return filetype
                }
            }
            return this._notfound
        },
        fromExtension: function(filename, accept) {
            accept = accept || Object.keys(this.types);
            var ext = filename.split('.').pop();
            for (var i = accept.length - 1; i >= 0; --i) {
                if (this.types[accept[i]].extensions.indexOf(ext) > -1) {
                    return this.types[accept[i]]
                }
            }
            return this._notfound
        }
    }
})(jQuery);
//
(function($) {
    if (!Zedity) throw new Error(Zedity.t('%s needs %s.', 'Zedity.Box.Article', 'Zedity'));
    if (!Zedity.Box) throw new Error(Zedity.t('%s needs %s.', 'Zedity.Box.Article', 'Zedity.Box'));
    Zedity.Box.Article = function(options) {
        this.type = 'Article';
        this._defaults = Zedity.Box.Article._defaults;
        Zedity.Box.prototype.constructor.call(this, options);
        this._can.push('layout');
        if (!this.$this.find('img').length) {
            this.$this.append($('<div/>', {
                class: 'zedity-content',
                css: {
                    position: 'relative',
                    width: '100%',
                    height: '100%',
                    overflow: 'hidden'
                },
                html: $('<img/>', {
                    src: this._options.src,
                    css: {
                        position: 'absolute',
                        margin: 0
                    }
                })
            })).append('<div class="zedity-empty"><p>' + Zedity.t('Click %s to insert Article.', '<span class="zedity-button"><span class="zicon zicon-Article zicon-size-s"></span></span>') + '</p></div>');
            Zedity.core._call(this, 'layout', this._options.layout);
            if (this._options.proportionalResize) this.$this.attr('data-aspectratio', 1)
        } else if (!this.$this.find('div.zedity-content').length) {
            this.$this.find('img').removeClass('zedity-content').wrap($('<div/>', {
                class: 'zedity-content',
                css: {
                    position: 'relative',
                    width: '100%',
                    height: '100%',
                    overflow: 'hidden'
                }
            }))
        }
        this.$this.find('style.imgData').detach().appendTo('head');
        Zedity.core._call(this, 'content', this.content(), null, true)
    };
    Zedity.Box.Article.prototype = Object.create(Zedity.Box.prototype);
    Zedity.Box.Article.prototype.constructor = Zedity.Box.Article;
    $.extend(Zedity.Box.Article.prototype, {
        createPropBar: function(options) {
            Zedity.Box.prototype.createPropBar.call(this);
            this.editor.menu.add({
                tabs: {
                    editbox: {
                        groups: {
                            Articlebox: {
                                title: Zedity.t('Article'),
                                order: -1000,
                                class: 'zedity-group-box',
                                features: {
                                    insert: {
                                        type: 'button',
                                        icon: 'article',
                                        label: Zedity.t('Insert'),
                                        title: Zedity.t('Insert Article'),
                                        order: 0,
                                        onclick: function(e, ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return;
                                            box.insert()
                                        }
                                    },
                                    layout: {
                                        type: 'menu',
                                        icon: 'imagelayout',
                                        label: Zedity.t('Layout'),
                                        title: Zedity.t('Select Article layout'),
                                        order: 100,
                                        items: [{
                                            label: Zedity.t('Center & fill'),
                                            value: 'centerfill'
                                        }, {
                                            label: Zedity.t('Fit'),
                                            value: 'fit'
                                        }, {
                                            label: Zedity.t('Center'),
                                            value: 'center'
                                        }, {
                                            label: Zedity.t('Stretch'),
                                            value: 'stretch'
                                        }],
                                        onclick: function(val, e, ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return;
                                            box.layout(val)
                                        },
                                        enable: function(ed, box) {
                                            return (box && box.$this.children('.zedity-empty').length == 0)
                                        }
                                    },
                                    config: {
                                        type: 'extpanel',
                                        icon: 'config2',
                                        label: Zedity.t('Options'),
                                        title: Zedity.t('Article options'),
                                        size: 'xs',
                                        order: 200,
                                        build: function($panel, ed) {
                                            $panel.append('<div class="zedity-image-quality-feat" style="border-bottom:1px solid silver;padding-bottom:10px;margin-bottom: 10px">' + '<span>' + Zedity.t('Image quality') + '&nbsp;</span>' + '<select class="zedity-image-quality">' + '<option value="2">' + Zedity.t('Original') + '</option>' + '<option value="0.92">' + Zedity.t('High') + '</option>' + '<option value="0.88">' + Zedity.t('Normal') + '</option>' + '<option value="0.75">' + Zedity.t('Low') + '</option>' + '</select>' + '</div>' + '<span class="zedity-button zedity-imagepropresize">' + '<span class="zicon zicon-size-xs zicon-resize"></span> ' + Zedity.t('Proportional resize') + '</span><br/>' + '<span class="zedity-button zedity-imageoriginalsize">' + '<span class="zicon zicon-size-xs zicon-image"></span> ' + Zedity.t('Set box to image original size') + '</span>');
                                            $panel.find('.zedity-image-quality').selectmenu({
                                                width: 'auto',
                                                appendTo: $panel,
                                                change: function(e, ui) {
                                                    var box = ed.boxes.selected();
                                                    if (!box) return;
                                                    box._options.quality = parseFloat(ui.item.value)
                                                }
                                            });
                                            $panel.find('.zedity-imagepropresize').on('click.zedity', function() {
                                                var box = ed.boxes.selected();
                                                if (!box) return;
                                                var val = !box.proportionalResize();
                                                val = box.proportionalResize(val);
                                                $(this).toggleClass('zedity-pressed', val)
                                            });
                                            $panel.find('.zedity-imageoriginalsize').on('click.zedity', function() {
                                                var box = ed.boxes.selected();
                                                if (box) box.resizeToContent()
                                            })
                                        },
                                        refresh: function(ed, box) {
                                            if (!box) return;
                                            this.$extpanel.find('.zedity-image-quality').val(box._options.quality).selectmenu('refresh');
                                            this.$extpanel.find('.zedity-imagepropresize').toggleClass('zedity-pressed', box.proportionalResize())
                                        },
                                        enable: function(ed, box) {
                                            return (box && box.$this.children('.zedity-empty').length == 0)
                                        }
                                    }
                                },
                                show: function(ed, box) {
                                    return box && box.type == 'Article'
                                }
                            }
                        }
                    }
                }
            }, 'imagebox');
            if ($('.zedity-dialog-image').length == 0) {
                var optionsElems = '';
                var cats = [];
                var catsElems = '';

                jQuery(posts).each(function(){
                    var thisCats = '';
                    jQuery(this.cats).each(function (a, e) {
                        thisCats += e.replace(/ /g,'')+' ';
                    })
                    var catsClass = thisCats;
                    optionsElems += '<option value="'+this.img+'" class="'+catsClass+'">'+this.title+'</option>';

                    jQuery(this.cats).each(function(a,cat){
                        if (!cats.includes(cat)) {
                            cats.push(cat);
                        }
                    })
                });
                jQuery(cats).each(function(a,cat){
                    catsElems +=
                        '<option value="'+cat+'">'+cat+'</option>';
                });

                //jQuery('iframe').contents().find()


                var $dialog = $(
                    '<div class="zedity-dialog-image">' +
                    '<div class="tabs">' +
                    '<ul>' +
                    '<li><a href="#tab-image-disk">' + Zedity.t('Disk') + '</a></li>' +
                    '<li><a href="#tab-image-link">' + Zedity.t('Link') + '</a></li>' +
                    '<li><a href="#tab-image-article">' + Zedity.t('Article') + '</a></li>' +
                    '</ul>' +
                    '<div id="tab-image-disk">' + Zedity.t('Supported image file types:') + '<br/><span id="zedity-lblSupportedImages"></span><br/><br/>' + Zedity.t('Select image file from disk (max size %s):', '<span id="zedity-lblMaxSize"></span>') + '<br/><br/>' +
                        '<button class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only zedity-fileupload"><span class="ui-button-text">' + Zedity.t('Browse...') + '</span></button>' +
                        '<p id="zedity-lblImageDisk" class="selected-file"></p>' + '<p class="zedity-image-quality">' + Zedity.t('Image quality:') + ' ' + '<select id="zedity-ddImageQuality" style="width:150px;">' + '<option value="2">' + Zedity.t('Original') + '</option>' + '<option value="0.92">' + Zedity.t('High') + '</option>' + '<option value="0.88" selected="selected">' + Zedity.t('Normal') + '</option>' + '<option value="0.75">' + Zedity.t('Low') + '</option>' + '</select>' + '</p>' +
                    '</div>' +
                    '<div id="tab-image-link">' + Zedity.t('Insert Article URL link:') + '<br/>' +
                        '<textarea id="zedity-txtImageLink" rows="4"></textarea>' +
                    '</div>' +
                    '<div id="tab-article-link">' + '<br/>' +
                    '<span>Sélection de la catégorie</span>' +
                    '<select id="catsId" anme="catsName">' +
                    catsElems +
                    '</select>' +
                    '<span>Sélection de l\'article</span>' +
                    '<select id="selectId" anme="selectName">' +
                        optionsElems +
                    '</select>' +
                    '</div>' +
                    '</div>' + '<p class="zedity-image-description">' + Zedity.t('Image description:') + '<br/>' +
                    '<input id="zedity-txtImageDescription" type="text" value=""><br/><br/>' + '</p>' +
                    '</div>');


                /*'<div class="zedity-dialog-image">' +
                '<div id="tab-image-link">' + Zedity.t('Image URL link:') + '<br/>' +
                '<textarea id="zedity-txtImageLink" rows="4"></textarea>' +
                '</div>' +
                '<div>' + '<p class="zedity-image-description">' + Zedity.t('Image description:') + '<br/>' +
                '<input id="zedity-txtImageDescription" type="text" value=""><br/><br/>' + '</p>' +
                '</div>' +
                '</div>');*/


                $dialog.find('.tabs').tabs({
                    activate: function(event, ui) {
                        $(this).find('.ui-tabs-panel:visible').find('input[type=text],textarea,select,button').filter(':visible').filter(':first').focus()
                    }
                });
                this.editor.$container.append($dialog);
                $dialog.dialog({
                    title: Zedity.t('Insert Article'),
                    dialogClass: 'zedity-dialog',
                    autoOpen: false,
                    modal: true,
                    resizable: false,
                    position: {
                        my: 'center',
                        at: 'center',
                        of: window.top
                    },
                    open: function() {
                        var $this = $(this);
                        var box = $this.data('box');
                        var disabled = [];
                        if (!box._options.allowLink) disabled.push(1);
                        $this.find('input[type=text],textarea').val('');
                        $this.find('#zedity-ddImageQuality').val(0.88);
                        $this.find('#zedity-lblMaxSize').text(Zedity.utils.beautifySize(box._options.maxSize));
                        $this.find('.tabs').tabs('option', {
                            active: 0,
                            disabled: disabled
                        });
                        $this.find('#zedity-lblSupportedImages').text(Object.keys(Zedity.utils.fileTypes.types).join(', '));
                        var content = box.content();
                        if (content && /^http/.test(content)) {
                            $this.find('.tabs').tabs('selected', 'tab-image-link');
                            $this.find('#zedity-txtImageLink').val(content)
                        }
                        $this.find('#zedity-txtImageDescription').val(box.$this.find('img').attr('alt') || '')
                    },
                    close: function() {
                        var $this = $(this);
                        $('#zedity-lblImageDisk').text('');
                        $this.find('.zedity-fileupload').upload('clear')
                    },
                    buttons: [{
                        text: Zedity.t('OK'),
                        class: 'zedity-button-ok',
                        click: function() {
                            var $this = $(this);
                            var box = $this.data('box');
                            if (box) {
                                var $inputDescription = $('#zedity-txtImageDescription');
                                if (box._options.descriptionMandatory && $inputDescription.val().length < 4) {
                                    if ($inputDescription.val().length == 0) {
                                        box.editor._error({
                                            message: Zedity.t('Please insert image description.')
                                        })
                                    } else if ($inputDescription.val().length < 4) {
                                        box.editor._error({
                                            message: Zedity.t('Image description is too short.')
                                        })
                                    }
                                    $inputDescription.focus();
                                    return
                                }
                                box._data.filterOriginal = null;
                                switch ($this.find('.tabs').tabs('selected')) {
                                    case 'tab-image-disk':
                                        var $fu = $this.find('.zedity-fileupload');
                                        if ($fu.upload('getfilename') == '') {
                                            box.editor._error({
                                                message: Zedity.t('No file selected.')
                                            });
                                            return
                                        }
                                        box._options.quality = parseFloat($this.find('#zedity-ddImageQuality').val());
                                        if (box._options.quality == 1) box._options.quality = 2;
                                        $fu.upload('submit');
                                        break;
                                    case 'tab-image-link':
                                        var content = $('#zedity-txtImageLink').val();
                                        if (content == '') {
                                            box.editor._error({
                                                message: Zedity.t('Please insert a link.')
                                            });
                                            return
                                        }
                                        box.content(content);
                                        break
                                }
                                box.description($inputDescription.val())
                            }
                            $(this).dialog('close')
                        }
                    }, {
                        text: Zedity.t('Cancel'),
                        class: 'zedity-button-cancel',
                        click: function() {
                            $(this).dialog('close')
                        }
                    }]
                })
            }
            $('.zedity-dialog-image .zedity-fileupload').upload({
                autosubmit: false,
                acceptmime: $.map(this._options.accept, function(key) {
                    return Zedity.utils.fileTypes.types[key].mime
                }).join(','),
                extensions: $.map(this._options.accept, function(key) {
                    return Zedity.utils.fileTypes.types[key].extensions
                }).join(' '),
                action: this._options.action,
                maxsize: this._options.maxSize,
                onselect: $.proxy(function(event, file) {
                    var fn = $(file).val();
                    fn = fn.split(/[\\\/]/).pop();
                    $('#zedity-lblImageDisk').html('Selected file:<br/><b>' + fn + '</b>');
                    $('#zedity-txtImageDescription').focus()
                }, this),
                onsubmit: function(file) {
                    var $this = $(this);
                    var data = $this.data('upload');
                    var box = $this.parents('.zedity-dialog-image').data('box');
                    box._loading();
                    data.$input.trigger('mouseout.upload');
                    if (!Zedity.core.supports.fileapi()) {
                        box.editor._data.imageupload = box;
                        return true
                    }
                    Zedity.utils.resizeImage(file.files[0], {
                        maxwidth: box._sizeLimits().maxWidth,
                        maxheight: box._sizeLimits().maxHeight,
                        aspectratio: true,
                        quality: box._options.quality,
                        accept: box._options.accept,
                        onerror: function(error) {
                            box.editor._error(error)
                        },
                        onresizeend: function(size, data, type) {
                            box.content(data, size);
                            box._data.fileType = type
                        }
                    });
                    return false
                },
                oncomplete: function(event, response) {
                    var box = $(this).parents('.zedity-dialog-image').data('box');
                    if (!box) return;
                    if (response.status == 'OK') {
                        if (box.editor._data.imageupload) {
                            box.editor._data.imageupload.content(response.data);
                            delete box.editor._data.imageupload
                        } else {
                            box.editor._error({
                                message: Zedity.t('An unexpected error occurred. Please try again.')
                            })
                        }
                    } else {
                        box.editor._error({
                            message: Zedity.t('There was an error during server image resize.')
                        })
                    }
                },
                onerror: function(error) {
                    var box = $(this).parents('.zedity-dialog-image').data('box');
                    if (!box) return;
                    box.editor._error(error)
                }
            });
            return this
        },
        _loading: function(set) {
            if (set === false) {
                this.$this.find('.zedity-loading').remove()
            } else {
                this.$this.find('.zedity-empty').remove();
                this.$this.append('<div class="zedity-loading"><p>' + Zedity.t('Loading...') + '</p></div>')
            }
            return this
        },
        _checkSize: function() {
            this.$this.removeClass('zedity-warn-size-up zedity-warn-size-down');
            if (this._data.size) {
                var $img = this.$this.find('img');
                var w = $img.width(),
                    h = $img.height();
                if (this._data.size.width < w || this._data.size.height < h) {
                    this.$this.addClass('zedity-warn-size-down')
                } else if (this._data.size.width > w || this._data.size.height > h) {
                    this.$this.addClass('zedity-warn-size-up')
                }
            }
            return this
        },
        setOriginalSize: function() {
            return this.resizeToContent()
        },
        content: function(content, size, dontresize, onload) {
            function resizeBox() {
                this.editor._changed();
                if (dontresize) {
                    Zedity.core._call(this, 'layout', this.layout());
                    return
                }
                var old = this.proportionalResize();
                Zedity.core._call(this, 'proportionalResize', true);
                if (!old) Zedity.core._call(this, 'proportionalResize', false)
            };

            function getSize(content) {
                var img = new Image();
                img.onload = $.proxy(function() {
                    this._data.size = {
                        width: img.width,
                        height: img.height
                    };
                    img = null;
                    resizeBox.call(this);
                    onload.call(this)
                }, this);
                img.src = content
            };
            if (content == null) {
                content = this.$this.find('img').css('background-image');
                if (/data:image\//.test(content)) {
                    content = /(url\("?)(data:.*?)("?\))/i.exec(content)[2]
                } else if (/^url\(/.test(content)) {
                    content = /(url\("?)(.*?)("?\))/i.exec(content)[2]
                } else {
                    content = this.$this.find('img').attr('src')
                }
                if (content == this._options.src) content = null
            } else {
                onload = onload || function() {};
                if (/^http/.test(content)) {
                    this._loading();
                    this.$this.removeNumberedClass('imgDataS');
                    this.$this.find('img').css({
                        'background-image': '',
                        'background-size': '',
                        'background-position': ''
                    }).attr('src', content);
                    this._loading(false);
                    this._data.fileType = Zedity.utils.fileTypes.fromExtension(content);
                    getSize.call(this, content)
                } else if (/^data:/.test(content)) {
                    this._loading();
                    this.$this.find('img').css({
                        'background-image': '',
                        'background-size': '100% 100%',
                        'background-position': 'left top'
                    }).attr('src', this._options.src);
                    var idx = $('style.imgData').getEmptyNumberedClass('imgDataS');
                    var $imgData = $('<style class="imgData imgDataS' + idx + '" type="text/css"></style>');
                    $imgData.appendTo('head');
                    $imgData.html('#' + this.editor.id + ' .imgDataS' + idx + ' img{background-image:url("' + content + '")}');
                    this.$this.removeNumberedClass('imgDataS').addClass('imgDataS' + idx);
                    this._addReference();
                    if (this.layout() == 'stretch' && this.$this.find('img')[0].style.backgroundSize == '100%') this.layout('stretch');
                    this._loading(false);
                    if (size) {
                        this._data.size = size;
                        resizeBox.call(this)
                    } else {
                        getSize.call(this, content)
                    }
                } else {
                    this.editor._error({
                        message: Zedity.t('Could not interpret the content as image.')
                    })
                }
            }
            return content
        },
        resizeToContent: function() {
            this.$this.css({
                width: this._data.size.width,
                height: this._data.size.height
            });
            Zedity.core._call(this, 'layout', this.layout());
            this.reposition()._resize();
            this.editor.boxes.refreshSelected();
            this.editor._changed();
            return this
        },
        extractText: function() {
            this._data.$clone = this.$this.clone();
            this._data.$clone.find('style').remove();
            return Zedity.Box.prototype.extractText.call(this)
        },
        description: function(description) {
            if (description != null) {
                this.$this.find('img').attr('alt', description)
            } else {
                description = this.$this.find('img').attr('alt')
            }
            return description
        },
        select: function() {
            Zedity.Box.prototype.select.call(this);
            if (this.$this.is(':data(ui-resizable)')) {
                this.$this.resizable('option', 'aspectRatio', this.proportionalResize())
            }
            if (this.$this.data('ui-resizable')) {
                this.$this.resizable('option', 'resize', $.proxy(function() {
                    Zedity.core._call(this, 'layout', this.layout())
                }, this))
            }
            return this
        },
        _getQualityName: function() {
            if (this._options.quality < 0.8) {
                return 'low'
            } else if (this._options.quality < 0.9) {
                return 'normal'
            } else if (this._options.quality <= 1) {
                return 'high'
            } else {
                return 'original'
            }
        },
        start: function() {
            Zedity.Box.prototype.start.call(this);
            return this
        },
        stop: function() {
            Zedity.Box.prototype.stop.call(this);
            return this
        },
        insert: function() {
            Zedity.Box.prototype.insert.call(this);
            $('.zedity-dialog-image').data('box', this).dialog('open');
            return this
        },
        duplicate: function() {
            Zedity.Box.prototype.duplicate.call(this);
            if (this.layout() == 'stretch' && this.$this.find('img')[0].style.backgroundSize == '100%') this.layout('stretch');
            this.editor.boxes.selected()._addReference();
            return this
        },
        init: function() {
            Zedity.Box.prototype.init.call(this);
            if (this.$this.hasNumberedClass('imgDataS')) {
                this._addReference();
                var nc = this.$this.getNumberedClass('imgDataS');
                var style = this.editor.$this.children('style.' + nc);
                if (style) {
                    style.detach().appendTo('head')
                }
            }
            return this
        },
        layout: function(layout) {
            if (layout) {
                this.$this.attr('data-layout', layout);
                if (!this._data.size) return layout;
                var wratio, hratio, ratio, width, height;
                var $c = this.$this.find('.zedity-content');
                switch (layout) {
                    case 'fit':
                        wratio = $c.width() / this._data.size.width;
                        hratio = $c.height() / this._data.size.height;
                        ratio = Math.min(wratio, hratio);
                        width = Math.round(this._data.size.width * ratio);
                        height = Math.round(this._data.size.height * ratio);
                        break;
                    case 'centerfill':
                        wratio = $c.width() / this._data.size.width;
                        hratio = $c.height() / this._data.size.height;
                        ratio = Math.max(wratio, hratio);
                        width = Math.round(this._data.size.width * ratio);
                        height = Math.round(this._data.size.height * ratio);
                        break;
                    case 'stretch':
                        width = $c.width();
                        height = $c.height();
                        break;
                    case 'center':
                        width = this._data.size.width;
                        height = this._data.size.height;
                        break
                }
                this.$this.find('img').css({
                    left: Math.round(($c.width() - width) / 2),
                    top: Math.round(($c.height() - height) / 2),
                    width: width,
                    height: height
                });
                this._checkSize();
                this.editor._changed()
            } else {
                layout = this.$this.attr('data-layout') || ''
            }
            return layout
        },
        proportionalResize: function(value) {
            if (this.asBackground()) return false;
            if (this.$this.find('.zedity-empty').length > 0) return false;
            if (value === true) {
                this.$this.attr('data-aspectratio', 1);
                if (!this._data.size) {
                    Zedity.core._call(this, 'content', Zedity.core._call(this, 'content'));
                    setTimeout($.proxy(function() {
                        Zedity.core._call(this, 'proportionalResize', true)
                    }, this), 0);
                    return true
                }
                var wratio = this.$this.width() / this._data.size.width;
                var hratio = this.$this.height() / this._data.size.height;
                var ratio = (wratio < hratio) ? wratio : hratio;
                var width = Math.round(this._data.size.width * ratio);
                var height = Math.round(this._data.size.height * ratio);
                this.$this.css({
                    width: width,
                    height: height
                });
                if (this.$this.is(':data(ui-resizable)')) {
                    this.$this.resizable('option', 'aspectRatio', value)
                }
                Zedity.core._call(this, 'layout', this.layout());
                this.editor.boxes.refreshSelected();
                this.editor._changed()
            } else if (value === false) {
                this.$this.removeAttr('data-aspectratio');
                Zedity.core._call(this, 'layout', this.layout());
                this.editor.boxes.refreshSelected();
                this.editor._changed()
            }
            return this.$this.attr('data-aspectratio') == 1
        },
        asBackground: function(setting) {
            var res = Zedity.Box.prototype.asBackground.call(this, setting);
            Zedity.core._call(this, 'layout', this.layout());
            return res
        },
        _removeUnreferencedData: function() {
            var list = Zedity.core.gc.getNonReferenced('imageGc');
            for (var i = list.length - 1; i >= 0; --i) {
                $('style.' + list[i]).remove()
            }
            Zedity.core.gc.deleteReference(list);
            return this
        },
        _addReference: function() {
            if (this.$this.hasNumberedClass('imgDataS')) {
                var nc = this.$this.getNumberedClass('imgDataS');
                Zedity.core.gc.addReference(nc, 'imageGc');
                Zedity.core.gc.addReference(nc, 'imageGc-' + this.id)
            }
            return this
        },
        _save: function(callback, options) {
            this._removeUnreferencedData();
            var nc = this.$this.getNumberedClass('imgDataS');
            if (nc) {
                var style = $('head style.' + nc);
                if (style.length > 0) {
                    if (!options.finalize) {
                        style.detach().appendTo(this.$this);
                        if (typeof(callback) == 'function') callback.call(this);
                        return this
                    }
                    if (['center', 'tile'].indexOf(this.layout()) > -1) {
                        style.detach().appendTo(this.$this);
                        if (typeof(callback) == 'function') callback.call(this)
                    } else {
                        var box = this;
                        var bsize = {
                            w: 0,
                            h: 0
                        };
                        this.editor.$this.children('.zedity-box-Article.' + nc).each(function(idx, elem) {
                            bsize.w = Math.max(bsize.w, $(elem).width());
                            bsize.h = Math.max(bsize.h, $(elem).height())
                        });
                        Zedity.utils.resizeImage(style.html(), {
                            maxwidth: bsize.w,
                            maxheight: bsize.h,
                            aspectratio: true,
                            quality: this._options.quality,
                            accept: this._options.accept,
                            onerror: function(error) {
                                box.editor._error(error)
                            },
                            onresizeend: function(size, data, type) {
                                Zedity.core._call(box, 'content', data, size, true);
                                box._data.fileType = type;
                                var newnc = box.$this.getNumberedClass('imgDataS');
                                box.editor.$this.children('.zedity-box-Image.' + nc).removeClass(nc).addClass(newnc);
                                box._addReference();
                                $('head style.' + newnc).detach().appendTo(box.$this);
                                style.remove();
                                Zedity.Box.prototype._save.call(box);
                                if (typeof(callback) == 'function') callback.call(this)
                            }
                        })
                    }
                } else {
                    Zedity.Box.prototype._save.call(this);
                    if (typeof(callback) == 'function') callback.call(this)
                }
            } else {
                Zedity.Box.prototype._save.call(this);
                if (typeof(callback) == 'function') callback.call(this)
            }
            return this
        },
        destroy: function() {
            Zedity.Box.prototype.destroy.call(this);
            var ref = Zedity.core.gc.getReferenced('imageGc-' + this.id);
            for (var i = ref.length - 1; i >= 0; --i) {
                Zedity.core.gc.removeReference(ref[i], 'imageGc')
            }
            Zedity.core.gc.flushData('imageGc-' + this.id);
            this._removeUnreferencedData();
            return this
        }
    });
    Zedity.Box.Article.type = 'Article';
    Zedity.Box.Article.sizeLimits = {
        minWidth: 16,
        minHeight: 16,
        maxWidth: null,
        maxHeight: null
    };
    Zedity.Box.Article._defaults = {
        src: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7',
        width: 250,
        height: 200,
        layout: 'centerfill',
        proportionalResize: true,
        quality: 0.88,
        accept: Object.keys(Zedity.utils.fileTypes.types),
        maxSize: 1000000,
        descriptionMandatory: true,
        allowLink: true
    };
    Zedity.Box.register({
        type: Zedity.Box.Article.type,
        requires: ['canvas'],
        section: 'basic',
        order: 100
    });
    Zedity.core.gc.flushData('imageGc');
    Zedity.core.store.delprefix('imageGc-')
})(jQuery);
//
(function($) {
    if (!Zedity) throw new Error(Zedity.t('%s needs %s.', 'Zedity.Box.Image', 'Zedity'));
    if (!Zedity.Box) throw new Error(Zedity.t('%s needs %s.', 'Zedity.Box.Image', 'Zedity.Box'));
    Zedity.Box.Image = function(options) {
        this.type = 'Image';
        this._defaults = Zedity.Box.Image._defaults;
        Zedity.Box.prototype.constructor.call(this, options);
        this._can.push('layout');
        if (!this.$this.find('img').length) {
            this.$this.append($('<div/>', {
                class: 'zedity-content',
                css: {
                    position: 'relative',
                    width: '100%',
                    height: '100%',
                    overflow: 'hidden'
                },
                html: $('<img/>', {
                    src: this._options.src,
                    css: {
                        position: 'absolute',
                        margin: 0
                    }
                })
            })).append('<div class="zedity-empty"><p>' + Zedity.t('Click %s to insert image.', '<span class="zedity-button"><span class="zicon zicon-image zicon-size-s"></span></span>') + '</p></div>');
            Zedity.core._call(this, 'layout', this._options.layout);
            if (this._options.proportionalResize) this.$this.attr('data-aspectratio', 1)
        } else if (!this.$this.find('div.zedity-content').length) {
            this.$this.find('img').removeClass('zedity-content').wrap($('<div/>', {
                class: 'zedity-content',
                css: {
                    position: 'relative',
                    width: '100%',
                    height: '100%',
                    overflow: 'hidden'
                }
            }))
        }
        this.$this.find('style.imgData').detach().appendTo('head');
        Zedity.core._call(this, 'content', this.content(), null, true)
    };
    Zedity.Box.Image.prototype = Object.create(Zedity.Box.prototype);
    Zedity.Box.Image.prototype.constructor = Zedity.Box.Image;
    $.extend(Zedity.Box.Image.prototype, {
        createPropBar: function(options) {
            Zedity.Box.prototype.createPropBar.call(this);
            this.editor.menu.add({
                tabs: {
                    editbox: {
                        groups: {
                            imagebox: {
                                title: Zedity.t('Image'),
                                order: -1000,
                                class: 'zedity-group-box',
                                features: {
                                    insert: {
                                        type: 'button',
                                        icon: 'image',
                                        label: Zedity.t('Insert'),
                                        title: Zedity.t('Insert image'),
                                        order: 0,
                                        onclick: function(e, ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return;
                                            box.insert()
                                        }
                                    },
                                    layout: {
                                        type: 'menu',
                                        icon: 'imagelayout',
                                        label: Zedity.t('Layout'),
                                        title: Zedity.t('Select image layout'),
                                        order: 100,
                                        items: [{
                                            label: Zedity.t('Center & fill'),
                                            value: 'centerfill'
                                        }, {
                                            label: Zedity.t('Fit'),
                                            value: 'fit'
                                        }, {
                                            label: Zedity.t('Center'),
                                            value: 'center'
                                        }, {
                                            label: Zedity.t('Stretch'),
                                            value: 'stretch'
                                        }],
                                        onclick: function(val, e, ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return;
                                            box.layout(val)
                                        },
                                        enable: function(ed, box) {
                                            return (box && box.$this.children('.zedity-empty').length == 0)
                                        }
                                    },
                                    config: {
                                        type: 'extpanel',
                                        icon: 'config2',
                                        label: Zedity.t('Options'),
                                        title: Zedity.t('Image options'),
                                        size: 'xs',
                                        order: 200,
                                        build: function($panel, ed) {
                                            $panel.append('<div class="zedity-image-quality-feat" style="border-bottom:1px solid silver;padding-bottom:10px;margin-bottom: 10px">' + '<span>' + Zedity.t('Image quality') + '&nbsp;</span>' + '<select class="zedity-image-quality">' + '<option value="2">' + Zedity.t('Original') + '</option>' + '<option value="0.92">' + Zedity.t('High') + '</option>' + '<option value="0.88">' + Zedity.t('Normal') + '</option>' + '<option value="0.75">' + Zedity.t('Low') + '</option>' + '</select>' + '</div>' + '<span class="zedity-button zedity-imagepropresize">' + '<span class="zicon zicon-size-xs zicon-resize"></span> ' + Zedity.t('Proportional resize') + '</span><br/>' + '<span class="zedity-button zedity-imageoriginalsize">' + '<span class="zicon zicon-size-xs zicon-image"></span> ' + Zedity.t('Set box to image original size') + '</span>');
                                            $panel.find('.zedity-image-quality').selectmenu({
                                                width: 'auto',
                                                appendTo: $panel,
                                                change: function(e, ui) {
                                                    var box = ed.boxes.selected();
                                                    if (!box) return;
                                                    box._options.quality = parseFloat(ui.item.value)
                                                }
                                            });
                                            $panel.find('.zedity-imagepropresize').on('click.zedity', function() {
                                                var box = ed.boxes.selected();
                                                if (!box) return;
                                                var val = !box.proportionalResize();
                                                val = box.proportionalResize(val);
                                                $(this).toggleClass('zedity-pressed', val)
                                            });
                                            $panel.find('.zedity-imageoriginalsize').on('click.zedity', function() {
                                                var box = ed.boxes.selected();
                                                if (box) box.resizeToContent()
                                            })
                                        },
                                        refresh: function(ed, box) {
                                            if (!box) return;
                                            this.$extpanel.find('.zedity-image-quality').val(box._options.quality).selectmenu('refresh');
                                            this.$extpanel.find('.zedity-imagepropresize').toggleClass('zedity-pressed', box.proportionalResize())
                                        },
                                        enable: function(ed, box) {
                                            return (box && box.$this.children('.zedity-empty').length == 0)
                                        }
                                    }
                                },
                                show: function(ed, box) {
                                    return box && box.type == 'Image'
                                }
                            }
                        }
                    }
                }
            }, 'imagebox');
            if ($('.zedity-dialog-image').length == 0) {
                var $dialog = $('<div class="zedity-dialog-image">' + '<div class="tabs">' + '<ul>' + '<li><a href="#tab-image-disk">' + Zedity.t('Disk') + '</a></li>' + '<li><a href="#tab-image-link">' + Zedity.t('Link') + '</a></li>' + '</ul>' + '<div id="tab-image-disk">' + Zedity.t('Supported image file types:') + '<br/><span id="zedity-lblSupportedImages"></span><br/><br/>' + Zedity.t('Select image file from disk (max size %s):', '<span id="zedity-lblMaxSize"></span>') + '<br/><br/>' + '<button class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only zedity-fileupload"><span class="ui-button-text">' + Zedity.t('Browse...') + '</span></button>' + '<p id="zedity-lblImageDisk" class="selected-file"></p>' + '<p class="zedity-image-quality">' + Zedity.t('Image quality:') + ' ' + '<select id="zedity-ddImageQuality" style="width:150px;">' + '<option value="2">' + Zedity.t('Original') + '</option>' + '<option value="0.92">' + Zedity.t('High') + '</option>' + '<option value="0.88" selected="selected">' + Zedity.t('Normal') + '</option>' + '<option value="0.75">' + Zedity.t('Low') + '</option>' + '</select>' + '</p>' + '</div>' + '<div id="tab-image-link">' +
                    Zedity.t('Insert image URL link:') + '<br/>' + '<textarea id="zedity-txtImageLink" rows="4"></textarea>' + '</div>' + '</div>' + '<p class="zedity-image-description">' + Zedity.t('Image description:') + '<br/>' + '<input id="zedity-txtImageDescription" type="text" value=""><br/><br/>' + '</p>' + '</div>');

                $dialog.find('.tabs').tabs({
                    activate: function(event, ui) {
                        $(this).find('.ui-tabs-panel:visible').find('input[type=text],textarea,select,button').filter(':visible').filter(':first').focus()
                    }
                });
                this.editor.$container.append($dialog);
                $dialog.dialog({
                    title: Zedity.t('Insert image'),
                    dialogClass: 'zedity-dialog',
                    autoOpen: false,
                    modal: true,
                    resizable: false,
                    position: {
                        my: 'center',
                        at: 'center',
                        of: window.top
                    },
                    open: function() {
                        var $this = $(this);
                        var box = $this.data('box');
                        var disabled = [];
                        if (!box._options.allowLink) disabled.push(1);
                        $this.find('input[type=text],textarea').val('');
                        $this.find('#zedity-ddImageQuality').val(0.88);
                        $this.find('#zedity-lblMaxSize').text(Zedity.utils.beautifySize(box._options.maxSize));
                        $this.find('.tabs').tabs('option', {
                            active: 0,
                            disabled: disabled
                        });
                        $this.find('#zedity-lblSupportedImages').text(Object.keys(Zedity.utils.fileTypes.types).join(', '));
                        var content = box.content();
                        if (content && /^http/.test(content)) {
                            $this.find('.tabs').tabs('selected', 'tab-image-link');
                            $this.find('#zedity-txtImageLink').val(content)
                        }
                        $this.find('#zedity-txtImageDescription').val(box.$this.find('img').attr('alt') || '')
                    },
                    close: function() {
                        var $this = $(this);
                        $('#zedity-lblImageDisk').text('');
                        $this.find('.zedity-fileupload').upload('clear')
                    },
                    buttons: [{
                        text: Zedity.t('OK'),
                        class: 'zedity-button-ok',
                        click: function() {
                            var $this = $(this);
                            var box = $this.data('box');
                            if (box) {
                                var $inputDescription = $('#zedity-txtImageDescription');
                                if (box._options.descriptionMandatory && $inputDescription.val().length < 4) {
                                    if ($inputDescription.val().length == 0) {
                                        box.editor._error({
                                            message: Zedity.t('Please insert image description.')
                                        })
                                    } else if ($inputDescription.val().length < 4) {
                                        box.editor._error({
                                            message: Zedity.t('Image description is too short.')
                                        })
                                    }
                                    $inputDescription.focus();
                                    return
                                }
                                box._data.filterOriginal = null;
                                switch ($this.find('.tabs').tabs('selected')) {
                                    case 'tab-image-disk':
                                        var $fu = $this.find('.zedity-fileupload');
                                        if ($fu.upload('getfilename') == '') {
                                            box.editor._error({
                                                message: Zedity.t('No file selected.')
                                            });
                                            return
                                        }
                                        box._options.quality = parseFloat($this.find('#zedity-ddImageQuality').val());
                                        if (box._options.quality == 1) box._options.quality = 2;
                                        $fu.upload('submit');
                                        break;
                                    case 'tab-image-link':
                                        var content = $('#zedity-txtImageLink').val();
                                        if (content == '') {
                                            box.editor._error({
                                                message: Zedity.t('Please insert a link.')
                                            });
                                            return
                                        }
                                        box.content(content);
                                        break
                                }
                                box.description($inputDescription.val())
                            }
                            $(this).dialog('close')
                        }
                    }, {
                        text: Zedity.t('Cancel'),
                        class: 'zedity-button-cancel',
                        click: function() {
                            $(this).dialog('close')
                        }
                    }]
                })
            }
            $('.zedity-dialog-image .zedity-fileupload').upload({
                autosubmit: false,
                acceptmime: $.map(this._options.accept, function(key) {
                    return Zedity.utils.fileTypes.types[key].mime
                }).join(','),
                extensions: $.map(this._options.accept, function(key) {
                    return Zedity.utils.fileTypes.types[key].extensions
                }).join(' '),
                action: this._options.action,
                maxsize: this._options.maxSize,
                onselect: $.proxy(function(event, file) {
                    var fn = $(file).val();
                    fn = fn.split(/[\\\/]/).pop();
                    $('#zedity-lblImageDisk').html('Selected file:<br/><b>' + fn + '</b>');
                    $('#zedity-txtImageDescription').focus()
                }, this),
                onsubmit: function(file) {
                    var $this = $(this);
                    var data = $this.data('upload');
                    var box = $this.parents('.zedity-dialog-image').data('box');
                    box._loading();
                    data.$input.trigger('mouseout.upload');
                    if (!Zedity.core.supports.fileapi()) {
                        box.editor._data.imageupload = box;
                        return true
                    }
                    Zedity.utils.resizeImage(file.files[0], {
                        maxwidth: box._sizeLimits().maxWidth,
                        maxheight: box._sizeLimits().maxHeight,
                        aspectratio: true,
                        quality: box._options.quality,
                        accept: box._options.accept,
                        onerror: function(error) {
                            box.editor._error(error)
                        },
                        onresizeend: function(size, data, type) {
                            box.content(data, size);
                            box._data.fileType = type
                        }
                    });
                    return false
                },
                oncomplete: function(event, response) {
                    var box = $(this).parents('.zedity-dialog-image').data('box');
                    if (!box) return;
                    if (response.status == 'OK') {
                        if (box.editor._data.imageupload) {
                            box.editor._data.imageupload.content(response.data);
                            delete box.editor._data.imageupload
                        } else {
                            box.editor._error({
                                message: Zedity.t('An unexpected error occurred. Please try again.')
                            })
                        }
                    } else {
                        box.editor._error({
                            message: Zedity.t('There was an error during server image resize.')
                        })
                    }
                },
                onerror: function(error) {
                    var box = $(this).parents('.zedity-dialog-image').data('box');
                    if (!box) return;
                    box.editor._error(error)
                }
            });
            return this
        },
        _loading: function(set) {
            if (set === false) {
                this.$this.find('.zedity-loading').remove()
            } else {
                this.$this.find('.zedity-empty').remove();
                this.$this.append('<div class="zedity-loading"><p>' + Zedity.t('Loading...') + '</p></div>')
            }
            return this
        },
        _checkSize: function() {
            this.$this.removeClass('zedity-warn-size-up zedity-warn-size-down');
            if (this._data.size) {
                var $img = this.$this.find('img');
                var w = $img.width(),
                    h = $img.height();
                if (this._data.size.width < w || this._data.size.height < h) {
                    this.$this.addClass('zedity-warn-size-down')
                } else if (this._data.size.width > w || this._data.size.height > h) {
                    this.$this.addClass('zedity-warn-size-up')
                }
            }
            return this
        },
        setOriginalSize: function() {
            return this.resizeToContent()
        },
        content: function(content, size, dontresize, onload) {
            function resizeBox() {
                this.editor._changed();
                if (dontresize) {
                    Zedity.core._call(this, 'layout', this.layout());
                    return
                }
                var old = this.proportionalResize();
                Zedity.core._call(this, 'proportionalResize', true);
                if (!old) Zedity.core._call(this, 'proportionalResize', false)
            };

            function getSize(content) {
                var img = new Image();
                img.onload = $.proxy(function() {
                    this._data.size = {
                        width: img.width,
                        height: img.height
                    };
                    img = null;
                    resizeBox.call(this);
                    onload.call(this)
                }, this);
                img.src = content
            };
            if (content == null) {
                content = this.$this.find('img').css('background-image');
                if (/data:image\//.test(content)) {
                    content = /(url\("?)(data:.*?)("?\))/i.exec(content)[2]
                } else if (/^url\(/.test(content)) {
                    content = /(url\("?)(.*?)("?\))/i.exec(content)[2]
                } else {
                    content = this.$this.find('img').attr('src')
                }
                if (content == this._options.src) content = null
            } else {
                onload = onload || function() {};
                if (/^http/.test(content)) {
                    this._loading();
                    this.$this.removeNumberedClass('imgDataS');
                    this.$this.find('img').css({
                        'background-image': '',
                        'background-size': '',
                        'background-position': ''
                    }).attr('src', content);
                    this._loading(false);
                    this._data.fileType = Zedity.utils.fileTypes.fromExtension(content);
                    getSize.call(this, content)
                } else if (/^data:/.test(content)) {
                    this._loading();
                    this.$this.find('img').css({
                        'background-image': '',
                        'background-size': '100% 100%',
                        'background-position': 'left top'
                    }).attr('src', this._options.src);
                    var idx = $('style.imgData').getEmptyNumberedClass('imgDataS');
                    var $imgData = $('<style class="imgData imgDataS' + idx + '" type="text/css"></style>');
                    $imgData.appendTo('head');
                    $imgData.html('#' + this.editor.id + ' .imgDataS' + idx + ' img{background-image:url("' + content + '")}');
                    this.$this.removeNumberedClass('imgDataS').addClass('imgDataS' + idx);
                    this._addReference();
                    if (this.layout() == 'stretch' && this.$this.find('img')[0].style.backgroundSize == '100%') this.layout('stretch');
                    this._loading(false);
                    if (size) {
                        this._data.size = size;
                        resizeBox.call(this)
                    } else {
                        getSize.call(this, content)
                    }
                } else {
                    this.editor._error({
                        message: Zedity.t('Could not interpret the content as image.')
                    })
                }
            }
            return content
        },
        resizeToContent: function() {
            this.$this.css({
                width: this._data.size.width,
                height: this._data.size.height
            });
            Zedity.core._call(this, 'layout', this.layout());
            this.reposition()._resize();
            this.editor.boxes.refreshSelected();
            this.editor._changed();
            return this
        },
        extractText: function() {
            this._data.$clone = this.$this.clone();
            this._data.$clone.find('style').remove();
            return Zedity.Box.prototype.extractText.call(this)
        },
        description: function(description) {
            if (description != null) {
                this.$this.find('img').attr('alt', description)
            } else {
                description = this.$this.find('img').attr('alt')
            }
            return description
        },
        select: function() {
            Zedity.Box.prototype.select.call(this);
            if (this.$this.is(':data(ui-resizable)')) {
                this.$this.resizable('option', 'aspectRatio', this.proportionalResize())
            }
            if (this.$this.data('ui-resizable')) {
                this.$this.resizable('option', 'resize', $.proxy(function() {
                    Zedity.core._call(this, 'layout', this.layout())
                }, this))
            }
            return this
        },
        _getQualityName: function() {
            if (this._options.quality < 0.8) {
                return 'low'
            } else if (this._options.quality < 0.9) {
                return 'normal'
            } else if (this._options.quality <= 1) {
                return 'high'
            } else {
                return 'original'
            }
        },
        start: function() {
            Zedity.Box.prototype.start.call(this);
            return this
        },
        stop: function() {
            Zedity.Box.prototype.stop.call(this);
            return this
        },
        insert: function() {
            Zedity.Box.prototype.insert.call(this);
            $('.zedity-dialog-image').data('box', this).dialog('open');
            return this
        },
        duplicate: function() {
            Zedity.Box.prototype.duplicate.call(this);
            if (this.layout() == 'stretch' && this.$this.find('img')[0].style.backgroundSize == '100%') this.layout('stretch');
            this.editor.boxes.selected()._addReference();
            return this
        },
        init: function() {
            Zedity.Box.prototype.init.call(this);
            if (this.$this.hasNumberedClass('imgDataS')) {
                this._addReference();
                var nc = this.$this.getNumberedClass('imgDataS');
                var style = this.editor.$this.children('style.' + nc);
                if (style) {
                    style.detach().appendTo('head')
                }
            }
            return this
        },
        layout: function(layout) {
            if (layout) {
                this.$this.attr('data-layout', layout);
                if (!this._data.size) return layout;
                var wratio, hratio, ratio, width, height;
                var $c = this.$this.find('.zedity-content');
                switch (layout) {
                    case 'fit':
                        wratio = $c.width() / this._data.size.width;
                        hratio = $c.height() / this._data.size.height;
                        ratio = Math.min(wratio, hratio);
                        width = Math.round(this._data.size.width * ratio);
                        height = Math.round(this._data.size.height * ratio);
                        break;
                    case 'centerfill':
                        wratio = $c.width() / this._data.size.width;
                        hratio = $c.height() / this._data.size.height;
                        ratio = Math.max(wratio, hratio);
                        width = Math.round(this._data.size.width * ratio);
                        height = Math.round(this._data.size.height * ratio);
                        break;
                    case 'stretch':
                        width = $c.width();
                        height = $c.height();
                        break;
                    case 'center':
                        width = this._data.size.width;
                        height = this._data.size.height;
                        break
                }
                this.$this.find('img').css({
                    left: Math.round(($c.width() - width) / 2),
                    top: Math.round(($c.height() - height) / 2),
                    width: width,
                    height: height
                });
                this._checkSize();
                this.editor._changed()
            } else {
                layout = this.$this.attr('data-layout') || ''
            }
            return layout
        },
        proportionalResize: function(value) {
            if (this.asBackground()) return false;
            if (this.$this.find('.zedity-empty').length > 0) return false;
            if (value === true) {
                this.$this.attr('data-aspectratio', 1);
                if (!this._data.size) {
                    Zedity.core._call(this, 'content', Zedity.core._call(this, 'content'));
                    setTimeout($.proxy(function() {
                        Zedity.core._call(this, 'proportionalResize', true)
                    }, this), 0);
                    return true
                }
                var wratio = this.$this.width() / this._data.size.width;
                var hratio = this.$this.height() / this._data.size.height;
                var ratio = (wratio < hratio) ? wratio : hratio;
                var width = Math.round(this._data.size.width * ratio);
                var height = Math.round(this._data.size.height * ratio);
                this.$this.css({
                    width: width,
                    height: height
                });
                if (this.$this.is(':data(ui-resizable)')) {
                    this.$this.resizable('option', 'aspectRatio', value)
                }
                Zedity.core._call(this, 'layout', this.layout());
                this.editor.boxes.refreshSelected();
                this.editor._changed()
            } else if (value === false) {
                this.$this.removeAttr('data-aspectratio');
                Zedity.core._call(this, 'layout', this.layout());
                this.editor.boxes.refreshSelected();
                this.editor._changed()
            }
            return this.$this.attr('data-aspectratio') == 1
        },
        asBackground: function(setting) {
            var res = Zedity.Box.prototype.asBackground.call(this, setting);
            Zedity.core._call(this, 'layout', this.layout());
            return res
        },
        _removeUnreferencedData: function() {
            var list = Zedity.core.gc.getNonReferenced('imageGc');
            for (var i = list.length - 1; i >= 0; --i) {
                $('style.' + list[i]).remove()
            }
            Zedity.core.gc.deleteReference(list);
            return this
        },
        _addReference: function() {
            if (this.$this.hasNumberedClass('imgDataS')) {
                var nc = this.$this.getNumberedClass('imgDataS');
                Zedity.core.gc.addReference(nc, 'imageGc');
                Zedity.core.gc.addReference(nc, 'imageGc-' + this.id)
            }
            return this
        },
        _save: function(callback, options) {
            this._removeUnreferencedData();
            var nc = this.$this.getNumberedClass('imgDataS');
            if (nc) {
                var style = $('head style.' + nc);
                if (style.length > 0) {
                    if (!options.finalize) {
                        style.detach().appendTo(this.$this);
                        if (typeof(callback) == 'function') callback.call(this);
                        return this
                    }
                    if (['center', 'tile'].indexOf(this.layout()) > -1) {
                        style.detach().appendTo(this.$this);
                        if (typeof(callback) == 'function') callback.call(this)
                    } else {
                        var box = this;
                        var bsize = {
                            w: 0,
                            h: 0
                        };
                        this.editor.$this.children('.zedity-box-Image.' + nc).each(function(idx, elem) {
                            bsize.w = Math.max(bsize.w, $(elem).width());
                            bsize.h = Math.max(bsize.h, $(elem).height())
                        });
                        Zedity.utils.resizeImage(style.html(), {
                            maxwidth: bsize.w,
                            maxheight: bsize.h,
                            aspectratio: true,
                            quality: this._options.quality,
                            accept: this._options.accept,
                            onerror: function(error) {
                                box.editor._error(error)
                            },
                            onresizeend: function(size, data, type) {
                                Zedity.core._call(box, 'content', data, size, true);
                                box._data.fileType = type;
                                var newnc = box.$this.getNumberedClass('imgDataS');
                                box.editor.$this.children('.zedity-box-Image.' + nc).removeClass(nc).addClass(newnc);
                                box._addReference();
                                $('head style.' + newnc).detach().appendTo(box.$this);
                                style.remove();
                                Zedity.Box.prototype._save.call(box);
                                if (typeof(callback) == 'function') callback.call(this)
                            }
                        })
                    }
                } else {
                    Zedity.Box.prototype._save.call(this);
                    if (typeof(callback) == 'function') callback.call(this)
                }
            } else {
                Zedity.Box.prototype._save.call(this);
                if (typeof(callback) == 'function') callback.call(this)
            }
            return this
        },
        destroy: function() {
            Zedity.Box.prototype.destroy.call(this);
            var ref = Zedity.core.gc.getReferenced('imageGc-' + this.id);
            for (var i = ref.length - 1; i >= 0; --i) {
                Zedity.core.gc.removeReference(ref[i], 'imageGc')
            }
            Zedity.core.gc.flushData('imageGc-' + this.id);
            this._removeUnreferencedData();
            return this
        }
    });
    Zedity.Box.Image.type = 'Image';
    Zedity.Box.Image.sizeLimits = {
        minWidth: 16,
        minHeight: 16,
        maxWidth: null,
        maxHeight: null
    };
    Zedity.Box.Image._defaults = {
        src: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7',
        width: 250,
        height: 200,
        layout: 'centerfill',
        proportionalResize: true,
        quality: 0.88,
        accept: Object.keys(Zedity.utils.fileTypes.types),
        maxSize: 1000000,
        descriptionMandatory: true,
        allowLink: true
    };
    Zedity.Box.register({
        type: Zedity.Box.Image.type,
        requires: ['canvas'],
        section: 'basic',
        order: 100
    });
    Zedity.core.gc.flushData('imageGc');
    Zedity.core.store.delprefix('imageGc-')
})(jQuery);
(function($) {
    $.fn.upload = function(method) {
        var methods = {
            init: function(options) {
                var settings = {
                    autosubmit: true,
                    name: 'file',
                    acceptmime: '',
                    extensions: undefined,
                    maxsize: undefined,
                    action: '/fake.php',
                    enctype: 'multipart/form-data',
                    onsubmit: function(file) {},
                    oncomplete: function(event, response) {},
                    onselect: function(event, file) {},
                    onerror: function(error) {}
                };
                $.extend(settings, options);
                if (typeof(settings.extensions) == 'string') settings.extensions = settings.extensions.split(' ');
                return this.each(function(idx, elem) {
                    var $upload = $(this);
                    if ($upload.data('upload')) return;
                    var id = Zedity.core.genId('upload');
                    var $iframe = $('<iframe/>', {
                        id: id,
                        name: id,
                        src: 'javascript:false;',
                        css: {
                            display: 'none'
                        }
                    });
                    var $form = $('<form/>', {
                        method: 'post',
                        enctype: settings.enctype,
                        action: settings.action,
                        target: id
                    });
                    var $input = $('<input/>', {
                        name: settings.name,
                        type: 'file',
                        accept: settings.acceptmime,
                        css: {
                            position: 'absolute',
                            right: -4,
                            margin: 0,
                            padding: 0,
                            'font-size': '480px',
                            opacity: 0
                        }
                    }).on('change.upload', function(event) {
                        if (typeof(settings.onselect) == 'function') settings.onselect.call($upload[0], event, $input[0]);
                        if (settings.autosubmit) $upload.upload('submit')
                    }).appendTo($form);
                    $upload.data('upload', {
                        $input: $input,
                        $form: $form,
                        $iframe: $iframe,
                        extensions: settings.extensions,
                        maxsize: settings.maxsize,
                        onsubmit: settings.onsubmit,
                        oncomplete: settings.oncomplete,
                        onerror: settings.onerror
                    });
                    var $container = $('<div>', {
                        css: {
                            position: 'absolute',
                            zIndex: 10000,
                            padding: 0,
                            overflow: 'hidden'
                        }
                    }).append($form).append($iframe);
                    $upload.add($container).on('mouseenter.upload', function() {
                        $container.css({
                            left: $upload.offset().left,
                            top: $upload.offset().top,
                            width: $upload.outerWidth(),
                            height: $upload.outerHeight()
                        });
                        $input.css({
                            cursor: $upload.css('cursor')
                        }).attr('title', $upload.attr('title'));
                        $upload.addClass('zedity-hover')
                    }).on('mouseleave.upload', function() {
                        $upload.removeClass('zedity-hover')
                    });
                    $upload.on('focus.upload', function() {
                        $upload.blur();
                        var tabbables = $(":tabbable:visible");
                        var index = tabbables.index($upload);
                        tabbables.eq(index + 1).focus()
                    }).on('click.upload', function() {
                        $input.show().focus().click().hide();
                        return false
                    });
                    $('body').append($container)
                })
            },
            validate: function() {
                var data = $(this).data('upload');
                if (data.extensions) {
                    var ext = data.$input.val().split('.').pop().toLowerCase();
                    if (data.extensions.indexOf(ext) < 0) {
                        data.onerror.call(this, {
                            message: Zedity.t('File extension not valid.')
                        });
                        data.$input.val('');
                        return false
                    }
                }
                if (data.maxsize && Zedity.core.supports.fileapi()) {
                    if (data.$input[0].files[0].size > data.maxsize) {
                        data.onerror.call(this, {
                            message: Zedity.t('File too big (max size: %s).', Zedity.utils.beautifySize(data.maxsize))
                        });
                        data.$input.val('');
                        return false
                    }
                }
                return true
            },
            getfilename: function() {
                var data = $(this).data('upload');
                if (data.$input) {
                    return data.$input.val()
                }
                return ''
            },
            clear: function() {
                var data = $(this).data('upload');
                data.$input.val('')
            },
            submit: function() {
                var $this = $(this);
                var data = $this.data('upload');
                if (!$this.upload('validate')) return false;
                if (typeof(data.onsubmit) == 'function') var ret = data.onsubmit.call(this, data.$input[0]);
                if (ret === false) {
                    data.$input.val('');
                    return false
                }
                data.$iframe.off('load.upload').on('load.upload', function(event) {
                    data.$input.val('');
                    var response = $(this).contents().find('body').html();
                    try {
                        response = JSON.parse(response)
                    } catch (e) {
                        response = {
                            status: 'ERROR',
                            message: Zedity.t('Error in reading the response from the server')
                        }
                    }
                    if (typeof(data.oncomplete) == 'function') data.oncomplete.call($this[0], event, response)
                });
                data.$form.submit()
            }
        };
        if (methods[method]) {
            return methods[method].apply(this, Array.prototype.slice.call(arguments, 1))
        } else if (typeof method === 'object' || !method) {
            return methods.init.apply(this, arguments)
        } else {
            throw new Error(Zedity.t('Method %s does not exist on %s.', method, 'jQuery.upload'))
        }
    };
    (function() {
        var oldSetOption = $.ui.resizable.prototype._setOption;
        $.ui.resizable.prototype._setOption = function(key, value) {
            oldSetOption.apply(this, arguments);
            if (key === 'aspectRatio') this._aspectRatio = !!value
        }
    })();
    Zedity.utils.resizeImage = function(input, options) {
        if (!input) throw new Error(Zedity.t('Input not defined'));
        if (input instanceof jQuery) input = input[0];
        var MAX_FILE_SIZE = 10000000;
        options = $.extend({
            maxwidth: 1024,
            maxheight: 1024,
            aspectratio: true,
            quality: 0.88,
            accept: Object.keys(Zedity.utils.fileTypes.types),
            onerror: null,
            onresizeend: null
        }, options);
        if (typeof(options.onerror) != 'function') options.onerror = function(event) {};
        if (typeof(options.onresizeend) != 'function') options.onresizeend = function(size, data, type) {};
        options.aspectratio = !!options.aspectratio;

        function resize() {
            options.origwidth = options.origwidth || options.image.width;
            options.origheight = options.origheight || options.image.height;
            options.maxwidth = options.maxwidth || options.image.width;
            options.maxheight = options.maxheight || options.image.height;
            var origImgSize = options.image.src.length;
            options.ftype = options.ftype || Zedity.utils.fileTypes.parse(options.image.src.substr(0, 100), options.accept);
            var needResize = false;
            var width = options.maxwidth;
            var height = options.maxheight;
            if (!options.ftype.canResize) {
                options.onerror({
                    type: 'WARNING',
                    message: Zedity.t('Image file type cannot be resized.')
                });
                options.onresizeend({
                    width: width,
                    height: height
                }, options.image.src, options.ftype);
                return
            }
            if (options.quality > 1) {
                options.onresizeend({
                    width: width,
                    height: height
                }, options.image.src, options.ftype);
                return
            }
            var $canvas = $('<canvas/>');
            var canvas = $canvas[0];
            var context = canvas.getContext('2d');
            var userQualFactor = 1;
            var wratio = (options.maxwidth / options.origwidth) * userQualFactor;
            var hratio = (options.maxheight / options.origheight) * userQualFactor;
            if (!options.aspectratio) {
                width = wratio > 1 ? options.origwidth : options.maxwidth;
                height = hratio > 1 ? options.origheight : options.maxheight
            } else {
                if (wratio > 1 || hratio > 1) {
                    wratio = hratio = 1
                } else {
                    if (wratio > hratio) hratio = wratio;
                    else wratio = hratio
                }
                width = Math.round(options.origwidth * wratio);
                height = Math.round(options.origheight * hratio)
            }
            canvas.width = width;
            canvas.height = height;
            context.drawImage(options.image, 0, 0, canvas.width, canvas.height);
            var tmp;
            try {
                tmp = canvas.toDataURL(options.ftype.mime, options.quality)
            } catch (e) {
                tmp = canvas.toDataURL('image/jpeg')
            }
            if ((0.95 * origImgSize) > tmp.length) {
                options.onresizeend({
                    width: width,
                    height: height
                }, tmp, options.ftype)
            } else {
                width = options.origwidth;
                height = options.origheight;
                options.onresizeend({
                    width: width,
                    height: height
                }, options.image.src, options.ftype)
            }
            context = null;
            canvas = null;
            $canvas = null
        };

        function loadFile() {
            var fr = new FileReader();
            options.image = new Image();
            options.image.src = '';
            fr.onload = function(event) {
                if (event.total > MAX_FILE_SIZE) {
                    event.target.abort();
                    return
                }
                options.ftype = Zedity.utils.fileTypes.parse(event.target.result.substr(0, 100), options.accept);
                if (options.ftype.type == 'other' || options.ftype.type == '') {
                    options.onerror($.extend(event, {
                        error: Zedity.t('File is not a supported image.')
                    }));
                    return
                }
                options.image.onload = function(event) {
                    if (options.image.width == 0 || options.image.height == 0) {
                        options.onerror($.extend(event, {
                            error: Zedity.t('File is not recognized as valid image.')
                        }));
                        options.image = null;
                        return
                    }
                    var w = options.image.width;
                    var h = options.image.height;
                    options.origwidth = options.image.width;
                    options.origheight = options.image.height;
                    resize()
                };
                options.image.src = event.target.result.replace(/^(data:)(.*?)(base64)/, '$1' + options.ftype.mime + ';$3')
            };
            fr.onerror = function(event) {
                switch (event.target.error.code) {
                    case event.target.error.ABORT_ERR:
                        $.extend(event, {
                            error: Zedity.t('File is too big.')
                        });
                        break;
                    case event.target.error.NOT_FOUND_ERR:
                    case event.target.error.NOT_READABLE_ERR:
                    default:
                        $.extend(event, {
                            error: Zedity.t('Error during loading of the image.')
                        });
                        break
                };
                options.onerror(event)
            };
            fr.readAsDataURL(input)
        };

        function loadData() {
            options.image = new Image();
            options.image.src = '';
            options.image.onload = function() {
                resize()
            };
            setTimeout(function() {
                options.image.src = input
            }, 0)
        };
        if (typeof input == 'string' || input instanceof String) {
            var rx = /(data:.*?)["\)$]/i;
            input = rx.exec(input)[1];
            loadData()
        } else if (input instanceof File) {
            loadFile()
        } else if (input.nodeName == 'IMG') {
            options.image = input;
            resize()
        }
    };
    Zedity.utils.beautifySize = function(size) {
        if (size == 0) return '0 Bytes';
        var sizes = ['Bytes', 'KB', 'MB', 'GB'];
        var i = Math.min(Math.floor(Math.log(size) / Math.log(1000)), sizes.length - 1);
        return +(size / Math.pow(1000, i)).toFixed(2) + ' ' + sizes[i]
    }
})(jQuery);
(function($) {
    $.fn.hasNumberedClass = function(c) {
        var classes = this.attr('class');
        var list = classes ? classes.split(/\s+/) : [];
        for (var i = 0; i < list.length; i++) {
            if (list[i].indexOf(c) != -1) return true
        }
        return false
    };
    $.fn.getEmptyNumberedClass = function(c) {
        var list = this.getNumberedClassList(c);
        var i = 0;
        do {
            i++
        } while (list.indexOf(c + i) != -1);
        return i
    };
    $.fn.getNumberedClass = function(c) {
        var classes = this.attr('class');
        var list = classes ? classes.split(/\s+/) : [];
        for (var i = 0, len = list.length; i < len; i++) {
            if (list[i].indexOf(c) != -1) return list[i]
        }
        return ''
    };
    $.fn.getNumberedClassList = function(c, unique) {
        var cl = [];
        this.each(function(idx, elem) {
            var nc = $(elem).getNumberedClass(c);
            if (nc != '' && (!unique || cl.indexOf(nc) == -1)) {
                cl.push(nc)
            }
        });
        return cl
    };
    $.fn.removeNumberedClass = function(c) {
        var numclass;
        return this.each(function(idx, elem) {
            numclass = $(elem).getNumberedClass(c);
            if (numclass) {
                $(elem).removeClass(numclass)
            }
        })
    }
})(jQuery);
(function($) {
    var old_prototype = Zedity.Box.Image.prototype;
    var old_constructor = Zedity.Box.Image;
    var old_props = {};
    for (var i in Zedity.Box.Image)
        if (Zedity.Box.Image.hasOwnProperty(i)) old_props[i] = Zedity.Box.Image[i];
    Zedity.Box.Image = function() {
        old_constructor.apply(this, arguments);
        this._can.push('filter')
    };
    Zedity.Box.Image.prototype = old_prototype;
    for (var i in old_props)
        if (old_props.hasOwnProperty(i)) Zedity.Box.Image[i] = old_props[i];
    var old_createPropBar = Zedity.Box.Image.prototype.createPropBar;
    Zedity.Box.Image.prototype.createPropBar = function(options) {
        old_createPropBar.call(this);
        this.editor.menu.add({
            tabs: {
                editbox: {
                    groups: {
                        imagebox: {
                            features: {
                                filters: {
                                    type: 'extpanel',
                                    icon: 'filter',
                                    label: Zedity.t('Filters'),
                                    title: Zedity.t('Apply image filters'),
                                    order: 300,
                                    build: function($panel, ed) {
                                        $panel.append('<select class="zedity-image-filters">' + '<option disabled selected class="ui-helper-hidden"></option>' + '<option value="adjust">' + Zedity.t('Adjust colors') + '</option>' + '<option value="threshold">' + Zedity.t('Black & white') + '</option>' + '<option value="blur">' + Zedity.t('Blur') + '</option>' + '<option value="brightness">' + Zedity.t('Brightness') + '</option>' + '<option value="contrast">' + Zedity.t('Contrast') + '</option>' + '<option value="emboss">' + Zedity.t('Emboss') + '</option>' + '<option value="grayscale">' + Zedity.t('Grayscale') + '</option>' + '<option value="invert">' + Zedity.t('Invert') + '</option>' + '<option value="pixelize">' + Zedity.t('Mosaic') + '</option>' + '<option value="motionblur">' + Zedity.t('Motion blur') + '</option>' + '<option value="noise">' + Zedity.t('Noise') + '</option>' + '<option value="paint">' + Zedity.t('Paint') + '</option>' + '<option value="posterize">' + Zedity.t('Posterize') + '</option>' + '<option value="sobel">' + Zedity.t('Psychedelia') + '</option>' + '<option value="sepia">' + Zedity.t('Sepia') + '</option>' + '<option value="sharpen">' + Zedity.t('Sharpen') + '</option>' + '<option value="vignette">' + Zedity.t('Vignette') + '</option>' + '</select>' + '<span class="zedity-button zedity-imagefilter-apply"><span class="zicon zicon-size-xs zicon-ok"></span></span>' + '<span class="zedity-button zedity-imagefilter-reset"><span class="zicon zicon-size-xs zicon-undo"></span></span>' + '<span class="zedity-button zedity-imagefilter-resetall"><span class="zicon zicon-size-xs zicon-delete"></span></span>' + '<div class="zedity-imagefilter-args" style="margin-top:15px;padding-top:10px;border-top:1px solid lightgray;"></div>');
                                        $panel.find('.zedity-image-filters').selectmenu({
                                            width: 140,
                                            appendTo: $panel,
                                            change: function(e, ui) {
                                                var box = ed.boxes.selected();
                                                if (box) box._data.filterPrevious = box.content();
                                                var filter = ui.item.value;
                                                var $ia = $panel.find('.zedity-imagefilter-args').empty();
                                                $.each(Zedity.core.imageFilters.args[filter], function(idx, val) {
                                                    $ia.append('<span class="zedity-filter-arg-label">' + val.name + ':</span>' + '<div class="zedity-filter-arg zedity-filter-arg-' + idx + '"></div>');
                                                    $ia.find('.zedity-filter-arg-' + idx).sliderSnap({
                                                        min: val.min,
                                                        max: val.max,
                                                        step: val.step
                                                    }).sliderSnap('value', val.default)
                                                })
                                            }
                                        }).trigger('selectmenuchange');
                                        $panel.find('.zedity-imagefilter-apply').attr('title', Zedity.t('Apply filter')).on('click.zedity', function() {
                                            var box = ed.boxes.selected();
                                            if (!box) return;
                                            var filter = $panel.find('.zedity-image-filters').val();
                                            var values = [];
                                            $panel.find('.zedity-imagefilter-args .zedity-filter-arg').each(function(idx, elem) {
                                                values.push($(elem).sliderSnap('value'))
                                            });
                                            box.filter(filter, values)
                                        });
                                        $panel.find('.zedity-imagefilter-reset').attr('title', Zedity.t('Reset filter')).on('click.zedity', function() {
                                            var box = ed.boxes.selected();
                                            if (!box) return;
                                            var filter = $panel.find('.zedity-image-filters').val();
                                            $.each(Zedity.core.imageFilters.args[filter], function(idx, val) {
                                                $panel.find('.zedity-imagefilter-args .zedity-filter-arg-' + idx).sliderSnap('value', val.default)
                                            });
                                            box.content(box._data.filterPrevious, null, true)
                                        });
                                        $panel.find('.zedity-imagefilter-resetall').attr('title', Zedity.t('Remove all filters')).on('click.zedity', function() {
                                            var box = ed.boxes.selected();
                                            if (!box) return;
                                            var filter = $panel.find('.zedity-image-filters').val();
                                            $.each(Zedity.core.imageFilters.args[filter], function(idx, val) {
                                                $panel.find('.zedity-imagefilter-args .zedity-filter-arg-' + idx).sliderSnap('value', val.default)
                                            });
                                            box.content(box._data.filterOriginal, null, true);
                                            box._data.filterPrevious = box._data.filterOriginal
                                        })
                                    },
                                    enable: function(ed, box) {
                                        return (box && box.$this.children('.zedity-empty').length == 0)
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }, 'imageboxcommercial')
    };
    $.extend(Zedity.Box.Image.prototype, {
        filter: function(filter, args) {
            if (!filter) return this;
            if (filter == 'reset') {
                this._data.filterOriginal = this.content();
                return this
            }
            if (filter == 'restore') {
                this._data.filterOriginal = this._data.filterOriginal || this.content();
                this.content(this._data.filterOriginal, null, true);
                return this
            }
            var image = new Image();
            image.onload = $.proxy(function() {
                var data = Zedity.core.imageFilters.filter(image, filter, this._data.fileType ? this._data.fileType.mime : 'image/jpeg', this._options.quality, args);
                if (typeof data == 'string') {
                    this.content(data, null, true)
                } else {
                    var err = Zedity.t('Error applying filter "%s".', filter);
                    switch (data) {
                        case -1:
                            err = Zedity.t('Filter "%s" not defined.', filter);
                            break;
                        case -2:
                            err = Zedity.t('Could not read image data. Filters cannot be applied on images hosted on a different domain.');
                            break
                    }
                    this.editor._error({
                        message: err
                    })
                }
            }, this);
            var content = this._data.filterPrevious || this.content();
            if (content && content != 'none') {
                if (!this._data.filterOriginal) this._data.filterOriginal = content;
                image.src = content
            }
            return this
        }
    });
    Zedity.core.imageFilters.add('table', function(px, table, alpha) {
        var d = px.data;
        for (var i = 0, len = d.length; i < len; i += 4) {
            d[i] = table[d[i]];
            d[i + 1] = table[d[i + 1]];
            d[i + 2] = table[d[i + 2]];
            if (alpha) d[i + 3] = table[d[i + 3]]
        }
        return px
    });
    Zedity.core.imageFilters.add('convolute', function(px, matrix, opaque) {
        var side = Math.round(Math.sqrt(matrix.length));
        var halfSide = Math.floor(side / 2);
        var d = px.data;
        var out = this._ctx.createImageData(px.width, px.height);
        var od = out.data;
        var alphaFac = opaque ? 1 : 0;
        for (var y = 0; y < px.height; y++) {
            for (var x = 0; x < px.width; x++) {
                var sy = y;
                var sx = x;
                var dstOff = (y * px.width + x) * 4;
                var r = 0,
                    g = 0,
                    b = 0,
                    a = 0;
                for (var cy = 0; cy < side; cy++) {
                    for (var cx = 0; cx < side; cx++) {
                        var scy = sy + cy - halfSide;
                        var scx = sx + cx - halfSide;
                        if (scy >= 0 && scy < px.height && scx >= 0 && scx < px.width) {
                            var srcOff = (scy * px.width + scx) * 4;
                            var wt = matrix[cy * side + cx];
                            r += d[srcOff] * wt;
                            g += d[srcOff + 1] * wt;
                            b += d[srcOff + 2] * wt;
                            a += d[srcOff + 3] * wt
                        }
                    }
                }
                od[dstOff] = r;
                od[dstOff + 1] = g;
                od[dstOff + 2] = b;
                od[dstOff + 3] = a + alphaFac * (255 - a)
            }
        }
        return out
    });
    Zedity.core.imageFilters.add('grayscale', function(px, percent) {
        percent = percent || 100;
        percent /= 100;
        var d = px.data;
        for (var i = 0, len = d.length; i < len; i += 4) {
            var a = (0.2126 * d[i] + 0.7152 * d[i + 1] + 0.0722 * d[i + 2]) * percent;
            d[i] = d[i] + (a - d[i] * percent);
            d[i + 1] = d[i + 1] + (a - d[i + 1] * percent);
            d[i + 2] = d[i + 2] + (a - d[i + 2] * percent)
        }
        return px
    }, [{
        name: Zedity.t('Percent'),
        default: 100,
        min: 1,
        max: 100,
        step: 1
    }]);
    Zedity.core.imageFilters.add('invert', function(px) {
        var table = [];
        for (var i = 0; i <= 255; ++i) {
            table[i] = 255 - i
        }
        return this.filters['table'].call(this, px, table)
    });
    Zedity.core.imageFilters.add('brightness', function(px, adjustment) {
        adjustment = Zedity.utils.normalize(adjustment != null ? adjustment : 0, -100, 100, -255, 255);
        var table = [];
        for (var i = 0; i <= 255; ++i) {
            table[i] = i + adjustment
        }
        return this.filters['table'].call(this, px, table)
    }, [{
        name: Zedity.t('Adjustment'),
        default: 0,
        min: -100,
        max: 100,
        step: 1
    }]);
    Zedity.core.imageFilters.add('contrast', function(px, adjustment) {
        adjustment = Zedity.utils.normalize(adjustment != null ? adjustment : 0, -100, 100, -255, 255);
        var factor = (259 * (adjustment + 255)) / (255 * (259 - adjustment));
        var table = [];
        for (var i = 0; i <= 255; ++i) {
            table[i] = Math.floor(factor * (i - 128) + 128)
        }
        return this.filters['table'].call(this, px, table)
    }, [{
        name: Zedity.t('Adjustment'),
        default: 0,
        min: -100,
        max: 100,
        step: 1
    }]);
    Zedity.core.imageFilters.add('threshold', function(px, threshold) {
        threshold = threshold != null ? threshold : 128;
        var d = px.data;
        for (var i = 0, len = d.length; i < len; i += 4) {
            d[i] = d[i + 1] = d[i + 2] = (0.2126 * d[i] + 0.7152 * d[i + 1] + 0.0722 * d[i + 2] >= threshold) ? 255 : 0
        }
        return px
    }, [{
        name: Zedity.t('Threshold'),
        default: 128,
        min: 0,
        max: 255,
        step: 1
    }]);
    Zedity.core.imageFilters.add('posterize', function(px, adjustment) {
        adjustment = adjustment || 15;
        var step = Math.floor(255 / adjustment);
        var table = [];
        for (var i = 0; i <= 255; ++i) {
            table[i] = i + (Math.floor(i / step) * step)
        }
        return this.filters['table'].call(this, px, table)
    }, [{
        name: Zedity.t('Adjustment'),
        default: 15,
        min: 1,
        max: 255,
        step: 1
    }]);
    Zedity.core.imageFilters.add('adjust', function(px, pr, pg, pb) {
        pr = Zedity.utils.normalize(pr != null ? pr : 0, -100, 100, -255, 255);
        pg = Zedity.utils.normalize(pg != null ? pg : 0, -100, 100, -255, 255);
        pb = Zedity.utils.normalize(pb != null ? pb : 0, -100, 100, -255, 255);
        var d = px.data;
        for (var i = 0, len = d.length; i < len; i += 4) {
            d[i] += pr;
            d[i + 1] += pg;
            d[i + 2] += pb
        }
        return px
    }, [{
        name: Zedity.t('Red'),
        default: 0,
        min: -100,
        max: 100,
        step: 1
    }, {
        name: Zedity.t('Green'),
        default: 0,
        min: -100,
        max: 100,
        step: 1
    }, {
        name: Zedity.t('Blue'),
        default: 0,
        min: -100,
        max: 100,
        step: 1
    }]);
    Zedity.core.imageFilters.add('sepia', function(px) {
        var d = px.data;
        for (var i = 0, len = d.length; i < len; i += 4) {
            var r = d[i];
            var g = d[i + 1];
            var b = d[i + 2];
            d[i] = (r * 0.393) + (g * 0.769) + (b * 0.189);
            d[i + 1] = (r * 0.349) + (g * 0.686) + (b * 0.168);
            d[i + 2] = (r * 0.272) + (g * 0.534) + (b * 0.131)
        }
        return px
    });
    Zedity.core.imageFilters.add('vignette', function(px, amount) {
        amount = amount || 0.3;
        var radius = Math.sqrt(Math.pow(px.width / 2, 2) + Math.pow(px.height / 2, 2));
        this._ctx.globalCompositeOperation = 'source-over';
        var gradient = this._ctx.createRadialGradient(px.width / 2, px.height / 2, 0, px.width / 2, px.height / 2, radius);
        gradient.addColorStop(0, 'rgba(0,0,0,0)');
        gradient.addColorStop(0.5, 'rgba(0,0,0,0)');
        gradient.addColorStop(1, 'rgba(0,0,0,' + amount + ')');
        this._ctx.fillStyle = gradient;
        this._ctx.fillRect(0, 0, px.width, px.height);
        gradient = this._ctx.createRadialGradient(px.width / 2, px.height / 2, 0, px.width / 2, px.height / 2, radius);
        gradient.addColorStop(0, 'rgba(255,255,255,' + amount + ')');
        gradient.addColorStop(0.5, 'rgba(255,255,255,0)');
        gradient.addColorStop(1, 'rgba(0,0,0,0)');
        this._ctx.fillStyle = gradient;
        this._ctx.fillRect(0, 0, px.width, px.height);
        return this._ctx.getImageData(0, 0, px.width, px.height)
    }, [{
        name: Zedity.t('Amount'),
        default: 0.3,
        min: 0.1,
        max: 1,
        step: 0.1
    }]);
    Zedity.core.imageFilters.add('noise', function(px, noise) {
        noise = Zedity.utils.normalize(noise || 20, 1, 100, 1, 500);
        var noise2 = noise / 2;
        var d = px.data;
        for (var i = 0, len = d.length; i < len; i += 4) {
            d[i] = d[i] - noise2 + (Math.random() * noise);
            d[i + 1] = d[i + 1] - noise2 + (Math.random() * noise);
            d[i + 2] = d[i + 2] - noise2 + (Math.random() * noise)
        }
        return px
    }, [{
        name: Zedity.t('Noise'),
        default: 20,
        min: 1,
        max: 100,
        step: 1
    }]);
    Zedity.core.imageFilters.add('pixelize', function(px, size) {
        size = size || 10;
        var d = px.data;
        for (var y = 0, h = px.height; y < h; y += size) {
            for (var x = 0, w = px.width; x < w; x += size) {
                var i = ((y * px.width) + x) * 4;
                this._ctx.fillStyle = 'rgba(' + d[i] + ',' + d[i + 1] + ',' + d[i + 2] + ', ' + d[i + 3] + ')';
                this._ctx.fillRect(x, y, size, size)
            }
        }
        return this._ctx.getImageData(0, 0, px.width, px.height)
    }, [{
        name: Zedity.t('Block size'),
        default: 10,
        min: 2,
        max: 50,
        step: 1
    }]);
    Zedity.core.imageFilters.add('sharpen', function(px, type) {
        type = type || 1;
        switch (type) {
            case 1:
                return this.filters['convolute'].call(this, px, [0, -1, 0, -1, 5, -1, 0, -1, 0]);
            case 2:
                return this.filters['convolute'].call(this, px, [0, 0, -1, 0, 0, 0, -1, -2, -1, 0, -1, -2, 17, -2, -1, 0, -1, -2, -1, 0, 0, 0, -1, 0, 0])
        }
    }, [{
        name: Zedity.t('Type'),
        default: 1,
        min: 1,
        max: 2,
        step: 1
    }]);
    Zedity.core.imageFilters.add('blur', function(px, size) {
        size = size || 3;
        var size2 = Math.pow(size, 2);
        var kernel = [];
        for (var i = size2 - 1; i >= 0; --i) {
            kernel[i] = 1 / size2
        }
        return this.filters['convolute'].call(this, px, kernel)
    }, [{
        name: Zedity.t('Strength'),
        default: 3,
        min: 3,
        max: 20,
        step: 1
    }]);
    Zedity.core.imageFilters.add('sobel', function(px) {
        var g = this.filters['grayscale'].call(this, px);
        var vertical = this.filters['convolute'].call(this, g, [-1, -2, -1, 0, 0, 0, 1, 2, 1]);
        var horizontal = this.filters['convolute'].call(this, g, [-1, 0, 1, -2, 0, 2, -1, 0, 1]);
        var out = this._ctx.createImageData(vertical.width, vertical.height);
        var d = out.data;
        for (var i = 0, len = d.length; i < len; i += 4) {
            var v = Math.abs(vertical.data[i]);
            d[i] = v;
            var h = Math.abs(horizontal.data[i]);
            d[i + 1] = h;
            d[i + 2] = (v + h) / 4;
            d[i + 3] = 255
        }
        return out
    });
    Zedity.core.imageFilters.add('emboss', function(px) {
        return this.filters['convolute'].call(this, px, [-2, -1, 0, -1, 1, 1, 0, 1, 2])
    });
    Zedity.core.imageFilters.add('motionblur', function(px) {
        return this.filters['convolute'].call(this, px, [1, -1 / 2, 0, 0, 0, -1 / 2, 1, -1 / 2, 0, 0, 0, -1 / 2, 1, -1 / 2, 0, 0, 0, -1 / 2, 1, -1 / 2, 0, 0, 0, -1 / 2, 1])
    });
    Zedity.core.imageFilters.add('paint', function(px, range) {
        range = range || 3;
        var d = px.data;
        var out = this._ctx.createImageData(px.width, px.height);
        var od = out.data;
        var rh = [],
            gh = [],
            bh = [];
        var rt = [],
            gt = [],
            bt = [];
        var levels = 256;
        for (var y = 0; y < px.height; ++y) {
            for (var x = 0; x < px.width; ++x) {
                var pixel = (y * px.width + x) * 4;
                for (var i = 0; i < levels; ++i) {
                    rh[i] = gh[i] = bh[i] = rt[i] = gt[i] = bt[i] = 0
                }
                for (var row = -range; row <= range; ++row) {
                    var iy = y + row;
                    if (0 <= iy && iy < px.height) {
                        var idy = iy * px.width;
                        for (var col = -range; col <= range; ++col) {
                            var ix = x + col;
                            if (0 <= ix && ix < px.width) {
                                var idx = (idy + ix) * 4;
                                var rix = d[idx];
                                var gix = d[idx + 1];
                                var bix = d[idx + 2];
                                rt[rix] += rix;
                                gt[gix] += gix;
                                bt[bix] += bix;
                                rh[rix]++;
                                gh[gix]++;
                                bh[bix]++
                            }
                        }
                    }
                }
                var r = 0,
                    g = 0,
                    b = 0;
                for (var i = 1; i < levels; i++) {
                    if (rh[i] > rh[r]) r = i;
                    if (gh[i] > gh[g]) g = i;
                    if (bh[i] > bh[b]) b = i
                }
                od[pixel] = rt[r] / rh[r];
                od[pixel + 1] = gt[g] / gh[g];
                od[pixel + 2] = bt[b] / bh[b];
                od[pixel + 3] = d[pixel + 3]
            }
        }
        return out
    }, [{
        name: Zedity.t('Brush size'),
        default: 3,
        min: 1,
        max: 5,
        step: 1
    }])
})(jQuery);
(function($) {
    if (!Zedity) throw new Error(Zedity.t('%s needs %s.', 'Zedity.Box.Text', 'Zedity'));
    if (!Zedity.Box) throw new Error(Zedity.t('%s needs %s.', 'Zedity.Box.Text', 'Zedity.Box'));
    Zedity.Box.Text = function(options) {
        this.type = 'Text';
        this._defaults = Zedity.Box.Text._defaults;
        Zedity.Box.prototype.constructor.call(this, options);
        this._options.defaultFont = this._options.defaultFont % this._options.fonts.length;
        this._options.defaultFontSize = this._options.defaultFontSize % this._options.fontSizes.length;
        this._data.textlength = 0;
        if (this.$this.find('.zedity-content').length == 0) {
            this.$this.append('<div class="zedity-content" style="width:100%;height:100%;color:black;line-height:' + this._options.lineHeights[this._options.defaultLineHeight] + '"/>' + '<div class="zedity-empty"><p>' + Zedity.t('Click %s to insert text.', '<span class="zedity-button"><span class="zicon zicon-text zicon-size-s"></span></span>') + '</p></div>');
            this.$this.find('.zedity-content').css({
                'font-size': this._options.fontSizes[this._options.defaultFontSize] + 'px',
                'font-family': this._options.fonts[this._options.defaultFont]
            })
        }
    };
    Zedity.Box.Text.prototype = Object.create(Zedity.Box.prototype);
    Zedity.Box.Text.prototype.constructor = Zedity.Box.Text;
    $.extend(Zedity.Box.Text.prototype, {
        createPropBar: function(options) {
            Zedity.Box.prototype.createPropBar.call(this);
            var self = this;
            var fonts = [];
            for (var i = 0, len = this._options.fonts.length; i < len; ++i) {
                fonts.push({
                    value: this._options.fonts[i],
                    label: this._options.fonts[i].split(',')[0],
                    attributes: {
                        'data-font': '12px ' + this._options.fonts[i]
                    }
                })
            }
            this.editor.menu.add({
                tabs: {
                    editbox: {
                        groups: {
                            textbox: {
                                title: Zedity.t('Text'),
                                order: -1000,
                                class: 'zedity-group-box',
                                features: {
                                    insert: {
                                        type: 'button',
                                        icon: 'text',
                                        label: Zedity.t('Insert'),
                                        title: Zedity.t('Insert/edit text'),
                                        onclick: function(e, ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return;
                                            box.insert()
                                        }
                                    },
                                    alignment: {
                                        type: 'menu',
                                        label: Zedity.t('Align'),
                                        title: Zedity.t('Text alignment'),
                                        icon: 'textalign-center',
                                        items: [{
                                            value: 'left',
                                            icon: 'textalign-left',
                                            label: Zedity.t('Left')
                                        }, {
                                            value: 'center',
                                            icon: 'textalign-center',
                                            label: Zedity.t('Center')
                                        }, {
                                            value: 'right',
                                            icon: 'textalign-right',
                                            label: Zedity.t('Right')
                                        }, {
                                            value: 'justify',
                                            icon: 'textalign-justify',
                                            label: Zedity.t('Justify')
                                        }, '--', {
                                            value: 'top',
                                            icon: 'align-top',
                                            label: Zedity.t('Top')
                                        }, {
                                            value: 'middle',
                                            icon: 'align-middle',
                                            label: Zedity.t('Middle')
                                        }, {
                                            value: 'bottom',
                                            icon: 'align-bottom',
                                            label: Zedity.t('Bottom')
                                        }],
                                        onclick: function(val, e, ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return;
                                            box.textAlign(val)
                                        },
                                        enable: function(ed, box) {
                                            return (box && box.$this.children('.zedity-empty').length == 0)
                                        }
                                    }
                                },
                                show: function(ed, box) {
                                    return box && box.type == 'Text'
                                }
                            }
                        }
                    },
                    textbox: {
                        icon: 'text',
                        title: Zedity.t('Text'),
                        order: 2000,
                        groups: {
                            edit: {
                                title: Zedity.t('Editing'),
                                order: 0,
                                class: 'zedity-group-box',
                                features: {
                                    done: {
                                        type: 'button',
                                        icon: 'ok',
                                        label: Zedity.t('Done'),
                                        title: Zedity.t('Done editing'),
                                        onclick: function(e, ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return;
                                            box.stop()
                                        }
                                    }
                                }
                            },
                            font: {
                                title: Zedity.t('Font'),
                                order: 100,
                                features: {
                                    font: {
                                        type: 'menu',
                                        title: 'Select font',
                                        width: 250,
                                        order: 0,
                                        items: fonts,
                                        onclick: function(val, e, ed) {
                                            Zedity.core.selection.restore();
                                            Zedity.core.selection.format({
                                                'font-family': val
                                            });
                                            Zedity.core.selection.save()
                                        },
                                        refresh: function(ed, box) {
                                            if (!box) return;
                                            var $elem = $(Zedity.core.selection.getElement());
                                            var font = $elem.css('font-family') || box._options.fonts[box._options.defaultFont];
                                            font = font.replace(/(,\s*)/g, ',').replace(/(\'|\")/g, '');
                                            this.$menu.val(font).selectmenu('refresh')
                                        }
                                    },
                                    buttons: {
                                        type: 'smallpanel',
                                        class: 'zedity-panel-font',
                                        order: 10,
                                        build: function($panel) {
                                            $panel.css('font-size', '18px').append('<span class="zedity-button zedity-btnB"><a href="javascript:;"><b>B</b></a></span>' + '<span class="zedity-button zedity-btnI"><a href="javascript:;"><i>I</i></a></span>' + '<span class="zedity-button zedity-btnU"><a href="javascript:;"><u>U</u></a></span>' + '<span class="zedity-button zedity-btnS" style="text-shadow:2px 2px 2px #000"><a href="javascript:;">S</a></span>');
                                            $panel.find('.zedity-btnB').attr('title', Zedity.t('Bold')).on('click.zedity-ribbon', function() {
                                                Zedity.core.selection.restore();
                                                Zedity.core.selection.command('bold');
                                                Zedity.core.selection.save()
                                            });
                                            $panel.find('.zedity-btnI').attr('title', Zedity.t('Italic')).on('click.zedity-ribbon', function() {
                                                Zedity.core.selection.restore();
                                                Zedity.core.selection.command('italic');
                                                Zedity.core.selection.save()
                                            });
                                            $panel.find('.zedity-btnU').attr('title', Zedity.t('Underline')).on('click.zedity-ribbon', function() {
                                                Zedity.core.selection.restore();
                                                Zedity.core.selection.command('underline');
                                                Zedity.core.selection.save()
                                            });
                                            $panel.find('.zedity-btnS').attr('title', Zedity.t('Shadow')).on('click.zedity-ribbon', function() {
                                                if (!Zedity.core.selection.selected()) return;
                                                Zedity.core.selection.restore();
                                                var styled = null;
                                                Zedity.core.selection.format({
                                                    'text-shadow': ''
                                                }, function(elem) {
                                                    var $elem = $(elem);
                                                    if (styled == null) {
                                                        var ts = $elem.css('text-shadow') || 'none';
                                                        styled = (ts != 'none' && ts.indexOf('px') > -1)
                                                    }
                                                    $elem.add($elem.find('span,' + Zedity.core.selection._elements)).css({
                                                        'text-shadow': (!styled ? '4px 4px 4px #666' : 'none')
                                                    })
                                                });
                                                Zedity.core.selection.save()
                                            })
                                        }
                                    },
                                    size: {
                                        type: 'menu',
                                        title: Zedity.t('Select font size'),
                                        width: 70,
                                        order: 20,
                                        items: this._options.fontSizes,
                                        onclick: function(val, e, ed) {
                                            Zedity.core.selection.restore();
                                            Zedity.core.selection.format({
                                                'font-size': val + 'px'
                                            });
                                            Zedity.core.selection.save()
                                        },
                                        refresh: function(ed, box) {
                                            if (!box || box.type != 'Text') return;
                                            var $elem = $(Zedity.core.selection.getElement());
                                            var size = parseInt($elem.css('font-size') || box._options.fontSizes[box._options.defaultFontSize], 10);
                                            this.$menu.val(size).selectmenu('refresh')
                                        }
                                    },
                                    color: {
                                        type: 'extpanel',
                                        size: 'xs',
                                        label: Zedity.t('Color'),
                                        icon: 'empty zicon-colorpicker',
                                        title: Zedity.t('Select font color'),
                                        class: 'zedity-font-colorpicker-button',
                                        order: 30,
                                        build: function($panel, ed) {
                                            this.$button.find('.zicon').width(30);
                                            $panel.append('<div class="zedity-font-colorpicker"/>');
                                            var $cp = $panel.find('.zedity-font-colorpicker');
                                            $cp.colorPicker({
                                                colors: ['#ffffff', '#f2f2f2', '#d8d8d8', '#bdbdbd', '#a4a4a4', '#6e6e6e', '#424242', '#2e2e2e', '#000000', '#fbefef', '#f8e0e0', '#f5a9a9', '#f78181', '#fe2e2e', '#df0101', '#b40404', '#8a0808', '#3b0b0b', '#fbf5ef', '#f8ece0', '#f5d0a9', '#faac58', '#ff8000', '#df7401', '#b45f04', '#8a4b08', '#3b240b', '#fbfbef', '#f5f6ce', '#f2f5a9', '#f4fa58', '#ffff00', '#d7df01', '#aeb404', '#868a08', '#393b0b', '#f5fbef', '#e3f6ce', '#d0f5a9', '#acfa58', '#80ff00', '#74df00', '#5fb404', '#4b8a08', '#38610b', '#effbef', '#cef6ce', '#a9f5a9', '#58fa58', '#00ff00', '#01df01', '#04b404', '#088a08', '#0b3b0b', '#effbfb', '#cef6f5', '#a9f5f2', '#58faf4', '#00ffff', '#01dfd7', '#04b4ae', '#088a85', '#0b3b39', '#eff5fb', '#cee3f6', '#81bef7', '#2e9afe', '#0080ff', '#045fb4', '#084b8a', '#08388a', '#0b243b', '#efeffb', '#cecef6', '#5858fa', '#2e2efe', '#0000ff', '#0404b4', '#08088a', '#0b0b61', '#0b0b3b', '#f5effb', '#e3cef6', '#be81f7', '#ac58fa', '#9a2efe', '#5f04b4', '#4b088a', '#380b61', '#240b3b', '#fbeffb', '#f6cef5', '#f781f3', '#fe2ef7', '#ff00ff', '#df01d7', '#b404ae', '#610b5e', '#3b0b39', '#fbeff5', '#f6cee3', '#f5a9d0', '#fa58ac', '#ff0080', '#df0174', '#b4045f', '#610b38', '#3b0b24'],
                                                defaultcolor: '#000000',
                                                fills: false,
                                                alpha: false,
                                                buttons: true,
                                                maxcols: 9,
                                                onchange: function(e, color) {
                                                    var box = ed.boxes.selected();
                                                    if (!box) return false;
                                                    Zedity.core.selection.restore();
                                                    Zedity.core.selection.format({
                                                        color: color
                                                    });
                                                    Zedity.core.selection.save();
                                                    self.editor.menu.$this.find('.zedity-font-colorpicker-button .zicon').css('background', color)
                                                }
                                            })
                                        },
                                        refresh: function(ed, box) {
                                            if (!box) return false;
                                            var $elem = $(Zedity.core.selection.getElement());
                                            var c = $elem.css('color') || '#000000';
                                            var $cp = this.$button.extpanel('instance').panel.find('.zedity-font-colorpicker');
                                            $cp.colorPicker('selectcolor', c);
                                            this.$button.find('.zicon').css('background', c);
                                            $cp.find('.zedity-colorbuttons').hide()
                                        }
                                    },
                                    size2: {
                                        type: 'smallpanel',
                                        order: 40,
                                        build: function($panel) {
                                            $panel.css('font-size', '18px').append('<span class="zedity-button zedity-font-increase" data-type="1"><a href="javascript:;">A+</a></span>' + '<span class="zedity-button zedity-font-decrease" data-type="-1"><a href="javascript:;">A-</a></span>');
                                            $panel.find('.zedity-font-increase').attr('title', Zedity.t('Increase font size'));
                                            $panel.find('.zedity-font-decrease').attr('title', Zedity.t('Decrease font size'));
                                            $panel.find('.zedity-button').on('click.zedity-ribbon', function() {
                                                var box = self.editor.boxes.selected();
                                                if (!box) return;
                                                var feat = self.editor.menu._feature('textbox', 'font', 'size');
                                                var idx = box._options.fontSizes.indexOf(feat.$menu.val());
                                                var inc = parseInt($(this).attr('data-type') || 1, 10);
                                                idx = (idx >= 0 ? idx : box._options.fontSizes.indexOf(box._options.defaultFontSize));
                                                if (((inc > 0) && (idx >= box._options.fontSizes.length - 1)) || ((inc < 0) && (idx <= 0))) return;
                                                var size = box._options.fontSizes[idx + inc];
                                                feat.$menu.val(size).selectmenu('refresh');
                                                feat.onclick.call(self.editor.menu, size, null, self.editor, feat)
                                            })
                                        }
                                    }
                                }
                            },
                            insert: {
                                title: Zedity.t('Insert'),
                                order: 300,
                                features: {
                                    link: {
                                        type: 'button',
                                        label: 'Link',
                                        icon: 'link',
                                        title: 'Insert link',
                                        onclick: function(e, ed) {
                                            Zedity.core.selection.save();
                                            Zedity.core.dialog({
                                                question: Zedity.t('Insert link url:'),
                                                default: 'http://',
                                                ok: function(url) {
                                                    if (url) {
                                                        Zedity.core.selection.restore();
                                                        Zedity.core.selection.command('createlink', url);
                                                        Zedity.core.selection.save()
                                                    }
                                                }
                                            })
                                        }
                                    }
                                }
                            }
                        },
                        show: function(ed, box) {
                            return box && box.type == 'Text' && box.$this.hasClass('zedity-editing')
                        }
                    }
                }
            }, 'textbox');
            return this
        },
        _checkScrollbar: function() {
            var $content = this.$this.find('.zedity-content');
            if (!$content) return;
            var oldy = $content[0].scrollTop;
            this.$this.addClass('zedity-calculate');
            this.$this.attr('style', (this.$this.attr('style') || '').replace(/display:.*?(;|$)/g, '').replace(/table-layout:.*?(;|$)/g, ''));
            $content.attr('style', ($content.attr('style') || '').replace(/display:.*?(;|$)/g, '').replace(/overflow:.*?(;|$)/g, ''));
            if ($content.height() < this.$this.height()) {
                this.$this.attr('style', this.$this.attr('style') + ';display:table;table-layout:fixed;');
                $content.attr('style', $content.attr('style') + ';display:table-cell;overflow:hidden;')
            } else {
                $content.attr('style', $content.attr('style') + ';overflow:auto;')
            }
            this.$this.removeClass('zedity-calculate');
            $content[0].scrollTop = oldy
        },
        _calcLength: function(onlythis) {
            if (onlythis) {
                this._data.textlength = this.$this.find('.zedity-content').html().length
            } else {
                var boxes = this.editor.boxes.get(this.type);
                var total = 0;
                for (var i = boxes.length - 1; i > 0; --i) {
                    var $content = boxes[i].$this.find('.zedity-content');
                    if ($content.length > 0) {
                        var len = $content.html().length;
                        total += len;
                        boxes[i]._data.textlength = len
                    }
                }
            }
            return true
        },
        _checkLength: function() {
            if (this._data.textlength > this._options.maxTextLength) return false;
            var boxes = this.editor.boxes.get(this.type);
            var total = 0;
            for (var i = boxes.length - 1; i > 0; --i) {
                total += boxes[i]._data.textlength
            }
            if (total > this._options.maxTotalTextLength) return false;
            return true
        },
        _refreshFontProperties: function() {
            clearTimeout(this._data.fontRefreshTimer);
            this._data.fontRefreshTimer = setTimeout($.proxy(function() {
                this.editor.menu.refresh('textbox', 'font');
                this.editor.menu.refresh('textbox', 'paragraph')
            }, this), 200);
            return this
        },
        _save: function(callback) {
            var css = (this.$this.find('.zedity-content').attr('style') || '');
            css = css.replace(/\s+/g, ' ').replace(/(;|,|:) /g, '$1').replace(/;{2,}/g, ';').replace(/(^;|;$)/, '');
            this.$this.find('.zedity-content').attr('style', css);
            Zedity.Box.prototype._save.call(this);
            if (typeof(callback) == 'function') callback.call(this);
            return this
        },
        select: function() {
            if (this.$this.hasClass('zedity-editing') || this.$this.hasClass('zedity-playing')) return this;
            Zedity.Box.prototype.select.call(this);
            if (this.$this.is(':data(ui-resizable)')) {
                this.$this.resizable('option', {
                    resize: $.proxy(function() {
                        this._checkScrollbar()
                    }, this)
                })
            }
            return this
        },
        start: function() {
            Zedity.Box.prototype.start.call(this);
            this.editor.boxes._select(null);
            this.editor.boxes._select(this);
            var $this = this.$this;
            var $content = this.$this.find('.zedity-content');
            this.revert = $this.html();
            if ($this.data('ui-draggable')) $this.draggable('option', 'disabled', true);
            if ($this.data('ui-resizable')) $this.resizable('option', 'disabled', true);
            if ($this.data('ui-rotatable')) $this.rotatable('option', 'disabled', true);
            $this.find('.zedity-empty').remove();
            $this.addClass('zedity-editing zedity-edited').removeClass('zedity-selected ui-state-disabled');
            $content.attr('contenteditable', 'true').focus();
            this._normalizeContent();
            Zedity.core.selection.setCursorPosition($content[0], 0);
            this._calcLength(true);
            this.reposition(true);
            $content.focus();
            var tabs = [];
            for (var i = this.editor.menu._tabs.length - 1; i >= 0; --i) {
                if (this.editor.menu._tabs[i].name != 'textbox') {
                    tabs.push(this.editor.menu._tabIdx(this.editor.menu._tabs[i].name))
                }
            }
            this.editor.menu.$this.tabs('option', 'disabled', tabs);
            this.editor.menu.openTab('textbox', true);
            return this
        },
        stop: function() {
            if (this._data.stopping || !this.$this.hasClass('zedity-editing')) return this;
            this._data.stopping = true;
            Zedity.Box.prototype.stop.call(this);
            var $this = this.$this;
            var $content = this.$this.find('.zedity-content');
            this._normalizeContent();
            if ($this.hasClass('zedity-editing')) {
                Zedity.core.selection.unselect();
                Zedity.core.selection._savedRange = null;
                $this.removeClass('zedity-editing');
                $content.removeAttr('contenteditable').blur();
                $content[0].normalize();
                if ($this.data('ui-draggable')) $this.draggable('option', 'disabled', false);
                if ($this.data('ui-resizable')) $this.resizable('option', 'disabled', false);
                if ($this.data('ui-rotatable')) $this.rotatable('option', 'disabled', false);
                this.select();
                this._checkScrollbar();
                this.editor._changed();
                this.editor.menu.$this.tabs('option', 'disabled', []);
                this.editor.menu.openTab('editbox')
            }
            this._calcLength();
            if (!this._checkLength()) {
                this.editor._error({
                    message: Zedity.t('Text length exceeds the maximum limit.')
                })
            }
            this._data.stopping = false;
            return this
        },
        insert: function() {
            Zedity.Box.prototype.insert.call(this);
            this.start();
            return this
        },
        _normalizeContent: function() {
            var $content = this.$this.find('.zedity-content');
            $content.contents().filter(function() {
                return ((this.nodeType == 3) && ($.trim(this.nodeValue) != '')) || ($(this).is('span,a,b,strong,i,em,u'))
            }).each($.proxy(function(idx, elem) {
                var $elem = $(elem);
                var $new = $('<p/>', {
                    html: elem.outerHTML || $elem.text(),
                    css: {
                        margin: 0,
                        color: 'black',
                        'font-size': this._options.fontSizes[this._options.defaultFontSize] + 'px',
                        'font-family': this._options.fonts[this._options.defaultFont]
                    }
                });
                $elem.replaceWith($new)
            }, this));
            $content.find('span').each(function(idx, elem) {
                var $elem = $(elem);
                if (elem.hasChildNodes() && elem.childNodes.length == 1 && elem.firstChild.tagName == 'SPAN') {
                    var child = elem.firstChild;
                    for (var j = elem.style.length - 1; j >= 0; --j) {
                        var prop = elem.style[j];
                        var cprop = child.style.getPropertyValue(prop);
                        if (cprop === '') child.style.setProperty(prop, elem.style.getPropertyValue(prop), '')
                    }
                    $elem.replaceWith(child)
                }
            });
            $content.find('a:empty').remove();
            $content.find('p,h1,h2,h3,h4,h5,h6').filter(':empty').append('<br/>');
            if ($.trim($content.text()) == '') {
                $content.html('<p style="margin:0;color:black">&nbsp;</p>');
                $content.find('p').css({
                    'font-size': this._options.fontSizes[this._options.defaultFontSize] + 'px',
                    'font-family': this._options.fonts[this._options.defaultFont]
                });
                Zedity.core.selection.setCursorPosition($content[0], 0);
                $content.focus()
            }
            return this
        },
        content: function(content) {
            if (content == null) {
                content = this.$this.find('.zedity-content').html()
            } else {
                this.$this.find('.zedity-content').html(content);
                this.$this.find('.zedity-empty').remove();
                this.$this.addClass('zedity-editing');
                this.stop();
                this.editor._changed()
            }
            return content
        },
        textAlign: function(type, alignment) {
            alignment = alignment || type;
            var $content = this.$this.find('.zedity-content');
            if (['left', 'center', 'right', 'justify'].indexOf(alignment) > -1) {
                $content.css('text-align', alignment);
                $content.find('*').css('text-align', '').removeAttr('align')
            }
            if (['top', 'middle', 'bottom'].indexOf(alignment) > -1) {
                $content.css('vertical-align', alignment)
            }
            var oldflip = this.flip();
            Zedity.core._call(this, 'flip', 'none');
            Zedity.core._call(this, 'flip', oldflip);
            this._checkScrollbar();
            this.editor._changed();
            return this
        },
        init: function() {
            Zedity.Box.prototype.init.call(this);
            var self = this;
            this.$this.off('click.zedity').on('click.zedity', function() {
                if (!self.$this.hasClass('zedity-editing')) {
                    Zedity.core.selection._savedRange = undefined
                }
            }).off('dblclick.zedity dbltap.zedity').on('dblclick.zedity dbltap.zedity', function() {
                if ($(this).hasClass('zedity-editing')) {
                    if (window.getSelection().toString().slice(-1) == ' ') {
                        window.getSelection().modify('extend', 'backward', 'character')
                    }
                    Zedity.core.selection.save()
                } else {
                    self.select().insert()
                }
            }).off('dblclick.zedity', 'a').on('dblclick.zedity', 'a', function() {
                if (!$(this).closest('.zedity-box-Text').hasClass('zedity-editing')) return;
                Zedity.core.selection.selectElement(this);
                Zedity.core.selection.save();
                $('.zedity-dialog-text-link').data('box', self).dialog('open');
                return false
            }).off('blur.zedity').on('blur.zedity', function() {
                if (Zedity.utils.opera()) Zedity.core.selection.save();
                Zedity.core.selection.restore()
            }).off('mousedown.zedity').on('mousedown.zedity', function(e) {
                if (e.button == 0) {
                    Zedity.core.selection.unselect()
                }
            }).off('mouseup.zedityed').on('mouseup.zedityed', function(e) {
                if (e.button == 0) {
                    Zedity.core.selection.save();
                    self._refreshFontProperties();
                    if (Zedity.core.selection.selected()) {
                        var $elem = $(Zedity.core.selection.getElement());
                        if ($elem.is('a')) {
                            Zedity.core.selection.expand();
                            Zedity.core.selection.save();
                            $('.zedity-dialog-text-link').data('box', self).dialog('open')
                        }
                    }
                }
            }).off('keydown.zedity').on('keydown.zedity', $.proxy(function(e) {
                if (e.keyCode == 13) {
                    this._checkScrollbar()
                } else if (e.keyCode == 32 || (e.keyCode >= 48 && e.keyCode <= 90)) {
                    this._data.textlength++
                } else if (e.keyCode == 8 || e.keyCode == 46) {
                    this._data.textlength--;
                    this._normalizeContent();
                    if ($.trim(this.$this.find('.zedity-content').text()) == '') {
                        return false
                    }
                }
                if (!this._checkLength()) {
                    this.editor._error({
                        message: Zedity.t('Text length exceeds the maximum limit.')
                    });
                    this._calcLength(true);
                    return false
                }
            }, this)).off('keyup.zedity').on('keyup.zedity', $.proxy(function(e) {
                if (e.keyCode == 13) {
                    var $el = $(Zedity.core.selection.getElement());
                    if ($el.closest('ol,ul').length) return;
                    $el = $(Zedity.core.selection.getParagraph());
                    var $prev = $el.prev();
                    if ($el.prop('tagName') != $prev.prop('tagName') || $el.attr('style') == null) {
                        $el.css({
                            margin: 0,
                            color: 'black',
                            'font-weight': '',
                            'font-style': '',
                            'font-size': this._options.fontSizes[this._options.defaultFontSize] + 'px',
                            'font-family': this._options.fonts[this._options.defaultFont]
                        });
                        var el = Zedity.core.selection.setParagraph('p');
                        $el = $(el);
                        if ($.trim($el.text()) == '') {
                            $el.html('&nbsp;');
                            Zedity.core.selection.selectText(el)
                        }
                    }
                }
                this._refreshFontProperties();
                Zedity.core.selection.save()
            }, this)).off('click.zedity', 'a').on('click.zedity', 'a', function(e) {
                return false
            });
            $('html,body').off('mouseup.zedity').on('mouseup.zedity', function() {
                var eb = self.editor.$this.find('.zedity-box.zedity-editing');
                var ae = $(document.activeElement).closest('.zedity-box');
                if (eb.length > 0 && eb.get(0) === ae.get(0)) {
                    Zedity.core.selection.save();
                    return false
                }
            });
            if (Zedity.core.supports.touch()) {
                document.onselectionchange = function() {
                    var e = Zedity.core.selection.getElement();
                    if (!e) return;
                    e = $(e).closest('.zedity-content[contenteditable]');
                    if (!e.length) return;
                    Zedity.core.selection.save();
                    self._refreshFontProperties();
                    if (Zedity.core.selection.selected()) {
                        var $elem = $(Zedity.core.selection.getElement());
                        if ($elem.is('a')) {
                            Zedity.core.selection.expand();
                            Zedity.core.selection.save();
                            $('.zedity-dialog-text-link').data('box', self).dialog('open')
                        }
                    }
                }
            }
            this.$this.off('paste.zedity').on('paste.zedity', $.proxy(function(e) {
                Zedity.core.selection.save();
                var $content = this.$this.find('.zedity-content');
                var old = $content.html();
                $content.blur();
                var $ta = $('<div contentEditable="true" style="width:1px;height:1px;position:absolute;overflow:hidden"></div>').appendTo('body');
                $ta.css({
                    top: document.body.scrollTop + 100,
                    left: document.body.scrollLeft + 10
                });
                $ta.focus();
                setTimeout($.proxy(function() {
                    function pasteText(plain) {
                        if (plain) {
                            var text = $ta.text();
                            $content.focus();
                            Zedity.core.selection.restore();
                            Zedity.core.selection.insertTextAtCursor(text)
                        } else {
                            var text = $ta.html();
                            $content.focus();
                            Zedity.core.selection.restore();
                            Zedity.core.selection.insertHtmlAtCursor(text)
                        }
                        $ta.remove();
                        this._calcLength(true);
                        if (!this._checkLength()) {
                            this.editor._error({
                                message: Zedity.t('Text length exceeds the maximum limit.')
                            });
                            $content.html(old);
                            old = null;
                            this._calcLength(true);
                            Zedity.core.selection.restore();
                            return false
                        }
                        this._normalizeContent();
                        this._checkScrollbar()
                    };
                    if (!this._options.forcePastePlainText && $ta.find('*').length > 0) {
                        var zthis = this;
                        $('<div style="padding:20px">' + '<span style="line-height:30px"><input type="radio" id="zedity-rbPasteText1" name="zedity-rbPasteText" value="1" checked="checked"><label for="zedity-rbPasteText1"> ' + Zedity.t('Plain text.') + '</label></span><br/>' + '<span><input type="radio" id="zedity-rbPasteText0" name="zedity-rbPasteText" value="0"><label for="zedity-rbPasteText0"> ' + Zedity.t('Formatted text.') + '</label></span>' + '</div>').dialog({
                            dialogClass: 'zedity-dialog',
                            title: Zedity.t('Paste text'),
                            modal: true,
                            buttons: [{
                                text: Zedity.t('OK'),
                                click: function() {
                                    var $this = $(this);
                                    pasteText.call(zthis, !!parseInt($this.find('input[name=zedity-rbPasteText]:checked').val()));
                                    $this.dialog('close').dialog('destroy').remove()
                                }
                            }]
                        })
                    } else {
                        pasteText.call(this, true)
                    }
                }, this), 200)
            }, this));
            return this
        }
    });
    Zedity.Box.Text.type = 'Text';
    Zedity.Box.Text.sizeLimits = {
        minWidth: 16,
        minHeight: 16,
        maxWidth: null,
        maxHeight: null
    };
    Zedity.Box.Text._defaults = {
        width: 200,
        height: 100,
        maxTextLength: 300000,
        maxTotalTextLength: 1000000,
        forcePastePlainText: false,
        fonts: ['Arial,Helvetica,sans-serif', 'Arial Black,Gadget,sans-serif', 'Arial Narrow,sans-serif', 'Century Gothic,sans-serif', 'Comic Sans MS,cursive', 'Copperplate Gothic Light,sans-serif', 'Courier New,Courier,monospace', 'Georgia,serif', 'Gill Sans,sans-serif', 'Helvetica,sans-serif', 'Impact,Charcoal,sans-serif', 'Lucida Console,Monaco,monospace', 'Lucida Sans Unicode,Lucida Grande,sans-serif', 'Palatino Linotype,Book Antiqua,Palatino,serif', 'Tahoma,Geneva,sans-serif', 'Times New Roman,Times,serif', 'Trebuchet MS,Helvetica,sans-serif', 'Verdana,Geneva,sans-serif'],
        defaultFont: 0,
        fontSizes: ['11', '12', '14', '16', '19', '21', '24', '27', '29', '32', '37', '48', '53', '64'],
        defaultFontSize: 2,
        lineHeights: [1, 1.1, 1.2, 1.3, 1.5, 1.7, 2, 2.5, 3, 4, 5],
        defaultLineHeight: 2
    };
    Zedity.Box.register({
        type: Zedity.Box.Text.type,
        requires: ['selection'],
        section: 'basic',
        order: 0
    })
})(jQuery);
(function() {
    Zedity.utils = Zedity.utils || {};
    Zedity.utils.opera = function() {
        return /opera/i.test(navigator.userAgent)
    }
})();
(function($) {
    var old = Zedity.Box.Text.prototype.createPropBar;
    Zedity.Box.Text.prototype.createPropBar = function(options) {
        old.call(this);
        var self = this;
        this.editor.menu.add({
            tabs: {
                textbox: {
                    icon: 'text',
                    title: Zedity.t('Text'),
                    order: 2000,
                    groups: {
                        paragraph: {
                            title: Zedity.t('Paragraph'),
                            order: 200,
                            features: {
                                paragraph: {
                                    type: 'menu',
                                    title: Zedity.t('Select paragraph'),
                                    width: 150,
                                    order: 0,
                                    items: [{
                                        value: 'p',
                                        label: Zedity.t('Paragraph') + ' (&lt;p&gt;)',
                                    }, {
                                        value: 'h1',
                                        label: Zedity.t('Heading') + ' (&lt;h1&gt;)',
                                    }, {
                                        value: 'h2',
                                        label: Zedity.t('Heading') + ' (&lt;h2&gt;)',
                                    }, {
                                        value: 'h3',
                                        label: Zedity.t('Heading') + ' (&lt;h3&gt;)',
                                    }, {
                                        value: 'h4',
                                        label: Zedity.t('Heading') + ' (&lt;h4&gt;)',
                                    }, {
                                        value: 'h5',
                                        label: Zedity.t('Heading') + ' (&lt;h5&gt;)',
                                    }, {
                                        value: 'h6',
                                        label: Zedity.t('Heading') + ' (&lt;h6&gt;)',
                                    }],
                                    onclick: function(val, e, ed) {
                                        var box = ed.boxes.selected();
                                        if (!box) return false;
                                        var def = {
                                            'font-size': '14px',
                                            'font-style': '',
                                            'font-weight': 'bold'
                                        };
                                        Zedity.core.selection.restore();
                                        var elem = Zedity.core.selection.setParagraph(val);
                                        if (elem) {
                                            switch (val) {
                                                case 'p':
                                                    $(elem).css($.extend({}, def, {
                                                        'font-weight': ''
                                                    }));
                                                    break;
                                                case 'h1':
                                                    $(elem).css($.extend({}, def, {
                                                        'font-size': '24px'
                                                    }));
                                                    break;
                                                case 'h2':
                                                    $(elem).css($.extend({}, def, {
                                                        'font-size': '20px'
                                                    }));
                                                    break;
                                                case 'h3':
                                                    $(elem).css($.extend({}, def, {
                                                        'font-size': '18px'
                                                    }));
                                                    break;
                                                case 'h4':
                                                    $(elem).css($.extend({}, def, {
                                                        'font-size': '16px'
                                                    }));
                                                    break;
                                                case 'h5':
                                                    $(elem).css(def);
                                                    break;
                                                case 'h6':
                                                    $(elem).css($.extend({}, def, {
                                                        'font-style': 'italic',
                                                        'font-weight': ''
                                                    }));
                                                    break
                                            }
                                            Zedity.core.selection.selectText(elem);
                                            Zedity.core.selection.save();
                                            box.$this.find('.zedity-content').focus()
                                        }
                                    },
                                    refresh: function(ed, box) {
                                        if (!box) return;
                                        var elem = Zedity.core.selection.getParagraph();
                                        if (elem) {
                                            var val = elem.nodeName.toLowerCase();
                                            if (this.$menu.find('option[value="' + val + '"]').length == 0) val = 'p';
                                            this.$menu.val(val)
                                        }
                                        this.$menu.selectmenu('refresh')
                                    }
                                },
                                alignment: {
                                    type: 'smallpanel',
                                    class: 'zedity-panel-align',
                                    order: 10,
                                    build: function($panel) {
                                        $panel.css('font-size', '18px').append('<span class="zedity-button zedity-btnAlignPar zedity-btnLeft" data-cmd="justifyLeft"><a href="javascript:;"><span class="zicon zicon-size-xs zicon-textalign-left"></span></a></span>' + '<span class="zedity-button zedity-btnAlignPar zedity-btnCenter" data-cmd="justifyCenter"><a href="javascript:;"><span class="zicon zicon-size-xs zicon-textalign-center"></span></a></span>' + '<span class="zedity-button zedity-btnAlignPar zedity-btnRight" data-cmd="justifyRight"><a href="javascript:;"><span class="zicon zicon-size-xs zicon-textalign-right"></span></a></span>' + '<span class="zedity-button zedity-btnAlignPar zedity-btnJust" data-cmd="justifyFull"><a href="javascript:;"><span class="zicon zicon-size-xs zicon-textalign-justify"></span></a></span>');
                                        $panel.find('.zedity-btnLeft').attr('title', Zedity.t('Align left'));
                                        $panel.find('.zedity-btnCenter').attr('title', Zedity.t('Align center'));
                                        $panel.find('.zedity-btnRight').attr('title', Zedity.t('Align right'));
                                        $panel.find('.zedity-btnJust').attr('title', Zedity.t('Justify'));
                                        $panel.find('.zedity-btnAlignPar').on('click.zedity-ribbon', function() {
                                            Zedity.core.selection.restore();
                                            var elem = Zedity.core.selection.getParagraphs();
                                            var cmd = $(this).attr('data-cmd');
                                            $(elem).css('text-align', '').removeAttr('align');
                                            Zedity.core.selection.restore();
                                            Zedity.core.selection.command(cmd);
                                            Zedity.core.selection.save()
                                        })
                                    },
                                    refresh: function(ed, box) {
                                        if (!box) return
                                    }
                                },
                                lineheight: {
                                    type: 'menu',
                                    title: Zedity.t('Select line height'),
                                    width: 70,
                                    order: 20,
                                    items: this._options.lineHeights,
                                    onclick: function(val, e, ed) {
                                        var box = ed.boxes.selected();
                                        if (!box) return;
                                        box.$this.find('.zedity-content').focus();
                                        Zedity.core.selection.restore();
                                        var elem = Zedity.core.selection.getParagraphs();
                                        $(elem).css('line-height', val);
                                        Zedity.core.selection.save()
                                    },
                                    refresh: function(ed, box) {
                                        if (!box) return;
                                        var elem = Zedity.core.selection.getParagraph();
                                        if (elem) {
                                            var lh = $(elem).css('line-height') || '1.2';
                                            if (lh.indexOf('px') > -1) {
                                                lh = Math.round(parseFloat(lh) / parseFloat($(elem).css('font-size') || 14) * 10) / 10
                                            } else {
                                                lh = parseFloat(lh)
                                            }
                                            if (this.$menu.find('option[value="' + lh + '"]').length == 0) lh = '1.2';
                                            this.$menu.val(lh)
                                        }
                                        this.$menu.selectmenu('refresh')
                                    }
                                },
                                lists: {
                                    type: 'smallpanel',
                                    class: 'zedity-panel-lists',
                                    order: 30,
                                    build: function($panel) {
                                        $panel.css('font-size', '18px').append('<span class="zedity-button zedity-btnOL" data-command="insertorderedlist" data-element="ol"><a href="javascript:;"><span class="zicon zicon-size-xs zicon-orderedlist"></span></a></span>' + '<span class="zedity-button zedity-btnUL" data-command="insertunorderedlist" data-element="ul"><a href="javascript:;"><span class="zicon zicon-size-xs zicon-unorderedlist"></span></a></span>');
                                        $panel.find('.zedity-btnOL').attr('title', Zedity.t('Ordered list'));
                                        $panel.find('.zedity-btnUL').attr('title', Zedity.t('Unordered list'));
                                        $panel.find('.zedity-button').on('click.zedity-ribbon', function() {
                                            var $this = $(this);
                                            Zedity.core.selection.restore();
                                            window.getSelection().collapseToEnd();
                                            Zedity.core.selection.command($this.attr('data-command'), false);
                                            var elem = Zedity.core.selection.getElement();
                                            $(elem).parentsUntil('.zedity-editor', $this.attr('data-element')).css('margin', '0');
                                            Zedity.core.selection.save();
                                            self.editor.boxes.selected().$this.find('.zedity-content').focus()
                                        })
                                    },
                                    refresh: function(ed, box) {
                                        if (!box) return
                                    }
                                },
                                paragraphspacing: {
                                    type: 'menu',
                                    title: Zedity.t('Select paragraph spacing'),
                                    width: 70,
                                    order: 40,
                                    items: ['0px', '2px', '5px', '10px', '15px', '20px', '25px', '30px', '40px', '50px'],
                                    onclick: function(val, e, ed) {
                                        var box = ed.boxes.selected();
                                        if (!box) return;
                                        box.$this.find('.zedity-content').focus();
                                        Zedity.core.selection.restore();
                                        var elem = Zedity.core.selection.getParagraphs();
                                        $(elem).css('margin-bottom', val);
                                        Zedity.core.selection.save()
                                    },
                                    refresh: function(ed, box) {
                                        if (!box) return;
                                        var elem = Zedity.core.selection.getParagraph();
                                        if (elem) this.$menu.val($(elem).css('margin-bottom') || '0px');
                                        this.$menu.selectmenu('refresh')
                                    }
                                },
                                indent: {
                                    type: 'smallpanel',
                                    class: 'zedity-panel-indent',
                                    order: 50,
                                    build: function($panel) {
                                        $panel.css('font-size', '18px').append('<span class="zedity-button zedity-btnIndent" data-command="indent" data-element="ol"><a href="javascript:;"><span class="zicon zicon-size-xs zicon-indent"></span></a></span>' + '<span class="zedity-button zedity-btnOutdent" data-command="outdent" data-element="ul"><a href="javascript:;"><span class="zicon zicon-size-xs zicon-outdent"></span></a></span>');
                                        $panel.find('.zedity-btnIndent').attr('title', Zedity.t('Indent'));
                                        $panel.find('.zedity-btnOutdent').attr('title', Zedity.t('Outdent'));
                                        $panel.find('.zedity-button').on('click.zedity-ribbon', function() {
                                            Zedity.core.selection.restore();
                                            window.getSelection().collapseToEnd();
                                            Zedity.core.selection.command($(this).attr('data-command'), false);
                                            var elem = Zedity.core.selection.getElement();
                                            $(elem).parentsUntil('.zedity-editor', 'blockquote').css('margin', '0 0 0 40px');
                                            Zedity.core.selection.save();
                                            self.editor.boxes.selected().$this.find('.zedity-content').focus()
                                        })
                                    }
                                }
                            }
                        }
                    }
                }
            },
            build: function(ed) {
                var $panel = this.editor.menu._feature('textbox', 'font', 'buttons').$panel;
                $panel.append('<span style="display:inline-block;width:20px"></span>' + '<span class="zedity-button zedity-btnSubSup zedity-btnSub" data-command="subscript"><a href="javascript:;"><span>X</span><sub style="font-size:0.7em">2</sub></a></span>' + '<span class="zedity-button zedity-btnSubSup zedity-btnSup" data-command="superscript"><a href="javascript:;"><span>X</span><sup style="vertical-align:top;font-size:0.7em;position:relative;top:-5px;line-height:inherit;">2</sup></a></span>');
                $panel.find('.zedity-btnSub').attr('title', Zedity.t('Subscript'));
                $panel.find('.zedity-btnSup').attr('title', Zedity.t('Superscript'));
                $panel.find('.zedity-btnSubSup').on('click.zedity-ribbon', function() {
                    Zedity.core.selection.restore();
                    Zedity.core.selection.command($(this).attr('data-command'));
                    Zedity.core.selection.save()
                });
                this.editor.menu._feature('textbox', 'insert', 'link').onclick = function(e, ed) {
                    var box = ed.boxes.selected();
                    if (!box) return;
                    Zedity.core.selection.save();
                    $('.zedity-dialog-text-link').data('box', box).dialog('open')
                };
                Zedity.core.patch(ed.menu._feature('textbox', 'font', 'color'), 'refresh', this._data.enableCpButtons)
            }
        }, 'textboxcomm');
        if ($('.zedity-dialog-text-link').length == 0) {
            var $dialog = $('<div class="zedity-dialog-text-link">' + Zedity.t('Insert link url:') + '<input id="zedity-txtTextLink" type="text" value=""><br/><br/>' + '<input id="zedity-rdTextLinkTarget-0" name="zedity-rdTextLinkTarget" type="radio" value="_self"/><label for="zedity-rdTextLinkTarget-0">' + Zedity.t('Open link in the same frame.') + '</label><br/>' + '<input id="zedity-rdTextLinkTarget-1" name="zedity-rdTextLinkTarget" type="radio" value="_top"/><label for="zedity-rdTextLinkTarget-1">' + Zedity.t('Open link in the same tab.') + '</label><br/>' + '<input id="zedity-rdTextLinkTarget-2" name="zedity-rdTextLinkTarget" type="radio" value="_blank" checked="checked"/><label for="zedity-rdTextLinkTarget-2">' + Zedity.t('Open link in a new tab.') + '</label><br/>' + '<div class="zedity-link-preview"><a href="javascript:;">' + Zedity.t('Link style preview') + '</a></div>' + '<div class="zedity-link-options">' + '<h4>' + Zedity.t('Link style') + '</h4>' + '<div class="zedity-link-style" style="max-height:180px;padding:5px">' + '<div class="zedity-fs1-wrapper"></div>' + '</div>' + '<h4>' + Zedity.t('Link style on mouse over') + '</h4>' + '<div class="zedity-link-stylemouseover" style="max-height:180px;padding:5px">' + '<div class="zedity-fs2-wrapper"></div>' + '</div>' + '</div>' + '</div>');
            var $fs1 = $dialog.find('.zedity-fs1-wrapper');
            var $fs2 = $dialog.find('.zedity-fs2-wrapper');
            this.editor.$container.append($dialog);
            $dialog.dialog({
                title: Zedity.t('Insert link'),
                dialogClass: 'zedity-dialog',
                autoOpen: false,
                modal: true,
                resizable: false,
                position: {
                    my: 'center',
                    at: 'center',
                    of: window.top
                },
                create: $.proxy(function() {
                    $dialog.find('.zedity-link-options').accordion({
                        active: false,
                        collapsible: true,
                        heightStyle: 'content'
                    });
                    $fs1.add($fs2).fontSelector({
                        order: 'font,size,style,color',
                        fonts: this._options.fonts,
                        sizes: this._options.fontSizes,
                        colorButtons: true,
                        onchange: function() {
                            if ($(this).is($fs1.find('.zedity-fontselector'))) {
                                $dialog.data('stylelink', true);
                                var style = $fs1.fontSelector('getfontstyle');
                                $dialog.find('.zedity-link-preview a').css({
                                    color: $fs1.fontSelector('getcolor'),
                                    'font-family': $fs1.fontSelector('getfont'),
                                    'font-size': $fs1.fontSelector('getfontsize') + 'px',
                                    'font-weight': (style.bold ? 'bold' : 'normal'),
                                    'font-style': (style.italic ? 'italic' : 'normal'),
                                    'text-decoration': (style.underline ? 'underline' : 'none')
                                })
                            } else {
                                $dialog.data('stylehover', true);
                                style = $fs2.fontSelector('getfontstyle');
                                $dialog.find('style').remove();
                                $dialog.prepend('<style scoped="scoped">.zedity-link-preview a:hover{' + 'color:' + $fs2.fontSelector('getcolor') + ' !important;' + 'font-family:' + $fs2.fontSelector('getfont') + ' !important;' + 'font-size:' + $fs2.fontSelector('getfontsize') + 'px !important;' + 'font-weight:' + (style.bold ? 'bold' : 'normal') + ' !important;' + 'font-style:' + (style.italic ? 'italic' : 'normal') + ' !important;' + 'text-decoration:' + (style.underline ? 'underline' : 'none') + ' !important;' + '}</style>')
                            }
                        }
                    });
                    $fs1.add($fs2).find('.zedity-fontsizeselector2').hide();
                    $fs1.add($fs2).find('.zedity-btnS').hide();
                    setTimeout($.proxy(function() {
                        $fs1.fontSelector('selectcolor', '#0000FF');
                        $fs1.fontSelector('selectfont', this._options.fonts[this._options.defaultFont]);
                        $fs1.fontSelector('selectfontsize', this._options.fontSizes[this._options.defaultFontSize]);
                        $fs1.fontSelector('selectfontstyle', {
                            bold: false,
                            italic: false,
                            underline: true
                        })
                    }, this), 100);
                    $fs2.fontSelector('selectcolor', '#FF0000');
                    $fs2.fontSelector('selectfont', this._options.fonts[this._options.defaultFont]);
                    $fs2.fontSelector('selectfontsize', this._options.fontSizes[this._options.defaultFontSize]);
                    $fs2.fontSelector('selectfontstyle', {
                        bold: false,
                        italic: false,
                        underline: true
                    });
                    setTimeout(function() {
                        $fs1.fontSelector('change');
                        $fs2.fontSelector('change')
                    }, 100)
                }, this),
                open: function() {
                    var box = $dialog.data('box');
                    if (!box) return false;
                    Zedity.core.selection.restore();
                    var $elem = $(Zedity.core.selection.findElements('a'));
                    if (!$elem.is('a')) $elem = $(Zedity.core.selection.getElement()).closest('a,.zedity-content');
                    var href = $elem.attr('href');
                    var id = $elem.attr('id');
                    if (href) Zedity.core.selection.expand(true);
                    Zedity.core.selection.save();
                    $('#zedity-txtTextLink').val(href || 'http://').select().focus();
                    $('input[name=zedity-rdTextLinkTarget][value=' + ($elem.attr('target') || '_top') + ']').prop('checked', true);
                    if (!$elem.is('a')) return false;
                    $dialog.data('stylelink', false);
                    setTimeout(function() {
                        $fs1.fontSelector('selectcolor', $elem.css('color') || '#0000FF');
                        $fs1.fontSelector('selectfont', $elem.css('font-family') || box._options.fonts[box._options.defaultFont]);
                        $fs1.fontSelector('selectfontsize', $elem.css('font-size') || box._options.fontSizes[box._options.defaultFontSize]);
                        $fs1.fontSelector('selectfontstyle', {
                            bold: $elem.css('font-weight') == 'bold' || parseInt($elem.css('font-weight') || '400') > 400,
                            italic: $elem.css('font-style') == 'italic',
                            underline: (!$elem.css('text-decoration') || $elem.css('text-decoration').indexOf('none') == -1)
                        })
                    }, 100);
                    var $stylel = $('#s' + id);
                    $dialog.data('stylehover', $stylel.length);
                    $fs2.fontSelector('selectcolor', $stylel.css('color') || '#FF0000');
                    $fs2.fontSelector('selectfont', $stylel.css('font-family') || box._options.fonts[box._options.defaultFont]);
                    $fs2.fontSelector('selectfontsize', $stylel.css('font-size') || box._options.fontSizes[box._options.defaultFontSize]);
                    $fs2.fontSelector('selectfontstyle', {
                        bold: $stylel.css('font-weight') == 'bold' || parseInt($elem.css('font-weight') || '400') > 400,
                        italic: $stylel.css('font-style') == 'italic',
                        underline: (!$stylel.css('text-decoration') || $stylel.css('text-decoration').indexOf('none') == -1)
                    });
                    setTimeout(function() {
                        $fs1.fontSelector('change');
                        $fs2.fontSelector('change')
                    }, 100)
                },
                close: function() {
                    $dialog.find('.zedity-link-options').accordion('option', 'active', false)
                },
                buttons: [{
                    text: Zedity.t('OK'),
                    class: 'zedity-button-ok',
                    click: function() {
                        var box = $dialog.data('box');
                        var url = $('#zedity-txtTextLink').val();
                        var target = $('input[name=zedity-rdTextLinkTarget]:checked').val();
                        $dialog.dialog('close');
                        Zedity.core.selection.restore();
                        if (box && url) {
                            var $elem = $(Zedity.core.selection.findElements('a')).eq(0);
                            if ($elem.length) box.$this.find('#s' + $elem.attr('id')).remove();
                            var style = $elem.attr('style');
                            $elem.removeAttr('style');
                            if ($elem.length) {
                                $elem.attr('href', url)
                            } else {
                                Zedity.core.selection.command('createlink', url);
                                $elem = $(Zedity.core.selection.findElements('a')).eq(0)
                            }
                            if ($dialog.data('stylelink')) {
                                style = $fs1.fontSelector('getfontstyle');
                                $elem.css({
                                    color: $fs1.fontSelector('getcolor'),
                                    'font-family': $fs1.fontSelector('getfont'),
                                    'font-size': $fs1.fontSelector('getfontsize') + 'px',
                                    'font-weight': (style.bold ? 'bold' : 'normal'),
                                    'font-style': (style.italic ? 'italic' : 'normal'),
                                    'text-decoration': (style.underline ? 'underline' : 'none')
                                })
                            } else {
                                $elem.attr('style', style)
                            }
                            if ($dialog.data('stylehover')) {
                                var id = Zedity.core.genId('zl');
                                $elem.attr({
                                    id: id,
                                    target: target
                                });
                                box.$this.find('#s' + id).remove();
                                style = $fs2.fontSelector('getfontstyle');
                                box.$this.prepend('<style id="s' + id + '" class="zedity-link-style" scoped="scoped">#s' + id + ',#' + id + ':hover{' + 'color:' + $fs2.fontSelector('getcolor') + ' !important;' + 'font-family:' + $fs2.fontSelector('getfont') + ' !important;' + 'font-size:' + $fs2.fontSelector('getfontsize') + 'px !important;' + 'font-weight:' + (style.bold ? 'bold' : 'normal') + ' !important;' + 'font-style:' + (style.italic ? 'italic' : 'normal') + ' !important;' + 'text-decoration:' + (style.underline ? 'underline' : 'none') + ' !important;' + '}</style>')
                            }
                            Zedity.core.selection.save()
                        }
                    }
                }, {
                    text: Zedity.t('Remove'),
                    class: 'zedity-button-remove',
                    click: function() {
                        var box = $dialog.data('box');
                        $dialog.dialog('close');
                        Zedity.core.selection.restore();
                        if (box) {
                            var $elem = $(Zedity.core.selection.findElements('a')).eq(0);
                            var id = $elem.attr('id');
                            if (id) box.$this.find('#s' + id).remove();
                            $elem.removeAttr('style');
                            Zedity.core.selection.command('unlink');
                            Zedity.core.selection.save()
                        }
                    }
                }, {
                    text: Zedity.t('Cancel'),
                    class: 'zedity-button-cancel',
                    click: function() {
                        $dialog.dialog('close');
                        Zedity.core.selection.restore()
                    }
                }]
            })
        }
    };
    Zedity.core.patch(Zedity.Box.Text.prototype, 'stop', {
        after: function() {
            this.$this.find('style[scoped]').each(function(idx, elem) {
                var $elem = $(elem);
                var id = ($elem.attr('id') || 'z').substring(1);
                if (id && !$('#' + id).length) {
                    $elem.remove()
                }
            })
        }
    });
    $(document).on('dialogopen', '.zedity-dialog-link', function(event, ui) {
        var $this = $(this);
        if ($this.find('.zedity-textbox-help').length == 0) {
            $this.append('<span style="clear:both"></span>' + '<span style="float:right"><span class="zedity-tooltip zedity-textbox-help" style="display:none">?</span></span>');
            $this.find('.zedity-textbox-help').attr('title', Zedity.t('The box link may override any link in the text.')).tooltip()
        }
        var obj = $this.data('obj');
        $this.find('.zedity-textbox-help').toggle(!!obj && obj.type == 'Text')
    })
})(jQuery);
(function($) {
    if (!Zedity) throw new Error(Zedity.t('%s needs %s.', 'Zedity.Box.Video', 'Zedity'));
    if (!Zedity.Box) throw new Error(Zedity.t('%s needs %s.', 'Zedity.Box.Video', 'Zedity.Box'));
    Zedity.Box.Video = function(options) {
        this.type = 'Video';
        this._defaults = Zedity.Box.Video._defaults;
        Zedity.Box.prototype.constructor.call(this, options);
        this._can.remove('background', 'rotation', 'flip', 'corners');
        if (this.$this.find('object,iframe,video').length == 0) {
            if (this.$this.find('.zedity-empty').length == 0) {
                this.$this.append('<div class="zedity-empty"><p>' + Zedity.t('Click %s to insert video.', '<span class="zedity-button"><span class="zicon zicon-video zicon-size-s"></span></span>') + '</p></div>')
            }
        } else if (this.$this.find('.zedity-boxoverlay').length == 0) {
            this.$this.append('<div class="zedity-boxoverlay"/>');
            var embed = Zedity.core.embed.parse(this.content(), 'video');
            this._data.content = this.getSrc(embed.iframe || embed.flash).join('\n')
        }
    };
    Zedity.Box.Video.prototype = Object.create(Zedity.Box.prototype);
    Zedity.Box.Video.prototype.constructor = Zedity.Box.Video;
    $.extend(Zedity.Box.Video.prototype, {
        createPropBar: function(options) {
            Zedity.Box.prototype.createPropBar.call(this);
            this.editor.menu.add({
                tabs: {
                    editbox: {
                        groups: {
                            videobox: {
                                title: Zedity.t('Video'),
                                order: -1000,
                                class: 'zedity-group-box',
                                features: {
                                    insert: {
                                        type: 'button',
                                        order: 0,
                                        icon: 'video',
                                        label: Zedity.t('Insert'),
                                        title: Zedity.t('Insert video'),
                                        onclick: function(e, ed) {
                                            var box = ed.boxes.selected();
                                            if (!box) return;
                                            box.insert()
                                        }
                                    },
                                    options: {
                                        type: 'extpanel',
                                        order: 10,
                                        icon: 'config',
                                        label: Zedity.t('Options'),
                                        title: Zedity.t('Video embed options'),
                                        enable: function(ed, box) {
                                            if (!box || box.type != 'Video') return false;
                                            var service = box.getService();
                                            return !!service && !$.isEmptyObject(service.options)
                                        },
                                        refresh: function(ed, box) {
                                            if (!box || box.type != 'Video') return;
                                            var service = box.getService();
                                            if (!service || $.isEmptyObject(service.options)) return;
                                            var options = box.videoOptions() || [];
                                            var html = '';
                                            for (var op in service.options) {
                                                if (!service.options.hasOwnProperty(op)) continue;
                                                html += '<label>' + '<input type="checkbox" value="' + op + '" ' + (options.indexOf(op) > -1 ? 'checked' : '') + '/>' + ' <span> ' + service.options[op].title + '</span>' + '</label><br/>'
                                            }
                                            this.$extpanel.html(html);
                                            var self = this;
                                            this.$extpanel.find('input').on('change', function() {
                                                var options = self.$extpanel.find('input:checked').map(function() {
                                                    return this.value
                                                }).get();
                                                box.videoOptions(options)
                                            })
                                        }
                                    },
                                    play: {
                                        type: 'toggle',
                                        order: 20,
                                        state: [{
                                            label: Zedity.t('Play'),
                                            icon: 'play',
                                            title: Zedity.t('Play video')
                                        }, {
                                            label: Zedity.t('Pause'),
                                            icon: 'pause',
                                            title: Zedity.t('Pause video')
                                        }],
                                        onclick: function(e, ed, before) {
                                            var box = ed.boxes.selected();
                                            if (!box) return false;
                                            switch (before) {
                                                case 0:
                                                    box.start();
                                                    break;
                                                case 1:
                                                    box.stop();
                                                    break
                                            }
                                        },
                                        enable: function(ed, box) {
                                            if (!box || box.type != 'Video') return false;
                                            var service = box.getService();
                                            return service && service.canplay
                                        },
                                        show: function(ed, box) {
                                            if (!box || box.type != 'Video') return false;
                                            var service = box.getService();
                                            return !service || (service && service.canplay)
                                        },
                                        refresh: function(ed, box) {
                                            if (!box) return;
                                            this.$button.trigger('toggle', box.$this.hasClass('zedity-playing') ? 1 : 0)
                                        }
                                    },
                                    view: {
                                        type: 'toggle',
                                        order: 20,
                                        state: [{
                                            label: Zedity.t('Show'),
                                            icon: 'view',
                                            title: Zedity.t('Show video')
                                        }, {
                                            label: Zedity.t('Close'),
                                            icon: 'view',
                                            title: Zedity.t('Close video')
                                        }],
                                        onclick: function(e, ed, before) {
                                            var box = ed.boxes.selected();
                                            if (!box) return false;
                                            switch (before) {
                                                case 0:
                                                    box.start();
                                                    break;
                                                case 1:
                                                    box.stop();
                                                    break
                                            }
                                        },
                                        show: function(ed, box) {
                                            if (!box || box.type != 'Video') return false;
                                            var service = box.getService();
                                            return !!service && !service.canplay
                                        },
                                        refresh: function(ed, box) {
                                            if (!box) return;
                                            this.$button.trigger('toggle', box.$this.hasClass('zedity-playing') ? 1 : 0)
                                        }
                                    }
                                },
                                show: function(ed, box) {
                                    return box && box.type == 'Video'
                                }
                            }
                        }
                    }
                }
            }, 'videobox');
            return this
        },
        _sizeLimits: function() {
            var sl = Zedity.Box.prototype._sizeLimits.call(this);
            var service = this.getService();
            if (!service) return sl;
            return {
                minWidth: service.sizeLimits.minWidth || sl.minWidth,
                maxWidth: service.sizeLimits.maxWidth || sl.maxWidth,
                minHeight: service.sizeLimits.minHeight || sl.minHeight,
                maxHeight: service.sizeLimits.maxHeight || sl.maxHeight
            }
        },
        _save: function(callback) {
            Zedity.Box.prototype._save.call(this);
            this.$this.find('.zedity-boxoverlay').remove();
            if (typeof(callback) == 'function') callback.call(this);
            return this
        },
        content: function(content) {
            function checkFiles(content) {
                var filetypes = Object.keys(this._options.filetypes);
                for (var i = filetypes.length - 1; i >= 0; --i) {
                    var rx = new RegExp('\\.' + filetypes[i] + '(?:$|\\?)', 'gm');
                    if (rx.test(content)) return true
                }
                return false
            };
            if (content != null) {
                if (typeof content == 'string' || content instanceof String) {
                    var embed = Zedity.core.embed.parse(content, 'video');
                    if (!embed.code) {
                        if (checkFiles.call(this, content)) {
                            return Zedity.core._call(this, 'content', content.split('\n'))
                        } else {
                            this.editor._error({
                                message: Zedity.t('Please provide a valid link/embed code for any of the supported video services.')
                            });
                            return this.content()
                        }
                    } else if (embed.html5) {
                        return Zedity.core._call(this, 'content', embed.html5)
                    } else {
                        content = (embed.iframe || embed.flash) + '<div class="zedity-boxoverlay"/>';
                        this.$this.attr('data-service', embed.service)
                    }
                } else if ($.isArray(content)) {
                    var thumbnail = '';
                    for (var i = 0, len = content.length; i < len; ++i) {
                        if (['jpeg', 'jpg', 'jpe', 'png'].indexOf(content[i].split('.').pop()) > -1) {
                            thumbnail = ' poster="' + content[i] + '"';
                            break
                        }
                    }
                    var html = '<video controls="controls" style="width:100%;height:100%" preload="none"' + thumbnail + '>';
                    for (var i = 0, len = content.length; i < len; ++i) {
                        var ext = content[i].split('.').pop();
                        if (this._options.filetypes[ext]) {
                            html += '<source src="' + content[i] + '" type="' + this._options.filetypes[ext] + '"/>'
                        }
                    }
                    html += '<p>Your browser does not support HTML5 videos.</p></video><div class="zedity-boxoverlay"/>';
                    content = html;
                    this.$this.attr('data-service', 'html5')
                } else {
                    this.editor._error({
                        message: Zedity.t('Could not interpret the content as video.')
                    })
                }
                this.videoOptions(this._data.videoOptions)
            }
            content = Zedity.Box.prototype.content.call(this, content);
            this._data.content = content = this.getSrc(content).join('\n');
            this._resize();
            this.editor.boxes.refreshSelected();
            return content
        },
        getSrc: function(content) {
            content = content || this.content();
            var src = [];
            $('<div/>').html(content).find('object,iframe,video,video source').each(function() {
                var ts = $(this).attr('src') || $(this).attr('data') || $(this).attr('poster');
                if (ts) src.push(ts)
            });
            return src
        },
        videoOptions: function(options) {
            var service = this.getService();
            if ($.isArray(options)) {
                var params = '';
                for (var i = options.length - 1; i >= 0; --i) {
                    params += '&' + service.options[options[i]].urlparam
                }
                var self = this;
                this.$this.find('object,iframe,video,video source').each(function() {
                    var $this = $(this);
                    if ($this.attr('src')) $this.attr('src', self._data.content + params);
                    if ($this.attr('data')) $this.attr('data', self._data.content + params)
                })
            } else {
                options = [];
                var content;
                this.$this.find('object,iframe,video,video source').each(function() {
                    content = $(this).attr('src') || $(this).attr('data');
                    return false
                });
                if (content) {
                    for (var op in service.options) {
                        if (!service.options.hasOwnProperty(op)) continue;
                        if (content.indexOf(service.options[op].urlparam) >= 1) options.push(op)
                    }
                }
            }
            this._data.videoOptions = options;
            return options
        },
        select: function() {
            if (this.$this.hasClass('zedity-editing') || this.$this.hasClass('zedity-playing')) return this;
            Zedity.Box.prototype.select.call(this);
            return this
        },
        rotation: function(setting) {
            if (setting != null) {
                this.editor._error({
                    message: Zedity.t('%s can\'t be rotated.', 'Video box')
                })
            }
            return 0
        },
        background: function(setting) {
            if (setting != null) {
                this.editor._error({
                    message: Zedity.t('%s doesn\'t support background property.', 'Video box')
                })
            }
            return {
                type: 'solid',
                alpha: 1,
                colors: ['transparent']
            }
        },
        corners: function(setting) {
            if (setting != null) {
                this.editor._error({
                    message: Zedity.t('%s doesn\'t support rounded corners.', 'Video box')
                })
            }
            return {
                'border-top-left-radius': 0,
                'border-top-right-radius': 0,
                'border-bottom-left-radius': 0,
                'border-bottom-right-radius': 0
            }
        },
        flip: function(setting) {
            if (setting != null) {
                this.editor._error({
                    message: Zedity.t('%s doesn\'t support flipping.', 'Video box')
                })
            }
            return 'none'
        },
        start: function() {
            Zedity.Box.prototype.start.call(this);
            var $obj = this.$this.find('object,iframe,video');
            if ($obj.lenght == 0) return this;
            var service = this.getService();
            if (!service) return this;
            if (this.$this.data('ui-draggable')) this.$this.draggable('option', 'disabled', true);
            if (this.$this.data('ui-resizable')) this.$this.resizable('option', 'disabled', true);
            this.$this.removeClass('ui-state-disabled');
            Zedity.core.embed.player($obj, service.service, 'play');
            this.$this.addClass('zedity-playing').find('.zedity-boxoverlay').hide();
            return this
        },
        stop: function() {
            Zedity.Box.prototype.stop.call(this);
            var $obj = this.$this.find('object,iframe,video');
            if ($obj.lenght == 0) return this;
            var service = this.getService();
            if (!service) return this;
            if (this.$this.data('ui-draggable')) this.$this.draggable('option', 'disabled', false);
            if (this.$this.data('ui-resizable')) this.$this.resizable('option', 'disabled', false);
            if (this.$this.hasClass('zedity-playing')) {
                Zedity.core.embed.player($obj, service.service, 'pause')
            }
            this.$this.removeClass('zedity-playing').find('.zedity-boxoverlay').show();
            return this
        },
        insert: function() {
            Zedity.Box.prototype.insert.call(this);
            $('.zedity-dialog-video').data('box', this).dialog('open');
            return this
        },
        getService: function() {
            var service = this.$this.attr('data-service') || this.$this.find('object,iframe,video').attr('data-service');
            var data;
            if (service == 'html5') {
                data = {
                    service: 'html5',
                    type: 'video',
                    canplay: true,
                    sizeLimits: {
                        minWidth: 230,
                        maxWidth: null,
                        minHeight: 100,
                        maxHeight: null
                    }
                }
            } else {
                data = Zedity.core.embed.services[service];
                if (data) data.canplay = !!(data.player.flash.play || data.player.iframe.play)
            }
            return data
        },
        duplicate: function() {
            var newbox = Zedity.Box.prototype.duplicate.call(this);
            var $obj = newbox.$this.find('object,iframe,video');
            var service = newbox.getService();
            if (service) {
                $obj.attr('id', Zedity.core.genId(service.service))
            }
            return newbox
        },
        init: function() {
            Zedity.Box.prototype.init.call(this);
            if ($('.zedity-dialog-video').length == 0) {
                var $dialog = $('<div class="zedity-dialog-video">' + '<div class="tabs">' + '<ul>' + '<li><a href="#tab-video-embed">' + Zedity.t('Embed') + '</a></li>' + '<li><a href="#tab-video-files">' + Zedity.t('Files') + '</a></li>' + '</ul>' + '<div id="tab-video-embed">' + Zedity.t('Insert video embed code or url:') + '<br/>' + '<textarea id="zedity-txtVideoEmbed" rows="4"></textarea>' + '<p>' + Zedity.t('Supported services:') + '<br/><span id="zedity-lblVideoServices"></span></p>' + '</div>' + '<div id="tab-video-files">' + Zedity.t('Select video from the list of available videos:') + '<br/>' + '<div id="zedity-ddVideoFiles" class="zedity-button zedity-ddmenu zedity-menu" data-ddmenu="#zedity-videosel-menu" style="width:260px"><span><a href="javascript:;">--</a></span></div>' + '<ul id="zedity-videosel-menu" class="zedity-propbar-menu"></ul>' + '<img id="zedity-video-preview" src=""/>' + '</div>' + '</div>' + '</div>');
                $dialog.find('.tabs').tabs({
                    activate: function(event, ui) {
                        $(this).find('.ui-tabs-panel:visible').find('input[type=text],textarea,select').filter(':visible').filter(':first').focus()
                    }
                });
                this.editor.$container.append($dialog);
                $dialog.dialog({
                    title: Zedity.t('Insert video'),
                    dialogClass: 'zedity-dialog',
                    autoOpen: false,
                    modal: true,
                    resizable: false,
                    position: {
                        my: 'center',
                        at: 'center',
                        of: window.top
                    },
                    open: function() {
                        var $this = $(this);
                        var $tabs = $this.find('.tabs');
                        var box = $this.data('box');
                        var disabled = [];
                        $('#zedity-video-preview').attr('src', '').hide();
                        $('#zedity-ddVideoFiles a').html('--');
                        if ($('#zedity-videosel-menu').data('ui-menu')) $('#zedity-videosel-menu').menu('destroy').html('');
                        if (box._options.files) {
                            var files = '<li data-value="-1"><a href="javascript:;">--</a></li>';
                            for (var i = 0, len = box._options.files.length; i < len; ++i) {
                                var tn = box._options.files[i].thumbnail ? '<img class="zedity-pic-preview" src="' + box._options.files[i].thumbnail + '"/>' : '';
                                files += '<li data-value="' + i + '"><a href="javascript:;">' + tn + box._options.files[i].title + '</a></li>'
                            }
                            $('#zedity-videosel-menu').html(files);
                            $('#zedity-ddVideoFiles').ddmenu({
                                onchange: function() {
                                    $('#zedity-video-preview').attr('src', '').hide();
                                    var val = $(this).ddmenu('value');
                                    if (val == -1) return;
                                    if (box._options.files[val].thumbnail) {
                                        $('#zedity-video-preview').attr('src', box._options.files[val].thumbnail).show()
                                    }
                                }
                            })
                        } else {
                            disabled.push($tabs.tabs('getidx', 'tab-video-files'))
                        }
                        var services = Zedity.core.embed.getServices('video', true);
                        $('#zedity-lblVideoServices').html(services.join(', '));
                        $this.find('input[type=text],textarea').val('');
                        $tabs.tabs('option', {
                            active: 0,
                            disabled: disabled
                        });
                        $('#zedity-txtVideoEmbed').val(box.content()).focus()
                    },
                    close: function() {
                        $(this).data('box', null)
                    },
                    buttons: [{
                        text: Zedity.t('OK'),
                        class: 'zedity-button-ok',
                        click: function() {
                            var box = $(this).data('box');
                            $(this).dialog('close');
                            if (!box) return;
                            var content = '';
                            switch ($(this).find('.tabs').tabs('selected')) {
                                case 'tab-video-embed':
                                    content = $('#zedity-txtVideoEmbed').val();
                                    var embed = Zedity.core.embed.parse(content, 'video');
                                    if (!embed.code) {
                                        box.editor._error({
                                            message: Zedity.t('Please provide a valid link/embed code for any of the supported video services.')
                                        });
                                        return
                                    }
                                    break;
                                case 'tab-video-files':
                                    var val = parseInt($('#zedity-ddVideoFiles').ddmenu('value'));
                                    if (val > -1) {
                                        content = box._options.files[val].src;
                                        if (box._options.files[val].thumbnail) {
                                            content.unshift(box._options.files[val].thumbnail)
                                        }
                                    }
                                    break
                            }
                            box.content(content)
                        }
                    }, {
                        text: Zedity.t('Cancel'),
                        class: 'zedity-button-cancel',
                        click: function() {
                            $(this).dialog('close')
                        }
                    }]
                })
            }
            return this
        }
    });
    Zedity.Box.Video.type = 'Video';
    Zedity.Box.Video.sizeLimits = {
        minWidth: 220,
        minHeight: 200,
        maxWidth: null,
        maxHeight: null
    };
    Zedity.Box.Video._defaults = {
        width: 300,
        height: 200,
        filetypes: {
            mp4: 'video/mp4',
            mov: 'video/mp4',
            ogg: 'video/ogg',
            ogv: 'video/ogg',
            webm: 'video/webm'
        }
    };
    Zedity.Box.register({
        type: Zedity.Box.Video.type,
        section: 'media-embed',
        order: 0
    });
    Zedity.core.embed.add('youtube', {
        url: 'http://www.youtube.com',
        type: 'video',
        regex: [new RegExp('youtube\\.com/watch\\?.*v=(.+?)(&|"|\'|$)'), new RegExp('youtu\\.be/(.+?)(\\?|&|$)'), new RegExp('youtube(?:-nocookie|)\\.com/(?:v|embed)/(.+?)(\\?|&|"|\'|$)')],
        parser: function(code) {
            return {
                code: code[1],
                flash: '//www.youtube.com/v/' + code[1] + '?rel=0&amp;showsearch=0&amp;showinfo=0&amp;enablejsapi=1',
                iframe: '//www.youtube.com/embed/' + code[1] + '?wmode=opaque&amp;rel=0&amp;modestbranding=1&amp;showinfo=0&amp;enablejsapi=1'
            }
        },
        player: {
            flash: {
                play: 'playVideo',
                pause: 'pauseVideo'
            },
            iframe: {
                play: 'playVideo',
                pause: 'pauseVideo',
                command: function(frame_id, func, args) {
                    $('#' + frame_id)[0].contentWindow.postMessage(JSON.stringify({
                        event: 'command',
                        func: func,
                        args: args || [],
                        id: frame_id
                    }), '*')
                }
            }
        }
    });
    Zedity.core.embed.add('vimeo', {
        url: 'http://vimeo.com',
        type: 'video',
        regex: [new RegExp('vimeo\\.com/.*?clip_id=(.*?)("|\'|&|$)'), new RegExp('vimeo\\.com/.*?([^/]+?)("|\'|\\?|&|$)')],
        parser: function(code) {
            return {
                code: code[1],
                flash: '//vimeo.com/moogaloop.swf?clip_id=' + code[1] + '&amp;server=vimeo.com&amp;show_title=0&amp;show_byline=0&amp;show_portrait=0&amp;color=00adef&amp;fullscreen=0&amp;loop=0&amp;api=1',
                iframe: '//player.vimeo.com/video/' + code[1] + '?title=0&amp;byline=0&amp;portrait=0&amp;api=1'
            }
        },
        player: {
            flash: {
                play: 'api_play',
                pause: 'api_pause'
            },
            iframe: {
                play: 'play',
                pause: 'pause',
                command: function(frame_id, func, value) {
                    $('#' + frame_id)[0].contentWindow.postMessage(JSON.stringify({
                        method: func,
                        value: value
                    }), '*')
                }
            }
        }
    })
})(jQuery);
(function($) {
    var old = Zedity.Box.Video.prototype.createPropBar;
    Zedity.Box.Video.prototype.createPropBar = function(options) {
        old.call(this)
    };
    var old_init = Zedity.Box.Video.prototype.init;
    Zedity.Box.Video.prototype.init = function(options) {
        old_init.apply(this, arguments);
        var $dialog = $('.zedity-dialog-video');
        $dialog.parent().find('.zedity-button-ok').off('click').on('click', $.proxy(function() {
            var box = $(this).data('box');
            $(this).dialog('close');
            if (!box) return;
            var content = '';
            switch ($(this).find('.tabs').tabs('selected')) {
                case 'tab-video-embed':
                    content = $('#zedity-txtVideoEmbed').val();
                    break;
                case 'tab-video-files':
                    var val = parseInt($('#zedity-ddVideoFiles').ddmenu('value'));
                    if (val > -1) {
                        content = box._options.files[val].src;
                        if (box._options.files[val].thumbnail) {
                            content.unshift(box._options.files[val].thumbnail)
                        }
                    }
                    break
            }
            box.content(content)
        }, $dialog[0]))
    };
    if (Zedity.core.embed.services.youtube) {
        Zedity.core.embed.services.youtube.regex = [new RegExp('youtube\\.com/watch\\?.*v=(.+?)(?:[&"\'\\s]|$)[^"\'\\s]*'), new RegExp('youtu\\.be/(.+?)(?:[?&"\'\\s]|$)[^"\'\\s]*'), new RegExp('youtube(?:-nocookie|)\\.com/(?:v|embed)/(.+?)(?:[?&"\'\\s]|$)[^"\'\\s]*')];
        Zedity.core.embed.services.youtube.parser = function(code) {
            var listcode = decodeURIComponent((new RegExp('[?|&]list=([^&;]+?)(&|#|;|$)').exec(code[0]) || [, ""])[1].replace(/\+/g, '%20')) || '';
            if (listcode) listcode = '&list=' + listcode;
            return {
                code: code[1],
                flash: '//www.youtube.com/v/' + code[1] + '?rel=0&amp;loop=0&amp;autoplay=0&amp;showsearch=0&amp;showinfo=0&amp;enablejsapi=1' + (listcode ? listcode : ''),
                iframe: '//www.youtube.com/embed/' + code[1] + '?wmode=opaque&amp;rel=0&amp;modestbranding=1&amp;showinfo=0&amp;enablejsapi=1' + (listcode ? listcode : '')
            }
        };
        Zedity.core.embed.services.youtube.options = {
            autoplay: {
                title: Zedity.t('Autoplay'),
                urlparam: 'autoplay=1'
            }
        }
    }
    if (Zedity.core.embed.services.vimeo) {
        Zedity.core.embed.services.vimeo.options = {
            autoplay: {
                title: Zedity.t('Autoplay'),
                urlparam: 'autoplay=1'
            }
        }
    }
    Zedity.core.embed.add('facebook', {
        url: 'https://facebook.com/',
        type: 'video',
        regex: [new RegExp('facebook\\.com/(?:.*?)/videos/(.*?)(&|/|\\?|"|\'|$)'), new RegExp('facebook\\.com/(?:photo|video)\\.php\\?v=(.*?)(&|/|\\?|"|\'|$)'), new RegExp('facebook\\.com/video/embed\\?video_id=(.*?)(&|/|\\?|"|\'|$)'), new RegExp('facebook\\.com/v.*?/plugins/video\\.php\\?.*?href=.*?%3Fv%3D(.*?)(%|&|/|\\?|"|\'|$)'), new RegExp('facebook\\.com/(?:v.*?/)*plugins/video\\.php\\?.*?href=.*videos%2F(.*?)(%|&|/|\\?|"|\'|$)')],
        parser: function(code) {
            return {
                code: code[1],
                iframe: '//www.facebook.com/plugins/video.php?href=' + encodeURIComponent('https://www.facebook.com/facebook/videos/' + code[1])
            }
        }
    });
    Zedity.core.embed.add('instagram', {
        url: 'http://instagram.com/',
        type: 'video',
        regex: [new RegExp('instagram\\.com/p/(.*?)(/|\\?|"|\'|$)')],
        parser: function(code, embed) {
            return {
                code: code[1],
                iframe: '//www.instagram.com/p/' + code[1] + '/embed/'
            }
        },
        sizeLimits: {
            minWidth: 240
        }
    });
    Zedity.core.embed.add('dailymotion', {
        url: 'http://www.dailymotion.com',
        type: 'video',
        regex: [new RegExp('dailymotion\\..*?/(?:video|swf/video|swf)/(.+?)(_|\\?|&|"|\'|$)')],
        parser: function(code) {
            return {
                code: code[1],
                flash: '//www.dailymotion.com/swf/' + code[1] + '?enableApi=1',
                iframe: '//www.dailymotion.com/embed/video/' + code[1] + '&amp;api=postMessage&amp;logo=0&amp;related=0'
            }
        }
    });
    Zedity.core.embed.add('metacafe', {
        url: 'http://www.metacafe.com',
        type: 'video',
        regex: [new RegExp('metacafe\\.com/(?:watch|embed|fplayer|w)/(.*?)(/|$)')],
        parser: function(code) {
            return {
                code: code[1],
                flash: '//www.metacafe.com/fplayer/' + code[1] + '/.swf',
                iframe: '//www.metacafe.com/embed/' + code[1] + '/'
            }
        }
    });
    Zedity.core.embed.add('ustream', {
        url: 'http://www.ustream.tv',
        type: 'video',
        regex: [new RegExp('ustream\\.tv/(?:embed|channel)/(.*?)(\\?|$)')],
        parser: function(code) {
            return {
                code: code[1],
                iframe: '//www.ustream.tv/embed/' + code[1] + '?v=3&amp;wmode=opaque'
            }
        },
        player: {
            iframe: {
                play: 'play',
                pause: 'pause',
                command: function(frame_id, func, value) {
                    $('#' + frame_id)[0].contentWindow.postMessage(JSON.stringify({
                        cmd: func,
                        args: value
                    }), '*')
                }
            }
        }
    });
    Zedity.core.embed.add('myspace_video', {
        url: 'https://myspace.com/discover/videos',
        type: 'video',
        regex: [new RegExp('myspace\\.com/.*?/video/(.*?)($|"|\')')],
        parser: function(code) {
            code[1] = code[1].replace('/', '');
            return {
                code: code[1],
                iframe: '//myspace.com/play/video/' + code[1]
            }
        }
    });
    Zedity.core.embed.add('veoh', {
        url: 'http://www.veoh.com',
        type: 'video',
        regex: [new RegExp('veoh\\.com/.*?(?:watch/|permalinkId=)(.*?)(&|$|"|\'|\\?)')],
        parser: function(code) {
            return {
                code: code[1],
                flash: '//www.veoh.com/swf/webplayer/WebPlayer.swf?version=AFrontend.5.7.0.1404&amp;permalinkId=' + code[1] + '&amp;player=videodetailsembedded&amp;videoAutoPlay=0&amp;id=anonymous'
            }
        }
    });
    Zedity.core.embed.add('metatube', {
        url: 'http://www.metatube.com',
        type: 'video',
        regex: [new RegExp('metatube\\.com/.*?/videos/(.*?)/(.*?)/')],
        parser: function(code) {
            return {
                code: code[1],
                iframe: '//www.metatube.com/en/videos/' + code[1] + '/' + code[2] + '/embed/'
            }
        }
    });
    Zedity.core.embed.add('vine', {
        url: 'http://vine.co',
        type: 'video',
        regex: [new RegExp('vine\\.co/v/(.+?)(/|$)')],
        parser: function(code) {
            return {
                code: code[1],
                iframe: '//vine.co/v/' + code[1] + '/embed/simple'
            }
        }
    });
    Zedity.core.embed.add('snotr', {
        url: 'http://www.snotr.com',
        type: 'video',
        regex: [new RegExp('snotr\\.com/(?:video|embed)/(.*?)("|/|\'|$|\\?)')],
        parser: function(code) {
            return {
                code: code[1],
                iframe: '//www.snotr.com/embed/' + code[1]
            }
        }
    });
    Zedity.core.embed.add('bliptv', {
        url: 'http://blip.tv',
        type: 'video',
        regex: [new RegExp('blip\\.tv/(?:play/|api.swf#)(.*?)[\.\'\?"$]')],
        parser: function(code) {
            return {
                code: code[1],
                flash: '//a.blip.tv/api.swf#' + code[1],
                iframe: '//blip.tv/play/' + code[1] + '.x?p=1'
            }
        },
        sizeLimits: {
            minWidth: 250,
            minHeight: 250
        }
    });
    Zedity.core.embed.add('5min', {
        url: 'http://www.5minmedia.com/VideoLibrary/',
        type: 'video',
        regex: [new RegExp('5min\\.com/.*?playList=(.*?)[\'">&$]'), new RegExp('aol\\.com/.*-(.*?)[\\?$]')],
        parser: function(code) {
            return {
                code: code[1],
                flash: '//cfiles.5min.com/FlexPlayers/SmartPlayer_221.swf?sid=281&amp;skey=0&amp;isEmbed=True&amp;isAutoStart=False&amp;videoID=' + code[1]
            }
        }
    });
    Zedity.core.embed.add('tunepk', {
        url: 'http://tune.pk/',
        type: 'video',
        regex: [new RegExp('tune\\.pk/(?:video|play)/(.*?)(&|/|\\?|"|\'|$)'), new RegExp('tune\\.pk/player/embed_player.php\\?.*?vid=(.*?)(&|/|\\?|"|\'|$)')],
        parser: function(code) {
            return {
                code: code[1],
                iframe: '//embed.tune.pk/play/' + code[1] + '?autoplay=no'
            }
        }
    });
    Zedity.core.embed.add('coub', {
        url: 'http://coub.com/',
        type: 'video',
        regex: [new RegExp('coub\\.com/(?:view|embed)/(.*?)(&|/|\\?|"|\'|$)')],
        parser: function(code) {
            return {
                code: code[1],
                iframe: '//coub.com/embed/' + code[1] + '?muted=false&amp;autostart=false&amp;originalSize=false&amp;hideTopBar=true&amp;noSiteButtons=true'
            }
        }
    })
})(jQuery);
(function($) {
    if (!Zedity) throw new Error(Zedity.t('%s needs %s.', 'Zedity.Responsive', 'Zedity'));
    Zedity.Responsive = function(options) {
        this._options = $.extend(true, {
            layouts: {
                1: {
                    title: Zedity.t('Extra small layout') + ' (XS)',
                    short: 'XS',
                    icon: 'smartphone',
                    width: 300
                },
                6: {
                    title: Zedity.t('Small layout') + ' (S)',
                    short: 'S',
                    icon: 'tablet',
                    width: 400
                },
                11: {
                    title: Zedity.t('Medium layout') + ' (M)',
                    short: 'M',
                    icon: 'laptop',
                    width: 500
                },
                16: {
                    title: Zedity.t('Large layout') + ' (L)',
                    short: 'L',
                    icon: 'desktop',
                    width: 600
                }
            },
            customsizes: {
                21: 'XL',
                26: 'XXL',
                31: '3XL',
                36: '4XL',
                41: '5XL'
            },
            onsave: function(html) {
                this._options.onsave.call(this, html)
            },
            revertmessage: Zedity.t('If you perform this action you will revert to a non-responsive design. Are you sure?')
        }, options);
        this.editor = this._options.editor;
        this.saved = [];
        this._data = {
            originaloptions: $.extend(true, {}, this._options)
        };
        var buttons = '';
        for (var i = 1; i <= 16; ++i) {
            if (this._options.layouts[i]) {
                buttons += '<button class="zedity-responsive" data-layout="' + i + '">' + '<span class="zedity-responsive-icon zedity-responsive-icon-' + this._options.layouts[i].icon + '"></span><br/>' + this._options.layouts[i].title + '<span class="zedity-delete" title="' + Zedity.t('Delete layout') + '">&times;</span>' + '</button>'
            }
        }
        var custombuttons = '';
        for (var i in this._options.customsizes) {
            if (this._options.customsizes.hasOwnProperty(i)) {
                custombuttons += '<button class="zedity-responsive zedity-small" data-layout="' + i + '" style="display:none">' + this._options.customsizes[i] + '<span class="zedity-delete" title="' + Zedity.t('Delete layout') + '">&times;</span>' + '</button>'
            }
        }
        var $dialog = $('<div class="zedity-dialog-responsive">' + '<div class="zedity-responsive-main">' + '<ul>' + '<li>' + Zedity.t('You can start your design from any layout.') + '</li>' + '<li>' + Zedity.t('Boxes can be added in any layout and can be modified only in the layout they were added to.') + '</li>' + '<li>' + Zedity.t('Boxes added in a layout can be hidden in other layouts.') + '</li>' + '</ul>' + '</div>' + '<div class="zedity-responsive-others">' + buttons + '</div>' + '<div class="zedity-responsive-custom">' + '<span style="margin-right:10px">' + Zedity.t('Custom layouts:') + '</span>' + '<span class="zedity-tooltip help-custom">?</span>' + '<div class="zedity-responsive-custom-buttons-wrapper">' + '<div class="zedity-responsive-custom-buttons">' + custombuttons + '</div>' + '<button id="btnAddCustom" title="' + Zedity.t('Add custom layout') + '"></button>' + '</div>' + '</div>' + '<div class="zedity-responsive-message"><p></p></div>' + '</div>');
        this.editor.$container.append($dialog);
        var editor = this.editor;
        var self = this;
        $dialog.dialog({
            title: Zedity.t('Multiple layout responsive design'),
            dialogClass: 'zedity-dialog zedity-dialog-responsive-outer',
            autoOpen: false,
            modal: true,
            closeOnEscape: false,
            resizable: false,
            position: {
                my: 'center',
                at: 'center',
                of: window.top
            },
            width: 650,
            create: function() {
                $dialog.find('.zedity-tooltip.help-custom').attr('title', Zedity.t('The width of custom layouts can be adjusted to fit larger designs.')).tooltip();
                $dialog.find('button.zedity-responsive .zedity-delete').on('click.zedity', function(e) {
                    var $this = $(this);
                    var $parent = $this.closest('button.zedity-responsive');
                    if ($parent.hasClass('zedity-disabled')) return;
                    var thislayout = parseInt($parent.attr('data-layout'), 10);
                    Zedity.core.dialog({
                        title: Zedity.t('Delete layout'),
                        message: Zedity.t('Are you sure you want to delete this layout?') + '<br/>' + Zedity.t('The layout will be cleared and all boxes owned by layout "%s" will be deleted (even in other layouts).', editor.responsive._options.layouts[thislayout].short),
                        cancel: true,
                        ok: function() {
                            editor.$this.removeAttr('data-layout-' + thislayout);
                            $.each(editor.boxes.get(), function(idx, box) {
                                if (box._data.ownerlayout == thislayout) {
                                    box.remove()
                                } else {
                                    box.deleteLayoutData(thislayout)
                                }
                            });
                            delete self._options.layouts[thislayout].done;
                            if (self._data.main == thislayout) {
                                self._data.main = null;
                                for (var i in self._options.layouts) {
                                    if (self._options.layouts[i].done) {
                                        self._data.main = i;
                                        break
                                    }
                                }
                            }
                            self.refresh();
                            editor.page._saveUndo();
                            editor.page._clearUndo()
                        }
                    });
                    return false
                });
                $dialog.find('button.zedity-responsive').on('click.zedity', function() {
                    var $this = $(this);
                    if ($this.hasClass('zedity-disabled')) return;
                    var thislayout = parseInt($this.attr('data-layout'), 10);
                    var isnew = true;
                    for (var i in editor.responsive._options.layouts) {
                        if (editor.responsive._options.layouts[i].done) {
                            isnew = false;
                            break
                        }
                    }
                    if (isnew) editor.responsive._data.main = thislayout;
                    $.each(editor.boxes.get(), function(idx, box) {
                        box._data.ownerlayout = box._data.ownerlayout || box.$this.attr('data-ol') || editor.responsive._data.main || 1
                    });
                    editor.responsive.startLayout(thislayout)
                });
                $dialog.parent().find('button.zedity-button-ok').button('disable');
                $dialog.find('#btnAddCustom').button({
                    icons: {
                        primary: 'ui-icon-plusthick'
                    },
                    text: false
                }).button('disable').on('click.zedity', function() {
                    var newlayout = editor.responsive.addLayout();
                    $dialog.trigger('refresh.zedity')
                })
            },
            open: function() {
                if (!editor.responsive.current) {
                    $dialog.find('button.zedity-responsive').removeClass('zedity-ok zedity-warn');
                    $dialog.find('.zedity-responsive-message p').text(Zedity.t('Click on a layout button to start creating content for that layout.'));
                    $dialog.parent().find('button.zedity-button-ok').removeClass('zedity-ok zedity-warn').find('.ui-button-text').text(Zedity.t('Save'))
                }
            },
            beforeClose: function(event, ui) {
                if (event.originalEvent && $(event.originalEvent.currentTarget).is('.ui-dialog-titlebar-close')) {
                    $dialog.data('cancel', true)
                }
            },
            close: function(event, ui) {
                if ($dialog.data('cancel')) {
                    var isnew = true;
                    for (var i in editor.responsive._options.layouts) {
                        if (editor.responsive._options.layouts[i].done) {
                            isnew = false;
                            break
                        }
                    }
                    if (isnew) editor.responsive.revert(true)
                }
                $dialog.removeData('cancel')
            },
            buttons: [{
                text: Zedity.t('Save'),
                class: 'zedity-button-ok',
                click: function() {
                    editor.responsive.save()
                }
            }, {
                text: Zedity.t('Abort'),
                class: 'zedity-button-abort',
                click: function() {
                    if (editor.responsive.revert()) $dialog.dialog('close')
                }
            }, {
                text: Zedity.t('Cancel'),
                class: 'zedity-button-cancel',
                click: function() {
                    $dialog.data('cancel', true).dialog('close')
                }
            }]
        }).on('refresh.zedity', function() {
            var $allbuttons = $dialog.find('button.zedity-responsive');
            $allbuttons.removeClass('zedity-ok zedity-warn').hide().removeClass('zedity-visible');
            for (var i in editor.responsive._options.layouts) {
                if (editor.responsive._options.layouts.hasOwnProperty(i)) {
                    var $cur = $dialog.find('button.zedity-responsive[data-layout=' + i + ']').show().addClass('zedity-visible');
                    if (editor.responsive._options.layouts[i].done === true) {
                        $cur.addClass('zedity-ok')
                    } else if (editor.responsive._options.layouts[i].done === false) {
                        $cur.addClass('zedity-warn')
                    }
                }
            }
            var $custombuttons = $dialog.find('.zedity-responsive-custom-buttons button.zedity-responsive');
            var lastl = editor.responsive.lastLayout();
            var lastc = parseInt(Object.keys(editor.responsive._options.customsizes).pop());
            $('#btnAddCustom').button(((editor.responsive._options.layouts['1'].done || editor.responsive._options.layouts['6'].done || editor.responsive._options.layouts['11'].done || editor.responsive._options.layouts['16'].done) && !$custombuttons.filter(':visible:not(.zedity-ok):not(.zedity-warn)').length && lastl < lastc) ? 'enable' : 'disable');
            var $message = $dialog.find('.zedity-responsive-message p');
            var $button = $dialog.parent().find('button.zedity-button-ok').button('enable');
            editor.contentChanged = false;
            if ($dialog.find('button.zedity-responsive.zedity-warn').length) {
                $message.text(Zedity.t('You may want to review the design for layouts in yellow.'));
                $button.removeClass('zedity-ok').addClass('zedity-warn').find('.ui-button-text').text(Zedity.t('Save without reviewing'));
                editor.contentChanged = true
            } else if ($dialog.find('button.zedity-responsive.zedity-visible:not(.zedity-ok)').length) {
                $message.text(Zedity.t('Please click on the layouts in gray to provide the design for all layouts.'));
                $button.removeClass('zedity-warn zedity-ok').find('.ui-button-text').text(Zedity.t('Save anyway (not recommended)'))
            } else {
                $message.text(Zedity.t('Your responsive content is ready to be saved!'));
                $button.removeClass('zedity-warn').addClass('zedity-ok').find('.ui-button-text').text(Zedity.t('Save'))
            }
        });
        this.editor.$container.on('mouseenter.zedity', '.zedity-bar', function(event) {
            var $this = $(this);
            var box = $this.editor().boxes.selected();
            if (!box || box.editor.$container.find('.ui-draggable-dragging').length) return false;
            if (box.editor.responsive.current && box._data.ownerlayout != box.editor.responsive.current) {
                $this.tooltip({
                    items: this,
                    show: {
                        delay: 500,
                        duration: 100
                    },
                    hide: false,
                    content: Zedity.t('This box was created in another layout.') + '<br/>' + Zedity.t('To modify its content edit the layout "%s".', box.editor.responsive._options.layouts[box._data.ownerlayout].short),
                    position: {
                        my: 'center bottom',
                        at: 'center top'
                    }
                });
                $this.tooltip('open')
            }
        });
        this.editor.$container.on('mousemove.zedity', '.zedity-bar .zedity-button', function(event) {
            var $this = $(this).parents('.zedity-bar');
            if ($this.data('ui-tooltip')) {
                $this.tooltip('close')
            }
            return false
        });
        this.editor.$container.on('mouseenter.zedity', '.zedity-box', function() {
            function keepTooltipOpen(event) {
                var $target = $(event.target);
                if (!$target.hasClass('zedity-box')) $target = $target.parents('.zedity-box');
                if ($target.length == 0) return;
                event.stopImmediatePropagation();
                var fixed = setTimeout(function() {
                    if ($target.data('ui-tooltip')) {
                        $target.tooltip('close')
                    }
                }, 200);
                $('.ui-tooltip').hover(function() {
                    clearTimeout(fixed)
                }, function() {
                    $target.tooltip('close')
                });
                return false
            };
            var $this = $(this);
            var box = $this.box();
            if (!box || box.editor.$container.find('.ui-draggable-dragging').length) return false;
            if ($this.data('ui-tooltip')) $this.tooltip('destroy');
            if (box.asBackground()) return;
            if ($this.hasClass('zedity-mlrd-hidden')) {
                $this.tooltip({
                    items: this,
                    show: {
                        delay: 500,
                        duration: 100
                    },
                    hide: false,
                    content: Zedity.t('The box is hidden in this layout.') + '<br/>' + '<a class="zedity-showbox" href="javascript:;">' + Zedity.t('Show box') + '</a>',
                    open: function(event, ui) {
                        $(ui.tooltip[0]).data('box', box)
                    },
                    position: {
                        my: 'center bottom',
                        at: 'center top'
                    }
                });
                $this.on('mouseleave.zedity-tooltip', keepTooltipOpen);
                $this.tooltip('open')
            } else {
                if ($this.data('ui-tooltip')) $this.tooltip('remove');
                $this.off('mouseleave.zedity-tooltip')
            }
        });
        this.editor.$container.on('mousemove.zedity', '.zedity-box', function() {
            var $this = $(this);
            if ($this.data('ui-tooltip')) {
                $this.tooltip('open')
            }
        });
        this.editor.$container.on('mouseleave.zedity', '.zedity-box', function() {
            var $this = $(this);
            if ($this.data('ui-tooltip')) {
                $this.tooltip('close');
                $this.tooltip('destroy')
            }
        });
        this.editor.$container.on('tooltipopen.zedity', '.zedity-box', function() {
            var $this = $(this);
            if ($this.box().editor.$container.find('.ui-draggable-dragging').length) {
                $this.tooltip('close');
                return false
            }
        });
        this.editor.$container.on('dragstart.zedity', '.zedity-box', function() {
            var $this = $(this);
            if ($this.data('ui-tooltip')) $this.tooltip('close')
        });
        $(document).on('click.zedity', '.ui-tooltip .zedity-showbox', function() {
            var box = $(this).parents('.ui-tooltip').data('box');
            box.select();
            box.editor.menu.activateFeature('editbox', 'layout', 'showhideresponsive');
            box.$this.tooltip('close')
        });
        var disableAll = function(ed, box, tab) {
            var en = (!ed.responsive.current || ed.responsive.current == box._data.ownerlayout);
            if (en) return true;
            for (var i = tab.groups.length - 1; i >= 0; --i) {
                for (var j = tab.groups[i].features.length - 1; j >= 0; --j) {
                    ed.menu._featureElement(tab.groups[i].features[j]).addClass('zedity-disabled')
                }
            }
        };
        this.editor.menu.add({
            tabs: {
                content: {
                    groups: {
                        responsive: {
                            title: Zedity.t('Responsive'),
                            order: 300,
                            features: {
                                responsive: {
                                    icon: 'responsive',
                                    label: Zedity.t('Start %s', 'MLRD'),
                                    title: 'Multiple Layout Responsive Design',
                                    order: 0,
                                    onclick: function(e, ed) {
                                        if (!ed.responsive.current) {
                                            ed.responsive.load()
                                        } else {
                                            ed.responsive.saveLayout()
                                        }
                                    },
                                    refresh: function(ed) {
                                        this.$button.find('.zedity-ribbon-button-label').html(ed.responsive && ed.responsive.current ? Zedity.t('Save "%s"', ed.responsive._options.layouts[ed.responsive.current].short) : Zedity.t('Start %s', 'MLRD'))
                                    }
                                },
                                options: {
                                    type: 'extpanel',
                                    icon: 'config',
                                    label: Zedity.t('Options'),
                                    title: Zedity.t('%s options', 'MLRD'),
                                    order: 10,
                                    build: function($panel, ed) {
                                        $panel.append(Zedity.t('Hidden boxes') + ' &nbsp; ' + '<select class="zedity-mlrd-hiddenboxes">' + '<option value="0">' + Zedity.t('Hide') + '</option>' + '<option value="1">' + Zedity.t('Show as icons') + '</option>' + '</select>');
                                        $panel.find('.zedity-mlrd-hiddenboxes').selectmenu({
                                            width: 130,
                                            appendTo: $panel,
                                            change: function(e, ui) {
                                                if (!ed.responsive) return;
                                                ed.$this.toggleClass('zedity-mlrd-hideboxes', parseInt(ui.item.value, 10) == 0)
                                            }
                                        })
                                    },
                                    refresh: function(ed) {
                                        if (!ed.responsive) return;
                                        this.$extpanel.find('.zedity-mlrd-hiddenboxes').val(ed.$this.hasClass('zedity-mlrd-hideboxes') ? 0 : 1).selectmenu('refresh')
                                    }
                                }
                            }
                        }
                    }
                },
                editbox: {
                    icon: 'editbox',
                    title: Zedity.t('Edit box'),
                    order: 1000,
                    groups: {
                        layout: {
                            title: Zedity.t('Layout'),
                            order: 0,
                            features: {
                                showhideresponsive: {
                                    type: 'toggle',
                                    order: -1000,
                                    state: [{
                                        icon: 'view',
                                        label: Zedity.t('Show'),
                                        title: Zedity.t('Show box in this layout')
                                    }, {
                                        icon: 'view',
                                        label: Zedity.t('Hide'),
                                        title: Zedity.t('Hide box in this layout')
                                    }],
                                    onclick: function(e, ed, before) {
                                        var box = ed.boxes.selected();
                                        if (!box) return;
                                        box.$this.toggleClass('zedity-mlrd-hidden', before == 1);
                                        if (box.$this.hasClass('zedity-mlrd-hidden')) {
                                            Zedity.core._call(box, 'asBackground', false);
                                            ed.boxes._select()
                                        }
                                        ed.responsive._arrangeIcons();
                                        ed._changed()
                                    },
                                    show: function(ed) {
                                        return !ed.responsive || !!ed.responsive.current
                                    },
                                    refresh: function(ed, box) {
                                        if (!box) return;
                                        this.$button.trigger('toggle', box.$this.hasClass('zedity-mlrd-hidden') ? 0 : 1)
                                    }
                                }
                            }
                        }
                    },
                    show: function(ed, box) {
                        return !!box
                    },
                    refresh: function(ed, box) {
                        if (!box) return;
                        if (disableAll(ed, box, this)) return;
                        ed.menu._featureElement(ed.menu._feature('editbox', 'imagebox', 'insert')).removeClass('zedity-disabled');
                        ed.menu._featureElement(ed.menu._feature('editbox', 'imagebox', 'config')).removeClass('zedity-disabled');
                        ed.menu._featureElement(ed.menu._feature('editbox', 'videobox', 'play')).removeClass('zedity-disabled');
                        ed.menu._featureElement(ed.menu._feature('editbox', 'videobox', 'show')).removeClass('zedity-disabled');
                        ed.menu._featureElement(ed.menu._feature('editbox', 'audiobox', 'play')).removeClass('zedity-disabled');
                        ed.menu._featureElement(ed.menu._feature('editbox', 'audiobox', 'show')).removeClass('zedity-disabled');
                        ed.menu._featureElement(ed.menu._feature('editbox', 'layout', 'showhideresponsive')).removeClass('zedity-disabled');
                        ed.menu._featureElement(ed.menu._feature('editbox', 'layout', 'background')).removeClass('zedity-disabled');
                        ed.menu._featureElement(ed.menu._feature('editbox', 'layout', 'arrange')).removeClass('zedity-disabled');
                        ed.menu._featureElement(ed.menu._feature('editbox', 'layout', 'align')).removeClass('zedity-disabled');
                        ed.menu._featureElement(ed.menu._feature('editbox', 'edit', 'duplicate')).removeClass('zedity-disabled');
                        ed.menu._featureElement(ed.menu._feature('editbox', 'positioning', 'position')).removeClass('zedity-disabled');
                        ed.menu._featureElement(ed.menu._feature('editbox', 'positioning', 'size')).removeClass('zedity-disabled')
                    }
                },
                boxstyle: {
                    icon: 'style',
                    title: Zedity.t('Box style'),
                    order: 1100,
                    show: function(ed, box) {
                        return !!box
                    },
                    refresh: function(ed, box) {
                        if (!box) return;
                        if (disableAll(ed, box, this)) return
                    }
                }
            },
            onadd: function(ed) {
                Zedity.core.patch(ed.menu._tab('content'), 'refresh', {
                    after: function() {
                        if (ed.responsive.current) {
                            ed.menu.tabBadge('content', 'responsive', ed.responsive._options.layouts[ed.responsive.current].short)
                        } else {
                            ed.menu.tabBadge('content', 'responsive', null)
                        }
                    }
                })
            }
        })
    };
    $.extend(Zedity.Responsive.prototype, {
        lastLayout: function() {
            return parseInt(Object.keys(this._options.layouts).pop())
        },
        prevLayout: function(layout) {
            layout = layout || this.current;
            for (var i = layout - 1; i >= 1; --i) {
                if (this._options.layouts.hasOwnProperty(i)) {
                    return i
                }
            }
            return null
        },
        nextLayout: function(layout) {
            layout = layout || this.current;
            var last = this.lastLayout();
            for (var i = layout + 1; i <= last; ++i) {
                if (this._options.layouts.hasOwnProperty(i)) {
                    return i
                }
            }
            return null
        },
        start: function() {
            var editor = this.editor;
            this.editor.$this.addClass('zedity-responsive-layout');
            this.editor._changed();
            var $dialog = $('.zedity-dialog-responsive');
            $dialog.trigger('refresh.zedity').data('editor', this.editor).dialog('open');
            this._data.startmlrd = true
        },
        load: function() {
            if (this.editor.$this.hasClass('zedity-responsive-layout')) {
                this._options = $.extend(true, {}, this._data.originaloptions);
                this._data.main = this.editor.$this.attr('data-mainl');
                var data = JSON.parse(this.editor.$this.attr('data-layouts') || '[]');
                for (var i = 0, len = data.length - 1; i <= len; ++i) {
                    if (!this._options.layouts[data[i].i]) {
                        this.addLayout()
                    }
                    if (this._options.layouts[data[i].i]) {
                        if (!this._data.main) this._data.main = data[i].i;
                        this._options.layouts[data[i].i].done = true;
                        $('.zedity-dialog-responsive button.zedity-responsive[data-layout=' + data[i].i + ']').addClass('zedity-ok')
                    }
                }
                this.current = 1;
                this.loadLayout(1)
            }
            this.start()
        },
        addLayout: function() {
            var last = this.lastLayout();
            var next = last + 5;
            this._options.layouts[next] = {
                custom: true,
                title: this._options.customsizes[next],
                short: this._options.customsizes[next],
                width: this._options.layouts[last].width + 100
            };
            return next
        },
        startLayout: function(layout) {
            if (!this._options.layouts[layout]) return;
            this.current = layout;
            $('.zedity-dialog-responsive').dialog('close');
            this.editor.page.size({
                width: this._options.layouts[layout].width
            });
            this.loadLayout(layout);
            this.refresh();
            this.editor.page._saveUndo();
            this.editor.page._clearUndo();
            this.editor.$this.children('.zedity-box').each($.proxy(function(idx, el) {
                var box = $(el).box();
                box.$this.toggleClass('zedity-mlrd-ownerlayout', this.current == box._data.ownerlayout)
            }, this));
            setTimeout($.proxy(function() {
                this.editor.contentChanged = false
            }, this), 500)
        },
        loadLayout: function(layout) {
            var data = this.editor.$this.attr('data-layout-' + layout);
            if (data) {
                data = JSON.parse(data);
                this.editor.page.size({
                    width: parseInt(data.w),
                    height: parseInt(data.h)
                })
            }
            var isnew = true;
            for (var i in this._options.layouts) {
                if (this._options.layouts[i].done) {
                    isnew = false;
                    break
                }
            }
            if (isnew) {
                var boxes = this.editor.boxes.get();
                for (var i = boxes.length - 1; i >= 0; --i) {
                    if (boxes[i].$this.width() > this._options.layouts[layout].width) {
                        boxes[i].fitToPage('width', true)
                    }
                }
            } else if (this._options.layouts[layout].done == null && layout != this._data.main) {
                var w = this._options.layouts[layout].width;
                var data = JSON.parse(this.editor.$this.attr('data-layout-' + this._data.main));
                this.editor.page.size({
                    width: w,
                    height: Math.round(parseInt(data.h) * w / parseInt(data.w))
                })
            }
            var boxes = this.editor.boxes.get();
            for (var i = boxes.length - 1; i >= 0; --i) {
                boxes[i].loadLayoutData(layout)
            }
            Zedity.core._call(this.editor.page, '_setPage', this.editor.page._getPage());
            setTimeout($.proxy(function() {
                this.editor.contentChanged = false
            }, this), 500)
        },
        saveLayout: function(layout) {
            layout = layout || this.current;
            if (!layout) return;
            this._options.layouts[layout].done = true;
            if (this.editor.contentChanged) {
                for (var i in this._options.layouts) {
                    if (i <= layout || !this._options.layouts[i].hasOwnProperty('done')) continue;
                    this._options.layouts[i].done = false
                }
            }
            var boxes = this.editor.boxes.get();
            for (var i = boxes.length - 1; i >= 0; --i) {
                boxes[i].saveLayoutData(layout)
            }
            var data = this.editor.$this.getCss('width height');
            if (layout > 16) this._options.layouts[layout].width = parseInt(data.width, 10);
            this.editor.$this.attr('data-layout-' + this.current, JSON.stringify({
                w: data.width,
                h: data.height
            }));
            this.refresh();
            this.start()
        },
        save: function(options) {
            $('.zedity-dialog-responsive').dialog('close');
            var layouts = [];
            for (var layout in this._options.layouts) {
                if (this._options.layouts.hasOwnProperty(layout) && this._options.layouts[layout].done != null) {
                    layouts.push({
                        i: layout,
                        w: this._options.layouts[layout].width
                    })
                }
            }
            layouts.sort(function(a, b) {
                return a.i - b.i
            });
            this.editor.$this.attr('data-layouts', JSON.stringify(layouts));
            if (this._data.main) this.editor.$this.attr('data-mainl', this._data.main);
            this.current = null;
            this.refresh();
            this.editor.save(function(html) {
                this.responsive._options.onsave.call(this, html)
            }, options)
        },
        revert: function(force) {
            var ret = force || confirm(this._options.revertmessage);
            if (!ret) return false;
            this.current = null;
            this.refresh();
            var a = 'data-layouts';
            var last = this.lastLayout();
            for (var i = 1; i <= last; ++i) {
                a += ' data-layout-' + i;
                if (this._options.layouts[i]) delete this._options.layouts[i].done
            }
            this.editor.$this.removeClass('zedity-responsive-layout');
            this.editor.$container.find('.zedity-editor,.zedity-box').removeAttr(a).removeClass('zedity-mlrd-hidden');
            Zedity.core._call(this.editor.page, '_setPage', this.editor.page._getPage());
            this.editor._changed();
            this._options = $.extend(true, {}, this._data.originaloptions);
            return true
        },
        refresh: function() {
            $('.zedity-dialog-responsive').trigger('refresh.zedity');
            this.editor.menu.refresh().refresh('content');
            this.editor.contextMenu.refresh();
            this._arrangeIcons()
        },
        _arrangeIcons: function() {
            this.editor.$this.find('.zedity-mlrd-hidden').each(function(idx, elem) {
                var box = $(elem).box();
                if (box.type == 'Image' && !box.$this.hasClass('zedity-selected')) {
                    box.$this.addClass('zedity-selected');
                    setTimeout(function() {
                        Zedity.core._call(box, 'layout', box.layout());
                        box.$this.removeClass('zedity-selected')
                    }, 0)
                }
            })
        }
    })
})(jQuery);
(function($) {
    var old_constructor = Zedity;
    var old_prototype = Zedity.prototype;
    var old_map = [];
    for (var i in Zedity) {
        if (Zedity.hasOwnProperty(i)) old_map[i] = Zedity[i]
    }
    Zedity = function(options) {
        old_constructor.call(this, $.extend({
            onsave: function() {}
        }, options));
        if (!Zedity.Responsive) throw new Error(Zedity.t('%s needs %s.', 'Zedity', 'Zedity.Responsive'));
        this.responsive = new Zedity.Responsive({
            editor: this
        })
    };
    Zedity.prototype = old_prototype;
    for (var i in old_map) {
        if (old_map.hasOwnProperty(i)) Zedity[i] = old_map[i]
    }
    var old_changed = Zedity.prototype._changed;
    Zedity.prototype._changed = function() {
        old_changed.apply(this, arguments);
        if (!this._data.internal) {
            this.contentChanged = true
        }
        return this
    };
    var old_save = Zedity.prototype.save;
    Zedity.prototype.save = function(callback, options) {
        if (this._data.saving) return;
        this._data.saving = true;
        if (this.$this.hasClass('zedity-responsive-layout')) {
            this.responsive.saveLayout();
            this.responsive.save(options)
        }
        old_save.apply(this, arguments);
        this._data.saveq.queue('save', $.proxy(function(next) {
            this._data.saving = false;
            next()
        }, this))
    }
})(jQuery);
(function($) {
    var old_content = Zedity.Page.prototype.content;
    Zedity.Page.prototype.content = function(content) {
        var ret = old_content.apply(this, arguments);
        if (this.editor.$this.hasClass('zedity-responsive-layout') && content) {
            setTimeout($.proxy(function() {
                this.editor.responsive.load()
            }, this), 100)
        }
        return ret
    };
    var old_sizeConstraints = Zedity.Page.prototype.sizeConstraints;
    Zedity.Page.prototype.sizeConstraints = function() {
        var sc = old_sizeConstraints.apply(this, arguments);
        if (this.editor.responsive && this.editor.responsive.current) {
            if (this.editor.responsive.current <= 16) {
                sc.minWidth = sc.maxWidth = this.editor.responsive._options.layouts[this.editor.responsive.current].width
            } else {
                var prev = this.editor.responsive.prevLayout();
                if (prev) {
                    sc.minWidth = Math.max(sc.minWidth, this.editor.responsive._options.layouts[prev].width + 100)
                }
                var next = this.editor.responsive.nextLayout();
                if (next) {
                    sc.maxWidth = Math.min(sc.maxWidth, this.editor.responsive._options.layouts[next].width - 100)
                }
            }
        }
        return sc
    }
})(jQuery);
(function($) {
    var old_refresh = Zedity.ContextMenu.prototype.refresh;
    Zedity.ContextMenu.prototype.refresh = function() {
        old_refresh.call(this);
        if (!this.editor.responsive || !this.editor.responsive.current) return;
        var box = this.editor.boxes.selected();
        var canmodify = box && this.editor.responsive.current == box._data.ownerlayout;
        this.$this.find('.zedity-menu-SelFlipMain').toggleClass('zedity-responsive-disabled', !canmodify);
        this.$this.find('.zedity-menu-SelDelete').toggleClass('zedity-responsive-disabled', !canmodify)
    }
})(jQuery);
(function($) {
    var old_constructor = Zedity.Box;
    var old_prototype = Zedity.Box.prototype;
    var old_map = [];
    for (var i in Zedity.Box) {
        if (Zedity.Box.hasOwnProperty(i)) old_map[i] = Zedity.Box[i]
    }
    Zedity.Box = function(options) {
        old_constructor.call(this, $.extend({
            onsave: function() {}
        }, options));
        Zedity.core._later(this, function() {
            this._data.ownerlayout = this.$this.attr('data-ol') || this.editor.responsive.current || this._data.main || 1;
            this.$this.attr('data-ol', this._data.ownerlayout);
            if (this.editor.responsive.current) {
                this.$this.toggleClass('zedity-mlrd-ownerlayout', this.editor.responsive.current == this._data.ownerlayout)
            }
        }, 10)
    };
    Zedity.Box.prototype = old_prototype;
    Zedity.Box.prototype.constructor = Zedity.Box;
    for (var i in old_map) {
        if (old_map.hasOwnProperty(i)) Zedity.Box[i] = old_map[i]
    }
    var allowinsert = ['Image'];
    $.each(Zedity.Box.types, function(idx, elem) {
        if (allowinsert.indexOf(elem) > -1) return;
        var old_insert = Zedity.Box[elem].prototype.insert;
        Zedity.Box[elem].prototype.insert = function() {
            if (this.editor && this.editor.responsive.current && this.editor.responsive.current != this._data.ownerlayout) return this;
            return old_insert.apply(this, arguments)
        }
    });
    var old_duplicate = Zedity.Box.prototype.duplicate;
    Zedity.Box.prototype.duplicate = function() {
        var box = old_duplicate.apply(this, arguments);
        box._data.ownerlayout = this.editor.responsive.current;
        box.$this.attr('data-ol', box._data.ownerlayout);
        box.$this.removeClass('zedity-mlrd-hidden');
        for (var i = this.editor.responsive.current - 1; i >= 1; --i) {
            if (this.editor.responsive._options.layouts.hasOwnProperty(i)) {
                box.$this.removeAttr('data-layout-' + i)
            }
        }
        this.editor.boxes.refreshSelected();
        return box
    };
    var old_save = Zedity.Box.prototype._save;
    Zedity.Box.prototype._save = function() {
        this.$this.attr('data-ol', this._data.ownerlayout);
        this.$this.removeClass('zedity-mlrd-ownerlayout');
        return old_save.apply(this, arguments)
    };
    var old_createPropBar = Zedity.Box.prototype.createPropBar;
    Zedity.Box.prototype.createPropBar = function(options) {
        old_createPropBar.call(this)
    };
    $.extend(Zedity.Box.prototype, {
        saveLayoutData: function(layout, data) {
            var ishidden = this.$this.hasClass('zedity-mlrd-hidden');
            this.$this.removeClass('zedity-mlrd-hidden');
            var css = this.$this.getCss('width height top left z-index', true);
            var pd = this.editor.page.size();
            data = $.extend({
                v: !ishidden,
                w: +(parseInt(css.width) * 100 / pd.width).toFixed(3) + '%',
                h: +(parseInt(css.height) * 100 / pd.height).toFixed(3) + '%',
                l: +(parseInt(css.left) * 100 / pd.width).toFixed(3) + '%',
                t: +(parseInt(css.top) * 100 / pd.height).toFixed(3) + '%',
                z: css['z-index']
            }, data);
            this.$this.attr('data-layout-' + layout, JSON.stringify(data));
            if (ishidden) this.$this.addClass('zedity-mlrd-hidden');
            return data
        },
        loadLayoutData: function(layout) {
            var data = JSON.parse(this.$this.attr('data-layout-' + layout) || '{}');
            if (Object.keys(data).length == 0) {
                if (this.editor.responsive._options.layouts[this._data.ownerlayout].done) {
                    data = this.loadLayoutData(this._data.ownerlayout);
                    var datap = layout > 1 ? this.loadLayoutData(this.editor.responsive.prevLayout(layout)) : false
                } else {
                    datap = {
                        v: true
                    }
                }
                data.v = datap ? datap.v : layout >= this._data.ownerlayout
            }
            if (Object.keys(data).length !== 0 && !this.$this.hasClass('zedity-background')) {
                var pd = this.editor.page.size();
                this.$this.css({
                    width: Math.round(parseFloat(data.w) * pd.width / 100),
                    height: Math.round(parseFloat(data.h) * pd.height / 100),
                    left: Math.round(parseFloat(data.l) * pd.width / 100),
                    top: Math.round(parseFloat(data.t) * pd.height / 100),
                    'z-index': data.z
                }).removeClass('zedity-mlrd-hidden');
                this._resize();
                this.$this.toggleClass('zedity-mlrd-hidden', data.v === false)
            }
            return data
        },
        deleteLayoutData: function(layout) {
            this.$this.removeAttr('data-layout-' + layout)
        }
    });
    $.extend(Zedity.Box.Image.prototype, {
        saveLayoutData: function(layout, data) {
            data = Zedity.Box.prototype.saveLayoutData.apply(this, arguments);
            var css = this.$this.find('img').getCss('width height top left', true);
            var pd = this.$this.getCss('width height', true);
            data.i = {
                w: +(parseInt(css.width) * 100 / parseInt(pd.width)).toFixed(3) + '%',
                h: +(parseInt(css.height) * 100 / parseInt(pd.height)).toFixed(3) + '%',
                l: +(parseInt(css.left) * 100 / parseInt(pd.width)).toFixed(3) + '%',
                t: +(parseInt(css.top) * 100 / parseInt(pd.height)).toFixed(3) + '%',
                a: this.description() || '',
                u: this.content()
            };
            this.$this.attr('data-layout-' + layout, JSON.stringify(data));
            return data
        },
        loadLayoutData: function(layout) {
            var data = Zedity.Box.prototype.loadLayoutData.call(this, layout);
            if (data.i) {
                this.content(data.i.u, null, true);
                this.description(data.i.a)
            }
            return data
        }
    });
    $.extend(Zedity.Box.Text.prototype, {
        saveLayoutData: function(layout, data) {
            data = Zedity.Box.prototype.saveLayoutData.apply(this, arguments);
            if (this.$this.css('display') == 'table') data.dt = 1;
            this.$this.attr('data-layout-' + layout, JSON.stringify(data));
            return data
        }
    });
    $.extend(Zedity.Box.Audio.prototype, {
        saveLayoutData: function(layout, data) {
            data = Zedity.Box.prototype.saveLayoutData.apply(this, arguments);
            data.h = this.$this.css('height');
            this.$this.attr('data-layout-' + layout, JSON.stringify(data));
            return data
        },
        loadLayoutData: function(layout) {
            var data = Zedity.Box.prototype.loadLayoutData.call(this, layout);
            if (data.h) this.$this.css('height', data.h);
            return data
        }
    })
})(jQuery);
(function($) {
    if (!Zedity) throw new Error(Zedity.t('%s needs %s.', 'Zedity.Grid', 'Zedity'));
    Zedity.Grid = function(options) {
        this._options = $.extend(true, {
            show: false,
            snap: false,
            width: 100,
            height: 100,
            color: '#888'
        }, options);
        this.editor = options.editor;
        this.editor.$this.before('<div class="zedity-grid"/>');
        this.$this = this.editor.$container.find('div.zedity-grid');
        this.$this.on('click', function(event) {
            var $this = $(this);
            $this.hide();
            var el = document.elementFromPoint(event.clientX, event.clientY);
            $this.show();
            $(el).trigger('click')
        });
        this.draw()
    };
    $.extend(Zedity.Grid.prototype, {
        draw: function() {
            if (this._options.show) {
                this.$this.html('<svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">' + '<defs>' + '<pattern id="grid" width="' + this._options.width + '" height="' + this._options.height + '" patternUnits="userSpaceOnUse">' + '<path d="M ' + this._options.width + ' 0 H 0 V ' + this._options.height + '" fill="none" stroke="' + this._options.color + '" stroke-width="0.5"/>' + '</pattern>' + '</defs>' + '<rect width="100%" height="100%" fill="url(#grid)" />' + '</svg>').css(this.editor.page.size())
            } else {
                this.$this.html('')
            }
            return true
        },
        show: function(show) {
            if (show != null) this._options.show = show;
            this.draw();
            return this._options.show
        },
        snap: function(snap) {
            if (snap != null) this._options.snap = snap;
            return this._options.snap
        },
        size: function(size) {
            size = size || {};
            this._options.width = size.width || this._options.width || 100;
            this._options.height = size.height || this._options.height || 100;
            this.draw();
            return {
                width: this._options.width,
                height: this._options.height
            }
        }
    })
})(jQuery);
(function($) {
    var old_constructor = Zedity;
    var old_prototype = Zedity.prototype;
    var old_map = [];
    for (var i in Zedity) {
        if (Zedity.hasOwnProperty(i)) old_map[i] = Zedity[i]
    }
    Zedity = function(options) {
        old_constructor.call(this, options);
        if (!Zedity.Grid) throw new Error(Zedity.t('%s needs %s.', 'Zedity', 'Zedity.Grid'));
        this.grid = new Zedity.Grid($.extend({
            editor: this
        }, this._options.grid || {}, {
            show: this._options.snapGrid
        }))
    };
    Zedity.prototype = old_prototype;
    for (var i in old_map) {
        if (old_map.hasOwnProperty(i)) Zedity[i] = old_map[i]
    }
})(jQuery);
(function($) {
    var old_size = Zedity.Page.prototype.size;
    Zedity.Page.prototype.size = function(size) {
        var rsize = old_size.apply(this, arguments);
        if (size && this.editor.grid) this.editor.grid.draw();
        return rsize
    }
})(jQuery);
(function($) {
    $.ui.plugin.add('draggable', 'snapToGrid', {
        drag: function(e, ui) {
            var $this = $(this);
            var o = $this.editor().grid._options;
            if (!o.snap || !o.show) return;
            var inst = $this.data('ui-draggable');
            var st = inst.options.snapTolerance;
            var $el = $(ui.helper.context);
            var op, sp, s;
            s = $el.outerHeight();
            op = ui.position.top + s;
            sp = Math.round(op / o.height) * o.height;
            if (Math.abs(sp - op) < st) {
                ui.position.top = sp - s
            }
            s = $el.outerWidth();
            op = ui.position.left + s;
            sp = Math.round(op / o.width) * o.width;
            if (Math.abs(sp - op) < st) {
                ui.position.left = sp - s
            }
            sp = Math.round(ui.position.top / o.height) * o.height;
            if (Math.abs(sp - ui.position.top) < st) {
                ui.position.top = sp
            }
            sp = Math.round(ui.position.left / o.width) * o.width;
            if (Math.abs(sp - ui.position.left) < st) {
                ui.position.left = sp
            }
        }
    });
    $.ui.plugin.add('resizable', 'snapToGrid', {
        resize: function(e, ui) {
            var $this = $(this);
            var o = $this.editor().grid._options;
            if (!o.snap || !o.show) return;
            var inst = $this.data('ui-resizable');
            var st = inst.options.snapTolerance;
            var op, sp, d;
            var axes = inst.axis.split('');
            for (var j = axes.length - 1; j >= 0; --j) {
                switch (axes[j]) {
                    case 'n':
                        sp = Math.round(ui.position.top / o.height) * o.height;
                        d = sp - ui.position.top;
                        if (Math.abs(d) < st) {
                            ui.position.top += d;
                            ui.size.height -= d
                        }
                        if (inst._aspectRatio) ui.size.width = ui.size.height * inst.aspectRatio;
                        break;
                    case 's':
                        op = ui.position.top + (ui.size.height + inst.sizeDiff.height);
                        sp = Math.round(op / o.height) * o.height;
                        d = sp - op;
                        if (Math.abs(d) < st) {
                            ui.size.height += d
                        }
                        if (inst._aspectRatio) ui.size.width = ui.size.height * inst.aspectRatio;
                        break;
                    case 'w':
                        sp = Math.round(ui.position.left / o.width) * o.width;
                        d = sp - ui.position.left;
                        if (Math.abs(d) < st) {
                            ui.position.left += d;
                            ui.size.width -= d
                        }
                        if (inst._aspectRatio) ui.size.height = ui.size.width / inst.aspectRatio;
                        break;
                    case 'e':
                        op = ui.position.left + (ui.size.width + inst.sizeDiff.width);
                        sp = Math.round(op / o.width) * o.width;
                        d = sp - op;
                        if (Math.abs(d) < st) {
                            ui.size.width += d
                        }
                        if (inst._aspectRatio) ui.size.height = ui.size.width / inst.aspectRatio;
                        break
                }
            }
        }
    })
})(jQuery);
(function($) {
    if (!Zedity) throw new Error(Zedity.t('%s needs %s.', 'Zedity.Templates', 'Zedity'));
    Zedity.Templates = function(options) {
        this._options = $.extend(true, {
            prefix: 'zedity-template-'
        }, options);
        this.editor = this._options.editor;
        this.current = null;
        var self = this;
        this.editor.menu.add({
            tabs: {
                content: {
                    groups: {
                        templates: {
                            title: Zedity.t('Templates'),
                            order: 200,
                            features: {
                                templates: {
                                    icon: 'template',
                                    onclick: function() {
                                        self.editor.templates.open()
                                    }
                                }
                            }
                        }
                    }
                }
            }
        });

        function addentry(num, title, classname) {
            return ('<tr class="template ' + (classname || '') + '">' + '<td><input type="radio" name="template" id="rbTemplate' + num + '" value="' + (num == -1 ? -1 : title) + '"></td>' + '<td><label for="rbTemplate' + num + '">' + title + '</label></td>' + '</tr>')
        };
        var $dialog = $('<div class="zedity-dialog-templates">' + '<table class="templates above" cellspacing="0">' + addentry(-1, Zedity.t('New Template'), 'new') + '</table>' + '<div class="scrollpanel">' + '<table class="templates main" cellspacing="0">' + '</table>' + '</div>' + '<div>' + '<button class="zedity-templates-btnSave" title="' + Zedity.t('Save current content as Template') + '">' + Zedity.t('Save') + '</button>' + '<button class="zedity-templates-btnLoad" title="' + Zedity.t('Load selected Template into editor') + '">' + Zedity.t('Load') + '</button>' + '<button class="zedity-templates-btnDelete title="' + Zedity.t('Delete selected Template') + '"">' + Zedity.t('Delete') + '</button>' + '</div>' + '</div>');
        this.editor.$container.append($dialog);
        var editor = this.editor;
        $dialog.dialog({
            title: Zedity.t('Templates'),
            dialogClass: 'zedity-dialog',
            autoOpen: false,
            modal: true,
            closeOnEscape: false,
            resizable: false,
            position: {
                my: 'center',
                at: 'center',
                of: window.top
            },
            width: 500,
            create: function() {
                $dialog.find('button').button().button('disable');
                $dialog.on('click.zedity', 'tr.template', function() {
                    $dialog.find('tr.template').removeClass('selected');
                    var $this = $(this);
                    var $radio = $this.find('input[type=radio]');
                    $radio.prop('checked', true);
                    $this.addClass('selected');
                    $dialog.find('button').button('disable');
                    if ($radio.val() == -1) {
                        $dialog.find('.zedity-templates-btnSave').button('enable')
                    } else if ($radio.val() != null) {
                        $dialog.find('button').button('enable')
                    }
                });
                $dialog.find('.zedity-templates-btnSave').on('click.zedity', function() {
                    function save(title, content) {
                        var ret = editor.templates.save(title, content);
                        if (!ret) {
                            alert(Zedity.t('An error occurred while saving the Template. Please try again.'));
                            return
                        }
                        $dialog.trigger('refresh.zedity');
                        setTimeout(function() {
                            Zedity.core.dialog({
                                message: Zedity.t('Template "%s" saved.', title)
                            })
                        }, 100)
                    };
                    var $radio = $dialog.find('input[type=radio]:checked');
                    var content = editor.page.content();
                    if ($radio.val() != -1) {
                        Zedity.core.dialog({
                            message: Zedity.t('The current content will overwrite the selected Template. Are you sure?'),
                            ok: function() {
                                save($radio.val(), content)
                            },
                            cancel: true
                        })
                    } else {
                        Zedity.core.dialog({
                            question: Zedity.t('Give a title to your Template:'),
                            acceptedChars: 'a-zA-Z0-9 \\-_',
                            ok: function(answer) {
                                if (editor.templates.load(answer)) {
                                    alert(Zedity.t('A Template with that title already exists, please change the title.'));
                                    return false
                                }
                                save(answer, content)
                            }
                        })
                    }
                });
                $dialog.find('.zedity-templates-btnLoad').on('click.zedity', function() {
                    Zedity.core.dialog({
                        message: Zedity.t('The Template will overwrite the current editor content. Are you sure?'),
                        ok: function() {
                            var $radio = $dialog.find('input[type=radio]:checked');
                            var title = $radio.val();
                            var content = editor.templates.load(title);
                            if (!content) {
                                alert(Zedity.t('An error occurred while loading the Template. Please try again.'));
                                return
                            }
                            editor.page.content(content);
                            setTimeout(function() {
                                Zedity.core.dialog({
                                    message: Zedity.t('Template "%s" loaded.', title)
                                })
                            }, 100)
                        },
                        cancel: true
                    })
                });
                $dialog.find('.zedity-templates-btnDelete').on('click.zedity', function() {
                    Zedity.core.dialog({
                        message: Zedity.t('Are you sure you want to delete the selected Template?'),
                        ok: function() {
                            var $radio = $dialog.find('input[type=radio]:checked');
                            var ret = editor.templates.del($radio.val());
                            if (!ret) {
                                alert(Zedity.t('An error occurred while deleting the Template. Please try again.'));
                                return
                            }
                            $dialog.trigger('refresh.zedity')
                        },
                        cancel: true
                    })
                })
            },
            open: function() {
                $dialog.trigger('refresh.zedity')
            },
            close: function() {},
            buttons: [{
                text: Zedity.t('Close'),
                class: 'zedity-button-close',
                click: function() {
                    $dialog.dialog('close')
                }
            }]
        }).on('refresh.zedity', function() {
            var list = editor.templates.list();
            var entries = '';
            for (var i = 0, len = list.length; i < len; ++i) {
                entries += addentry(i, list[i])
            }
            $dialog.find('tr.template').removeClass('selected');
            $dialog.find('input[type=radio]').prop('checked', false);
            $dialog.find('button').button('disable');
            $dialog.find('table.templates.main').html(entries)
        })
    };
    $.extend(Zedity.Templates.prototype, {
        open: function() {
            var $dialog = $('.zedity-dialog-templates');
            $dialog.dialog('open')
        },
        list: function() {
            var templates = Zedity.core.store.getprefix(this._options.prefix, localStorage);
            for (var i = templates.length - 1; i >= 0; --i) {
                templates[i] = templates[i].replace(this._options.prefix, '')
            }
            return templates.sort()
        },
        load: function(title) {
            var content = Zedity.core.store.get(this._options.prefix + title, localStorage);
            return content || false
        },
        save: function(title, content) {
            if (!title || !content) return false;
            Zedity.core.store.set(this._options.prefix + title, content, localStorage);
            return this.load(title)
        },
        del: function(title) {
            if (!title) return false;
            Zedity.core.store.del(this._options.prefix + title, localStorage);
            return true
        }
    })
})(jQuery);
(function($) {
    Zedity.core.patch(window, 'Zedity', {
        restorePrototype: true,
        after: function() {
            if (!Zedity.Templates) throw new Error(Zedity.t('%s needs %s.', 'Zedity', 'Zedity.Templates'));
            this.templates = new Zedity.Templates({
                editor: this
            })
        }
    })
})(jQuery);